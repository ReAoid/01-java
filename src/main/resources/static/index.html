<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI聊天机器人系统</title>
    <!-- 引入marked.js用于markdown解析 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }
        
        /* 左侧Tab导航 */
        .sidebar {
            width: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 1000;
        }
        
        .tab-button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button:hover {
            background: rgba(103, 126, 234, 0.1);
            transform: scale(1.1);
        }
        
        .tab-button.active {
            background: rgba(103, 126, 234, 0.2);
            color: #667eea;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            right: -10px;
            width: 3px;
            height: 20px;
            background: #667eea;
            border-radius: 2px;
        }
        
        /* 主内容区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Tab内容 */
        .tab-content {
            display: none;
            flex: 1;
            padding: 0;
            overflow: hidden;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* 聊天Tab - 适应70%窗口 */
        .tab-content#chat-tab {
            height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .tab-content#chat-tab.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* 设置Tab标准高度 */
        .tab-content#settings-tab {
            height: 100vh;
        }
        
        .tab-content#settings-tab.active {
            display: flex;
            flex-direction: column;
        }
        
        /* 日志Tab - 适应70%窗口 */
        .tab-content#logs-tab {
            height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .tab-content#logs-tab.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* 聊天界面样式 - 70%大小居中 */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 70%;
            height: 70vh;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .chat-container .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 12px;
            box-shadow: none;
            background: white;
        }
        
        .chat-container .header {
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .chat-container .chat-messages {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            background: white;
        }
        
        .chat-container .input-container {
            flex-shrink: 0;
            background: white;
            border-radius: 0 0 12px 12px;
        }
        
        /* 确保消息区域正确滚动 */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
        }
        
        .input-container {
            padding: 20px;
            border-top: 1px solid #eee;
            background: white;
        }
        
        /* 设置界面样式 */
        .settings-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            min-height: 100vh;
        }
        
        .settings-container .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: none;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }
        
        .settings-container .header {
            flex-shrink: 0;
            border-radius: 0;
        }
        
        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 0;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .settings-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .settings-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
        }
        
        .save-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .reset-btn {
            background: #dc3545;
            color: white;
        }
        
        .reset-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .export-btn, .import-btn {
            background: #007bff;
            color: white;
        }
        
        .export-btn:hover, .import-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .setting-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .setting-section:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .setting-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            position: relative;
        }
        
        .setting-item:last-child {
            margin-bottom: 0;
        }
        
        .setting-item label {
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .setting-item input[type="text"],
        .setting-item input[type="url"],
        .setting-item input[type="number"],
        .setting-item select {
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .setting-item input[type="text"]:focus,
        .setting-item input[type="url"]:focus,
        .setting-item input[type="number"]:focus,
        .setting-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .setting-item input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e1e5e9;
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }
        
        .setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .setting-item input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }
        
        .setting-item input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .setting-description {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-weight: 500;
            color: #555;
        }
        
        .info-value {
            font-weight: 600;
            color: #333;
        }
        
        .setting-section p {
            margin: 0 0 15px 0;
            color: #666;
        }
        
        /* 日志界面样式 - 70%大小居中 */
        .logs-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 70%;
            height: 80vh;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .logs-container .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 12px;
            box-shadow: none;
            background: white;
        }
        
        .logs-container .header {
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .logs-content {
            flex: 1;
            padding: 20px;
            overflow: visible;
            min-height: 0;
        }
        
        .log-controls {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .log-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .log-controls select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .log-controls label {
            font-size: 14px;
            color: #333;
            margin-right: 8px;
        }
        
        .custom-time-range {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .custom-time-range div {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .custom-time-range input[type="datetime-local"] {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .refresh-btn {
            background: #007bff;
            color: white;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
        }
        
        .clear-btn {
            background: #dc3545;
            color: white;
        }
        
        .clear-btn:hover {
            background: #c82333;
        }
        
        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .log-viewer {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #d4d4d4;
            overflow-y: auto;
            height: 300px;
            border: 1px solid #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #569cd6;
            font-weight: bold;
        }
        
        .log-level {
            font-weight: bold;
            margin: 0 8px;
        }
        
        .log-level.INFO {
            color: #4ec9b0;
        }
        
        .log-level.WARN {
            color: #dcdcaa;
        }
        
        .log-level.ERROR {
            color: #f44747;
        }
        
        .log-level.DEBUG {
            color: #9cdcfe;
        }
        
        .log-message {
            color: #d4d4d4;
        }
        
        .log-stats {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .log-stats h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .stat-label {
            font-weight: 500;
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
        }
        
        .setting-item {
            margin: 15px 0;
        }
        
        .setting-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .setting-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .info-label {
            font-weight: 500;
            color: #666;
        }
        
        .info-value {
            font-weight: bold;
            color: #333;
        }
        
        #connectionStatus.connected {
            color: #28a745;
        }
        
        #connectionStatus.disconnected {
            color: #dc3545;
        }
        
        /* 深色模式样式 */
        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        body.dark-mode .sidebar {
            background: rgba(52, 73, 94, 0.95);
        }
        
        body.dark-mode .tab-button {
            color: #ecf0f1;
        }
        
        body.dark-mode .tab-button:hover {
            background: rgba(52, 152, 219, 0.2);
        }
        
        body.dark-mode .tab-button.active {
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }
        
        body.dark-mode .container:not(.chat-container .container):not(.settings-container .container) {
            background: #34495e;
            color: #ecf0f1;
        }
        
        body.dark-mode .chat-container .container,
        body.dark-mode .settings-container .container {
            background: #34495e;
            color: #ecf0f1;
        }
        
        /* 聊天界面在深色模式下保持白色背景 */
        body.dark-mode .chat-container,
        body.dark-mode .chat-container .container,
        body.dark-mode .chat-container .chat-messages,
        body.dark-mode .chat-container .input-container {
            background: white !important;
            color: #333 !important;
        }
        
        /* 聊天界面头部在深色模式下保持渐变 */
        body.dark-mode .chat-container .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        
        body.dark-mode .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        body.dark-mode .setting-section {
            background: #2c3e50;
            color: #ecf0f1;
        }
        
        body.dark-mode .info-item {
            background: #34495e;
        }
        
        body.dark-mode .info-label {
            color: #bdc3c7;
        }
        
        body.dark-mode .info-value {
            color: #ecf0f1;
        }
        
        /* 深色模式下的日志界面样式 - 保持白色背景 */
        body.dark-mode .logs-container,
        body.dark-mode .logs-container .container,
        body.dark-mode .logs-content {
            background: white !important;
            color: #333 !important;
        }
        
        /* 日志界面头部在深色模式下保持渐变 */
        body.dark-mode .logs-container .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        
        body.dark-mode .log-controls {
            background: white !important;
            color: #333 !important;
        }
        
        body.dark-mode .log-stats {
            background: white !important;
            color: #333 !important;
        }
        
        body.dark-mode .log-stats h4 {
            color: #333 !important;
        }
        
        body.dark-mode .stat-item {
            background: #f8f9fa !important;
        }
        
        body.dark-mode .stat-label {
            color: #666 !important;
        }
        
        body.dark-mode .stat-value {
            color: #333 !important;
        }
        
        body.dark-mode .log-controls select {
            background: white !important;
            border-color: #ddd !important;
            color: #333 !important;
        }
        
        body.dark-mode .log-controls label {
            color: #333 !important;
        }
        
        body.dark-mode .custom-time-range {
            background: white !important;
            color: #333 !important;
        }
        
        body.dark-mode .custom-time-range label {
            color: #333 !important;
        }
        
        body.dark-mode .custom-time-range input[type="datetime-local"] {
            background: white !important;
            border-color: #ddd !important;
            color: #333 !important;
        }
        
        /* 无动画模式 */
        body.no-animations * {
            transition: none !important;
            animation: none !important;
        }
        /* 默认容器样式（仅用于独立页面） */
        .container:not(.chat-container .container):not(.settings-container .container) {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .status {
            padding: 10px 20px;
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            margin: 0;
            transition: all 0.3s ease;
        }
        .status.disconnected {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .status.connecting {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .message.assistant {
            background: #f1f3f4;
            color: #333;
        }
        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            max-width: 100%;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            text-align: center;
            max-width: 100%;
        }
        .typing-indicator {
            background: #f1f3f4;
            color: #666;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }
        .typing-indicator .dots {
            animation: blink 1.4s infinite both;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        .message.assistant[data-streamable="true"] {
            position: relative;
        }
        .message.assistant[data-streamable="true"]:after {
            content: '|';
            animation: cursor-blink 1s infinite;
            color: #007bff;
        }
        .message.assistant.stream-complete:after {
            display: none;
        }
        /* 混合内容消息不显示光标 */
        .message.mixed-content:after {
            display: none !important;
        }
        /* 混合内容消息样式 */
        .message.mixed-content {
            background: #f1f3f4;
            color: #333;
            padding: 0;
        }
        
        /* 思考部分样式 - 灰色背景，灰白色字体 */
        .thinking-section {
            background: #6c757d;
            padding: 12px 15px;
            margin: 0;
            border-radius: 15px 15px 0 0;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #e9ecef;
            position: relative;
        }
        
        .thinking-section::before {
            content: '🧠 AI思考过程';
            display: block;
            font-weight: bold;
            color: #f8f9fa;
            margin-bottom: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
        }
        
        /* 普通内容部分样式 - 正常背景和字体 */
        .normal-section {
            background: #f1f3f4;
            padding: 12px 15px;
            margin: 0;
            border-radius: 0 0 15px 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            border-top: 1px solid #dee2e6;
        }
        
        /* 只有思考内容时的样式 */
        .thinking-only {
            border-radius: 15px;
        }
        
        /* 只有普通内容时的样式 */
        .normal-only {
            border-radius: 15px;
        }
        
        /* 思考部分markdown样式 - 适配灰色背景 */
        .thinking-section h1, .thinking-section h2, .thinking-section h3 {
            margin: 10px 0 5px 0;
            color: #f8f9fa;
            font-weight: bold;
        }
        
        .thinking-section h1 { font-size: 16px; }
        .thinking-section h2 { font-size: 15px; }
        .thinking-section h3 { font-size: 14px; }
        
        .thinking-section code {
            background: rgba(0, 0, 0, 0.2);
            color: #ffc107;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: inherit;
        }
        
        .thinking-section pre {
            background: rgba(0, 0, 0, 0.2);
            color: #e9ecef;
            padding: 8px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .thinking-section ul, .thinking-section ol {
            margin: 8px 0;
            padding-left: 20px;
            color: #e9ecef;
        }
        
        .thinking-section li {
            margin: 4px 0;
        }
        
        .thinking-section blockquote {
            border-left: 3px solid #17a2b8;
            padding-left: 10px;
            margin: 8px 0;
            font-style: italic;
            color: #ced4da;
        }
        
        .thinking-section p {
            margin: 8px 0;
            color: #e9ecef;
        }
        
        .thinking-section strong {
            color: #f8f9fa;
            font-weight: bold;
        }
        
        .thinking-section em {
            color: #ced4da;
            font-style: italic;
        }
        
        /* 保留原有的独立思考消息样式，用于兼容 */
        .message.thinking {
            background: #fff8dc;
            border-left: 4px solid #ffa500;
            font-style: italic;
            opacity: 0.8;
        }
        .message.thinking::before {
            content: '🧠 思考: ';
            font-weight: bold;
            color: #ff8c00;
        }
        @keyframes cursor-blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .input-container {
            padding: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }
        .send-btn {
            padding: 12px 25px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }
        .send-btn:hover {
            background: #0056b3;
        }
        .interrupt-btn {
            padding: 12px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            display: none; /* 默认隐藏 */
            transition: all 0.3s ease;
        }
        .interrupt-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        .interrupt-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .interrupt-btn.visible {
            display: block;
        }
        .interrupt-icon {
            font-size: 16px;
            margin-right: 5px;
        }
        .persona-selector {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .persona-selector select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        .thinking-toggle, .tts-toggle, .web-search-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .thinking-toggle label, .tts-toggle label, .web-search-toggle label {
            font-size: 14px;
            color: #666;
            margin: 0;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #007bff;
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch.active::before {
            transform: translateX(26px);
        }
        .ollama-status {
            padding: 5px 20px;
            background: #d1ecf1;
            border-bottom: 1px solid #bee5eb;
            font-size: 12px;
            color: #0c5460;
        }
        .ollama-status.unavailable {
            background: #f8d7da;
            border-bottom-color: #f5c6cb;
            color: #721c24;
        }
        
        /* ========== 多通道TTS样式 ========== */
        
        /* Live2D气泡样式 */
        .live2d-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 20px 20px 5px 20px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            max-width: 250px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease;
        }
        
        .live2d-bubble.waiting-for-audio {
            border-left: 4px solid #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }
        
        .live2d-bubble.playing-audio {
            border-left: 4px solid #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            box-shadow: 0 2px 12px rgba(76, 175, 80, 0.3);
            transform: scale(1.02);
        }
        
        .live2d-bubble.sentence-completed {
            border-left: 4px solid #2196f3;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            opacity: 0.8;
        }
        
        .live2d-bubble.audio-failed {
            border-left: 4px solid #f44336;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
        }
        
        .live2d-bubble::before {
            content: '';
            position: absolute;
            bottom: -5px;
            right: 15px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #764ba2;
        }
        
        .live2d-bubble.waiting-for-audio::before {
            border-top-color: #ffe0b2;
        }
        
        .live2d-bubble.playing-audio::before {
            border-top-color: #c8e6c9;
        }
        
        .live2d-bubble.sentence-completed::before {
            border-top-color: #bbdefb;
        }
        
        .live2d-bubble.audio-failed::before {
            border-top-color: #ffcdd2;
        }
        
        /* Live2D容器 */
        .live2d-container {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* 音频状态指示器 */
        .audio-waiting-indicator,
        .audio-playing-indicator {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .audio-waiting-indicator {
            color: #ff9800;
            animation: pulse 1.5s infinite;
        }
        
        .audio-playing-indicator {
            color: #4caf50;
            animation: pulse 1.5s infinite;
        }
        
        .audio-error-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.7;
            font-size: 16px;
        }
        
        /* TTS错误通知 */
        .tts-error-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffebee;
            color: #c62828;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0.9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease;
        }
        
        /* 全局音频指示器 */
        .global-audio-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .global-audio-indicator.active {
            opacity: 1;
            transform: scale(1);
        }
        
        .global-audio-indicator::before {
            content: '🔊';
            font-size: 18px;
            animation: pulse 1.5s infinite;
        }
        
        /* 多通道配置界面 */
        .output-channels-settings {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .channel-config {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            background: #fafafa;
        }
        
        .channel-config h4 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 16px;
        }
        
        .sub-options {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        .sub-options label {
            display: block;
            margin: 6px 0;
            font-size: 14px;
        }
        
        .preset-configs {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }
        
        .preset-configs button {
            margin: 4px;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .preset-configs button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        /* TTS模式显示 */
        .current-mode-display {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        /* 动画效果 */
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1); 
            }
            50% { 
                opacity: 0.6; 
                transform: scale(1.05); 
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 0.9;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        /* 聊天窗口TTS状态 */
        .message.assistant.tts-enabled {
            border-left: 3px solid #4caf50;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e9 100%);
        }
        
        .message.assistant.tts-playing {
            animation: pulse 2s infinite;
            border-left-color: #ff9800;
        }
        
        .message.assistant.tts-completed {
            border-left-color: #2196f3;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .live2d-container {
                right: 10px;
                width: 250px;
            }
            
            .live2d-bubble {
                max-width: 200px;
                font-size: 13px;
                padding: 10px 14px;
            }
            
            .tts-error-notification {
                right: 10px;
                font-size: 11px;
                padding: 6px 10px;
            }
            
            .preset-configs button {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-description {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        .cancel-btn,
        .create-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .create-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .create-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 深色模式下的弹窗样式 */
        body.dark-mode .modal-content {
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        body.dark-mode .form-group input[type="text"],
        body.dark-mode .form-group textarea {
            background-color: #34495e;
            border-color: #4a5f7a;
            color: #ecf0f1;
        }

        body.dark-mode .form-group input[type="text"]:focus,
        body.dark-mode .form-group textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        body.dark-mode .form-description {
            color: #bdc3c7;
        }

        body.dark-mode .form-actions {
            border-top-color: #4a5f7a;
        }

        /* 加载动画 */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 左侧Tab导航 -->
    <div class="sidebar">
        <button class="tab-button active" data-tab="chat" title="聊天">
            💬
        </button>
        <button class="tab-button" data-tab="settings" title="设置">
            ⚙️
        </button>
        <button class="tab-button" data-tab="logs" title="日志">
            📋
        </button>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content">
        <!-- 聊天Tab内容 -->
        <div class="tab-content active" id="chat-tab">
            <div class="chat-container">
    <div class="container">
        <div class="header">
            <h1>🤖 AI聊天机器人系统</h1>
            <p>基于Java21的智能对话系统 - 支持流式响应、多人设、长期记忆</p>
        </div>
        
        <div class="status" id="status">
            🔴 未连接
        </div>
        
        <div class="ollama-status" id="ollamaStatus">
            🤖 正在检查Ollama服务状态...
        </div>
        
        <div class="persona-selector">
            <div>
                <label>选择人设: </label>
                <select id="personaSelect">
                    <option value="default">智能助手</option>
                    <option value="advisor">专业顾问</option>
                    <option value="creative">创意助手</option>
                </select>
            </div>
            <div class="thinking-toggle">
                <label for="thinkingToggle">显示思考:</label>
                <div class="toggle-switch" id="thinkingToggle" title="切换是否显示AI的思考过程"></div>
            </div>
            <div class="tts-toggle">
                <label for="ttsToggle">开启TTS:</label>
                <div class="toggle-switch" id="ttsToggle" title="切换聊天窗口语音输出模式"></div>
            </div>
            <div class="web-search-toggle">
                <label for="webSearchToggle">联网搜索:</label>
                <div class="toggle-switch" id="webSearchToggle" title="切换是否启用联网搜索功能"></div>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="message system">欢迎使用AI聊天机器人系统！正在连接服务器...</div>
        </div>
        
        <div class="input-container">
            <input type="text" id="messageInput" class="message-input" 
                   placeholder="输入您的消息..." disabled>
            <button id="interruptBtn" class="interrupt-btn" title="停止AI回复">
                <span class="interrupt-icon">⏹</span>停止
            </button>
            <button id="sendBtn" class="send-btn" disabled>发送</button>
        </div>
    </div>
            </div>
        </div>

        <!-- 设置Tab内容 -->
        <div class="tab-content" id="settings-tab">
            <div class="settings-container">
                <div class="container">
                    <div class="header">
                        <h1>⚙️ 系统设置</h1>
                        <p>系统配置和个性化选项</p>
                    </div>
                    
                    <div class="settings-content">
                        <!-- 配置操作按钮 -->
                        <div class="settings-actions">
                            <button id="saveSettingsBtn" class="save-btn">💾 保存配置</button>
                            <button id="resetSettingsBtn" class="reset-btn">🔄 重置为默认</button>
                            <button id="exportSettingsBtn" class="export-btn">📤 导出配置</button>
                            <button id="importSettingsBtn" class="import-btn">📥 导入配置</button>
                            <input type="file" id="importFileInput" accept=".json" style="display: none;">
                        </div>
                        
                        <!-- 界面设置 -->
                        <div class="setting-section">
                            <h3>🎨 界面设置</h3>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="darkModeToggle"> 深色模式
                                </label>
                                <span class="setting-description">切换深色/浅色主题</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="animationsToggle" checked> 启用动画效果
                                </label>
                                <span class="setting-description">启用界面动画和过渡效果</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="autoScrollToggle" checked> 自动滚动到底部
                                </label>
                                <span class="setting-description">新消息时自动滚动到底部</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="soundNotificationToggle"> 消息提示音
                                </label>
                                <span class="setting-description">收到新消息时播放提示音</span>
                            </div>
                            <div class="setting-item">
                                <label for="languageSelect">界面语言:</label>
                                <select id="languageSelect">
                                    <option value="zh-CN">简体中文</option>
                                    <option value="zh-TW">繁體中文</option>
                                    <option value="en-US">English</option>
                                    <option value="ja-JP">日本語</option>
                                </select>
                                <span class="setting-description">选择界面显示语言</span>
                            </div>
                        </div>
                        
                        <!-- Ollama设置 -->
                        <div class="setting-section">
                            <h3>🤖 Ollama设置</h3>
                            <div class="setting-item">
                                <label for="ollamaUrlInput">Ollama服务地址:</label>
                                <input type="url" id="ollamaUrlInput" placeholder="http://localhost:11434" value="http://localhost:11434">
                                <span class="setting-description">Ollama服务的访问地址</span>
                            </div>
                            <div class="setting-item">
                                <label for="ollamaModelInput">使用模型:</label>
                                <input type="text" id="ollamaModelInput" placeholder="qwen3:4b" value="qwen3:4b">
                                <span class="setting-description">指定使用的AI模型名称</span>
                            </div>
                            <div class="setting-item">
                                <label for="ollamaTimeoutInput">连接超时 (毫秒):</label>
                                <input type="number" id="ollamaTimeoutInput" min="5000" max="120000" step="1000" value="30000">
                                <span class="setting-description">Ollama服务连接超时时间</span>
                            </div>
                            <div class="setting-item">
                                <label for="ollamaMaxTokensInput">最大输出长度:</label>
                                <input type="number" id="ollamaMaxTokensInput" min="512" max="8192" step="256" value="4096">
                                <span class="setting-description">单次回复的最大长度限制</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="ollamaStreamToggle" checked> 启用流式输出
                                </label>
                                <span class="setting-description">实时显示AI回复过程</span>
                            </div>
                        </div>
                        
                        <!-- 联网搜索设置 -->
                        <div class="setting-section">
                            <h3>🌐 联网搜索设置</h3>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="webSearchEnabledToggle"> 启用联网搜索
                                </label>
                                <span class="setting-description">全局启用/禁用联网搜索功能</span>
                            </div>
                            <div class="setting-item">
                                <label for="webSearchEngineSelect">搜索引擎:</label>
                                <select id="webSearchEngineSelect">
                                    <option value="duckduckgo">DuckDuckGo</option>
                                    <option value="google">Google</option>
                                    <option value="bing">Bing</option>
                                </select>
                                <span class="setting-description">选择默认搜索引擎</span>
                            </div>
                            <div class="setting-item">
                                <label for="webSearchMaxResultsInput">最大搜索结果数:</label>
                                <input type="number" id="webSearchMaxResultsInput" min="1" max="20" value="5">
                                <span class="setting-description">每次搜索返回的最大结果数量</span>
                            </div>
                            <div class="setting-item">
                                <label for="webSearchTimeoutInput">搜索超时 (秒):</label>
                                <input type="number" id="webSearchTimeoutInput" min="5" max="60" value="10">
                                <span class="setting-description">搜索请求的超时时间</span>
                            </div>
                        </div>
                        
                        <!-- TTS语音设置 -->
                        <div class="setting-section">
                            <h3>🔊 TTS语音设置</h3>
                            <div class="setting-item">
                                <label>当前TTS模式:</label>
                                <span id="currentTTSMode" class="current-mode-display">模式1 - 纯文本</span>
                                <span class="setting-description">当前激活的语音输出模式（通过聊天窗口切换）</span>
                            </div>
                            <div class="setting-item">
                                <label for="cosyVoiceSpeakerSelect">语音人设:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <select id="cosyVoiceSpeakerSelect" style="flex: 1;">
                                        <option value="">请选择语音人设...</option>
                                    </select>
                                    <button id="refreshSpeakersBtn" type="button">刷新</button>
                                    <button id="addCustomSpeakerBtn" type="button">新增语音人设</button>
                                </div>
                                <span class="setting-description">选择CosyVoice TTS服务的语音人设</span>
                            </div>
                            <div class="setting-item">
                                <label for="testVoiceText">测试人设语音:</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" id="testVoiceText" placeholder="请输入要测试的文本..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button id="generateVoiceBtn" type="button">生成语音</button>
                                </div>
                                <div id="voiceTestResult" style="margin-top: 10px; min-height: 40px;">
                                    <!-- 音频播放器将在这里显示 -->
                                </div>
                                <span class="setting-description">输入文本测试当前选中的语音人设效果</span>
                            </div>
                            <div class="setting-item">
                                <label for="ttsSpeedRange">语音速度:</label>
                                <input type="range" id="ttsSpeedRange" min="0.5" max="2.0" step="0.1" value="1.0">
                                <span id="ttsSpeedValue">1.0x</span>
                                <span class="setting-description">调整语音播放速度</span>
                            </div>
                        </div>
                        
                        
                        <!-- 系统信息 -->
                        <div class="setting-section">
                            <h3>🔧 系统信息</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">版本:</span>
                                    <span class="info-value">v1.0.0</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">连接状态:</span>
                                    <span class="info-value" id="connectionStatus">未连接</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">配置状态:</span>
                                    <span class="info-value" id="configStatus">未加载</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">最后保存:</span>
                                    <span class="info-value" id="lastSavedTime">从未保存</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日志Tab内容 -->
        <div class="tab-content" id="logs-tab">
            <div class="logs-container">
                <div class="container">
                    <div class="header">
                        <h1>📋 系统日志</h1>
                        <p>实时查看系统运行日志和状态信息</p>
                    </div>
                    
                    <div class="logs-content">
                        <div class="log-controls">
                            <div>
                                <button id="refreshLogsBtn" class="refresh-btn">🔄 刷新日志</button>
                                <button id="clearLogsBtn" class="clear-btn">🗑️ 清空显示</button>
                            </div>
                            <div>
                                <label for="logLevelSelect">日志级别:</label>
                                <select id="logLevelSelect">
                                    <option value="ALL">全部</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="WARN">WARN</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="TRACE">TRACE</option>
                                </select>
                            </div>
                            <div>
                                <label for="timeRangeSelect">时间范围:</label>
                                <select id="timeRangeSelect">
                                    <option value="30m" selected>最近30分钟</option>
                                    <option value="1h">最近1小时</option>
                                    <option value="3h">最近3小时</option>
                                    <option value="12h">最近半天</option>
                                    <option value="1d">最近1天</option>
                                    <option value="custom">自定义时间段</option>
                                    <option value="all">全部时间</option>
                                </select>
                            </div>
                            <div class="auto-refresh-toggle">
                                <label for="autoRefreshToggle">自动刷新:</label>
                                <div class="toggle-switch active" id="autoRefreshToggle" title="切换是否自动刷新日志"></div>
                                <select id="refreshIntervalSelect">
                                    <option value="5">5秒</option>
                                    <option value="10" selected>10秒</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="custom-time-range" id="customTimeRange" style="display: none;">
                            <div>
                                <label for="startTimeInput">开始时间:</label>
                                <input type="datetime-local" id="startTimeInput">
                            </div>
                            <div>
                                <label for="endTimeInput">结束时间:</label>
                                <input type="datetime-local" id="endTimeInput">
                            </div>
                            <button id="applyCustomTimeBtn" class="refresh-btn">应用时间段</button>
                        </div>
                        
                        <div class="log-viewer" id="logViewer">
                            <div class="log-entry">
                                <span class="log-message">正在加载日志...</span>
                            </div>
                        </div>
                        
                        <div class="log-stats">
                            <h4>📊 日志统计</h4>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">总条数:</span>
                                    <span class="stat-value" id="totalLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">错误:</span>
                                    <span class="stat-value" id="errorLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">警告:</span>
                                    <span class="stat-value" id="warnLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">信息:</span>
                                    <span class="stat-value" id="infoLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">最后更新:</span>
                                    <span class="stat-value" id="lastUpdate">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentSessionId = null;
        let isConnected = false;
        let currentAssistantMessage = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let showThinking = true; // 思考显示状态
        let useWebSearch = false; // 联网搜索状态
        let isAIResponding = false; // AI是否正在回复
        let currentStreamingMessage = null; // 当前流式消息元素
        let aiResponseTimeout = null; // AI响应超时定时器
        let timeoutMessageShown = false; // 防止重复显示超时消息的标志
        let lastAIActivityTime = null; // 最后一次AI活动时间
        let activityCheckInterval = null; // 活动检测定时器
        
        // TTS相关变量
        let currentTTSMode = 'text_only'; // 当前TTS模式
        let ttsSettings = {
            chatEnabled: false,
            chatMode: 'text_only',
            speed: 1.0,
            spk_id: null // CosyVoice语音人设ID
        };
        
        // 日志相关变量
        let autoRefreshLogs = true; // 自动刷新日志状态 - 默认开启
        let logRefreshInterval = null; // 日志刷新定时器
        let refreshIntervalSeconds = 10; // 默认刷新间隔10秒
        let isLogsTabActive = false; // 日志tab是否激活
        let logStats = {
            total: 0,
            error: 0,
            warn: 0,
            info: 0,
            debug: 0
        };

        const statusDiv = document.getElementById('status');
        const ollamaStatusDiv = document.getElementById('ollamaStatus');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const interruptBtn = document.getElementById('interruptBtn');
        const personaSelect = document.getElementById('personaSelect');
        const thinkingToggle = document.getElementById('thinkingToggle');
        const ttsToggle = document.getElementById('ttsToggle');
        const webSearchToggle = document.getElementById('webSearchToggle');
        
        // 日志相关DOM元素
        const logViewer = document.getElementById('logViewer');
        const refreshLogsBtn = document.getElementById('refreshLogsBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        const logLevelSelect = document.getElementById('logLevelSelect');
        const refreshIntervalSelect = document.getElementById('refreshIntervalSelect');
        const timeRangeSelect = document.getElementById('timeRangeSelect');
        const customTimeRange = document.getElementById('customTimeRange');
        const startTimeInput = document.getElementById('startTimeInput');
        const endTimeInput = document.getElementById('endTimeInput');
        const applyCustomTimeBtn = document.getElementById('applyCustomTimeBtn');
        const totalLogsSpan = document.getElementById('totalLogs');
        const errorLogsSpan = document.getElementById('errorLogs');
        const warnLogsSpan = document.getElementById('warnLogs');
        const infoLogsSpan = document.getElementById('infoLogs');
        const lastUpdateSpan = document.getElementById('lastUpdate');

        // 连接WebSocket
        function connect() {
            if (reconnectAttempts === 0) {
                updateStatus('connecting', '🟡 正在连接...');
            }
            
            const wsUrl = `ws://${window.location.host}/ws/chat`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                isConnected = true;
                reconnectAttempts = 0;
                updateStatus('connected', '🟢 已连接');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                
                addMessage('system', '连接成功！您可以开始对话了。');
                checkOllamaStatus();
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleIncomingMessage(message);
                } catch (e) {
                    console.error('解析消息失败:', e);
                }
            };

            ws.onclose = function() {
                isConnected = false;
                updateStatus('disconnected', '🔴 连接断开');
                messageInput.disabled = true;
                sendBtn.disabled = true;
                
                // 重置AI响应状态（连接断开时）
                console.log('🔌 WebSocket连接断开 - 重置AI状态');
                isAIResponding = false;
                hideInterruptButton();
                enableChatControls();
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    addMessage('system', `连接已断开，正在尝试重连... (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
                    reconnectAttempts++;
                    setTimeout(connect, 3000);
                } else {
                    addMessage('system', '连接失败，请检查服务器状态后刷新页面重试。');
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket错误:', error);
                addMessage('system', '连接出现错误，请检查服务器状态。');
                
                // 重置AI响应状态（连接错误时）
                console.log('❌ WebSocket连接错误 - 重置AI状态');
                isAIResponding = false;
                hideInterruptButton();
                enableChatControls();
            };
        }

        // 更新连接状态
        function updateStatus(type, text) {
            statusDiv.innerHTML = text;
            statusDiv.className = 'status';
            if (type === 'disconnected') {
                statusDiv.classList.add('disconnected');
            } else if (type === 'connecting') {
                statusDiv.classList.add('connecting');
            }
        }

        // 检查Ollama服务状态
        function checkOllamaStatus() {
            // 发送一个检查服务状态的消息
            if (ws && isConnected) {
                const checkMessage = {
                    type: 'system',
                    content: 'check_ollama_status',
                    metadata: { action: 'check_service' }
                };
                ws.send(JSON.stringify(checkMessage));
            }
        }

        // 多通道消息路由器
        class MultiChannelRouter {
            constructor() {
                this.channels = new Map();
                this.registerChannels();
            }
            
            registerChannels() {
                this.channels.set('chat_window', new ChatWindowHandler());
                this.channels.set('live2d', new Live2DHandler());
            }
            
            routeMessage(message) {
                const channelType = message.channelType || 'chat_window';
                const handler = this.channels.get(channelType);
                
                if (handler) {
                    handler.handleMessage(message);
                } else {
                    console.warn('未知的通道类型:', channelType, message);
                    // 抛出异常让外层处理
                    throw new Error(`未知的通道类型: ${channelType}`);
                }
            }
            
            // 兼容旧版本消息处理
            handleLegacyMessage(message) {
                const chatHandler = this.channels.get('chat_window');
                if (chatHandler) {
                    chatHandler.handleMessage(message);
                }
            }
            
            getChannel(channelType) {
                return this.channels.get(channelType);
            }
        }
        
        // 聊天窗口处理器
        class ChatWindowHandler {
            constructor() {
                this.audioManager = new CharStreamAudioManager();
                this.currentAssistantMessage = null;
            }
            
            handleMessage(message) {
                console.log('🏠 聊天窗口处理消息:', message);
                
                switch(message.type) {
                    case 'text':
                        this.handleTextMessage(message);
                        break;
                    case 'audio':
                        this.handleAudioMessage(message);
                        break;
                    case 'tts_error':
                        this.handleTTSError(message);
                        break;
                    default:
                        console.log('聊天窗口未处理的消息类型:', message.type);
                }
            }
            
            handleTextMessage(message) {
                removeTypingIndicator();
                
                // 如果是思考内容，使用传统的流式消息处理（不触发TTS）
                if (message.thinking) {
                    console.log('🧠 处理思考内容，跳过TTS:', message);
                    if (message.streaming) {
                        if (!isAIResponding) {
                            console.log('🚀 开始AI回复 (思考流式消息)');
                            isAIResponding = true;
                            showInterruptButton();
                            disableChatControls();
                            setAIResponseTimeout();
                        }
                        handleStreamingMessage(message);
                    } else {
                        recordAIActivity(); // 记录最后一次活动
                        addMessage('assistant', message.content);
                        // 重置AI响应状态（思考消息完成）
                        console.log('✅ AI回复结束 (思考非流式消息)');
                        isAIResponding = false;
                        clearAIResponseTimeout();
                        hideInterruptButton();
                        enableSendButton();
                        enableChatControls();
                    }
                    return;
                }
                
                if (message.ttsMode === 'char_stream') {
                    // 模式2：字符流+TTS
                    if (!isAIResponding) {
                        console.log('🚀 开始AI回复 (字符流模式)');
                        isAIResponding = true;
                        showInterruptButton();
                        disableChatControls();
                        setAIResponseTimeout();
                    }
                    this.handleCharStreamText(message);
                } else if (message.streaming) {
                    // 传统流式消息
                    if (!isAIResponding) {
                        console.log('🚀 开始AI回复 (传统流式消息)');
                        isAIResponding = true;
                        showInterruptButton();
                        disableChatControls();
                        setAIResponseTimeout();
                    }
                    handleStreamingMessage(message);
                } else {
                    // 普通文本消息 - 需要重置AI状态
                    recordAIActivity(); // 记录最后一次活动
                    addMessage('assistant', message.content);
                    // 重置AI响应状态
                    console.log('✅ AI回复结束 (普通文本消息)');
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableSendButton();
                    enableChatControls();
                }
            }
            
            handleCharStreamText(message) {
                // 记录AI活动
                recordAIActivity();
                
                // 为每个新的AI回复创建新的消息气泡
                if (!this.currentAssistantMessage || message.sentenceOrder === 0) {
                    this.currentAssistantMessage = this.createMessage('assistant');
                    console.log('🆕 创建新的助手消息气泡');
                }
                
                // 立即显示文本
                this.appendText(this.currentAssistantMessage, message.content);
                
                if (message.streamComplete) {
                    this.currentAssistantMessage = null;
                    enableSendButton();
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableChatControls();
                    console.log('✅ 字符流模式完成，重置状态');
                }
            }
            
            handleAudioMessage(message) {
                if (message.ttsMode === 'char_stream') {
                    // 模式2：异步音频播放
                    this.audioManager.addAudio(
                        message.audioData, 
                        message.sentenceId || this.generateId(), 
                        message.content
                    );
                }
            }
            
            handleTTSError(message) {
                console.warn('TTS错误:', message.content);
                // 可以显示一个小的错误提示
                this.showTTSError(message.content);
            }
            
            createMessage(sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                chatContainer.appendChild(messageDiv);
                scrollToBottom();
                return messageDiv;
            }
            
            appendText(element, text) {
                element.textContent += text;
                scrollToBottom();
            }
            
            showTTSError(errorText) {
                // 显示一个临时的错误提示
                const errorDiv = document.createElement('div');
                errorDiv.className = 'tts-error-notification';
                errorDiv.textContent = '🔇 ' + errorText;
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #ffebee;
                    color: #c62828;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    opacity: 0.9;
                `;
                
                document.body.appendChild(errorDiv);
                
                // 3秒后自动移除
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 3000);
            }
            
            generateId() {
                return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
        }
        
        // Live2D处理器
        class Live2DHandler {
            constructor() {
                this.sentenceSyncManager = new StrictSentenceSyncManager();
                this.live2dController = null; // 将来连接Live2D
            }
            
            handleMessage(message) {
                console.log('🎨 Live2D处理消息:', message);
                
                switch(message.type) {
                    case 'live2d_sentence_display':
                        this.sentenceSyncManager.handleSentenceDisplay(message);
                        this.showLive2DBubble(message);
                        break;
                    case 'live2d_sentence_audio':
                        this.sentenceSyncManager.handleSentenceAudio(message);
                        break;
                    case 'live2d_audio_failed':
                        this.sentenceSyncManager.handleAudioFailed(message);
                        break;
                    case 'live2d_all_complete':
                        this.handleAllComplete(message);
                        break;
                    default:
                        console.log('Live2D未处理的消息类型:', message.type);
                }
            }
            
            showLive2DBubble(message) {
                // 显示Live2D气泡
                if (this.live2dController) {
                    this.live2dController.showBubble(message.content, message.sentenceId);
                } else {
                    // 降级显示：在页面上显示Live2D气泡
                    this.showFallbackBubble(message.content, message.sentenceId);
                }
            }
            
            showFallbackBubble(text, sentenceId) {
                // 在页面右侧显示Live2D风格的气泡
                const bubble = document.createElement('div');
                bubble.className = 'live2d-bubble';
                bubble.dataset.sentenceId = sentenceId;
                bubble.textContent = text;
                
                const live2dContainer = document.querySelector('.live2d-container') || 
                                       this.createLive2DContainer();
                live2dContainer.appendChild(bubble);
                
                // 添加动画
                bubble.style.opacity = '0';
                bubble.style.transform = 'scale(0.8) translateY(20px)';
                
                requestAnimationFrame(() => {
                    bubble.style.transition = 'all 0.3s ease';
                    bubble.style.opacity = '1';
                    bubble.style.transform = 'scale(1) translateY(0)';
                });
            }
            
            createLive2DContainer() {
                const container = document.createElement('div');
                container.className = 'live2d-container';
                container.style.cssText = `
                    position: fixed;
                    right: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 300px;
                    z-index: 1000;
                    pointer-events: none;
                `;
                document.body.appendChild(container);
                return container;
            }
            
            handleAllComplete(message) {
                console.log('✅ Live2D所有句子处理完成 - 重置AI状态');
                // 重置AI响应状态
                isAIResponding = false;
                clearAIResponseTimeout();
                hideInterruptButton();
                enableSendButton();
                enableChatControls();
            }
        }
        
        // 字符流音频管理器
        class CharStreamAudioManager {
            constructor() {
                this.audioQueue = [];
                this.isPlaying = false;
                this.currentAudio = null;
            }
            
            addAudio(audioData, sentenceId, text) {
                if (!audioData) {
                    console.warn('音频数据为空，跳过播放');
                    return;
                }
                
                try {
                    // 将Base64音频数据转换为Blob
                    const binaryString = atob(audioData);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    const audioBlob = new Blob([bytes], {type: 'audio/mp3'});
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    const audioItem = {
                        id: sentenceId,
                        text: text,
                        audio: new Audio(audioUrl),
                        timestamp: Date.now()
                    };
                    
                    this.audioQueue.push(audioItem);
                    
                    // 如果当前没有播放，立即开始播放
                    if (!this.isPlaying) {
                        this.playNext();
                    }
                } catch (error) {
                    console.error('处理音频数据失败:', error);
                }
            }
            
            async playNext() {
                if (this.audioQueue.length === 0) {
                    this.isPlaying = false;
                    return;
                }
                
                this.isPlaying = true;
                const audioItem = this.audioQueue.shift();
                this.currentAudio = audioItem.audio;
                
                try {
                    await this.playAudio(audioItem.audio);
                } catch (error) {
                    console.error('音频播放失败:', error);
                } finally {
                    // 播放下一个
                    setTimeout(() => this.playNext(), 100); // 句子间100ms间隔
                }
            }
            
            playAudio(audio) {
                return new Promise((resolve, reject) => {
                    audio.onended = resolve;
                    audio.onerror = reject;
                    audio.play().catch(reject);
                });
            }
            
            skipCurrent() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.playNext();
                }
            }
            
            clearQueue() {
                this.audioQueue = [];
                if (this.currentAudio) {
                    this.currentAudio.pause();
                }
                this.isPlaying = false;
            }
        }
        
        // 严格句子同步管理器
        class StrictSentenceSyncManager {
            constructor() {
                this.currentSentence = null;
                this.isWaitingForAudio = false;
                this.isPlayingAudio = false;
            }
            
            handleSentenceDisplay(message) {
                // 只有在没有当前句子时才显示新句子
                if (this.currentSentence === null) {
                    this.displaySentence(message);
                } else {
                    console.error('收到新句子但当前句子未完成:', message);
                }
            }
            
            handleSentenceAudio(message) {
                if (this.currentSentence && 
                    this.currentSentence.sentenceId === message.sentenceId) {
                    
                    if (message.audioData) {
                        this.playAudio(message.audioData);
                    } else {
                        // TTS失败，跳过音频直接完成
                        this.completeSentence();
                    }
                }
            }
            
            handleAudioFailed(message) {
                if (this.currentSentence && 
                    this.currentSentence.sentenceId === message.sentenceId) {
                    
                    this.markAudioFailed();
                    this.completeSentence();
                }
            }
            
            displaySentence(message) {
                // 创建句子气泡
                const bubble = this.createSentenceBubble(message.content, message.sentenceId);
                
                this.currentSentence = {
                    sentenceId: message.sentenceId,
                    order: message.sentenceOrder,
                    text: message.content,
                    element: bubble,
                    audio: null
                };
                
                this.isWaitingForAudio = true;
                
                // 显示等待音频的状态
                bubble.classList.add('waiting-for-audio');
                this.showWaitingIndicator(bubble);
            }
            
            async playAudio(audioData) {
                if (!this.currentSentence) return;
                
                this.isWaitingForAudio = false;
                this.isPlayingAudio = true;
                
                try {
                    // 将Base64音频数据转换为Audio对象
                    const binaryString = atob(audioData);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    const audioBlob = new Blob([bytes], {type: 'audio/mp3'});
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    this.currentSentence.audio = audio;
                    this.currentSentence.element.classList.remove('waiting-for-audio');
                    this.currentSentence.element.classList.add('playing-audio');
                    
                    this.hideWaitingIndicator();
                    this.showPlayingIndicator(this.currentSentence.element);
                    
                    await this.playAudioWithPromise(audio);
                    this.completeSentence();
                } catch (error) {
                    console.error('音频播放失败:', error);
                    this.markAudioFailed();
                    this.completeSentence();
                }
            }
            
            playAudioWithPromise(audio) {
                return new Promise((resolve, reject) => {
                    audio.onended = resolve;
                    audio.onerror = reject;
                    audio.play().catch(reject);
                });
            }
            
            completeSentence() {
                if (!this.currentSentence) return;
                
                this.isWaitingForAudio = false;
                this.isPlayingAudio = false;
                
                // 标记句子完成
                this.currentSentence.element.classList.remove('waiting-for-audio', 'playing-audio');
                this.currentSentence.element.classList.add('sentence-completed');
                
                this.hideAllIndicators();
                
                // 通知后端音频播放完成，可以发送下一句
                this.notifyAudioCompleted(this.currentSentence.sentenceId);
                
                // 清空当前句子
                this.currentSentence = null;
            }
            
            notifyAudioCompleted(sentenceId) {
                const completionMessage = {
                    type: 'audio_playback_completed',
                    sentenceId: sentenceId,
                    timestamp: Date.now()
                };
                
                // 通过WebSocket发送给后端
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(completionMessage));
                    console.log('通知后端音频播放完成:', sentenceId);
                }
            }
            
            createSentenceBubble(text, sentenceId) {
                const bubble = document.createElement('div');
                bubble.className = 'live2d-bubble';
                bubble.dataset.sentenceId = sentenceId;
                bubble.textContent = text;
                
                // 添加到Live2D容器
                const container = document.querySelector('.live2d-container') || 
                                 this.createLive2DContainer();
                container.appendChild(bubble);
                
                // 添加出现动画
                bubble.style.opacity = '0';
                bubble.style.transform = 'translateY(20px)';
                bubble.style.transition = 'all 0.4s ease';
                
                requestAnimationFrame(() => {
                    bubble.style.opacity = '1';
                    bubble.style.transform = 'translateY(0)';
                });
                
                return bubble;
            }
            
            createLive2DContainer() {
                const container = document.createElement('div');
                container.className = 'live2d-container';
                container.style.cssText = `
                    position: fixed;
                    right: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 300px;
                    z-index: 1000;
                `;
                document.body.appendChild(container);
                return container;
            }
            
            showWaitingIndicator(bubble) {
                const indicator = document.createElement('div');
                indicator.className = 'audio-waiting-indicator';
                indicator.innerHTML = '⏳ 正在生成语音...';
                bubble.appendChild(indicator);
            }
            
            hideWaitingIndicator() {
                if (this.currentSentence) {
                    const indicator = this.currentSentence.element.querySelector('.audio-waiting-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            }
            
            showPlayingIndicator(bubble) {
                const indicator = document.createElement('div');
                indicator.className = 'audio-playing-indicator';
                indicator.innerHTML = '🔊 正在播放...';
                bubble.appendChild(indicator);
            }
            
            hideAllIndicators() {
                if (this.currentSentence) {
                    const indicators = this.currentSentence.element.querySelectorAll('.audio-waiting-indicator, .audio-playing-indicator');
                    indicators.forEach(indicator => indicator.remove());
                }
            }
            
            markAudioFailed() {
                if (this.currentSentence) {
                    this.currentSentence.element.classList.add('audio-failed');
                    const errorIcon = document.createElement('span');
                    errorIcon.className = 'audio-error-icon';
                    errorIcon.textContent = '🔇';
                    errorIcon.title = '语音生成失败';
                    this.currentSentence.element.appendChild(errorIcon);
                }
            }
            
            skipCurrentSentence() {
                if (this.currentSentence) {
                    if (this.currentSentence.audio) {
                        this.currentSentence.audio.pause();
                    }
                    this.completeSentence();
                }
            }
        }

        // 创建全局多通道路由器实例
        const multiChannelRouter = new MultiChannelRouter();

        // 处理收到的消息 - 多通道版本
        function handleIncomingMessage(message) {
            // 系统消息特殊处理
            if (message.type === 'system') {
                if (!currentSessionId) {
                    currentSessionId = message.sessionId;
                }
                
                // 检查是否是Ollama状态更新
                if (message.metadata && message.metadata.ollama_status) {
                    updateOllamaStatus(message.metadata.ollama_status === 'available');
                } else if (message.metadata && message.metadata.thinking_toggle) {
                    // 处理思考切换确认
                    handleThinkingToggleConfirmation(message);
                } else if (message.metadata && message.metadata.web_search_toggle) {
                    // 处理联网搜索切换确认
                    handleWebSearchToggleConfirmation(message);
                } else if (message.metadata && message.metadata.interrupt_confirmed) {
                    // 处理打断确认
                    handleInterruptConfirmation(message);
                } else {
                    addMessage('system', message.content);
                }
                return;
            }
            
            // 错误消息特殊处理
            if (message.type === 'error') {
                removeTypingIndicator();
                addMessage('error', '❌ ' + message.content);
                // 重置AI响应状态
                isAIResponding = false;
                hideInterruptButton();
                enableSendButton();
                enableChatControls();
                return;
            }
            
            // 使用多通道路由器处理其他消息
            try {
                multiChannelRouter.routeMessage(message);
            } catch (error) {
                console.error('多通道消息路由失败:', error, message);
                // 降级到传统处理方式
                handleLegacyMessage(message);
            }
        }
        
        // 传统消息处理（降级方案）
        function handleLegacyMessage(message) {
            if (message.type === 'text') {
                removeTypingIndicator();
                if (message.streaming) {
                    // 流式消息处理
                    if (!isAIResponding) {
                        isAIResponding = true;
                        showInterruptButton();
                        disableChatControls();
                        setAIResponseTimeout();
                    }
                    handleStreamingMessage(message);
                } else {
                    recordAIActivity(); // 记录最后一次活动
                    addMessage('assistant', message.content);
                    // 重置AI响应状态（非流式消息完成）
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableSendButton();
                    enableChatControls();
                }
            }
        }
        
        // 处理流式消息
        function handleStreamingMessage(message) {
            console.log('🔄 处理流式消息:', message);
            console.log('🔧 当前思考显示状态:', showThinking);
            console.log('🔧 当前AI响应状态:', isAIResponding);
            console.log('🔍 消息详细信息:', {
                hasContent: !!message.content,
                contentLength: message.content ? message.content.length : 0,
                streaming: message.streaming,
                streamComplete: message.streamComplete,
                thinking: message.thinking,
                type: message.type
            });
            
            // 首先处理有内容的消息
            if (message.content) {
                // 记录AI活动
                recordAIActivity();
                
                console.log('📝 收到内容:', {
                    content: message.content,
                    thinking: message.thinking,
                    hasCurrentMessage: !!currentAssistantMessage,
                    isMixedContent: currentAssistantMessage?.classList.contains('mixed-content')
                });
                
                // 确保有一个混合内容消息来接收内容
                // 重要：每次新的对话都应该创建新的消息气泡
                if (!currentAssistantMessage || !currentAssistantMessage.classList.contains('mixed-content')) {
                    console.log('🆕 创建新的混合内容消息');
                    currentAssistantMessage = addMixedContentMessage('', '');
                }
                
                // 有内容的流式消息
                if (message.thinking) {
                    console.log('🧠 处理思考内容:', message.content);
                    appendToMixedContentMessage(message.content, '', true);
                } else {
                    console.log('💬 处理普通内容:', message.content);
                    appendToMixedContentMessage('', message.content, false);
                }
                
                // 如果流式消息完成，标记完成状态
                if (message.streamComplete && currentAssistantMessage) {
                    console.log('✅ 单个消息流完成 - 重置AI状态');
                    currentAssistantMessage.dataset.streamable = 'false';
                    currentAssistantMessage.classList.add('stream-complete');
                    currentAssistantMessage = null;
                    enableSendButton();
                    // 隐藏打断按钮
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableChatControls();
                }
            } else if (message.streamComplete) {
                // 处理无内容的完成信号
                console.log('✅ 收到无内容的流式完成信号 - 重置AI状态');
                if (currentAssistantMessage) {
                    currentAssistantMessage.dataset.streamable = 'false';
                    currentAssistantMessage.classList.add('stream-complete');
                    currentAssistantMessage = null;
                }
                // 重新启用发送按钮
                enableSendButton();
                // 隐藏打断按钮
                isAIResponding = false;
                clearAIResponseTimeout();
                hideInterruptButton();
                enableChatControls();
            }
        }

        // 更新Ollama状态
        function updateOllamaStatus(available) {
            if (available) {
                ollamaStatusDiv.innerHTML = '🟢 Ollama服务正常 - 使用本地AI模型';
                ollamaStatusDiv.className = 'ollama-status';
            } else {
                ollamaStatusDiv.innerHTML = '🟡 Ollama服务不可用 - 使用Mock响应';
                ollamaStatusDiv.className = 'ollama-status unavailable';
            }
        }

        // 添加消息到聊天容器
        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = content;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 如果是助手消息且支持流式，标记为可追加
            if (sender === 'assistant') {
                messageDiv.dataset.streamable = 'true';
                currentAssistantMessage = messageDiv;
            }
        }
        
        // 添加混合内容消息到聊天容器
        function addMixedContentMessage(thinkingContent = '', normalContent = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant mixed-content';
            messageDiv.dataset.streamable = 'true';
            messageDiv.dataset.hasThinking = thinkingContent ? 'true' : 'false';
            messageDiv.dataset.hasNormal = normalContent ? 'true' : 'false';
            messageDiv.dataset.thinkingContent = thinkingContent;
            messageDiv.dataset.normalContent = normalContent;
            
            updateMixedContentMessage(messageDiv, thinkingContent, normalContent);
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            
            currentAssistantMessage = messageDiv;
            return messageDiv;
        }
        
        // 更新混合内容消息
        function updateMixedContentMessage(messageDiv, thinkingContent, normalContent) {
            console.log('🔄 更新混合内容消息:', {
                thinkingLength: thinkingContent?.length || 0,
                normalLength: normalContent?.length || 0,
                thinkingPreview: thinkingContent?.substring(0, 50) + '...',
                normalPreview: normalContent?.substring(0, 50) + '...'
            });
            
            let html = '';
            
            // 处理思考内容
            if (thinkingContent && thinkingContent.trim()) {
                // 移除<think>和</think>标签
                let cleanThinking = thinkingContent.replace(/<\/?think>/g, '').trim();
                console.log('🧠 清理后的思考内容:', cleanThinking.substring(0, 100) + '...');
                
                if (cleanThinking) {
                    // 使用marked解析markdown
                    let thinkingHtml = '';
                    try {
                        thinkingHtml = marked.parse(cleanThinking);
                        console.log('✅ Markdown解析成功');
                    } catch (e) {
                        console.warn('⚠️ Markdown解析失败，使用原始文本:', e);
                        // 如果markdown解析失败，使用原始文本
                        thinkingHtml = cleanThinking.replace(/\n/g, '<br>');
                    }
                    
                    const sectionClass = normalContent && normalContent.trim() ? 'thinking-section' : 'thinking-section thinking-only';
                    html += `<div class="${sectionClass}">${thinkingHtml}</div>`;
                    messageDiv.dataset.hasThinking = 'true';
                    console.log('🧠 添加思考部分，样式类:', sectionClass);
                }
            }
            
            // 处理普通内容
            if (normalContent && normalContent.trim()) {
                const sectionClass = (thinkingContent && thinkingContent.trim()) ? 'normal-section' : 'normal-section normal-only';
                html += `<div class="${sectionClass}">${normalContent.replace(/\n/g, '<br>')}</div>`;
                messageDiv.dataset.hasNormal = 'true';
                console.log('💬 添加普通部分，样式类:', sectionClass);
            }
            
            console.log('📝 最终HTML长度:', html.length);
            messageDiv.innerHTML = html;
        }
        
        // 添加思考消息到聊天容器
        function addThinkingMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant thinking';
            messageDiv.textContent = content;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            
            return messageDiv;
        }

        // 显示正在输入指示器
        function showTypingIndicator() {
            removeTypingIndicator(); // 确保只有一个指示器
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = 'AI正在思考中<span class="dots">...</span>';
            
            chatContainer.appendChild(typingDiv);
            scrollToBottom();
        }
        
        // 滚动到底部 - 优化版
        function scrollToBottom() {
            // 使用requestAnimationFrame保证滚动的流畅性
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // 移除正在输入指示器
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 追加内容到混合内容消息
        function appendToMixedContentMessage(thinkingContent, normalContent, isThinking) {
            // 现在我们确保在调用此函数之前已经有了混合内容消息
            if (!currentAssistantMessage || !currentAssistantMessage.classList.contains('mixed-content')) {
                console.error('appendToMixedContentMessage called without mixed-content message');
                return;
            }
            
            // 获取现有内容
            let existingThinking = currentAssistantMessage.dataset.thinkingContent || '';
            let existingNormal = currentAssistantMessage.dataset.normalContent || '';
            
            // 追加新内容
            if (isThinking) {
                existingThinking += thinkingContent;
            } else {
                existingNormal += normalContent;
            }
            
            // 保存到dataset
            currentAssistantMessage.dataset.thinkingContent = existingThinking;
            currentAssistantMessage.dataset.normalContent = existingNormal;
            
            // 更新显示
            updateMixedContentMessage(currentAssistantMessage, existingThinking, existingNormal);
            
            // 使用节流滚动以提高性能
            throttledScrollToBottom();
        }
        
        // 追加内容到最后一条助手消息 - 优化版（保留用于兼容）
        function appendToLastMessage(content, isComplete) {
            if (!currentAssistantMessage) {
                // 如果没有当前消息，创建新消息
                addMessage('assistant', content);
                return;
            }
            
            // 检查是否是混合内容消息
            if (currentAssistantMessage.classList.contains('mixed-content')) {
                appendToMixedContentMessage('', content, false);
                return;
            }
            
            // 批量处理DOM更新以提高性能
            if (currentAssistantMessage.textContent === 'AI正在思考中...') {
                // 首次内容，替换占位文本
                currentAssistantMessage.textContent = content;
            } else {
                // 追加内容
                currentAssistantMessage.textContent += content;
            }
            
            // 使用节流滚动以提高性能
            throttledScrollToBottom();
            
            if (isComplete) {
                currentAssistantMessage.dataset.streamable = 'false';
                currentAssistantMessage.classList.add('stream-complete');
                currentAssistantMessage = null;
                // 重新启用发送按钮
                enableSendButton();
                enableChatControls();
            }
        }
        
        // 追加内容到最后一条思考消息
        function appendToLastThinkingMessage(content, isComplete) {
            // 查找最后一条思考消息
            const thinkingMessages = chatContainer.querySelectorAll('.message.thinking');
            let lastThinkingMessage = null;
            
            if (thinkingMessages.length > 0) {
                lastThinkingMessage = thinkingMessages[thinkingMessages.length - 1];
                // 检查是否是最新的消息（简单检查）
                const allMessages = chatContainer.querySelectorAll('.message');
                const lastMessage = allMessages[allMessages.length - 1];
                if (lastMessage !== lastThinkingMessage) {
                    lastThinkingMessage = null;
                }
            }
            
            if (!lastThinkingMessage) {
                // 创建新的思考消息
                lastThinkingMessage = addThinkingMessage(content);
            } else {
                // 追加到现有消息
                lastThinkingMessage.textContent += content;
            }
            
            throttledScrollToBottom();
            
            if (isComplete) {
                lastThinkingMessage.classList.add('stream-complete');
                // 重置AI响应状态
                isAIResponding = false;
                clearAIResponseTimeout();
                hideInterruptButton();
                enableSendButton();
                enableChatControls();
                console.log('✅ 思考消息完成，重置状态');
            }
        }
        
        // 节流滚动函数
        const throttledScrollToBottom = throttle(scrollToBottom, 16); // 60fps
        
        // 节流函数
        function throttle(func, delay) {
            let timeoutId;
            let lastExecTime = 0;
            return function (...args) {
                const currentTime = Date.now();
                
                if (currentTime - lastExecTime > delay) {
                    func.apply(this, args);
                    lastExecTime = currentTime;
                } else {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        func.apply(this, args);
                        lastExecTime = Date.now();
                    }, delay - (currentTime - lastExecTime));
                }
            };
        }

        // 发送消息
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !isConnected) return;

            // 如果AI正在回复，先发送打断信号
            if (isAIResponding) {
                sendInterruptSignal('NEW_MESSAGE', '用户发送了新消息');
            }

            // 重置当前消息状态，确保新消息创建新气泡
            currentAssistantMessage = null;
            
            // 同时重置ChatWindowHandler中的currentAssistantMessage
            const chatHandler = multiChannelRouter.getChannel('chat_window');
            if (chatHandler) {
                chatHandler.currentAssistantMessage = null;
            }

            const message = {
                type: 'text',
                content: content,
                role: 'user',
                sessionId: currentSessionId
            };

            // 显示用户消息
            addMessage('user', content);
            
            // 显示AI正在思考的指示器
            showTypingIndicator();
            
            // 发送到服务器
            ws.send(JSON.stringify(message));
            
            // 清空输入框
            messageInput.value = '';
            
            // 禁用发送按钮防止重复发送
            disableSendButton();
        }

        // 事件监听
        sendBtn.addEventListener('click', sendMessage);
        
        interruptBtn.addEventListener('click', function() {
            sendInterruptSignal('USER_STOP', '用户点击停止按钮');
        });
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        personaSelect.addEventListener('change', function() {
            // 如果AI正在回复，恢复到之前的选择并直接返回
            if (isAIResponding) {
                // 恢复到之前的选择
                this.selectedIndex = this.dataset.lastSelectedIndex || 0;
                return;
            }
            
            // 记录当前选择的索引
            this.dataset.lastSelectedIndex = this.selectedIndex;
            
            if (currentSessionId) {
                const message = {
                    type: 'system',
                    content: `切换到人设: ${this.options[this.selectedIndex].text}`,
                    metadata: {
                        action: 'change_persona',
                        personaId: this.value
                    }
                };
                
                addMessage('system', `已切换到 ${this.options[this.selectedIndex].text} 人设`);
                ws.send(JSON.stringify(message));
            }
        });
        
        // 思考切换事件监听
        thinkingToggle.addEventListener('click', toggleThinkingDisplay);
        
        // TTS切换事件监听
        ttsToggle.addEventListener('click', toggleChatTTS);
        
        // 联网搜索切换事件监听
        webSearchToggle.addEventListener('click', toggleWebSearchDisplay);

        // 启用/禁用发送按钮的工具函数
        function enableSendButton() {
            if (isConnected) {
                sendBtn.disabled = false;
                messageInput.disabled = false;
                sendBtn.textContent = '发送';
            }
        }
        
        function disableSendButton() {
            sendBtn.disabled = true;
            messageInput.disabled = true;
            sendBtn.textContent = '发送中...';
        }

        // 禁用聊天控件（AI回复时）
        function disableChatControls() {
            console.log('🚫 禁用聊天控件 - isAIResponding:', isAIResponding);
            // 禁用人设选择器
            personaSelect.disabled = true;
            personaSelect.style.opacity = '0.5';
            personaSelect.style.cursor = 'not-allowed';
            
            // 禁用思考过程切换
            thinkingToggle.style.pointerEvents = 'none';
            thinkingToggle.style.opacity = '0.5';
            thinkingToggle.style.cursor = 'not-allowed';
            
            // 禁用TTS切换
            ttsToggle.style.pointerEvents = 'none';
            ttsToggle.style.opacity = '0.5';
            ttsToggle.style.cursor = 'not-allowed';
            
            // 禁用联网搜索切换
            webSearchToggle.style.pointerEvents = 'none';
            webSearchToggle.style.opacity = '0.5';
            webSearchToggle.style.cursor = 'not-allowed';
        }

        // 启用聊天控件（AI回复结束时）
        function enableChatControls() {
            console.log('✅ 启用聊天控件 - isAIResponding:', isAIResponding);
            // 启用人设选择器
            personaSelect.disabled = false;
            personaSelect.style.opacity = '1';
            personaSelect.style.cursor = 'pointer';
            
            // 启用思考过程切换
            thinkingToggle.style.pointerEvents = 'auto';
            thinkingToggle.style.opacity = '1';
            thinkingToggle.style.cursor = 'pointer';
            
            // 启用TTS切换
            ttsToggle.style.pointerEvents = 'auto';
            ttsToggle.style.opacity = '1';
            ttsToggle.style.cursor = 'pointer';
            
            // 启用联网搜索切换
            webSearchToggle.style.pointerEvents = 'auto';
            webSearchToggle.style.opacity = '1';
            webSearchToggle.style.cursor = 'pointer';
        }

        // 记录AI活动
        function recordAIActivity() {
            lastAIActivityTime = Date.now();
            console.log('📝 记录AI活动时间:', new Date(lastAIActivityTime).toLocaleTimeString());
        }
        
        // 设置AI响应超时（基于活动检测）
        function setAIResponseTimeout() {
            // 如果已经有超时定时器在运行，不重复设置
            if (aiResponseTimeout || activityCheckInterval) {
                console.log('🔄 AI响应超时定时器已存在，跳过重复设置');
                return;
            }
            
            // 重置超时消息标志
            timeoutMessageShown = false;
            
            // 记录开始时间
            recordAIActivity();
            
            console.log('⏰ 启动基于活动检测的AI响应监控 (每30秒检查一次)');
            
            // 每30秒检查一次AI活动状态
            activityCheckInterval = setInterval(() => {
                if (!isAIResponding) {
                    // AI已经不在响应状态，清除监控
                    console.log('✅ AI已完成响应，停止活动监控');
                    clearAIResponseTimeout();
                    return;
                }
                
                const now = Date.now();
                const timeSinceLastActivity = now - (lastAIActivityTime || now);
                
                console.log('🔍 检查AI活动状态:', {
                    timeSinceLastActivity: Math.round(timeSinceLastActivity / 1000) + '秒',
                    isAIResponding: isAIResponding,
                    lastActivity: new Date(lastAIActivityTime).toLocaleTimeString()
                });
                
                // 如果30秒内没有AI活动，认为超时
                if (timeSinceLastActivity > 30000 && !timeoutMessageShown) {
                    console.log('⏰ AI响应真正超时 - 30秒内无活动，强制重置状态');
                    timeoutMessageShown = true;
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableSendButton();
                    enableChatControls();
                    addMessage('system', '⚠️ AI响应超时，已自动重置状态');
                }
            }, 30000); // 每30秒检查一次
        }

        // 清除AI响应超时
        function clearAIResponseTimeout() {
            if (aiResponseTimeout) {
                clearTimeout(aiResponseTimeout);
                aiResponseTimeout = null;
            }
            if (activityCheckInterval) {
                clearInterval(activityCheckInterval);
                activityCheckInterval = null;
                console.log('🛑 停止AI活动监控');
            }
            // 重置超时消息标志和活动时间
            timeoutMessageShown = false;
            lastAIActivityTime = null;
        }
        
        // 处理思考切换确认
        function handleThinkingToggleConfirmation(message) {
            if (message.metadata.thinking_toggle === 'confirmed') {
                const newState = message.metadata.showThinking;
                showThinking = newState;
                updateThinkingToggleUI(newState);
                addMessage('system', message.content);
            }
        }
        
        
        // 更新思考切换UI
        function updateThinkingToggleUI(state) {
            if (state) {
                thinkingToggle.classList.add('active');
            } else {
                thinkingToggle.classList.remove('active');
            }
        }
        
        
        // 发送思考切换请求
        function toggleThinkingDisplay() {
            if (!ws || !isConnected) {
                addMessage('system', '请先连接到服务器');
                return;
            }
            
            // 如果AI正在回复，直接返回不做任何操作
            if (isAIResponding) {
                return;
            }
            
            const newState = !showThinking;
            
            const toggleMessage = {
                type: 'system',
                content: 'toggle_thinking',
                metadata: {
                    action: 'toggle_thinking',
                    showThinking: newState
                }
            };
            
            ws.send(JSON.stringify(toggleMessage));
        }
        
        
        // 处理联网搜索切换确认
        function handleWebSearchToggleConfirmation(message) {
            if (message.metadata.web_search_toggle === 'confirmed') {
                const newState = message.metadata.useWebSearch;
                useWebSearch = newState;
                updateWebSearchToggleUI(newState);
                addMessage('system', message.content);
            }
        }
        
        // 更新联网搜索切换UI
        function updateWebSearchToggleUI(state) {
            if (state) {
                webSearchToggle.classList.add('active');
            } else {
                webSearchToggle.classList.remove('active');
            }
        }
        
        // 发送联网搜索切换请求
        function toggleWebSearchDisplay() {
            if (!ws || !isConnected) {
                addMessage('system', '请先连接到服务器');
                return;
            }
            
            // 如果AI正在回复，直接返回不做任何操作
            if (isAIResponding) {
                return;
            }
            
            const newState = !useWebSearch;
            
            const toggleMessage = {
                type: 'system',
                content: 'toggle_web_search',
                metadata: {
                    action: 'toggle_web_search',
                    useWebSearch: newState
                }
            };
            
            ws.send(JSON.stringify(toggleMessage));
        }
        
        // 初始化思考切换UI
        updateThinkingToggleUI(showThinking);
        
        // 初始化联网搜索切换UI
        updateWebSearchToggleUI(useWebSearch);
        
        // 初始化TTS切换UI
        updateTTSToggleUI(ttsSettings.chatEnabled);
        
        // 初始化人设选择器的索引记录
        personaSelect.dataset.lastSelectedIndex = personaSelect.selectedIndex;
        
        // TTS健康检查函数
        async function checkTTSHealth() {
            try {
                const response = await fetch('/api/cosyvoice/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.success && result.healthy;
                } else {
                    console.error('TTS健康检查失败:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('TTS健康检查异常:', error);
                return false;
            }
        }
        
        // TTS切换函数
        async function toggleChatTTS() {
            // 如果AI正在回复，直接返回不做任何操作
            if (isAIResponding) {
                return;
            }
            
            // 如果要启用TTS，先检查服务健康状态
            if (!ttsSettings.chatEnabled) {
                // 显示检查中的提示
                addMessage('system', '🔍 正在检查TTS服务状态...');
                
                // 执行健康检查
                const isHealthy = await checkTTSHealth();
                
                if (!isHealthy) {
                    // TTS服务不可用，显示警告并返回
                    addMessage('system', '⚠️ TTS服务不可用，无法启用');
                    return;
                }
                
                // 服务可用，继续启用TTS
                ttsSettings.chatEnabled = true;
                ttsSettings.chatMode = 'char_stream_tts';
                currentTTSMode = 'char_stream_tts';
                addMessage('system', '✅ 已启用聊天窗口TTS (模式2 - 字符流+语音)');
            } else {
                // 禁用TTS，切换到模式1
                ttsSettings.chatEnabled = false;
                ttsSettings.chatMode = 'text_only';
                currentTTSMode = 'text_only';
                addMessage('system', '❌ 已禁用聊天窗口TTS (模式1 - 纯文本)');
            }
            
            // 更新UI
            updateTTSToggleUI(ttsSettings.chatEnabled);
            updateTTSModeDisplay();
            updateTTSControlButton();
            
            // 同步更新设置页面的状态
            syncSettingsPageTTS();
            
            // 保存设置
            saveTTSSettings();
            
            console.log('TTS状态切换:', {
                enabled: ttsSettings.chatEnabled,
                mode: currentTTSMode,
                settings: ttsSettings
            });
        }
        
        // 更新TTS切换UI
        function updateTTSToggleUI(state) {
            if (state) {
                ttsToggle.classList.add('active');
            } else {
                ttsToggle.classList.remove('active');
            }
        }
        
        // 同步设置页面的TTS状态
        function syncSettingsPageTTS() {
            const chatToggle = document.getElementById('chatTTSToggle');
            if (chatToggle) {
                chatToggle.checked = ttsSettings.chatEnabled;
            }
        }
        
        // 发送打断信号
        function sendInterruptSignal(interruptType, reason) {
            if (!ws || !isConnected || !currentSessionId) {
                console.warn('无法发送打断信号：WebSocket未连接或无会话ID');
                return;
            }
            
            const interruptMessage = {
                type: 'system',
                content: 'interrupt',
                metadata: {
                    action: 'interrupt',
                    interruptType: interruptType,
                    reason: reason
                },
                sessionId: currentSessionId
            };
            
            ws.send(JSON.stringify(interruptMessage));
            console.log('发送打断信号:', interruptMessage);
            
            // 立即进行视觉反馈
            if (currentStreamingMessage) {
                // 在当前流式消息末尾添加中断提示
                const interruptNotice = document.createElement('span');
                interruptNotice.className = 'interrupt-notice';
                interruptNotice.textContent = ' ...（已中断）';
                interruptNotice.style.color = '#dc3545';
                interruptNotice.style.fontStyle = 'italic';
                currentStreamingMessage.appendChild(interruptNotice);
            }
            
            // 立即隐藏打断按钮
            isAIResponding = false;
            clearAIResponseTimeout();
            hideInterruptButton();
            enableChatControls();
        }
        
        // 显示打断按钮
        function showInterruptButton() {
            interruptBtn.classList.add('visible');
            interruptBtn.disabled = false;
        }
        
        // 隐藏打断按钮
        function hideInterruptButton() {
            interruptBtn.classList.remove('visible');
            interruptBtn.disabled = true;
        }
        
        // 处理打断确认
        function handleInterruptConfirmation(message) {
            console.log('收到打断确认:', message);
            
            // 确保打断按钮被隐藏
            isAIResponding = false;
            clearAIResponseTimeout();
            hideInterruptButton();
            enableChatControls();
            
            // 移除正在输入指示器
            removeTypingIndicator();
            
            // 重新启用发送按钮
            enableSendButton();
            enableChatControls();
            
            // 只有在确实有任务被中断时才显示中断确认消息
            if (message.metadata.interrupted_tasks && message.metadata.interrupted_tasks > 0) {
                addMessage('system', message.content + ` (中断了 ${message.metadata.interrupted_tasks} 个任务)`);
            } else {
                // 如果没有任务被中断，不显示中断消息
                console.log('没有任务被中断，跳过显示中断消息');
            }
        }
        
        // 自适应窗口大小管理
        function initResponsiveLayout() {
            function updateLayout() {
                const viewportWidth = document.documentElement.clientWidth;
                const viewportHeight = document.documentElement.clientHeight;
                
                console.log(`📐 Viewport size: ${viewportWidth}x${viewportHeight}`);
                
                // 更新聊天界面大小 (70%窗口)
                const chatContainer = document.querySelector('.chat-container');
                if (chatContainer) {
                    const containerWidth = Math.min(viewportWidth * 0.7, 1200); // 最大1200px
                    const containerHeight = viewportHeight * 0.7;
                    
                    chatContainer.style.width = `${containerWidth}px`;
                    chatContainer.style.height = `${containerHeight}px`;
                }
                
                // 更新设置页面
                const settingsTab = document.getElementById('settings-tab');
                if (settingsTab) {
                    settingsTab.style.height = `${viewportHeight}px`;
                    settingsTab.style.maxHeight = `${viewportHeight}px`;
                }
                
                // 触发自定义事件，通知其他组件
                window.dispatchEvent(new CustomEvent('layoutUpdated', {
                    detail: { width: viewportWidth, height: viewportHeight }
                }));
            }
            
            // 初始化布局
            updateLayout();
            
            // 监听窗口大小变化
            let resizeTimer;
            window.addEventListener('resize', function() {
                // 防抖处理，避免频繁触发
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(updateLayout, 150);
            });
            
            // 监听方向变化（移动设备）
            window.addEventListener('orientationchange', function() {
                setTimeout(updateLayout, 300);
            });
            
            console.log('📱 Responsive layout initialized');
        }
        
        // Tab切换功能
        function initTabSwitching() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('🔄 Initializing tab switching...');
            console.log('Found tab buttons:', tabButtons.length);
            console.log('Found tab contents:', tabContents.length);
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    console.log(`🎯 Switching to tab: ${targetTab}`);
                    
                    try {
                        // 更新按钮状态
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        
                        // 更新内容显示
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        const targetContent = document.getElementById(`${targetTab}-tab`);
                        if (targetContent) {
                            targetContent.classList.add('active');
                            console.log(`✅ Successfully switched to ${targetTab} tab`);
                        } else {
                            console.error(`❌ Target tab content not found: ${targetTab}-tab`);
                        }
                        
                        // 更新状态信息（仅在切换到设置页面时）
                        if (targetTab === 'settings') {
                            try {
                                updateSettingsInfo();
                            } catch (error) {
                                console.error('❌ Error updating settings info:', error);
                            }
                        }
                        
                        // 处理日志页面切换
                        if (targetTab === 'logs') {
                            try {
                                // 如果是第一次切换到日志页面，初始化日志功能
                                if (!window.logsInitialized) {
                                    initLogsPage();
                                    window.logsInitialized = true;
                                } else {
                                    // 已经初始化过，只需要激活自动刷新
                                    isLogsTabActive = true;
                                    if (autoRefreshLogs) {
                                        startAutoRefresh();
                                    }
                                }
                            } catch (error) {
                                console.error('❌ Error initializing logs page:', error);
                            }
                        } else {
                            // 切换到其他tab时，停止日志自动刷新
                            if (window.logsInitialized) {
                                isLogsTabActive = false;
                                stopAutoRefresh();
                            }
                        }
                        
                        // 如果切换到聊天页面，触发布局更新
                        if (targetTab === 'chat') {
                            setTimeout(() => {
                                if (typeof initResponsiveLayout !== 'undefined') {
                                    // 触发布局更新
                                    window.dispatchEvent(new Event('resize'));
                                }
                            }, 100);
                        }
                        
                    } catch (error) {
                        console.error('❌ Error during tab switching:', error);
                    }
                });
            });
            
            console.log('✅ Tab switching initialized');
        }
        
        // 更新设置页面信息
        function updateSettingsInfo() {
            // 更新连接状态
            const connectionStatus = document.getElementById('connectionStatus');
            if (connectionStatus) {
                // 检查WebSocket是否存在且已连接
                if (typeof ws !== 'undefined' && ws && ws.readyState === WebSocket.OPEN) {
                    connectionStatus.textContent = '已连接';
                    connectionStatus.className = 'info-value connected';
                } else {
                    connectionStatus.textContent = '未连接';
                    connectionStatus.className = 'info-value disconnected';
                }
            }
        }
        
        // 日志功能
        function fetchLogs() {
            const level = logLevelSelect ? logLevelSelect.value : 'INFO';
            const limit = 100; // 默认获取最近100条日志
            const timeRange = timeRangeSelect ? timeRangeSelect.value : '30m';
            
            let url = `/api/logs?level=${level}&limit=${limit}&timeRange=${timeRange}`;
            
            // 如果是自定义时间段，添加开始和结束时间参数
            if (timeRange === 'custom' && startTimeInput && endTimeInput) {
                const startTime = formatDateTimeForAPI(startTimeInput.value);
                const endTime = formatDateTimeForAPI(endTimeInput.value);
                if (startTime && endTime) {
                    url += `&startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`;
                }
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayLogs(data.logs);
                        updateLogStats();
                        // 显示获取信息
                        if (data.message) {
                            console.log('日志获取信息:', data.message);
                        }
                    } else {
                        console.error('获取日志失败:', data.message);
                        displayLogs([]);
                        logViewer.innerHTML = '<div class="log-entry"><span class="log-message">获取日志失败: ' + data.message + '</span></div>';
                    }
                })
                .catch(error => {
                    console.error('获取日志请求失败:', error);
                    displayLogs([]);
                    logViewer.innerHTML = '<div class="log-entry"><span class="log-message">获取日志请求失败: ' + error.message + '</span></div>';
                });
        }
        
        // 格式化日期时间为API所需格式
        function formatDateTimeForAPI(datetimeLocal) {
            if (!datetimeLocal) return '';
            // 将 "2024-10-10T17:30" 格式转换为 "2024-10-10 17:30:00"
            return datetimeLocal.replace('T', ' ') + ':00';
        }
        
        // 设置默认自定义时间
        function setDefaultCustomTime() {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            
            // 格式化为 datetime-local 输入所需的格式
            const formatForInput = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            if (startTimeInput) {
                startTimeInput.value = formatForInput(oneHourAgo);
            }
            if (endTimeInput) {
                endTimeInput.value = formatForInput(now);
            }
        }
        
        function displayLogs(logs) {
            if (!logs || logs.length === 0) {
                logViewer.innerHTML = '<div class="log-entry"><span class="log-message">暂无日志数据</span></div>';
                return;
            }
            
            logViewer.innerHTML = '';
            logs.forEach(log => {
                addLogEntry(log.level, log.message, log.timestamp, false);
            });
            
            // 滚动到底部
            logViewer.scrollTop = logViewer.scrollHeight;
        }
        
        function addLogEntry(level, message, timestamp = null, updateStats = true) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const time = timestamp || new Date().toLocaleString('zh-CN');
            
            logEntry.innerHTML = `
                <span class="log-timestamp">${time}</span>
                <span class="log-level ${level}">${level}</span>
                <span class="log-message">${message}</span>
            `;
            
            logViewer.appendChild(logEntry);
            
            if (updateStats) {
                // 更新统计
                logStats.total++;
                switch(level.toUpperCase()) {
                    case 'ERROR':
                        logStats.error++;
                        break;
                    case 'WARN':
                        logStats.warn++;
                        break;
                    case 'INFO':
                        logStats.info++;
                        break;
                    case 'DEBUG':
                        logStats.debug++;
                        break;
                }
                updateLogStats();
            }
            
            // 自动滚动到底部
            logViewer.scrollTop = logViewer.scrollHeight;
        }
        
        function updateLogStats() {
            if (totalLogsSpan) totalLogsSpan.textContent = logStats.total;
            if (errorLogsSpan) errorLogsSpan.textContent = logStats.error;
            if (warnLogsSpan) warnLogsSpan.textContent = logStats.warn;
            if (infoLogsSpan) infoLogsSpan.textContent = logStats.info;
            if (lastUpdateSpan) lastUpdateSpan.textContent = new Date().toLocaleString('zh-CN');
        }
        
        function clearLogDisplay() {
            logViewer.innerHTML = '<div class="log-entry"><span class="log-message">日志显示已清空</span></div>';
            logStats = {
                total: 0,
                error: 0,
                warn: 0,
                info: 0,
                debug: 0
            };
            updateLogStats();
        }
        
        function toggleAutoRefresh() {
            autoRefreshLogs = !autoRefreshLogs;
            
            if (autoRefreshLogs) {
                autoRefreshToggle.classList.add('active');
                startAutoRefresh();
            } else {
                autoRefreshToggle.classList.remove('active');
                stopAutoRefresh();
            }
        }
        
        function startAutoRefresh() {
            if (autoRefreshLogs && isLogsTabActive) {
                stopAutoRefresh(); // 先停止现有的定时器
                const intervalMs = refreshIntervalSeconds * 1000;
                logRefreshInterval = setInterval(fetchLogs, intervalMs);
                console.log(`自动刷新已启动，间隔: ${refreshIntervalSeconds}秒`);
            }
        }
        
        function stopAutoRefresh() {
            if (logRefreshInterval) {
                clearInterval(logRefreshInterval);
                logRefreshInterval = null;
                console.log('自动刷新已停止');
            }
        }
        
        function initLogsPage() {
            // 刷新日志按钮
            if (refreshLogsBtn) {
                refreshLogsBtn.addEventListener('click', () => {
                    fetchLogs();
                });
            }
            
            // 清空日志按钮
            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', clearLogDisplay);
            }
            
            // 自动刷新切换
            if (autoRefreshToggle) {
                autoRefreshToggle.addEventListener('click', toggleAutoRefresh);
            }
            
            // 日志级别选择器
            if (logLevelSelect) {
                logLevelSelect.addEventListener('change', () => {
                    fetchLogs(); // 级别改变时重新获取日志
                });
            }
            
            // 刷新间隔选择器
            if (refreshIntervalSelect) {
                refreshIntervalSelect.addEventListener('change', () => {
                    refreshIntervalSeconds = parseInt(refreshIntervalSelect.value);
                    // 如果自动刷新正在运行，重新启动以应用新间隔
                    if (autoRefreshLogs && isLogsTabActive) {
                        startAutoRefresh();
                    }
                });
            }
            
            // 时间范围选择器
            if (timeRangeSelect) {
                timeRangeSelect.addEventListener('change', () => {
                    const selectedRange = timeRangeSelect.value;
                    
                    // 显示或隐藏自定义时间段输入
                    if (customTimeRange) {
                        if (selectedRange === 'custom') {
                            customTimeRange.style.display = 'flex';
                            // 设置默认时间值
                            setDefaultCustomTime();
                        } else {
                            customTimeRange.style.display = 'none';
                            // 立即获取日志
                            fetchLogs();
                        }
                    }
                });
            }
            
            // 自定义时间段应用按钮
            if (applyCustomTimeBtn) {
                applyCustomTimeBtn.addEventListener('click', () => {
                    fetchLogs();
                });
            }
            
            // 设置日志tab为激活状态
            isLogsTabActive = true;
            
            // 初始化时加载一次日志
            fetchLogs();
            
            // 启动自动刷新（如果开启的话）
            if (autoRefreshLogs) {
                startAutoRefresh();
            }
        }
        
        // 设置页面功能
        function initSettingsPage() {
            // 用户配置对象
            let userPreferences = {};
            
            // 加载用户配置
            async function loadUserPreferences() {
                try {
                    const response = await fetch('/api/preferences');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        userPreferences = result.data;
                        updateSettingsUI(userPreferences);
                        updateConfigStatus('loaded', '配置已加载');
                        console.log('✅ 用户配置加载成功', userPreferences);
                    } else {
                        console.warn('⚠️ 加载用户配置失败', result.message);
                        updateConfigStatus('error', '加载失败');
                    }
                } catch (error) {
                    console.error('❌ 加载用户配置错误', error);
                    updateConfigStatus('error', '加载错误');
                }
            }
            
            // 保存用户配置
            async function saveUserPreferences() {
                try {
                    updateConfigStatus('loading', '保存中...');
                    
                    const response = await fetch('/api/preferences', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userPreferences)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        updateConfigStatus('loaded', '保存成功');
                        updateLastSavedTime();
                        console.log('✅ 用户配置保存成功');
                        
                        // 显示成功提示
                        showNotification('配置保存成功！', 'success');
                    } else {
                        console.error('❌ 保存用户配置失败', result.message);
                        updateConfigStatus('error', '保存失败');
                        showNotification('配置保存失败: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('❌ 保存用户配置错误', error);
                    updateConfigStatus('error', '保存错误');
                    showNotification('配置保存错误: ' + error.message, 'error');
                }
            }
            
            // 重置配置为默认值
            async function resetUserPreferences() {
                if (!confirm('确定要重置所有配置为默认值吗？此操作不可撤销。')) {
                    return;
                }
                
                try {
                    updateConfigStatus('loading', '重置中...');
                    
                    const response = await fetch('/api/preferences/reset', {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        userPreferences = result.data;
                        updateSettingsUI(userPreferences);
                        updateConfigStatus('loaded', '重置成功');
                        updateLastSavedTime();
                        console.log('✅ 用户配置重置成功');
                        showNotification('配置已重置为默认值！', 'success');
                    } else {
                        console.error('❌ 重置用户配置失败', result.message);
                        updateConfigStatus('error', '重置失败');
                        showNotification('配置重置失败: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('❌ 重置用户配置错误', error);
                    updateConfigStatus('error', '重置错误');
                    showNotification('配置重置错误: ' + error.message, 'error');
                }
            }
            
            // 更新设置界面
            function updateSettingsUI(preferences) {
                // 界面设置
                setElementValue('darkModeToggle', preferences.darkMode);
                setElementValue('animationsToggle', preferences.enableAnimations);
                setElementValue('autoScrollToggle', preferences.autoScroll);
                setElementValue('soundNotificationToggle', preferences.soundNotification);
                setElementValue('languageSelect', preferences.language);
                
                // Ollama设置
                setElementValue('ollamaUrlInput', preferences.ollamaBaseUrl);
                setElementValue('ollamaModelInput', preferences.ollamaModel);
                setElementValue('ollamaTimeoutInput', preferences.ollamaTimeout);
                setElementValue('ollamaMaxTokensInput', preferences.ollamaMaxTokens);
                setElementValue('ollamaStreamToggle', preferences.ollamaStream);
                
                // 联网搜索设置
                setElementValue('webSearchEnabledToggle', preferences.webSearchEnabled);
                setElementValue('webSearchEngineSelect', preferences.webSearchEngine);
                setElementValue('webSearchMaxResultsInput', preferences.webSearchMaxResults);
                setElementValue('webSearchTimeoutInput', preferences.webSearchTimeout);
                
                
                // 应用一些设置
                applyUISettings(preferences);
            }
            
            // 从界面收集设置
            function collectSettingsFromUI() {
                // 界面设置
                userPreferences.darkMode = getElementValue('darkModeToggle');
                userPreferences.enableAnimations = getElementValue('animationsToggle');
                userPreferences.autoScroll = getElementValue('autoScrollToggle');
                userPreferences.soundNotification = getElementValue('soundNotificationToggle');
                userPreferences.language = getElementValue('languageSelect');
                
                // Ollama设置
                userPreferences.ollamaBaseUrl = getElementValue('ollamaUrlInput');
                userPreferences.ollamaModel = getElementValue('ollamaModelInput');
                userPreferences.ollamaTimeout = parseInt(getElementValue('ollamaTimeoutInput'));
                userPreferences.ollamaMaxTokens = parseInt(getElementValue('ollamaMaxTokensInput'));
                userPreferences.ollamaStream = getElementValue('ollamaStreamToggle');
                
                // 联网搜索设置
                userPreferences.webSearchEnabled = getElementValue('webSearchEnabledToggle');
                userPreferences.webSearchEngine = getElementValue('webSearchEngineSelect');
                userPreferences.webSearchMaxResults = parseInt(getElementValue('webSearchMaxResultsInput'));
                userPreferences.webSearchTimeout = parseInt(getElementValue('webSearchTimeoutInput'));
                
            }
            
            // 应用UI设置
            function applyUISettings(preferences) {
                // 深色模式
                if (preferences.darkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                
                // 动画效果
                if (!preferences.enableAnimations) {
                    document.body.classList.add('no-animations');
                } else {
                    document.body.classList.remove('no-animations');
                }
                
                // 自动滚动
                window.autoScrollEnabled = preferences.autoScroll;
            }
            
            // 工具函数
            function setElementValue(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            }
            
            function getElementValue(id) {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        return element.checked;
                    } else {
                        return element.value;
                    }
                }
                return null;
            }
            
            function updateRangeValue(inputId, valueId, value) {
                const valueElement = document.getElementById(valueId);
                if (valueElement) {
                    valueElement.textContent = value;
                }
            }
            
            function updateConfigStatus(status, message) {
                const statusElement = document.getElementById('configStatus');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = 'info-value config-status ' + status;
                }
            }
            
            function updateLastSavedTime() {
                const timeElement = document.getElementById('lastSavedTime');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleString();
                }
            }
            
            function showNotification(message, type = 'info') {
                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 6px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                `;
                
                // 设置颜色
                switch (type) {
                    case 'success':
                        notification.style.background = '#28a745';
                        break;
                    case 'error':
                        notification.style.background = '#dc3545';
                        break;
                    default:
                        notification.style.background = '#007bff';
                }
                
                document.body.appendChild(notification);
                
                // 显示动画
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // 自动移除
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }
            
            // 导出配置
            function exportSettings() {
                collectSettingsFromUI();
                const dataStr = JSON.stringify(userPreferences, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'chatbot-settings-' + new Date().toISOString().split('T')[0] + '.json';
                link.click();
                URL.revokeObjectURL(url);
                showNotification('配置已导出到文件！', 'success');
            }
            
            // 导入配置
            function importSettings(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedSettings = JSON.parse(e.target.result);
                        userPreferences = { ...userPreferences, ...importedSettings };
                        updateSettingsUI(userPreferences);
                        showNotification('配置导入成功！请点击保存按钮应用配置。', 'success');
                    } catch (error) {
                        console.error('❌ 导入配置失败', error);
                        showNotification('配置文件格式错误！', 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            // 绑定事件监听器
            function bindEventListeners() {
                // 保存按钮
                const saveBtn = document.getElementById('saveSettingsBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        collectSettingsFromUI();
                        saveUserPreferences();
                    });
                }
                
                // 重置按钮
                const resetBtn = document.getElementById('resetSettingsBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', resetUserPreferences);
                }
                
                // 导出按钮
                const exportBtn = document.getElementById('exportSettingsBtn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportSettings);
                }
                
                // 导入按钮
                const importBtn = document.getElementById('importSettingsBtn');
                const importFileInput = document.getElementById('importFileInput');
                if (importBtn && importFileInput) {
                    importBtn.addEventListener('click', () => importFileInput.click());
                    importFileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            importSettings(file);
                        }
                    });
                }
                
                // 范围滑块实时更新
                const responseSpeedInput = document.getElementById('responseSpeedInput');
                if (responseSpeedInput) {
                    responseSpeedInput.addEventListener('input', (e) => {
                        updateRangeValue('responseSpeedInput', 'responseSpeedValue', e.target.value + 'x');
                    });
                }
                
                // 实时应用某些设置
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            document.body.classList.add('dark-mode');
                        } else {
                            document.body.classList.remove('dark-mode');
                        }
                    });
                }
                
                const animationsToggle = document.getElementById('animationsToggle');
                if (animationsToggle) {
                    animationsToggle.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            document.body.classList.remove('no-animations');
                        } else {
                            document.body.classList.add('no-animations');
                        }
                    });
                }
                
                const autoScrollToggle = document.getElementById('autoScrollToggle');
                if (autoScrollToggle) {
                    autoScrollToggle.addEventListener('change', (e) => {
                        window.autoScrollEnabled = e.target.checked;
                    });
                }
            }
            
            // 初始化
            updateConfigStatus('loading', '加载中...');
            bindEventListeners();
            loadUserPreferences();
        }
        window.addEventListener('load', function() {
            connect();
            
            // 初始化Tab切换功能
            initTabSwitching();
            
            // 初始化设置页面
            initSettingsPage();
            
            // 初始化自适应布局
            initResponsiveLayout();
            
            // 初始化TTS设置
            loadTTSSettings();
            initTTSSettings();
            
            console.log('✅ Chat system initialized');
        });
        
        // ========== TTS控制功能 ==========
        
        // 更新TTS模式显示
        function updateTTSModeDisplay() {
            const display = document.getElementById('currentTTSMode');
            if (display) {
                const modeText = currentTTSMode === 'text_only' ? '模式1 - 纯文本' : '模式2 - 字符流+语音';
                display.textContent = modeText;
            }
            
            // 更新设置界面的checkbox状态
            const chatToggle = document.getElementById('chatTTSToggle');
            if (chatToggle) chatToggle.checked = ttsSettings.chatEnabled;
            
            // 更新语音人设选择状态
            const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
            if (speakerSelect && ttsSettings.spk_id) {
                speakerSelect.value = ttsSettings.spk_id;
            }
        }
        
        
        // 更新TTS控制按钮状态
        function updateTTSControlButton() {
            // 更新切换按钮状态
            updateTTSToggleUI(ttsSettings.chatEnabled);
        }
        
        // 获取CosyVoice语音角色列表
        async function loadCosyVoiceSpeakers() {
            try {
                const response = await fetch('/api/cosyvoice/speakers', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateSpeakerSelect(result.builtinSpeakers, result.customSpeakers);
                        return true;
                    } else {
                        console.error('获取语音人设失败:', result.message);
                        showTTSNotification('获取语音人设失败: ' + result.message);
                        return false;
                    }
                } else {
                    console.error('获取语音人设请求失败:', response.status);
                    showTTSNotification('获取语音人设失败，请检查TTS服务状态');
                    return false;
                }
            } catch (error) {
                console.error('获取语音人设异常:', error);
                showTTSNotification('获取语音人设异常: ' + error.message);
                return false;
            }
        }
        
        // 更新语音人设选择框
        function updateSpeakerSelect(builtinSpeakers, customSpeakers) {
            const select = document.getElementById('cosyVoiceSpeakerSelect');
            if (!select) return;
            
            // 清空现有选项
            select.innerHTML = '';
            
            let firstSpeaker = null;
            
            // 添加内置语音人设
            if (builtinSpeakers && builtinSpeakers.length > 0) {
                const builtinGroup = document.createElement('optgroup');
                builtinGroup.label = '内置语音人设';
                
                builtinSpeakers.forEach((speaker, index) => {
                    const option = document.createElement('option');
                    option.value = speaker;
                    option.textContent = speaker;
                    builtinGroup.appendChild(option);
                    
                    // 记录第一个语音人设
                    if (firstSpeaker === null) {
                        firstSpeaker = speaker;
                    }
                });
                
                select.appendChild(builtinGroup);
            }
            
            // 添加自定义语音人设
            if (customSpeakers && customSpeakers.length > 0) {
                const customGroup = document.createElement('optgroup');
                customGroup.label = '自定义语音人设';
                
                customSpeakers.forEach(speaker => {
                    const option = document.createElement('option');
                    option.value = speaker;
                    option.textContent = speaker + ' (自定义)';
                    customGroup.appendChild(option);
                    
                    // 如果没有内置语音人设，记录第一个自定义语音人设
                    if (firstSpeaker === null) {
                        firstSpeaker = speaker;
                    }
                });
                
                select.appendChild(customGroup);
            }
            
            // 设置选中的语音人设
            let selectedSpeaker = ttsSettings.spk_id;
            
            // 如果没有保存的选择或保存的选择不在列表中，使用第一个
            if (!selectedSpeaker || !isValidSpeaker(selectedSpeaker, builtinSpeakers, customSpeakers)) {
                selectedSpeaker = firstSpeaker;
                if (selectedSpeaker) {
                    ttsSettings.spk_id = selectedSpeaker;
                    saveTTSSettings();
                }
            }
            
            // 设置选中值
            if (selectedSpeaker) {
                select.value = selectedSpeaker;
            }
            
            console.log('语音人设列表已更新:', {
                builtin: builtinSpeakers ? builtinSpeakers.length : 0,
                custom: customSpeakers ? customSpeakers.length : 0,
                selected: selectedSpeaker,
                first: firstSpeaker
            });
        }
        
        // 检查语音人设是否有效
        function isValidSpeaker(speakerId, builtinSpeakers, customSpeakers) {
            if (!speakerId) return false;
            
            if (builtinSpeakers && builtinSpeakers.includes(speakerId)) {
                return true;
            }
            
            if (customSpeakers && customSpeakers.includes(speakerId)) {
                return true;
            }
            
            return false;
        }
        
        // 显示TTS通知
        function showTTSNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'tts-notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                animation: slideInRight 0.3s ease, fadeInUp 0.3s ease;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后自动消失
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // 保存TTS设置
        function saveTTSSettings() {
            localStorage.setItem('ttsSettings', JSON.stringify(ttsSettings));
            localStorage.setItem('currentTTSMode', currentTTSMode);
        }
        
        // 加载TTS设置
        function loadTTSSettings() {
            const savedSettings = localStorage.getItem('ttsSettings');
            const savedMode = localStorage.getItem('currentTTSMode');
            
            if (savedSettings) {
                ttsSettings = { ...ttsSettings, ...JSON.parse(savedSettings) };
            }
            
            if (savedMode) {
                currentTTSMode = savedMode;
            }
            
            updateTTSModeDisplay();
            updateTTSControlButton();
            
            // 初始加载语音角色列表
            loadCosyVoiceSpeakers();
        }
        
        // 初始化TTS设置事件监听
        function initTTSSettings() {
            // 聊天TTS开关 - 设置页面的checkbox现在只是显示状态，不允许直接修改
            const chatToggle = document.getElementById('chatTTSToggle');
            if (chatToggle) {
                chatToggle.addEventListener('change', function() {
                    // 阻止直接在设置页面修改，提示用户在聊天窗口操作
                    this.checked = ttsSettings.chatEnabled; // 恢复原状态
                    
                    // 显示提示信息
                    showTTSNotification('请在聊天窗口使用TTS按钮切换模式');
                });
            }
            
            
            // CosyVoice语音人设选择
            const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
            if (speakerSelect) {
                speakerSelect.addEventListener('change', function() {
                    // 确保不可为空，如果为空则不保存
                    if (this.value) {
                        ttsSettings.spk_id = this.value;
                        saveTTSSettings();
                        console.log('语音人设已更改:', ttsSettings.spk_id);
                        showTTSNotification('语音人设已更新: ' + this.value);
                    }
                });
                
                // 点击下拉框时自动刷新语音人设列表
                speakerSelect.addEventListener('focus', function() {
                    loadCosyVoiceSpeakers();
                });
            }
            
            // 刷新语音人设按钮
            const refreshBtn = document.getElementById('refreshSpeakersBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    showTTSNotification('正在刷新语音人设列表...');
                    loadCosyVoiceSpeakers();
                });
            }

            // 新增语音人设按钮
            const addSpeakerBtn = document.getElementById('addCustomSpeakerBtn');
            if (addSpeakerBtn) {
                addSpeakerBtn.addEventListener('click', function() {
                    showAddSpeakerModal();
                });
            }

            // 生成语音按钮
            const generateVoiceBtn = document.getElementById('generateVoiceBtn');
            if (generateVoiceBtn) {
                generateVoiceBtn.addEventListener('click', function() {
                    generateTestVoice();
                });
            }
            
            // 语音速度
            const speedRange = document.getElementById('ttsSpeedRange');
            const speedValue = document.getElementById('ttsSpeedValue');
            if (speedRange && speedValue) {
                speedRange.addEventListener('input', function() {
                    ttsSettings.speed = parseFloat(this.value);
                    speedValue.textContent = this.value + 'x';
                    saveTTSSettings();
                });
            }
        }

        // ==================== 新增语音人设弹窗功能 ====================

        // 显示新增语音人设弹窗
        function showAddSpeakerModal() {
            const modal = document.getElementById('addSpeakerModal');
            if (modal) {
                modal.style.display = 'block';
                // 清空表单
                resetAddSpeakerForm();
            }
        }

        // 隐藏新增语音人设弹窗
        function hideAddSpeakerModal() {
            const modal = document.getElementById('addSpeakerModal');
            if (modal) {
                modal.style.display = 'none';
                resetAddSpeakerForm();
            }
        }

        // 重置表单
        function resetAddSpeakerForm() {
            const form = document.getElementById('addSpeakerForm');
            if (form) {
                form.reset();
            }
        }

        // 创建语音人设
        async function createCustomSpeaker(formData) {
            try {
                const createBtn = document.getElementById('createSpeakerBtn');
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.textContent = '创建中...';
                }

                const response = await fetch('/api/cosyvoice/speaker/create', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showTTSNotification('语音人设创建成功: ' + result.speakerName, 'success');
                        hideAddSpeakerModal();
                        
                        // 刷新语音人设列表
                        await loadCosyVoiceSpeakers();
                        
                        // 选中新创建的语音人设
                        const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
                        if (speakerSelect && result.speakerName) {
                            speakerSelect.value = result.speakerName;
                            ttsSettings.spk_id = result.speakerName;
                            saveTTSSettings();
                            showTTSNotification('已自动选择新创建的语音人设: ' + result.speakerName);
                        }
                        
                        return true;
                    } else {
                        showTTSNotification('创建失败: ' + result.message, 'error');
                        return false;
                    }
                } else {
                    const errorText = await response.text();
                    showTTSNotification('创建失败: HTTP ' + response.status + ' - ' + errorText, 'error');
                    return false;
                }
            } catch (error) {
                console.error('创建语音人设异常:', error);
                showTTSNotification('创建异常: ' + error.message, 'error');
                return false;
            } finally {
                const createBtn = document.getElementById('createSpeakerBtn');
                if (createBtn) {
                    createBtn.disabled = false;
                    createBtn.textContent = '创建语音人设';
                }
            }
        }

        // 验证表单数据
        function validateSpeakerForm() {
            const speakerName = document.getElementById('speakerNameInput').value.trim();
            const referenceText = document.getElementById('referenceTextInput').value.trim();
            const referenceAudio = document.getElementById('referenceAudioInput').files[0];

            if (!speakerName) {
                showTTSNotification('请输入语音人物名称', 'error');
                return false;
            }

            if (speakerName.length > 50) {
                showTTSNotification('语音人物名称不能超过50个字符', 'error');
                return false;
            }

            if (!referenceText) {
                showTTSNotification('请输入参考文本', 'error');
                return false;
            }

            if (referenceText.length > 500) {
                showTTSNotification('参考文本不能超过500个字符', 'error');
                return false;
            }

            if (!referenceAudio) {
                showTTSNotification('请选择参考音频文件', 'error');
                return false;
            }

            if (!referenceAudio.name.toLowerCase().endsWith('.wav')) {
                showTTSNotification('请选择WAV格式的音频文件', 'error');
                return false;
            }

            // 检查文件大小（限制为50MB）
            if (referenceAudio.size > 50 * 1024 * 1024) {
                showTTSNotification('音频文件大小不能超过50MB', 'error');
                return false;
            }

            return true;
        }

        // 初始化弹窗事件监听器
        function initAddSpeakerModal() {
            // 关闭按钮
            const closeBtn = document.getElementById('closeSpeakerModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', hideAddSpeakerModal);
            }

            // 取消按钮
            const cancelBtn = document.getElementById('cancelSpeakerBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideAddSpeakerModal);
            }

            // 点击背景关闭弹窗
            const modal = document.getElementById('addSpeakerModal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        hideAddSpeakerModal();
                    }
                });
            }

            // 表单提交
            const form = document.getElementById('addSpeakerForm');
            if (form) {
                form.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    if (!validateSpeakerForm()) {
                        return;
                    }

                    const formData = new FormData();
                    formData.append('speakerName', document.getElementById('speakerNameInput').value.trim());
                    formData.append('referenceText', document.getElementById('referenceTextInput').value.trim());
                    formData.append('referenceAudio', document.getElementById('referenceAudioInput').files[0]);

                    await createCustomSpeaker(formData);
                });
            }

            // ESC键关闭弹窗
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modal = document.getElementById('addSpeakerModal');
                    if (modal && modal.style.display === 'block') {
                        hideAddSpeakerModal();
                    }
                }
            });
        }

        // 在页面加载完成后初始化弹窗
        document.addEventListener('DOMContentLoaded', function() {
            initAddSpeakerModal();
        });

        // ==================== 测试语音生成功能 ====================

        // 生成测试语音
        async function generateTestVoice() {
            const textInput = document.getElementById('testVoiceText');
            const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
            const generateBtn = document.getElementById('generateVoiceBtn');
            const resultDiv = document.getElementById('voiceTestResult');

            // 验证输入
            const text = textInput.value.trim();
            if (!text) {
                showTTSNotification('请输入要测试的文本', 'error');
                textInput.focus();
                return;
            }

            const selectedSpeaker = speakerSelect.value;
            if (!selectedSpeaker) {
                showTTSNotification('请先选择一个语音人设', 'error');
                return;
            }

            try {
                // 禁用按钮并显示加载状态
                generateBtn.disabled = true;
                generateBtn.textContent = '生成中...';
                
                // 显示加载占位符
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        <div class="loading-spinner"></div>
                        <span>正在生成语音，请稍候...</span>
                    </div>
                `;

                // 获取当前语音速度设置
                const speedRange = document.getElementById('ttsSpeedRange');
                const speed = speedRange ? parseFloat(speedRange.value) : 1.0;

                // 调用API生成语音
                const response = await fetch('/api/cosyvoice/synthesis/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        text: text,
                        speakerName: selectedSpeaker,
                        speed: speed.toString(),
                        format: 'wav'
                    })
                });

                if (response.ok) {
                    // 获取音频数据
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // 显示音频播放器
                    resultDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #4caf50;">
                            <span style="color: #2e7d32; font-weight: 500;">✅ 语音生成成功</span>
                            <audio controls style="flex: 1;">
                                <source src="${audioUrl}" type="audio/wav">
                                您的浏览器不支持音频播放。
                            </audio>
                            <button onclick="downloadTestAudio('${audioUrl}')" style="padding: 4px 8px; font-size: 12px;">下载</button>
                        </div>
                    `;
                    
                    showTTSNotification('语音生成成功！', 'success');
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <div style="padding: 10px; background: #f8d7da; border-radius: 6px; border-left: 4px solid #dc3545; color: #721c24;">
                            ❌ 生成失败: ${errorText}
                        </div>
                    `;
                    showTTSNotification('语音生成失败: ' + errorText, 'error');
                }

            } catch (error) {
                console.error('生成语音异常:', error);
                resultDiv.innerHTML = `
                    <div style="padding: 10px; background: #f8d7da; border-radius: 6px; border-left: 4px solid #dc3545; color: #721c24;">
                        ❌ 生成异常: ${error.message}
                    </div>
                `;
                showTTSNotification('语音生成异常: ' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                generateBtn.disabled = false;
                generateBtn.textContent = '生成语音';
            }
        }

        // 下载测试音频
        function downloadTestAudio(audioUrl) {
            const link = document.createElement('a');
            link.href = audioUrl;
            link.download = 'test_voice_' + new Date().getTime() + '.wav';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 清理音频URL（防止内存泄漏）
        function cleanupAudioUrls() {
            const audioElements = document.querySelectorAll('#voiceTestResult audio');
            audioElements.forEach(audio => {
                if (audio.src && audio.src.startsWith('blob:')) {
                    URL.revokeObjectURL(audio.src);
                }
            });
        }

        // 在生成新语音前清理旧的URL
        window.addEventListener('beforeunload', cleanupAudioUrls);
    </script>

    <!-- 新增语音人设弹窗 -->
    <div id="addSpeakerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎭 新增语音人设</h2>
                <span class="close" id="closeSpeakerModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addSpeakerForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="speakerNameInput">语音人物名称:</label>
                        <input type="text" id="speakerNameInput" name="speakerName" required 
                               placeholder="请输入语音人物名称（如：派蒙）" maxlength="50">
                        <span class="form-description">将作为语音人设的标识名称</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="referenceTextInput">参考文本:</label>
                        <textarea id="referenceTextInput" name="referenceText" required 
                                  placeholder="请输入参考文本，用于训练语音特征..." 
                                  rows="4" maxlength="500"></textarea>
                        <span class="form-description">用于语音克隆的参考文本，建议10-50字</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="referenceAudioInput">参考音频文件:</label>
                        <input type="file" id="referenceAudioInput" name="referenceAudio" 
                               accept=".wav" required>
                        <span class="form-description">请选择WAV格式的音频文件，建议3-10秒</span>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="cancelSpeakerBtn" class="cancel-btn">取消</button>
                        <button type="submit" id="createSpeakerBtn" class="create-btn">创建语音人设</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>
</html>
