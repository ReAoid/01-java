<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIèŠå¤©æœºå™¨äººç³»ç»Ÿ</title>
    <!-- å¼•å…¥marked.jsç”¨äºmarkdownè§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }
        
        /* å·¦ä¾§Tabå¯¼èˆª */
        .sidebar {
            width: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 1000;
        }
        
        .tab-button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button:hover {
            background: rgba(103, 126, 234, 0.1);
            transform: scale(1.1);
        }
        
        .tab-button.active {
            background: rgba(103, 126, 234, 0.2);
            color: #667eea;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            right: -10px;
            width: 3px;
            height: 20px;
            background: #667eea;
            border-radius: 2px;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Tabå†…å®¹ */
        .tab-content {
            display: none;
            flex: 1;
            padding: 0;
            overflow: hidden;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* èŠå¤©Tab - é€‚åº”70%çª—å£ */
        .tab-content#chat-tab {
            height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .tab-content#chat-tab.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* è®¾ç½®Tabæ ‡å‡†é«˜åº¦ */
        .tab-content#settings-tab {
            height: 100vh;
        }
        
        .tab-content#settings-tab.active {
            display: flex;
            flex-direction: column;
        }
        
        /* æ—¥å¿—Tab - é€‚åº”70%çª—å£ */
        .tab-content#logs-tab {
            height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .tab-content#logs-tab.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* èŠå¤©ç•Œé¢æ ·å¼ - 70%å¤§å°å±…ä¸­ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 70%;
            height: 70vh;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .chat-container .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 12px;
            box-shadow: none;
            background: white;
        }
        
        .chat-container .header {
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .chat-container .chat-messages {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            background: white;
        }
        
        .chat-container .input-container {
            flex-shrink: 0;
            background: white;
            border-radius: 0 0 12px 12px;
        }
        
        /* ç¡®ä¿æ¶ˆæ¯åŒºåŸŸæ­£ç¡®æ»šåŠ¨ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
        }
        
        .input-container {
            padding: 20px;
            border-top: 1px solid #eee;
            background: white;
        }
        
        /* è®¾ç½®ç•Œé¢æ ·å¼ */
        .settings-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            min-height: 100vh;
        }
        
        .settings-container .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: none;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }
        
        .settings-container .header {
            flex-shrink: 0;
            border-radius: 0;
        }
        
        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 0;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .settings-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .settings-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
        }
        
        .save-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .reset-btn {
            background: #dc3545;
            color: white;
        }
        
        .reset-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .export-btn, .import-btn {
            background: #007bff;
            color: white;
        }
        
        .export-btn:hover, .import-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .setting-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .setting-section:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .setting-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            position: relative;
        }
        
        .setting-item:last-child {
            margin-bottom: 0;
        }
        
        .setting-item label {
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .setting-item input[type="text"],
        .setting-item input[type="url"],
        .setting-item input[type="number"],
        .setting-item select {
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .setting-item input[type="text"]:focus,
        .setting-item input[type="url"]:focus,
        .setting-item input[type="number"]:focus,
        .setting-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .setting-item input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e1e5e9;
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }
        
        .setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .setting-item input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }
        
        .setting-item input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .setting-description {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-weight: 500;
            color: #555;
        }
        
        .info-value {
            font-weight: 600;
            color: #333;
        }
        
        .setting-section p {
            margin: 0 0 15px 0;
            color: #666;
        }
        
        /* æ—¥å¿—ç•Œé¢æ ·å¼ - 70%å¤§å°å±…ä¸­ */
        .logs-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 70%;
            height: 80vh;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .logs-container .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 12px;
            box-shadow: none;
            background: white;
        }
        
        .logs-container .header {
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .logs-content {
            flex: 1;
            padding: 20px;
            overflow: visible;
            min-height: 0;
        }
        
        .log-controls {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .log-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .log-controls select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .log-controls label {
            font-size: 14px;
            color: #333;
            margin-right: 8px;
        }
        
        .custom-time-range {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .custom-time-range div {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .custom-time-range input[type="datetime-local"] {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .refresh-btn {
            background: #007bff;
            color: white;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
        }
        
        .clear-btn {
            background: #dc3545;
            color: white;
        }
        
        .clear-btn:hover {
            background: #c82333;
        }
        
        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .log-viewer {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #d4d4d4;
            overflow-y: auto;
            height: 300px;
            border: 1px solid #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #569cd6;
            font-weight: bold;
        }
        
        .log-level {
            font-weight: bold;
            margin: 0 8px;
        }
        
        .log-level.INFO {
            color: #4ec9b0;
        }
        
        .log-level.WARN {
            color: #dcdcaa;
        }
        
        .log-level.ERROR {
            color: #f44747;
        }
        
        .log-level.DEBUG {
            color: #9cdcfe;
        }
        
        .log-message {
            color: #d4d4d4;
        }
        
        .log-stats {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .log-stats h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .stat-label {
            font-weight: 500;
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
        }
        
        .setting-item {
            margin: 15px 0;
        }
        
        .setting-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .setting-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .info-label {
            font-weight: 500;
            color: #666;
        }
        
        .info-value {
            font-weight: bold;
            color: #333;
        }
        
        #connectionStatus.connected {
            color: #28a745;
        }
        
        #connectionStatus.disconnected {
            color: #dc3545;
        }
        
        /* æ·±è‰²æ¨¡å¼æ ·å¼ */
        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        body.dark-mode .sidebar {
            background: rgba(52, 73, 94, 0.95);
        }
        
        body.dark-mode .tab-button {
            color: #ecf0f1;
        }
        
        body.dark-mode .tab-button:hover {
            background: rgba(52, 152, 219, 0.2);
        }
        
        body.dark-mode .tab-button.active {
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }
        
        body.dark-mode .container:not(.chat-container .container):not(.settings-container .container) {
            background: #34495e;
            color: #ecf0f1;
        }
        
        body.dark-mode .chat-container .container,
        body.dark-mode .settings-container .container {
            background: #34495e;
            color: #ecf0f1;
        }
        
        /* èŠå¤©ç•Œé¢åœ¨æ·±è‰²æ¨¡å¼ä¸‹ä¿æŒç™½è‰²èƒŒæ™¯ */
        body.dark-mode .chat-container,
        body.dark-mode .chat-container .container,
        body.dark-mode .chat-container .chat-messages,
        body.dark-mode .chat-container .input-container {
            background: white !important;
            color: #333 !important;
        }
        
        /* èŠå¤©ç•Œé¢å¤´éƒ¨åœ¨æ·±è‰²æ¨¡å¼ä¸‹ä¿æŒæ¸å˜ */
        body.dark-mode .chat-container .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        
        body.dark-mode .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        body.dark-mode .setting-section {
            background: #2c3e50;
            color: #ecf0f1;
        }
        
        body.dark-mode .info-item {
            background: #34495e;
        }
        
        body.dark-mode .info-label {
            color: #bdc3c7;
        }
        
        body.dark-mode .info-value {
            color: #ecf0f1;
        }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ—¥å¿—ç•Œé¢æ ·å¼ - ä¿æŒç™½è‰²èƒŒæ™¯ */
        body.dark-mode .logs-container,
        body.dark-mode .logs-container .container,
        body.dark-mode .logs-content {
            background: white !important;
            color: #333 !important;
        }
        
        /* æ—¥å¿—ç•Œé¢å¤´éƒ¨åœ¨æ·±è‰²æ¨¡å¼ä¸‹ä¿æŒæ¸å˜ */
        body.dark-mode .logs-container .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        
        body.dark-mode .log-controls {
            background: white !important;
            color: #333 !important;
        }
        
        body.dark-mode .log-stats {
            background: white !important;
            color: #333 !important;
        }
        
        body.dark-mode .log-stats h4 {
            color: #333 !important;
        }
        
        body.dark-mode .stat-item {
            background: #f8f9fa !important;
        }
        
        body.dark-mode .stat-label {
            color: #666 !important;
        }
        
        body.dark-mode .stat-value {
            color: #333 !important;
        }
        
        body.dark-mode .log-controls select {
            background: white !important;
            border-color: #ddd !important;
            color: #333 !important;
        }
        
        body.dark-mode .log-controls label {
            color: #333 !important;
        }
        
        body.dark-mode .custom-time-range {
            background: white !important;
            color: #333 !important;
        }
        
        body.dark-mode .custom-time-range label {
            color: #333 !important;
        }
        
        body.dark-mode .custom-time-range input[type="datetime-local"] {
            background: white !important;
            border-color: #ddd !important;
            color: #333 !important;
        }
        
        /* æ— åŠ¨ç”»æ¨¡å¼ */
        body.no-animations * {
            transition: none !important;
            animation: none !important;
        }
        /* é»˜è®¤å®¹å™¨æ ·å¼ï¼ˆä»…ç”¨äºç‹¬ç«‹é¡µé¢ï¼‰ */
        .container:not(.chat-container .container):not(.settings-container .container) {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .status {
            padding: 10px 20px;
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            margin: 0;
            transition: all 0.3s ease;
        }
        .status.disconnected {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .status.connecting {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .message.assistant {
            background: #f1f3f4;
            color: #333;
        }
        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            max-width: 100%;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            text-align: center;
            max-width: 100%;
        }
        .typing-indicator {
            background: #f1f3f4;
            color: #666;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }
        .typing-indicator .dots {
            animation: blink 1.4s infinite both;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        .message.assistant[data-streamable="true"] {
            position: relative;
        }
        .message.assistant[data-streamable="true"]:after {
            content: '|';
            animation: cursor-blink 1s infinite;
            color: #007bff;
        }
        .message.assistant.stream-complete:after {
            display: none;
        }
        /* æ··åˆå†…å®¹æ¶ˆæ¯ä¸æ˜¾ç¤ºå…‰æ ‡ */
        .message.mixed-content:after {
            display: none !important;
        }
        /* æ··åˆå†…å®¹æ¶ˆæ¯æ ·å¼ */
        .message.mixed-content {
            background: #f1f3f4;
            color: #333;
            padding: 0;
        }
        
        /* æ€è€ƒéƒ¨åˆ†æ ·å¼ - ç°è‰²èƒŒæ™¯ï¼Œç°ç™½è‰²å­—ä½“ */
        .thinking-section {
            background: #6c757d;
            padding: 12px 15px;
            margin: 0;
            border-radius: 15px 15px 0 0;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #e9ecef;
            position: relative;
        }
        
        .thinking-section::before {
            content: 'ğŸ§  AIæ€è€ƒè¿‡ç¨‹';
            display: block;
            font-weight: bold;
            color: #f8f9fa;
            margin-bottom: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
        }
        
        /* æ™®é€šå†…å®¹éƒ¨åˆ†æ ·å¼ - æ­£å¸¸èƒŒæ™¯å’Œå­—ä½“ */
        .normal-section {
            background: #f1f3f4;
            padding: 12px 15px;
            margin: 0;
            border-radius: 0 0 15px 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            border-top: 1px solid #dee2e6;
        }
        
        /* åªæœ‰æ€è€ƒå†…å®¹æ—¶çš„æ ·å¼ */
        .thinking-only {
            border-radius: 15px;
        }
        
        /* åªæœ‰æ™®é€šå†…å®¹æ—¶çš„æ ·å¼ */
        .normal-only {
            border-radius: 15px;
        }
        
        /* æ€è€ƒéƒ¨åˆ†markdownæ ·å¼ - é€‚é…ç°è‰²èƒŒæ™¯ */
        .thinking-section h1, .thinking-section h2, .thinking-section h3 {
            margin: 10px 0 5px 0;
            color: #f8f9fa;
            font-weight: bold;
        }
        
        .thinking-section h1 { font-size: 16px; }
        .thinking-section h2 { font-size: 15px; }
        .thinking-section h3 { font-size: 14px; }
        
        .thinking-section code {
            background: rgba(0, 0, 0, 0.2);
            color: #ffc107;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: inherit;
        }
        
        .thinking-section pre {
            background: rgba(0, 0, 0, 0.2);
            color: #e9ecef;
            padding: 8px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .thinking-section ul, .thinking-section ol {
            margin: 8px 0;
            padding-left: 20px;
            color: #e9ecef;
        }
        
        .thinking-section li {
            margin: 4px 0;
        }
        
        .thinking-section blockquote {
            border-left: 3px solid #17a2b8;
            padding-left: 10px;
            margin: 8px 0;
            font-style: italic;
            color: #ced4da;
        }
        
        .thinking-section p {
            margin: 8px 0;
            color: #e9ecef;
        }
        
        .thinking-section strong {
            color: #f8f9fa;
            font-weight: bold;
        }
        
        .thinking-section em {
            color: #ced4da;
            font-style: italic;
        }
        
        /* ä¿ç•™åŸæœ‰çš„ç‹¬ç«‹æ€è€ƒæ¶ˆæ¯æ ·å¼ï¼Œç”¨äºå…¼å®¹ */
        .message.thinking {
            background: #fff8dc;
            border-left: 4px solid #ffa500;
            font-style: italic;
            opacity: 0.8;
        }
        .message.thinking::before {
            content: 'ğŸ§  æ€è€ƒ: ';
            font-weight: bold;
            color: #ff8c00;
        }
        @keyframes cursor-blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .input-container {
            padding: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }
        .send-btn {
            padding: 12px 25px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }
        .send-btn:hover {
            background: #0056b3;
        }
        .interrupt-btn {
            padding: 12px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            display: none; /* é»˜è®¤éšè— */
            transition: all 0.3s ease;
        }
        .interrupt-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        .interrupt-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .interrupt-btn.visible {
            display: block;
        }
        .interrupt-icon {
            font-size: 16px;
            margin-right: 5px;
        }
        .persona-selector {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .persona-selector select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        .thinking-toggle, .tts-toggle, .web-search-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .thinking-toggle label, .tts-toggle label, .web-search-toggle label {
            font-size: 14px;
            color: #666;
            margin: 0;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #007bff;
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch.active::before {
            transform: translateX(26px);
        }
        .ollama-status {
            padding: 5px 20px;
            background: #d1ecf1;
            border-bottom: 1px solid #bee5eb;
            font-size: 12px;
            color: #0c5460;
        }
        .ollama-status.unavailable {
            background: #f8d7da;
            border-bottom-color: #f5c6cb;
            color: #721c24;
        }
        
        /* ========== å¤šé€šé“TTSæ ·å¼ ========== */
        
        /* Live2Dæ°”æ³¡æ ·å¼ */
        .live2d-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 20px 20px 5px 20px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            max-width: 250px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease;
        }
        
        .live2d-bubble.waiting-for-audio {
            border-left: 4px solid #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }
        
        .live2d-bubble.playing-audio {
            border-left: 4px solid #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            box-shadow: 0 2px 12px rgba(76, 175, 80, 0.3);
            transform: scale(1.02);
        }
        
        .live2d-bubble.sentence-completed {
            border-left: 4px solid #2196f3;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            opacity: 0.8;
        }
        
        .live2d-bubble.audio-failed {
            border-left: 4px solid #f44336;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
        }
        
        .live2d-bubble::before {
            content: '';
            position: absolute;
            bottom: -5px;
            right: 15px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #764ba2;
        }
        
        .live2d-bubble.waiting-for-audio::before {
            border-top-color: #ffe0b2;
        }
        
        .live2d-bubble.playing-audio::before {
            border-top-color: #c8e6c9;
        }
        
        .live2d-bubble.sentence-completed::before {
            border-top-color: #bbdefb;
        }
        
        .live2d-bubble.audio-failed::before {
            border-top-color: #ffcdd2;
        }
        
        /* Live2Då®¹å™¨ */
        .live2d-container {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* éŸ³é¢‘çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .audio-waiting-indicator,
        .audio-playing-indicator {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .audio-waiting-indicator {
            color: #ff9800;
            animation: pulse 1.5s infinite;
        }
        
        .audio-playing-indicator {
            color: #4caf50;
            animation: pulse 1.5s infinite;
        }
        
        .audio-error-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.7;
            font-size: 16px;
        }
        
        /* TTSé”™è¯¯é€šçŸ¥ */
        .tts-error-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffebee;
            color: #c62828;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0.9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease;
        }
        
        /* å…¨å±€éŸ³é¢‘æŒ‡ç¤ºå™¨ */
        .global-audio-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .global-audio-indicator.active {
            opacity: 1;
            transform: scale(1);
        }
        
        .global-audio-indicator::before {
            content: 'ğŸ”Š';
            font-size: 18px;
            animation: pulse 1.5s infinite;
        }
        
        /* å¤šé€šé“é…ç½®ç•Œé¢ */
        .output-channels-settings {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .channel-config {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            background: #fafafa;
        }
        
        .channel-config h4 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 16px;
        }
        
        .sub-options {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        .sub-options label {
            display: block;
            margin: 6px 0;
            font-size: 14px;
        }
        
        .preset-configs {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }
        
        .preset-configs button {
            margin: 4px;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .preset-configs button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        /* TTSæ¨¡å¼æ˜¾ç¤º */
        .current-mode-display {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1); 
            }
            50% { 
                opacity: 0.6; 
                transform: scale(1.05); 
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 0.9;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        /* èŠå¤©çª—å£TTSçŠ¶æ€ */
        .message.assistant.tts-enabled {
            border-left: 3px solid #4caf50;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e9 100%);
        }
        
        .message.assistant.tts-playing {
            animation: pulse 2s infinite;
            border-left-color: #ff9800;
        }
        
        .message.assistant.tts-completed {
            border-left-color: #2196f3;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .live2d-container {
                right: 10px;
                width: 250px;
            }
            
            .live2d-bubble {
                max-width: 200px;
                font-size: 13px;
                padding: 10px 14px;
            }
            
            .tts-error-notification {
                right: 10px;
                font-size: 11px;
                padding: 6px 10px;
            }
            
            .preset-configs button {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-description {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        .cancel-btn,
        .create-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .create-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .create-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹çš„å¼¹çª—æ ·å¼ */
        body.dark-mode .modal-content {
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        body.dark-mode .form-group input[type="text"],
        body.dark-mode .form-group textarea {
            background-color: #34495e;
            border-color: #4a5f7a;
            color: #ecf0f1;
        }

        body.dark-mode .form-group input[type="text"]:focus,
        body.dark-mode .form-group textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        body.dark-mode .form-description {
            color: #bdc3c7;
        }

        body.dark-mode .form-actions {
            border-top-color: #4a5f7a;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§Tabå¯¼èˆª -->
    <div class="sidebar">
        <button class="tab-button active" data-tab="chat" title="èŠå¤©">
            ğŸ’¬
        </button>
        <button class="tab-button" data-tab="settings" title="è®¾ç½®">
            âš™ï¸
        </button>
        <button class="tab-button" data-tab="logs" title="æ—¥å¿—">
            ğŸ“‹
        </button>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- èŠå¤©Tabå†…å®¹ -->
        <div class="tab-content active" id="chat-tab">
            <div class="chat-container">
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIèŠå¤©æœºå™¨äººç³»ç»Ÿ</h1>
            <p>åŸºäºJava21çš„æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ - æ”¯æŒæµå¼å“åº”ã€å¤šäººè®¾ã€é•¿æœŸè®°å¿†</p>
        </div>
        
        <div class="status" id="status">
            ğŸ”´ æœªè¿æ¥
        </div>
        
        <div class="ollama-status" id="ollamaStatus">
            ğŸ¤– æ­£åœ¨æ£€æŸ¥OllamaæœåŠ¡çŠ¶æ€...
        </div>
        
        <div class="persona-selector">
            <div>
                <label>é€‰æ‹©äººè®¾: </label>
                <select id="personaSelect">
                    <option value="default">æ™ºèƒ½åŠ©æ‰‹</option>
                    <option value="advisor">ä¸“ä¸šé¡¾é—®</option>
                    <option value="creative">åˆ›æ„åŠ©æ‰‹</option>
                </select>
            </div>
            <div class="thinking-toggle">
                <label for="thinkingToggle">æ˜¾ç¤ºæ€è€ƒ:</label>
                <div class="toggle-switch" id="thinkingToggle" title="åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºAIçš„æ€è€ƒè¿‡ç¨‹"></div>
            </div>
            <div class="tts-toggle">
                <label for="ttsToggle">å¼€å¯TTS:</label>
                <div class="toggle-switch" id="ttsToggle" title="åˆ‡æ¢èŠå¤©çª—å£è¯­éŸ³è¾“å‡ºæ¨¡å¼"></div>
            </div>
            <div class="web-search-toggle">
                <label for="webSearchToggle">è”ç½‘æœç´¢:</label>
                <div class="toggle-switch" id="webSearchToggle" title="åˆ‡æ¢æ˜¯å¦å¯ç”¨è”ç½‘æœç´¢åŠŸèƒ½"></div>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="message system">æ¬¢è¿ä½¿ç”¨AIèŠå¤©æœºå™¨äººç³»ç»Ÿï¼æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
        </div>
        
        <div class="input-container">
            <input type="text" id="messageInput" class="message-input" 
                   placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." disabled>
            <button id="interruptBtn" class="interrupt-btn" title="åœæ­¢AIå›å¤">
                <span class="interrupt-icon">â¹</span>åœæ­¢
            </button>
            <button id="sendBtn" class="send-btn" disabled>å‘é€</button>
        </div>
    </div>
            </div>
        </div>

        <!-- è®¾ç½®Tabå†…å®¹ -->
        <div class="tab-content" id="settings-tab">
            <div class="settings-container">
                <div class="container">
                    <div class="header">
                        <h1>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h1>
                        <p>ç³»ç»Ÿé…ç½®å’Œä¸ªæ€§åŒ–é€‰é¡¹</p>
                    </div>
                    
                    <div class="settings-content">
                        <!-- é…ç½®æ“ä½œæŒ‰é’® -->
                        <div class="settings-actions">
                            <button id="saveSettingsBtn" class="save-btn">ğŸ’¾ ä¿å­˜é…ç½®</button>
                            <button id="resetSettingsBtn" class="reset-btn">ğŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
                            <button id="exportSettingsBtn" class="export-btn">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
                            <button id="importSettingsBtn" class="import-btn">ğŸ“¥ å¯¼å…¥é…ç½®</button>
                            <input type="file" id="importFileInput" accept=".json" style="display: none;">
                        </div>
                        
                        <!-- ç•Œé¢è®¾ç½® -->
                        <div class="setting-section">
                            <h3>ğŸ¨ ç•Œé¢è®¾ç½®</h3>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="darkModeToggle"> æ·±è‰²æ¨¡å¼
                                </label>
                                <span class="setting-description">åˆ‡æ¢æ·±è‰²/æµ…è‰²ä¸»é¢˜</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="animationsToggle" checked> å¯ç”¨åŠ¨ç”»æ•ˆæœ
                                </label>
                                <span class="setting-description">å¯ç”¨ç•Œé¢åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœ</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="autoScrollToggle" checked> è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                </label>
                                <span class="setting-description">æ–°æ¶ˆæ¯æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="soundNotificationToggle"> æ¶ˆæ¯æç¤ºéŸ³
                                </label>
                                <span class="setting-description">æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶æ’­æ”¾æç¤ºéŸ³</span>
                            </div>
                            <div class="setting-item">
                                <label for="languageSelect">ç•Œé¢è¯­è¨€:</label>
                                <select id="languageSelect">
                                    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                                    <option value="en-US">English</option>
                                    <option value="ja-JP">æ—¥æœ¬èª</option>
                                </select>
                                <span class="setting-description">é€‰æ‹©ç•Œé¢æ˜¾ç¤ºè¯­è¨€</span>
                            </div>
                        </div>
                        
                        <!-- Ollamaè®¾ç½® -->
                        <div class="setting-section">
                            <h3>ğŸ¤– Ollamaè®¾ç½®</h3>
                            <div class="setting-item">
                                <label for="ollamaUrlInput">OllamaæœåŠ¡åœ°å€:</label>
                                <input type="url" id="ollamaUrlInput" placeholder="http://localhost:11434" value="http://localhost:11434">
                                <span class="setting-description">OllamaæœåŠ¡çš„è®¿é—®åœ°å€</span>
                            </div>
                            <div class="setting-item">
                                <label for="ollamaModelInput">ä½¿ç”¨æ¨¡å‹:</label>
                                <input type="text" id="ollamaModelInput" placeholder="qwen3:4b" value="qwen3:4b">
                                <span class="setting-description">æŒ‡å®šä½¿ç”¨çš„AIæ¨¡å‹åç§°</span>
                            </div>
                            <div class="setting-item">
                                <label for="ollamaTimeoutInput">è¿æ¥è¶…æ—¶ (æ¯«ç§’):</label>
                                <input type="number" id="ollamaTimeoutInput" min="5000" max="120000" step="1000" value="30000">
                                <span class="setting-description">OllamaæœåŠ¡è¿æ¥è¶…æ—¶æ—¶é—´</span>
                            </div>
                            <div class="setting-item">
                                <label for="ollamaMaxTokensInput">æœ€å¤§è¾“å‡ºé•¿åº¦:</label>
                                <input type="number" id="ollamaMaxTokensInput" min="512" max="8192" step="256" value="4096">
                                <span class="setting-description">å•æ¬¡å›å¤çš„æœ€å¤§é•¿åº¦é™åˆ¶</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="ollamaStreamToggle" checked> å¯ç”¨æµå¼è¾“å‡º
                                </label>
                                <span class="setting-description">å®æ—¶æ˜¾ç¤ºAIå›å¤è¿‡ç¨‹</span>
                            </div>
                        </div>
                        
                        <!-- è”ç½‘æœç´¢è®¾ç½® -->
                        <div class="setting-section">
                            <h3>ğŸŒ è”ç½‘æœç´¢è®¾ç½®</h3>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="webSearchEnabledToggle"> å¯ç”¨è”ç½‘æœç´¢
                                </label>
                                <span class="setting-description">å…¨å±€å¯ç”¨/ç¦ç”¨è”ç½‘æœç´¢åŠŸèƒ½</span>
                            </div>
                            <div class="setting-item">
                                <label for="webSearchEngineSelect">æœç´¢å¼•æ“:</label>
                                <select id="webSearchEngineSelect">
                                    <option value="duckduckgo">DuckDuckGo</option>
                                    <option value="google">Google</option>
                                    <option value="bing">Bing</option>
                                </select>
                                <span class="setting-description">é€‰æ‹©é»˜è®¤æœç´¢å¼•æ“</span>
                            </div>
                            <div class="setting-item">
                                <label for="webSearchMaxResultsInput">æœ€å¤§æœç´¢ç»“æœæ•°:</label>
                                <input type="number" id="webSearchMaxResultsInput" min="1" max="20" value="5">
                                <span class="setting-description">æ¯æ¬¡æœç´¢è¿”å›çš„æœ€å¤§ç»“æœæ•°é‡</span>
                            </div>
                            <div class="setting-item">
                                <label for="webSearchTimeoutInput">æœç´¢è¶…æ—¶ (ç§’):</label>
                                <input type="number" id="webSearchTimeoutInput" min="5" max="60" value="10">
                                <span class="setting-description">æœç´¢è¯·æ±‚çš„è¶…æ—¶æ—¶é—´</span>
                            </div>
                        </div>
                        
                        <!-- TTSè¯­éŸ³è®¾ç½® -->
                        <div class="setting-section">
                            <h3>ğŸ”Š TTSè¯­éŸ³è®¾ç½®</h3>
                            <div class="setting-item">
                                <label>å½“å‰TTSæ¨¡å¼:</label>
                                <span id="currentTTSMode" class="current-mode-display">æ¨¡å¼1 - çº¯æ–‡æœ¬</span>
                                <span class="setting-description">å½“å‰æ¿€æ´»çš„è¯­éŸ³è¾“å‡ºæ¨¡å¼ï¼ˆé€šè¿‡èŠå¤©çª—å£åˆ‡æ¢ï¼‰</span>
                            </div>
                            <div class="setting-item">
                                <label for="cosyVoiceSpeakerSelect">è¯­éŸ³äººè®¾:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <select id="cosyVoiceSpeakerSelect" style="flex: 1;">
                                        <option value="">è¯·é€‰æ‹©è¯­éŸ³äººè®¾...</option>
                                    </select>
                                    <button id="refreshSpeakersBtn" type="button">åˆ·æ–°</button>
                                    <button id="addCustomSpeakerBtn" type="button">æ–°å¢è¯­éŸ³äººè®¾</button>
                                </div>
                                <span class="setting-description">é€‰æ‹©CosyVoice TTSæœåŠ¡çš„è¯­éŸ³äººè®¾</span>
                            </div>
                            <div class="setting-item">
                                <label for="testVoiceText">æµ‹è¯•äººè®¾è¯­éŸ³:</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" id="testVoiceText" placeholder="è¯·è¾“å…¥è¦æµ‹è¯•çš„æ–‡æœ¬..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button id="generateVoiceBtn" type="button">ç”Ÿæˆè¯­éŸ³</button>
                                </div>
                                <div id="voiceTestResult" style="margin-top: 10px; min-height: 40px;">
                                    <!-- éŸ³é¢‘æ’­æ”¾å™¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                </div>
                                <span class="setting-description">è¾“å…¥æ–‡æœ¬æµ‹è¯•å½“å‰é€‰ä¸­çš„è¯­éŸ³äººè®¾æ•ˆæœ</span>
                            </div>
                            <div class="setting-item">
                                <label for="ttsSpeedRange">è¯­éŸ³é€Ÿåº¦:</label>
                                <input type="range" id="ttsSpeedRange" min="0.5" max="2.0" step="0.1" value="1.0">
                                <span id="ttsSpeedValue">1.0x</span>
                                <span class="setting-description">è°ƒæ•´è¯­éŸ³æ’­æ”¾é€Ÿåº¦</span>
                            </div>
                        </div>
                        
                        
                        <!-- ç³»ç»Ÿä¿¡æ¯ -->
                        <div class="setting-section">
                            <h3>ğŸ”§ ç³»ç»Ÿä¿¡æ¯</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">ç‰ˆæœ¬:</span>
                                    <span class="info-value">v1.0.0</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">è¿æ¥çŠ¶æ€:</span>
                                    <span class="info-value" id="connectionStatus">æœªè¿æ¥</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">é…ç½®çŠ¶æ€:</span>
                                    <span class="info-value" id="configStatus">æœªåŠ è½½</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æœ€åä¿å­˜:</span>
                                    <span class="info-value" id="lastSavedTime">ä»æœªä¿å­˜</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—Tabå†…å®¹ -->
        <div class="tab-content" id="logs-tab">
            <div class="logs-container">
                <div class="container">
                    <div class="header">
                        <h1>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h1>
                        <p>å®æ—¶æŸ¥çœ‹ç³»ç»Ÿè¿è¡Œæ—¥å¿—å’ŒçŠ¶æ€ä¿¡æ¯</p>
                    </div>
                    
                    <div class="logs-content">
                        <div class="log-controls">
                            <div>
                                <button id="refreshLogsBtn" class="refresh-btn">ğŸ”„ åˆ·æ–°æ—¥å¿—</button>
                                <button id="clearLogsBtn" class="clear-btn">ğŸ—‘ï¸ æ¸…ç©ºæ˜¾ç¤º</button>
                            </div>
                            <div>
                                <label for="logLevelSelect">æ—¥å¿—çº§åˆ«:</label>
                                <select id="logLevelSelect">
                                    <option value="ALL">å…¨éƒ¨</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="WARN">WARN</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="TRACE">TRACE</option>
                                </select>
                            </div>
                            <div>
                                <label for="timeRangeSelect">æ—¶é—´èŒƒå›´:</label>
                                <select id="timeRangeSelect">
                                    <option value="30m" selected>æœ€è¿‘30åˆ†é’Ÿ</option>
                                    <option value="1h">æœ€è¿‘1å°æ—¶</option>
                                    <option value="3h">æœ€è¿‘3å°æ—¶</option>
                                    <option value="12h">æœ€è¿‘åŠå¤©</option>
                                    <option value="1d">æœ€è¿‘1å¤©</option>
                                    <option value="custom">è‡ªå®šä¹‰æ—¶é—´æ®µ</option>
                                    <option value="all">å…¨éƒ¨æ—¶é—´</option>
                                </select>
                            </div>
                            <div class="auto-refresh-toggle">
                                <label for="autoRefreshToggle">è‡ªåŠ¨åˆ·æ–°:</label>
                                <div class="toggle-switch active" id="autoRefreshToggle" title="åˆ‡æ¢æ˜¯å¦è‡ªåŠ¨åˆ·æ–°æ—¥å¿—"></div>
                                <select id="refreshIntervalSelect">
                                    <option value="5">5ç§’</option>
                                    <option value="10" selected>10ç§’</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="custom-time-range" id="customTimeRange" style="display: none;">
                            <div>
                                <label for="startTimeInput">å¼€å§‹æ—¶é—´:</label>
                                <input type="datetime-local" id="startTimeInput">
                            </div>
                            <div>
                                <label for="endTimeInput">ç»“æŸæ—¶é—´:</label>
                                <input type="datetime-local" id="endTimeInput">
                            </div>
                            <button id="applyCustomTimeBtn" class="refresh-btn">åº”ç”¨æ—¶é—´æ®µ</button>
                        </div>
                        
                        <div class="log-viewer" id="logViewer">
                            <div class="log-entry">
                                <span class="log-message">æ­£åœ¨åŠ è½½æ—¥å¿—...</span>
                            </div>
                        </div>
                        
                        <div class="log-stats">
                            <h4>ğŸ“Š æ—¥å¿—ç»Ÿè®¡</h4>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">æ€»æ¡æ•°:</span>
                                    <span class="stat-value" id="totalLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">é”™è¯¯:</span>
                                    <span class="stat-value" id="errorLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">è­¦å‘Š:</span>
                                    <span class="stat-value" id="warnLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ä¿¡æ¯:</span>
                                    <span class="stat-value" id="infoLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">æœ€åæ›´æ–°:</span>
                                    <span class="stat-value" id="lastUpdate">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentSessionId = null;
        let isConnected = false;
        let currentAssistantMessage = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let showThinking = true; // æ€è€ƒæ˜¾ç¤ºçŠ¶æ€
        let useWebSearch = false; // è”ç½‘æœç´¢çŠ¶æ€
        let isAIResponding = false; // AIæ˜¯å¦æ­£åœ¨å›å¤
        let currentStreamingMessage = null; // å½“å‰æµå¼æ¶ˆæ¯å…ƒç´ 
        let aiResponseTimeout = null; // AIå“åº”è¶…æ—¶å®šæ—¶å™¨
        let timeoutMessageShown = false; // é˜²æ­¢é‡å¤æ˜¾ç¤ºè¶…æ—¶æ¶ˆæ¯çš„æ ‡å¿—
        let lastAIActivityTime = null; // æœ€åä¸€æ¬¡AIæ´»åŠ¨æ—¶é—´
        let activityCheckInterval = null; // æ´»åŠ¨æ£€æµ‹å®šæ—¶å™¨
        
        // TTSç›¸å…³å˜é‡
        let currentTTSMode = 'text_only'; // å½“å‰TTSæ¨¡å¼
        let ttsSettings = {
            chatEnabled: false,
            chatMode: 'text_only',
            speed: 1.0,
            spk_id: null // CosyVoiceè¯­éŸ³äººè®¾ID
        };
        
        // æ—¥å¿—ç›¸å…³å˜é‡
        let autoRefreshLogs = true; // è‡ªåŠ¨åˆ·æ–°æ—¥å¿—çŠ¶æ€ - é»˜è®¤å¼€å¯
        let logRefreshInterval = null; // æ—¥å¿—åˆ·æ–°å®šæ—¶å™¨
        let refreshIntervalSeconds = 10; // é»˜è®¤åˆ·æ–°é—´éš”10ç§’
        let isLogsTabActive = false; // æ—¥å¿—tabæ˜¯å¦æ¿€æ´»
        let logStats = {
            total: 0,
            error: 0,
            warn: 0,
            info: 0,
            debug: 0
        };

        const statusDiv = document.getElementById('status');
        const ollamaStatusDiv = document.getElementById('ollamaStatus');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const interruptBtn = document.getElementById('interruptBtn');
        const personaSelect = document.getElementById('personaSelect');
        const thinkingToggle = document.getElementById('thinkingToggle');
        const ttsToggle = document.getElementById('ttsToggle');
        const webSearchToggle = document.getElementById('webSearchToggle');
        
        // æ—¥å¿—ç›¸å…³DOMå…ƒç´ 
        const logViewer = document.getElementById('logViewer');
        const refreshLogsBtn = document.getElementById('refreshLogsBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        const logLevelSelect = document.getElementById('logLevelSelect');
        const refreshIntervalSelect = document.getElementById('refreshIntervalSelect');
        const timeRangeSelect = document.getElementById('timeRangeSelect');
        const customTimeRange = document.getElementById('customTimeRange');
        const startTimeInput = document.getElementById('startTimeInput');
        const endTimeInput = document.getElementById('endTimeInput');
        const applyCustomTimeBtn = document.getElementById('applyCustomTimeBtn');
        const totalLogsSpan = document.getElementById('totalLogs');
        const errorLogsSpan = document.getElementById('errorLogs');
        const warnLogsSpan = document.getElementById('warnLogs');
        const infoLogsSpan = document.getElementById('infoLogs');
        const lastUpdateSpan = document.getElementById('lastUpdate');

        // è¿æ¥WebSocket
        function connect() {
            if (reconnectAttempts === 0) {
                updateStatus('connecting', 'ğŸŸ¡ æ­£åœ¨è¿æ¥...');
            }
            
            const wsUrl = `ws://${window.location.host}/ws/chat`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                isConnected = true;
                reconnectAttempts = 0;
                updateStatus('connected', 'ğŸŸ¢ å·²è¿æ¥');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                
                addMessage('system', 'è¿æ¥æˆåŠŸï¼æ‚¨å¯ä»¥å¼€å§‹å¯¹è¯äº†ã€‚');
                checkOllamaStatus();
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleIncomingMessage(message);
                } catch (e) {
                    console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e);
                }
            };

            ws.onclose = function() {
                isConnected = false;
                updateStatus('disconnected', 'ğŸ”´ è¿æ¥æ–­å¼€');
                messageInput.disabled = true;
                sendBtn.disabled = true;
                
                // é‡ç½®AIå“åº”çŠ¶æ€ï¼ˆè¿æ¥æ–­å¼€æ—¶ï¼‰
                console.log('ğŸ”Œ WebSocketè¿æ¥æ–­å¼€ - é‡ç½®AIçŠ¶æ€');
                isAIResponding = false;
                hideInterruptButton();
                enableChatControls();
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    addMessage('system', `è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡è¿... (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
                    reconnectAttempts++;
                    setTimeout(connect, 3000);
                } else {
                    addMessage('system', 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ååˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                addMessage('system', 'è¿æ¥å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ã€‚');
                
                // é‡ç½®AIå“åº”çŠ¶æ€ï¼ˆè¿æ¥é”™è¯¯æ—¶ï¼‰
                console.log('âŒ WebSocketè¿æ¥é”™è¯¯ - é‡ç½®AIçŠ¶æ€');
                isAIResponding = false;
                hideInterruptButton();
                enableChatControls();
            };
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(type, text) {
            statusDiv.innerHTML = text;
            statusDiv.className = 'status';
            if (type === 'disconnected') {
                statusDiv.classList.add('disconnected');
            } else if (type === 'connecting') {
                statusDiv.classList.add('connecting');
            }
        }

        // æ£€æŸ¥OllamaæœåŠ¡çŠ¶æ€
        function checkOllamaStatus() {
            // å‘é€ä¸€ä¸ªæ£€æŸ¥æœåŠ¡çŠ¶æ€çš„æ¶ˆæ¯
            if (ws && isConnected) {
                const checkMessage = {
                    type: 'system',
                    content: 'check_ollama_status',
                    metadata: { action: 'check_service' }
                };
                ws.send(JSON.stringify(checkMessage));
            }
        }

        // å¤šé€šé“æ¶ˆæ¯è·¯ç”±å™¨
        class MultiChannelRouter {
            constructor() {
                this.channels = new Map();
                this.registerChannels();
            }
            
            registerChannels() {
                this.channels.set('chat_window', new ChatWindowHandler());
                this.channels.set('live2d', new Live2DHandler());
            }
            
            routeMessage(message) {
                const channelType = message.channelType || 'chat_window';
                const handler = this.channels.get(channelType);
                
                if (handler) {
                    handler.handleMessage(message);
                } else {
                    console.warn('æœªçŸ¥çš„é€šé“ç±»å‹:', channelType, message);
                    // æŠ›å‡ºå¼‚å¸¸è®©å¤–å±‚å¤„ç†
                    throw new Error(`æœªçŸ¥çš„é€šé“ç±»å‹: ${channelType}`);
                }
            }
            
            // å…¼å®¹æ—§ç‰ˆæœ¬æ¶ˆæ¯å¤„ç†
            handleLegacyMessage(message) {
                const chatHandler = this.channels.get('chat_window');
                if (chatHandler) {
                    chatHandler.handleMessage(message);
                }
            }
            
            getChannel(channelType) {
                return this.channels.get(channelType);
            }
        }
        
        // èŠå¤©çª—å£å¤„ç†å™¨
        class ChatWindowHandler {
            constructor() {
                this.audioManager = new CharStreamAudioManager();
                this.currentAssistantMessage = null;
            }
            
            handleMessage(message) {
                console.log('ğŸ  èŠå¤©çª—å£å¤„ç†æ¶ˆæ¯:', message);
                
                switch(message.type) {
                    case 'text':
                        this.handleTextMessage(message);
                        break;
                    case 'audio':
                        this.handleAudioMessage(message);
                        break;
                    case 'tts_error':
                        this.handleTTSError(message);
                        break;
                    default:
                        console.log('èŠå¤©çª—å£æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:', message.type);
                }
            }
            
            handleTextMessage(message) {
                removeTypingIndicator();
                
                // å¦‚æœæ˜¯æ€è€ƒå†…å®¹ï¼Œä½¿ç”¨ä¼ ç»Ÿçš„æµå¼æ¶ˆæ¯å¤„ç†ï¼ˆä¸è§¦å‘TTSï¼‰
                if (message.thinking) {
                    console.log('ğŸ§  å¤„ç†æ€è€ƒå†…å®¹ï¼Œè·³è¿‡TTS:', message);
                    if (message.streaming) {
                        if (!isAIResponding) {
                            console.log('ğŸš€ å¼€å§‹AIå›å¤ (æ€è€ƒæµå¼æ¶ˆæ¯)');
                            isAIResponding = true;
                            showInterruptButton();
                            disableChatControls();
                            setAIResponseTimeout();
                        }
                        handleStreamingMessage(message);
                    } else {
                        recordAIActivity(); // è®°å½•æœ€åä¸€æ¬¡æ´»åŠ¨
                        addMessage('assistant', message.content);
                        // é‡ç½®AIå“åº”çŠ¶æ€ï¼ˆæ€è€ƒæ¶ˆæ¯å®Œæˆï¼‰
                        console.log('âœ… AIå›å¤ç»“æŸ (æ€è€ƒéæµå¼æ¶ˆæ¯)');
                        isAIResponding = false;
                        clearAIResponseTimeout();
                        hideInterruptButton();
                        enableSendButton();
                        enableChatControls();
                    }
                    return;
                }
                
                if (message.ttsMode === 'char_stream') {
                    // æ¨¡å¼2ï¼šå­—ç¬¦æµ+TTS
                    if (!isAIResponding) {
                        console.log('ğŸš€ å¼€å§‹AIå›å¤ (å­—ç¬¦æµæ¨¡å¼)');
                        isAIResponding = true;
                        showInterruptButton();
                        disableChatControls();
                        setAIResponseTimeout();
                    }
                    this.handleCharStreamText(message);
                } else if (message.streaming) {
                    // ä¼ ç»Ÿæµå¼æ¶ˆæ¯
                    if (!isAIResponding) {
                        console.log('ğŸš€ å¼€å§‹AIå›å¤ (ä¼ ç»Ÿæµå¼æ¶ˆæ¯)');
                        isAIResponding = true;
                        showInterruptButton();
                        disableChatControls();
                        setAIResponseTimeout();
                    }
                    handleStreamingMessage(message);
                } else {
                    // æ™®é€šæ–‡æœ¬æ¶ˆæ¯ - éœ€è¦é‡ç½®AIçŠ¶æ€
                    recordAIActivity(); // è®°å½•æœ€åä¸€æ¬¡æ´»åŠ¨
                    addMessage('assistant', message.content);
                    // é‡ç½®AIå“åº”çŠ¶æ€
                    console.log('âœ… AIå›å¤ç»“æŸ (æ™®é€šæ–‡æœ¬æ¶ˆæ¯)');
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableSendButton();
                    enableChatControls();
                }
            }
            
            handleCharStreamText(message) {
                // è®°å½•AIæ´»åŠ¨
                recordAIActivity();
                
                // ä¸ºæ¯ä¸ªæ–°çš„AIå›å¤åˆ›å»ºæ–°çš„æ¶ˆæ¯æ°”æ³¡
                if (!this.currentAssistantMessage || message.sentenceOrder === 0) {
                    this.currentAssistantMessage = this.createMessage('assistant');
                    console.log('ğŸ†• åˆ›å»ºæ–°çš„åŠ©æ‰‹æ¶ˆæ¯æ°”æ³¡');
                }
                
                // ç«‹å³æ˜¾ç¤ºæ–‡æœ¬
                this.appendText(this.currentAssistantMessage, message.content);
                
                if (message.streamComplete) {
                    this.currentAssistantMessage = null;
                    enableSendButton();
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableChatControls();
                    console.log('âœ… å­—ç¬¦æµæ¨¡å¼å®Œæˆï¼Œé‡ç½®çŠ¶æ€');
                }
            }
            
            handleAudioMessage(message) {
                if (message.ttsMode === 'char_stream') {
                    // æ¨¡å¼2ï¼šå¼‚æ­¥éŸ³é¢‘æ’­æ”¾
                    this.audioManager.addAudio(
                        message.audioData, 
                        message.sentenceId || this.generateId(), 
                        message.content
                    );
                }
            }
            
            handleTTSError(message) {
                console.warn('TTSé”™è¯¯:', message.content);
                // å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªå°çš„é”™è¯¯æç¤º
                this.showTTSError(message.content);
            }
            
            createMessage(sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                chatContainer.appendChild(messageDiv);
                scrollToBottom();
                return messageDiv;
            }
            
            appendText(element, text) {
                element.textContent += text;
                scrollToBottom();
            }
            
            showTTSError(errorText) {
                // æ˜¾ç¤ºä¸€ä¸ªä¸´æ—¶çš„é”™è¯¯æç¤º
                const errorDiv = document.createElement('div');
                errorDiv.className = 'tts-error-notification';
                errorDiv.textContent = 'ğŸ”‡ ' + errorText;
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #ffebee;
                    color: #c62828;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    opacity: 0.9;
                `;
                
                document.body.appendChild(errorDiv);
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 3000);
            }
            
            generateId() {
                return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
        }
        
        // Live2Då¤„ç†å™¨
        class Live2DHandler {
            constructor() {
                this.sentenceSyncManager = new StrictSentenceSyncManager();
                this.live2dController = null; // å°†æ¥è¿æ¥Live2D
            }
            
            handleMessage(message) {
                console.log('ğŸ¨ Live2Då¤„ç†æ¶ˆæ¯:', message);
                
                switch(message.type) {
                    case 'live2d_sentence_display':
                        this.sentenceSyncManager.handleSentenceDisplay(message);
                        this.showLive2DBubble(message);
                        break;
                    case 'live2d_sentence_audio':
                        this.sentenceSyncManager.handleSentenceAudio(message);
                        break;
                    case 'live2d_audio_failed':
                        this.sentenceSyncManager.handleAudioFailed(message);
                        break;
                    case 'live2d_all_complete':
                        this.handleAllComplete(message);
                        break;
                    default:
                        console.log('Live2Dæœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:', message.type);
                }
            }
            
            showLive2DBubble(message) {
                // æ˜¾ç¤ºLive2Dæ°”æ³¡
                if (this.live2dController) {
                    this.live2dController.showBubble(message.content, message.sentenceId);
                } else {
                    // é™çº§æ˜¾ç¤ºï¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºLive2Dæ°”æ³¡
                    this.showFallbackBubble(message.content, message.sentenceId);
                }
            }
            
            showFallbackBubble(text, sentenceId) {
                // åœ¨é¡µé¢å³ä¾§æ˜¾ç¤ºLive2Dé£æ ¼çš„æ°”æ³¡
                const bubble = document.createElement('div');
                bubble.className = 'live2d-bubble';
                bubble.dataset.sentenceId = sentenceId;
                bubble.textContent = text;
                
                const live2dContainer = document.querySelector('.live2d-container') || 
                                       this.createLive2DContainer();
                live2dContainer.appendChild(bubble);
                
                // æ·»åŠ åŠ¨ç”»
                bubble.style.opacity = '0';
                bubble.style.transform = 'scale(0.8) translateY(20px)';
                
                requestAnimationFrame(() => {
                    bubble.style.transition = 'all 0.3s ease';
                    bubble.style.opacity = '1';
                    bubble.style.transform = 'scale(1) translateY(0)';
                });
            }
            
            createLive2DContainer() {
                const container = document.createElement('div');
                container.className = 'live2d-container';
                container.style.cssText = `
                    position: fixed;
                    right: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 300px;
                    z-index: 1000;
                    pointer-events: none;
                `;
                document.body.appendChild(container);
                return container;
            }
            
            handleAllComplete(message) {
                console.log('âœ… Live2Dæ‰€æœ‰å¥å­å¤„ç†å®Œæˆ - é‡ç½®AIçŠ¶æ€');
                // é‡ç½®AIå“åº”çŠ¶æ€
                isAIResponding = false;
                clearAIResponseTimeout();
                hideInterruptButton();
                enableSendButton();
                enableChatControls();
            }
        }
        
        // å­—ç¬¦æµéŸ³é¢‘ç®¡ç†å™¨
        class CharStreamAudioManager {
            constructor() {
                this.audioQueue = [];
                this.isPlaying = false;
                this.currentAudio = null;
            }
            
            addAudio(audioData, sentenceId, text) {
                if (!audioData) {
                    console.warn('éŸ³é¢‘æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡æ’­æ”¾');
                    return;
                }
                
                try {
                    // å°†Base64éŸ³é¢‘æ•°æ®è½¬æ¢ä¸ºBlob
                    const binaryString = atob(audioData);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    const audioBlob = new Blob([bytes], {type: 'audio/mp3'});
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    const audioItem = {
                        id: sentenceId,
                        text: text,
                        audio: new Audio(audioUrl),
                        timestamp: Date.now()
                    };
                    
                    this.audioQueue.push(audioItem);
                    
                    // å¦‚æœå½“å‰æ²¡æœ‰æ’­æ”¾ï¼Œç«‹å³å¼€å§‹æ’­æ”¾
                    if (!this.isPlaying) {
                        this.playNext();
                    }
                } catch (error) {
                    console.error('å¤„ç†éŸ³é¢‘æ•°æ®å¤±è´¥:', error);
                }
            }
            
            async playNext() {
                if (this.audioQueue.length === 0) {
                    this.isPlaying = false;
                    return;
                }
                
                this.isPlaying = true;
                const audioItem = this.audioQueue.shift();
                this.currentAudio = audioItem.audio;
                
                try {
                    await this.playAudio(audioItem.audio);
                } catch (error) {
                    console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                } finally {
                    // æ’­æ”¾ä¸‹ä¸€ä¸ª
                    setTimeout(() => this.playNext(), 100); // å¥å­é—´100msé—´éš”
                }
            }
            
            playAudio(audio) {
                return new Promise((resolve, reject) => {
                    audio.onended = resolve;
                    audio.onerror = reject;
                    audio.play().catch(reject);
                });
            }
            
            skipCurrent() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.playNext();
                }
            }
            
            clearQueue() {
                this.audioQueue = [];
                if (this.currentAudio) {
                    this.currentAudio.pause();
                }
                this.isPlaying = false;
            }
        }
        
        // ä¸¥æ ¼å¥å­åŒæ­¥ç®¡ç†å™¨
        class StrictSentenceSyncManager {
            constructor() {
                this.currentSentence = null;
                this.isWaitingForAudio = false;
                this.isPlayingAudio = false;
            }
            
            handleSentenceDisplay(message) {
                // åªæœ‰åœ¨æ²¡æœ‰å½“å‰å¥å­æ—¶æ‰æ˜¾ç¤ºæ–°å¥å­
                if (this.currentSentence === null) {
                    this.displaySentence(message);
                } else {
                    console.error('æ”¶åˆ°æ–°å¥å­ä½†å½“å‰å¥å­æœªå®Œæˆ:', message);
                }
            }
            
            handleSentenceAudio(message) {
                if (this.currentSentence && 
                    this.currentSentence.sentenceId === message.sentenceId) {
                    
                    if (message.audioData) {
                        this.playAudio(message.audioData);
                    } else {
                        // TTSå¤±è´¥ï¼Œè·³è¿‡éŸ³é¢‘ç›´æ¥å®Œæˆ
                        this.completeSentence();
                    }
                }
            }
            
            handleAudioFailed(message) {
                if (this.currentSentence && 
                    this.currentSentence.sentenceId === message.sentenceId) {
                    
                    this.markAudioFailed();
                    this.completeSentence();
                }
            }
            
            displaySentence(message) {
                // åˆ›å»ºå¥å­æ°”æ³¡
                const bubble = this.createSentenceBubble(message.content, message.sentenceId);
                
                this.currentSentence = {
                    sentenceId: message.sentenceId,
                    order: message.sentenceOrder,
                    text: message.content,
                    element: bubble,
                    audio: null
                };
                
                this.isWaitingForAudio = true;
                
                // æ˜¾ç¤ºç­‰å¾…éŸ³é¢‘çš„çŠ¶æ€
                bubble.classList.add('waiting-for-audio');
                this.showWaitingIndicator(bubble);
            }
            
            async playAudio(audioData) {
                if (!this.currentSentence) return;
                
                this.isWaitingForAudio = false;
                this.isPlayingAudio = true;
                
                try {
                    // å°†Base64éŸ³é¢‘æ•°æ®è½¬æ¢ä¸ºAudioå¯¹è±¡
                    const binaryString = atob(audioData);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    const audioBlob = new Blob([bytes], {type: 'audio/mp3'});
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    this.currentSentence.audio = audio;
                    this.currentSentence.element.classList.remove('waiting-for-audio');
                    this.currentSentence.element.classList.add('playing-audio');
                    
                    this.hideWaitingIndicator();
                    this.showPlayingIndicator(this.currentSentence.element);
                    
                    await this.playAudioWithPromise(audio);
                    this.completeSentence();
                } catch (error) {
                    console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                    this.markAudioFailed();
                    this.completeSentence();
                }
            }
            
            playAudioWithPromise(audio) {
                return new Promise((resolve, reject) => {
                    audio.onended = resolve;
                    audio.onerror = reject;
                    audio.play().catch(reject);
                });
            }
            
            completeSentence() {
                if (!this.currentSentence) return;
                
                this.isWaitingForAudio = false;
                this.isPlayingAudio = false;
                
                // æ ‡è®°å¥å­å®Œæˆ
                this.currentSentence.element.classList.remove('waiting-for-audio', 'playing-audio');
                this.currentSentence.element.classList.add('sentence-completed');
                
                this.hideAllIndicators();
                
                // é€šçŸ¥åç«¯éŸ³é¢‘æ’­æ”¾å®Œæˆï¼Œå¯ä»¥å‘é€ä¸‹ä¸€å¥
                this.notifyAudioCompleted(this.currentSentence.sentenceId);
                
                // æ¸…ç©ºå½“å‰å¥å­
                this.currentSentence = null;
            }
            
            notifyAudioCompleted(sentenceId) {
                const completionMessage = {
                    type: 'audio_playback_completed',
                    sentenceId: sentenceId,
                    timestamp: Date.now()
                };
                
                // é€šè¿‡WebSocketå‘é€ç»™åç«¯
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(completionMessage));
                    console.log('é€šçŸ¥åç«¯éŸ³é¢‘æ’­æ”¾å®Œæˆ:', sentenceId);
                }
            }
            
            createSentenceBubble(text, sentenceId) {
                const bubble = document.createElement('div');
                bubble.className = 'live2d-bubble';
                bubble.dataset.sentenceId = sentenceId;
                bubble.textContent = text;
                
                // æ·»åŠ åˆ°Live2Då®¹å™¨
                const container = document.querySelector('.live2d-container') || 
                                 this.createLive2DContainer();
                container.appendChild(bubble);
                
                // æ·»åŠ å‡ºç°åŠ¨ç”»
                bubble.style.opacity = '0';
                bubble.style.transform = 'translateY(20px)';
                bubble.style.transition = 'all 0.4s ease';
                
                requestAnimationFrame(() => {
                    bubble.style.opacity = '1';
                    bubble.style.transform = 'translateY(0)';
                });
                
                return bubble;
            }
            
            createLive2DContainer() {
                const container = document.createElement('div');
                container.className = 'live2d-container';
                container.style.cssText = `
                    position: fixed;
                    right: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 300px;
                    z-index: 1000;
                `;
                document.body.appendChild(container);
                return container;
            }
            
            showWaitingIndicator(bubble) {
                const indicator = document.createElement('div');
                indicator.className = 'audio-waiting-indicator';
                indicator.innerHTML = 'â³ æ­£åœ¨ç”Ÿæˆè¯­éŸ³...';
                bubble.appendChild(indicator);
            }
            
            hideWaitingIndicator() {
                if (this.currentSentence) {
                    const indicator = this.currentSentence.element.querySelector('.audio-waiting-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            }
            
            showPlayingIndicator(bubble) {
                const indicator = document.createElement('div');
                indicator.className = 'audio-playing-indicator';
                indicator.innerHTML = 'ğŸ”Š æ­£åœ¨æ’­æ”¾...';
                bubble.appendChild(indicator);
            }
            
            hideAllIndicators() {
                if (this.currentSentence) {
                    const indicators = this.currentSentence.element.querySelectorAll('.audio-waiting-indicator, .audio-playing-indicator');
                    indicators.forEach(indicator => indicator.remove());
                }
            }
            
            markAudioFailed() {
                if (this.currentSentence) {
                    this.currentSentence.element.classList.add('audio-failed');
                    const errorIcon = document.createElement('span');
                    errorIcon.className = 'audio-error-icon';
                    errorIcon.textContent = 'ğŸ”‡';
                    errorIcon.title = 'è¯­éŸ³ç”Ÿæˆå¤±è´¥';
                    this.currentSentence.element.appendChild(errorIcon);
                }
            }
            
            skipCurrentSentence() {
                if (this.currentSentence) {
                    if (this.currentSentence.audio) {
                        this.currentSentence.audio.pause();
                    }
                    this.completeSentence();
                }
            }
        }

        // åˆ›å»ºå…¨å±€å¤šé€šé“è·¯ç”±å™¨å®ä¾‹
        const multiChannelRouter = new MultiChannelRouter();

        // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯ - å¤šé€šé“ç‰ˆæœ¬
        function handleIncomingMessage(message) {
            // ç³»ç»Ÿæ¶ˆæ¯ç‰¹æ®Šå¤„ç†
            if (message.type === 'system') {
                if (!currentSessionId) {
                    currentSessionId = message.sessionId;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯OllamaçŠ¶æ€æ›´æ–°
                if (message.metadata && message.metadata.ollama_status) {
                    updateOllamaStatus(message.metadata.ollama_status === 'available');
                } else if (message.metadata && message.metadata.thinking_toggle) {
                    // å¤„ç†æ€è€ƒåˆ‡æ¢ç¡®è®¤
                    handleThinkingToggleConfirmation(message);
                } else if (message.metadata && message.metadata.web_search_toggle) {
                    // å¤„ç†è”ç½‘æœç´¢åˆ‡æ¢ç¡®è®¤
                    handleWebSearchToggleConfirmation(message);
                } else if (message.metadata && message.metadata.interrupt_confirmed) {
                    // å¤„ç†æ‰“æ–­ç¡®è®¤
                    handleInterruptConfirmation(message);
                } else {
                    addMessage('system', message.content);
                }
                return;
            }
            
            // é”™è¯¯æ¶ˆæ¯ç‰¹æ®Šå¤„ç†
            if (message.type === 'error') {
                removeTypingIndicator();
                addMessage('error', 'âŒ ' + message.content);
                // é‡ç½®AIå“åº”çŠ¶æ€
                isAIResponding = false;
                hideInterruptButton();
                enableSendButton();
                enableChatControls();
                return;
            }
            
            // ä½¿ç”¨å¤šé€šé“è·¯ç”±å™¨å¤„ç†å…¶ä»–æ¶ˆæ¯
            try {
                multiChannelRouter.routeMessage(message);
            } catch (error) {
                console.error('å¤šé€šé“æ¶ˆæ¯è·¯ç”±å¤±è´¥:', error, message);
                // é™çº§åˆ°ä¼ ç»Ÿå¤„ç†æ–¹å¼
                handleLegacyMessage(message);
            }
        }
        
        // ä¼ ç»Ÿæ¶ˆæ¯å¤„ç†ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
        function handleLegacyMessage(message) {
            if (message.type === 'text') {
                removeTypingIndicator();
                if (message.streaming) {
                    // æµå¼æ¶ˆæ¯å¤„ç†
                    if (!isAIResponding) {
                        isAIResponding = true;
                        showInterruptButton();
                        disableChatControls();
                        setAIResponseTimeout();
                    }
                    handleStreamingMessage(message);
                } else {
                    recordAIActivity(); // è®°å½•æœ€åä¸€æ¬¡æ´»åŠ¨
                    addMessage('assistant', message.content);
                    // é‡ç½®AIå“åº”çŠ¶æ€ï¼ˆéæµå¼æ¶ˆæ¯å®Œæˆï¼‰
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableSendButton();
                    enableChatControls();
                }
            }
        }
        
        // å¤„ç†æµå¼æ¶ˆæ¯
        function handleStreamingMessage(message) {
            console.log('ğŸ”„ å¤„ç†æµå¼æ¶ˆæ¯:', message);
            console.log('ğŸ”§ å½“å‰æ€è€ƒæ˜¾ç¤ºçŠ¶æ€:', showThinking);
            console.log('ğŸ”§ å½“å‰AIå“åº”çŠ¶æ€:', isAIResponding);
            console.log('ğŸ” æ¶ˆæ¯è¯¦ç»†ä¿¡æ¯:', {
                hasContent: !!message.content,
                contentLength: message.content ? message.content.length : 0,
                streaming: message.streaming,
                streamComplete: message.streamComplete,
                thinking: message.thinking,
                type: message.type
            });
            
            // é¦–å…ˆå¤„ç†æœ‰å†…å®¹çš„æ¶ˆæ¯
            if (message.content) {
                // è®°å½•AIæ´»åŠ¨
                recordAIActivity();
                
                console.log('ğŸ“ æ”¶åˆ°å†…å®¹:', {
                    content: message.content,
                    thinking: message.thinking,
                    hasCurrentMessage: !!currentAssistantMessage,
                    isMixedContent: currentAssistantMessage?.classList.contains('mixed-content')
                });
                
                // ç¡®ä¿æœ‰ä¸€ä¸ªæ··åˆå†…å®¹æ¶ˆæ¯æ¥æ¥æ”¶å†…å®¹
                // é‡è¦ï¼šæ¯æ¬¡æ–°çš„å¯¹è¯éƒ½åº”è¯¥åˆ›å»ºæ–°çš„æ¶ˆæ¯æ°”æ³¡
                if (!currentAssistantMessage || !currentAssistantMessage.classList.contains('mixed-content')) {
                    console.log('ğŸ†• åˆ›å»ºæ–°çš„æ··åˆå†…å®¹æ¶ˆæ¯');
                    currentAssistantMessage = addMixedContentMessage('', '');
                }
                
                // æœ‰å†…å®¹çš„æµå¼æ¶ˆæ¯
                if (message.thinking) {
                    console.log('ğŸ§  å¤„ç†æ€è€ƒå†…å®¹:', message.content);
                    appendToMixedContentMessage(message.content, '', true);
                } else {
                    console.log('ğŸ’¬ å¤„ç†æ™®é€šå†…å®¹:', message.content);
                    appendToMixedContentMessage('', message.content, false);
                }
                
                // å¦‚æœæµå¼æ¶ˆæ¯å®Œæˆï¼Œæ ‡è®°å®ŒæˆçŠ¶æ€
                if (message.streamComplete && currentAssistantMessage) {
                    console.log('âœ… å•ä¸ªæ¶ˆæ¯æµå®Œæˆ - é‡ç½®AIçŠ¶æ€');
                    currentAssistantMessage.dataset.streamable = 'false';
                    currentAssistantMessage.classList.add('stream-complete');
                    currentAssistantMessage = null;
                    enableSendButton();
                    // éšè—æ‰“æ–­æŒ‰é’®
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableChatControls();
                }
            } else if (message.streamComplete) {
                // å¤„ç†æ— å†…å®¹çš„å®Œæˆä¿¡å·
                console.log('âœ… æ”¶åˆ°æ— å†…å®¹çš„æµå¼å®Œæˆä¿¡å· - é‡ç½®AIçŠ¶æ€');
                if (currentAssistantMessage) {
                    currentAssistantMessage.dataset.streamable = 'false';
                    currentAssistantMessage.classList.add('stream-complete');
                    currentAssistantMessage = null;
                }
                // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                enableSendButton();
                // éšè—æ‰“æ–­æŒ‰é’®
                isAIResponding = false;
                clearAIResponseTimeout();
                hideInterruptButton();
                enableChatControls();
            }
        }

        // æ›´æ–°OllamaçŠ¶æ€
        function updateOllamaStatus(available) {
            if (available) {
                ollamaStatusDiv.innerHTML = 'ğŸŸ¢ OllamaæœåŠ¡æ­£å¸¸ - ä½¿ç”¨æœ¬åœ°AIæ¨¡å‹';
                ollamaStatusDiv.className = 'ollama-status';
            } else {
                ollamaStatusDiv.innerHTML = 'ğŸŸ¡ OllamaæœåŠ¡ä¸å¯ç”¨ - ä½¿ç”¨Mockå“åº”';
                ollamaStatusDiv.className = 'ollama-status unavailable';
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨
        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = content;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // å¦‚æœæ˜¯åŠ©æ‰‹æ¶ˆæ¯ä¸”æ”¯æŒæµå¼ï¼Œæ ‡è®°ä¸ºå¯è¿½åŠ 
            if (sender === 'assistant') {
                messageDiv.dataset.streamable = 'true';
                currentAssistantMessage = messageDiv;
            }
        }
        
        // æ·»åŠ æ··åˆå†…å®¹æ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨
        function addMixedContentMessage(thinkingContent = '', normalContent = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant mixed-content';
            messageDiv.dataset.streamable = 'true';
            messageDiv.dataset.hasThinking = thinkingContent ? 'true' : 'false';
            messageDiv.dataset.hasNormal = normalContent ? 'true' : 'false';
            messageDiv.dataset.thinkingContent = thinkingContent;
            messageDiv.dataset.normalContent = normalContent;
            
            updateMixedContentMessage(messageDiv, thinkingContent, normalContent);
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            
            currentAssistantMessage = messageDiv;
            return messageDiv;
        }
        
        // æ›´æ–°æ··åˆå†…å®¹æ¶ˆæ¯
        function updateMixedContentMessage(messageDiv, thinkingContent, normalContent) {
            console.log('ğŸ”„ æ›´æ–°æ··åˆå†…å®¹æ¶ˆæ¯:', {
                thinkingLength: thinkingContent?.length || 0,
                normalLength: normalContent?.length || 0,
                thinkingPreview: thinkingContent?.substring(0, 50) + '...',
                normalPreview: normalContent?.substring(0, 50) + '...'
            });
            
            let html = '';
            
            // å¤„ç†æ€è€ƒå†…å®¹
            if (thinkingContent && thinkingContent.trim()) {
                // ç§»é™¤<think>å’Œ</think>æ ‡ç­¾
                let cleanThinking = thinkingContent.replace(/<\/?think>/g, '').trim();
                console.log('ğŸ§  æ¸…ç†åçš„æ€è€ƒå†…å®¹:', cleanThinking.substring(0, 100) + '...');
                
                if (cleanThinking) {
                    // ä½¿ç”¨markedè§£æmarkdown
                    let thinkingHtml = '';
                    try {
                        thinkingHtml = marked.parse(cleanThinking);
                        console.log('âœ… Markdownè§£ææˆåŠŸ');
                    } catch (e) {
                        console.warn('âš ï¸ Markdownè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬:', e);
                        // å¦‚æœmarkdownè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬
                        thinkingHtml = cleanThinking.replace(/\n/g, '<br>');
                    }
                    
                    const sectionClass = normalContent && normalContent.trim() ? 'thinking-section' : 'thinking-section thinking-only';
                    html += `<div class="${sectionClass}">${thinkingHtml}</div>`;
                    messageDiv.dataset.hasThinking = 'true';
                    console.log('ğŸ§  æ·»åŠ æ€è€ƒéƒ¨åˆ†ï¼Œæ ·å¼ç±»:', sectionClass);
                }
            }
            
            // å¤„ç†æ™®é€šå†…å®¹
            if (normalContent && normalContent.trim()) {
                const sectionClass = (thinkingContent && thinkingContent.trim()) ? 'normal-section' : 'normal-section normal-only';
                html += `<div class="${sectionClass}">${normalContent.replace(/\n/g, '<br>')}</div>`;
                messageDiv.dataset.hasNormal = 'true';
                console.log('ğŸ’¬ æ·»åŠ æ™®é€šéƒ¨åˆ†ï¼Œæ ·å¼ç±»:', sectionClass);
            }
            
            console.log('ğŸ“ æœ€ç»ˆHTMLé•¿åº¦:', html.length);
            messageDiv.innerHTML = html;
        }
        
        // æ·»åŠ æ€è€ƒæ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨
        function addThinkingMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant thinking';
            messageDiv.textContent = content;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            
            return messageDiv;
        }

        // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            removeTypingIndicator(); // ç¡®ä¿åªæœ‰ä¸€ä¸ªæŒ‡ç¤ºå™¨
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = 'AIæ­£åœ¨æ€è€ƒä¸­<span class="dots">...</span>';
            
            chatContainer.appendChild(typingDiv);
            scrollToBottom();
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨ - ä¼˜åŒ–ç‰ˆ
        function scrollToBottom() {
            // ä½¿ç”¨requestAnimationFrameä¿è¯æ»šåŠ¨çš„æµç•…æ€§
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // ç§»é™¤æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // è¿½åŠ å†…å®¹åˆ°æ··åˆå†…å®¹æ¶ˆæ¯
        function appendToMixedContentMessage(thinkingContent, normalContent, isThinking) {
            // ç°åœ¨æˆ‘ä»¬ç¡®ä¿åœ¨è°ƒç”¨æ­¤å‡½æ•°ä¹‹å‰å·²ç»æœ‰äº†æ··åˆå†…å®¹æ¶ˆæ¯
            if (!currentAssistantMessage || !currentAssistantMessage.classList.contains('mixed-content')) {
                console.error('appendToMixedContentMessage called without mixed-content message');
                return;
            }
            
            // è·å–ç°æœ‰å†…å®¹
            let existingThinking = currentAssistantMessage.dataset.thinkingContent || '';
            let existingNormal = currentAssistantMessage.dataset.normalContent || '';
            
            // è¿½åŠ æ–°å†…å®¹
            if (isThinking) {
                existingThinking += thinkingContent;
            } else {
                existingNormal += normalContent;
            }
            
            // ä¿å­˜åˆ°dataset
            currentAssistantMessage.dataset.thinkingContent = existingThinking;
            currentAssistantMessage.dataset.normalContent = existingNormal;
            
            // æ›´æ–°æ˜¾ç¤º
            updateMixedContentMessage(currentAssistantMessage, existingThinking, existingNormal);
            
            // ä½¿ç”¨èŠ‚æµæ»šåŠ¨ä»¥æé«˜æ€§èƒ½
            throttledScrollToBottom();
        }
        
        // è¿½åŠ å†…å®¹åˆ°æœ€åä¸€æ¡åŠ©æ‰‹æ¶ˆæ¯ - ä¼˜åŒ–ç‰ˆï¼ˆä¿ç•™ç”¨äºå…¼å®¹ï¼‰
        function appendToLastMessage(content, isComplete) {
            if (!currentAssistantMessage) {
                // å¦‚æœæ²¡æœ‰å½“å‰æ¶ˆæ¯ï¼Œåˆ›å»ºæ–°æ¶ˆæ¯
                addMessage('assistant', content);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ··åˆå†…å®¹æ¶ˆæ¯
            if (currentAssistantMessage.classList.contains('mixed-content')) {
                appendToMixedContentMessage('', content, false);
                return;
            }
            
            // æ‰¹é‡å¤„ç†DOMæ›´æ–°ä»¥æé«˜æ€§èƒ½
            if (currentAssistantMessage.textContent === 'AIæ­£åœ¨æ€è€ƒä¸­...') {
                // é¦–æ¬¡å†…å®¹ï¼Œæ›¿æ¢å ä½æ–‡æœ¬
                currentAssistantMessage.textContent = content;
            } else {
                // è¿½åŠ å†…å®¹
                currentAssistantMessage.textContent += content;
            }
            
            // ä½¿ç”¨èŠ‚æµæ»šåŠ¨ä»¥æé«˜æ€§èƒ½
            throttledScrollToBottom();
            
            if (isComplete) {
                currentAssistantMessage.dataset.streamable = 'false';
                currentAssistantMessage.classList.add('stream-complete');
                currentAssistantMessage = null;
                // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                enableSendButton();
                enableChatControls();
            }
        }
        
        // è¿½åŠ å†…å®¹åˆ°æœ€åä¸€æ¡æ€è€ƒæ¶ˆæ¯
        function appendToLastThinkingMessage(content, isComplete) {
            // æŸ¥æ‰¾æœ€åä¸€æ¡æ€è€ƒæ¶ˆæ¯
            const thinkingMessages = chatContainer.querySelectorAll('.message.thinking');
            let lastThinkingMessage = null;
            
            if (thinkingMessages.length > 0) {
                lastThinkingMessage = thinkingMessages[thinkingMessages.length - 1];
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€æ–°çš„æ¶ˆæ¯ï¼ˆç®€å•æ£€æŸ¥ï¼‰
                const allMessages = chatContainer.querySelectorAll('.message');
                const lastMessage = allMessages[allMessages.length - 1];
                if (lastMessage !== lastThinkingMessage) {
                    lastThinkingMessage = null;
                }
            }
            
            if (!lastThinkingMessage) {
                // åˆ›å»ºæ–°çš„æ€è€ƒæ¶ˆæ¯
                lastThinkingMessage = addThinkingMessage(content);
            } else {
                // è¿½åŠ åˆ°ç°æœ‰æ¶ˆæ¯
                lastThinkingMessage.textContent += content;
            }
            
            throttledScrollToBottom();
            
            if (isComplete) {
                lastThinkingMessage.classList.add('stream-complete');
                // é‡ç½®AIå“åº”çŠ¶æ€
                isAIResponding = false;
                clearAIResponseTimeout();
                hideInterruptButton();
                enableSendButton();
                enableChatControls();
                console.log('âœ… æ€è€ƒæ¶ˆæ¯å®Œæˆï¼Œé‡ç½®çŠ¶æ€');
            }
        }
        
        // èŠ‚æµæ»šåŠ¨å‡½æ•°
        const throttledScrollToBottom = throttle(scrollToBottom, 16); // 60fps
        
        // èŠ‚æµå‡½æ•°
        function throttle(func, delay) {
            let timeoutId;
            let lastExecTime = 0;
            return function (...args) {
                const currentTime = Date.now();
                
                if (currentTime - lastExecTime > delay) {
                    func.apply(this, args);
                    lastExecTime = currentTime;
                } else {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        func.apply(this, args);
                        lastExecTime = Date.now();
                    }, delay - (currentTime - lastExecTime));
                }
            };
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !isConnected) return;

            // å¦‚æœAIæ­£åœ¨å›å¤ï¼Œå…ˆå‘é€æ‰“æ–­ä¿¡å·
            if (isAIResponding) {
                sendInterruptSignal('NEW_MESSAGE', 'ç”¨æˆ·å‘é€äº†æ–°æ¶ˆæ¯');
            }

            // é‡ç½®å½“å‰æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ–°æ¶ˆæ¯åˆ›å»ºæ–°æ°”æ³¡
            currentAssistantMessage = null;
            
            // åŒæ—¶é‡ç½®ChatWindowHandlerä¸­çš„currentAssistantMessage
            const chatHandler = multiChannelRouter.getChannel('chat_window');
            if (chatHandler) {
                chatHandler.currentAssistantMessage = null;
            }

            const message = {
                type: 'text',
                content: content,
                role: 'user',
                sessionId: currentSessionId
            };

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', content);
            
            // æ˜¾ç¤ºAIæ­£åœ¨æ€è€ƒçš„æŒ‡ç¤ºå™¨
            showTypingIndicator();
            
            // å‘é€åˆ°æœåŠ¡å™¨
            ws.send(JSON.stringify(message));
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
            
            // ç¦ç”¨å‘é€æŒ‰é’®é˜²æ­¢é‡å¤å‘é€
            disableSendButton();
        }

        // äº‹ä»¶ç›‘å¬
        sendBtn.addEventListener('click', sendMessage);
        
        interruptBtn.addEventListener('click', function() {
            sendInterruptSignal('USER_STOP', 'ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®');
        });
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        personaSelect.addEventListener('change', function() {
            // å¦‚æœAIæ­£åœ¨å›å¤ï¼Œæ¢å¤åˆ°ä¹‹å‰çš„é€‰æ‹©å¹¶ç›´æ¥è¿”å›
            if (isAIResponding) {
                // æ¢å¤åˆ°ä¹‹å‰çš„é€‰æ‹©
                this.selectedIndex = this.dataset.lastSelectedIndex || 0;
                return;
            }
            
            // è®°å½•å½“å‰é€‰æ‹©çš„ç´¢å¼•
            this.dataset.lastSelectedIndex = this.selectedIndex;
            
            if (currentSessionId) {
                const message = {
                    type: 'system',
                    content: `åˆ‡æ¢åˆ°äººè®¾: ${this.options[this.selectedIndex].text}`,
                    metadata: {
                        action: 'change_persona',
                        personaId: this.value
                    }
                };
                
                addMessage('system', `å·²åˆ‡æ¢åˆ° ${this.options[this.selectedIndex].text} äººè®¾`);
                ws.send(JSON.stringify(message));
            }
        });
        
        // æ€è€ƒåˆ‡æ¢äº‹ä»¶ç›‘å¬
        thinkingToggle.addEventListener('click', toggleThinkingDisplay);
        
        // TTSåˆ‡æ¢äº‹ä»¶ç›‘å¬
        ttsToggle.addEventListener('click', toggleChatTTS);
        
        // è”ç½‘æœç´¢åˆ‡æ¢äº‹ä»¶ç›‘å¬
        webSearchToggle.addEventListener('click', toggleWebSearchDisplay);

        // å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®çš„å·¥å…·å‡½æ•°
        function enableSendButton() {
            if (isConnected) {
                sendBtn.disabled = false;
                messageInput.disabled = false;
                sendBtn.textContent = 'å‘é€';
            }
        }
        
        function disableSendButton() {
            sendBtn.disabled = true;
            messageInput.disabled = true;
            sendBtn.textContent = 'å‘é€ä¸­...';
        }

        // ç¦ç”¨èŠå¤©æ§ä»¶ï¼ˆAIå›å¤æ—¶ï¼‰
        function disableChatControls() {
            console.log('ğŸš« ç¦ç”¨èŠå¤©æ§ä»¶ - isAIResponding:', isAIResponding);
            // ç¦ç”¨äººè®¾é€‰æ‹©å™¨
            personaSelect.disabled = true;
            personaSelect.style.opacity = '0.5';
            personaSelect.style.cursor = 'not-allowed';
            
            // ç¦ç”¨æ€è€ƒè¿‡ç¨‹åˆ‡æ¢
            thinkingToggle.style.pointerEvents = 'none';
            thinkingToggle.style.opacity = '0.5';
            thinkingToggle.style.cursor = 'not-allowed';
            
            // ç¦ç”¨TTSåˆ‡æ¢
            ttsToggle.style.pointerEvents = 'none';
            ttsToggle.style.opacity = '0.5';
            ttsToggle.style.cursor = 'not-allowed';
            
            // ç¦ç”¨è”ç½‘æœç´¢åˆ‡æ¢
            webSearchToggle.style.pointerEvents = 'none';
            webSearchToggle.style.opacity = '0.5';
            webSearchToggle.style.cursor = 'not-allowed';
        }

        // å¯ç”¨èŠå¤©æ§ä»¶ï¼ˆAIå›å¤ç»“æŸæ—¶ï¼‰
        function enableChatControls() {
            console.log('âœ… å¯ç”¨èŠå¤©æ§ä»¶ - isAIResponding:', isAIResponding);
            // å¯ç”¨äººè®¾é€‰æ‹©å™¨
            personaSelect.disabled = false;
            personaSelect.style.opacity = '1';
            personaSelect.style.cursor = 'pointer';
            
            // å¯ç”¨æ€è€ƒè¿‡ç¨‹åˆ‡æ¢
            thinkingToggle.style.pointerEvents = 'auto';
            thinkingToggle.style.opacity = '1';
            thinkingToggle.style.cursor = 'pointer';
            
            // å¯ç”¨TTSåˆ‡æ¢
            ttsToggle.style.pointerEvents = 'auto';
            ttsToggle.style.opacity = '1';
            ttsToggle.style.cursor = 'pointer';
            
            // å¯ç”¨è”ç½‘æœç´¢åˆ‡æ¢
            webSearchToggle.style.pointerEvents = 'auto';
            webSearchToggle.style.opacity = '1';
            webSearchToggle.style.cursor = 'pointer';
        }

        // è®°å½•AIæ´»åŠ¨
        function recordAIActivity() {
            lastAIActivityTime = Date.now();
            console.log('ğŸ“ è®°å½•AIæ´»åŠ¨æ—¶é—´:', new Date(lastAIActivityTime).toLocaleTimeString());
        }
        
        // è®¾ç½®AIå“åº”è¶…æ—¶ï¼ˆåŸºäºæ´»åŠ¨æ£€æµ‹ï¼‰
        function setAIResponseTimeout() {
            // å¦‚æœå·²ç»æœ‰è¶…æ—¶å®šæ—¶å™¨åœ¨è¿è¡Œï¼Œä¸é‡å¤è®¾ç½®
            if (aiResponseTimeout || activityCheckInterval) {
                console.log('ğŸ”„ AIå“åº”è¶…æ—¶å®šæ—¶å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤è®¾ç½®');
                return;
            }
            
            // é‡ç½®è¶…æ—¶æ¶ˆæ¯æ ‡å¿—
            timeoutMessageShown = false;
            
            // è®°å½•å¼€å§‹æ—¶é—´
            recordAIActivity();
            
            console.log('â° å¯åŠ¨åŸºäºæ´»åŠ¨æ£€æµ‹çš„AIå“åº”ç›‘æ§ (æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡)');
            
            // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡AIæ´»åŠ¨çŠ¶æ€
            activityCheckInterval = setInterval(() => {
                if (!isAIResponding) {
                    // AIå·²ç»ä¸åœ¨å“åº”çŠ¶æ€ï¼Œæ¸…é™¤ç›‘æ§
                    console.log('âœ… AIå·²å®Œæˆå“åº”ï¼Œåœæ­¢æ´»åŠ¨ç›‘æ§');
                    clearAIResponseTimeout();
                    return;
                }
                
                const now = Date.now();
                const timeSinceLastActivity = now - (lastAIActivityTime || now);
                
                console.log('ğŸ” æ£€æŸ¥AIæ´»åŠ¨çŠ¶æ€:', {
                    timeSinceLastActivity: Math.round(timeSinceLastActivity / 1000) + 'ç§’',
                    isAIResponding: isAIResponding,
                    lastActivity: new Date(lastAIActivityTime).toLocaleTimeString()
                });
                
                // å¦‚æœ30ç§’å†…æ²¡æœ‰AIæ´»åŠ¨ï¼Œè®¤ä¸ºè¶…æ—¶
                if (timeSinceLastActivity > 30000 && !timeoutMessageShown) {
                    console.log('â° AIå“åº”çœŸæ­£è¶…æ—¶ - 30ç§’å†…æ— æ´»åŠ¨ï¼Œå¼ºåˆ¶é‡ç½®çŠ¶æ€');
                    timeoutMessageShown = true;
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableSendButton();
                    enableChatControls();
                    addMessage('system', 'âš ï¸ AIå“åº”è¶…æ—¶ï¼Œå·²è‡ªåŠ¨é‡ç½®çŠ¶æ€');
                }
            }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // æ¸…é™¤AIå“åº”è¶…æ—¶
        function clearAIResponseTimeout() {
            if (aiResponseTimeout) {
                clearTimeout(aiResponseTimeout);
                aiResponseTimeout = null;
            }
            if (activityCheckInterval) {
                clearInterval(activityCheckInterval);
                activityCheckInterval = null;
                console.log('ğŸ›‘ åœæ­¢AIæ´»åŠ¨ç›‘æ§');
            }
            // é‡ç½®è¶…æ—¶æ¶ˆæ¯æ ‡å¿—å’Œæ´»åŠ¨æ—¶é—´
            timeoutMessageShown = false;
            lastAIActivityTime = null;
        }
        
        // å¤„ç†æ€è€ƒåˆ‡æ¢ç¡®è®¤
        function handleThinkingToggleConfirmation(message) {
            if (message.metadata.thinking_toggle === 'confirmed') {
                const newState = message.metadata.showThinking;
                showThinking = newState;
                updateThinkingToggleUI(newState);
                addMessage('system', message.content);
            }
        }
        
        
        // æ›´æ–°æ€è€ƒåˆ‡æ¢UI
        function updateThinkingToggleUI(state) {
            if (state) {
                thinkingToggle.classList.add('active');
            } else {
                thinkingToggle.classList.remove('active');
            }
        }
        
        
        // å‘é€æ€è€ƒåˆ‡æ¢è¯·æ±‚
        function toggleThinkingDisplay() {
            if (!ws || !isConnected) {
                addMessage('system', 'è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }
            
            // å¦‚æœAIæ­£åœ¨å›å¤ï¼Œç›´æ¥è¿”å›ä¸åšä»»ä½•æ“ä½œ
            if (isAIResponding) {
                return;
            }
            
            const newState = !showThinking;
            
            const toggleMessage = {
                type: 'system',
                content: 'toggle_thinking',
                metadata: {
                    action: 'toggle_thinking',
                    showThinking: newState
                }
            };
            
            ws.send(JSON.stringify(toggleMessage));
        }
        
        
        // å¤„ç†è”ç½‘æœç´¢åˆ‡æ¢ç¡®è®¤
        function handleWebSearchToggleConfirmation(message) {
            if (message.metadata.web_search_toggle === 'confirmed') {
                const newState = message.metadata.useWebSearch;
                useWebSearch = newState;
                updateWebSearchToggleUI(newState);
                addMessage('system', message.content);
            }
        }
        
        // æ›´æ–°è”ç½‘æœç´¢åˆ‡æ¢UI
        function updateWebSearchToggleUI(state) {
            if (state) {
                webSearchToggle.classList.add('active');
            } else {
                webSearchToggle.classList.remove('active');
            }
        }
        
        // å‘é€è”ç½‘æœç´¢åˆ‡æ¢è¯·æ±‚
        function toggleWebSearchDisplay() {
            if (!ws || !isConnected) {
                addMessage('system', 'è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }
            
            // å¦‚æœAIæ­£åœ¨å›å¤ï¼Œç›´æ¥è¿”å›ä¸åšä»»ä½•æ“ä½œ
            if (isAIResponding) {
                return;
            }
            
            const newState = !useWebSearch;
            
            const toggleMessage = {
                type: 'system',
                content: 'toggle_web_search',
                metadata: {
                    action: 'toggle_web_search',
                    useWebSearch: newState
                }
            };
            
            ws.send(JSON.stringify(toggleMessage));
        }
        
        // åˆå§‹åŒ–æ€è€ƒåˆ‡æ¢UI
        updateThinkingToggleUI(showThinking);
        
        // åˆå§‹åŒ–è”ç½‘æœç´¢åˆ‡æ¢UI
        updateWebSearchToggleUI(useWebSearch);
        
        // åˆå§‹åŒ–TTSåˆ‡æ¢UI
        updateTTSToggleUI(ttsSettings.chatEnabled);
        
        // åˆå§‹åŒ–äººè®¾é€‰æ‹©å™¨çš„ç´¢å¼•è®°å½•
        personaSelect.dataset.lastSelectedIndex = personaSelect.selectedIndex;
        
        // TTSå¥åº·æ£€æŸ¥å‡½æ•°
        async function checkTTSHealth() {
            try {
                const response = await fetch('/api/cosyvoice/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.success && result.healthy;
                } else {
                    console.error('TTSå¥åº·æ£€æŸ¥å¤±è´¥:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('TTSå¥åº·æ£€æŸ¥å¼‚å¸¸:', error);
                return false;
            }
        }
        
        // TTSåˆ‡æ¢å‡½æ•°
        async function toggleChatTTS() {
            // å¦‚æœAIæ­£åœ¨å›å¤ï¼Œç›´æ¥è¿”å›ä¸åšä»»ä½•æ“ä½œ
            if (isAIResponding) {
                return;
            }
            
            // å¦‚æœè¦å¯ç”¨TTSï¼Œå…ˆæ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
            if (!ttsSettings.chatEnabled) {
                // æ˜¾ç¤ºæ£€æŸ¥ä¸­çš„æç¤º
                addMessage('system', 'ğŸ” æ­£åœ¨æ£€æŸ¥TTSæœåŠ¡çŠ¶æ€...');
                
                // æ‰§è¡Œå¥åº·æ£€æŸ¥
                const isHealthy = await checkTTSHealth();
                
                if (!isHealthy) {
                    // TTSæœåŠ¡ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºè­¦å‘Šå¹¶è¿”å›
                    addMessage('system', 'âš ï¸ TTSæœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•å¯ç”¨');
                    return;
                }
                
                // æœåŠ¡å¯ç”¨ï¼Œç»§ç»­å¯ç”¨TTS
                ttsSettings.chatEnabled = true;
                ttsSettings.chatMode = 'char_stream_tts';
                currentTTSMode = 'char_stream_tts';
                addMessage('system', 'âœ… å·²å¯ç”¨èŠå¤©çª—å£TTS (æ¨¡å¼2 - å­—ç¬¦æµ+è¯­éŸ³)');
            } else {
                // ç¦ç”¨TTSï¼Œåˆ‡æ¢åˆ°æ¨¡å¼1
                ttsSettings.chatEnabled = false;
                ttsSettings.chatMode = 'text_only';
                currentTTSMode = 'text_only';
                addMessage('system', 'âŒ å·²ç¦ç”¨èŠå¤©çª—å£TTS (æ¨¡å¼1 - çº¯æ–‡æœ¬)');
            }
            
            // æ›´æ–°UI
            updateTTSToggleUI(ttsSettings.chatEnabled);
            updateTTSModeDisplay();
            updateTTSControlButton();
            
            // åŒæ­¥æ›´æ–°è®¾ç½®é¡µé¢çš„çŠ¶æ€
            syncSettingsPageTTS();
            
            // ä¿å­˜è®¾ç½®
            saveTTSSettings();
            
            console.log('TTSçŠ¶æ€åˆ‡æ¢:', {
                enabled: ttsSettings.chatEnabled,
                mode: currentTTSMode,
                settings: ttsSettings
            });
        }
        
        // æ›´æ–°TTSåˆ‡æ¢UI
        function updateTTSToggleUI(state) {
            if (state) {
                ttsToggle.classList.add('active');
            } else {
                ttsToggle.classList.remove('active');
            }
        }
        
        // åŒæ­¥è®¾ç½®é¡µé¢çš„TTSçŠ¶æ€
        function syncSettingsPageTTS() {
            const chatToggle = document.getElementById('chatTTSToggle');
            if (chatToggle) {
                chatToggle.checked = ttsSettings.chatEnabled;
            }
        }
        
        // å‘é€æ‰“æ–­ä¿¡å·
        function sendInterruptSignal(interruptType, reason) {
            if (!ws || !isConnected || !currentSessionId) {
                console.warn('æ— æ³•å‘é€æ‰“æ–­ä¿¡å·ï¼šWebSocketæœªè¿æ¥æˆ–æ— ä¼šè¯ID');
                return;
            }
            
            const interruptMessage = {
                type: 'system',
                content: 'interrupt',
                metadata: {
                    action: 'interrupt',
                    interruptType: interruptType,
                    reason: reason
                },
                sessionId: currentSessionId
            };
            
            ws.send(JSON.stringify(interruptMessage));
            console.log('å‘é€æ‰“æ–­ä¿¡å·:', interruptMessage);
            
            // ç«‹å³è¿›è¡Œè§†è§‰åé¦ˆ
            if (currentStreamingMessage) {
                // åœ¨å½“å‰æµå¼æ¶ˆæ¯æœ«å°¾æ·»åŠ ä¸­æ–­æç¤º
                const interruptNotice = document.createElement('span');
                interruptNotice.className = 'interrupt-notice';
                interruptNotice.textContent = ' ...ï¼ˆå·²ä¸­æ–­ï¼‰';
                interruptNotice.style.color = '#dc3545';
                interruptNotice.style.fontStyle = 'italic';
                currentStreamingMessage.appendChild(interruptNotice);
            }
            
            // ç«‹å³éšè—æ‰“æ–­æŒ‰é’®
            isAIResponding = false;
            clearAIResponseTimeout();
            hideInterruptButton();
            enableChatControls();
        }
        
        // æ˜¾ç¤ºæ‰“æ–­æŒ‰é’®
        function showInterruptButton() {
            interruptBtn.classList.add('visible');
            interruptBtn.disabled = false;
        }
        
        // éšè—æ‰“æ–­æŒ‰é’®
        function hideInterruptButton() {
            interruptBtn.classList.remove('visible');
            interruptBtn.disabled = true;
        }
        
        // å¤„ç†æ‰“æ–­ç¡®è®¤
        function handleInterruptConfirmation(message) {
            console.log('æ”¶åˆ°æ‰“æ–­ç¡®è®¤:', message);
            
            // ç¡®ä¿æ‰“æ–­æŒ‰é’®è¢«éšè—
            isAIResponding = false;
            clearAIResponseTimeout();
            hideInterruptButton();
            enableChatControls();
            
            // ç§»é™¤æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            removeTypingIndicator();
            
            // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
            enableSendButton();
            enableChatControls();
            
            // åªæœ‰åœ¨ç¡®å®æœ‰ä»»åŠ¡è¢«ä¸­æ–­æ—¶æ‰æ˜¾ç¤ºä¸­æ–­ç¡®è®¤æ¶ˆæ¯
            if (message.metadata.interrupted_tasks && message.metadata.interrupted_tasks > 0) {
                addMessage('system', message.content + ` (ä¸­æ–­äº† ${message.metadata.interrupted_tasks} ä¸ªä»»åŠ¡)`);
            } else {
                // å¦‚æœæ²¡æœ‰ä»»åŠ¡è¢«ä¸­æ–­ï¼Œä¸æ˜¾ç¤ºä¸­æ–­æ¶ˆæ¯
                console.log('æ²¡æœ‰ä»»åŠ¡è¢«ä¸­æ–­ï¼Œè·³è¿‡æ˜¾ç¤ºä¸­æ–­æ¶ˆæ¯');
            }
        }
        
        // è‡ªé€‚åº”çª—å£å¤§å°ç®¡ç†
        function initResponsiveLayout() {
            function updateLayout() {
                const viewportWidth = document.documentElement.clientWidth;
                const viewportHeight = document.documentElement.clientHeight;
                
                console.log(`ğŸ“ Viewport size: ${viewportWidth}x${viewportHeight}`);
                
                // æ›´æ–°èŠå¤©ç•Œé¢å¤§å° (70%çª—å£)
                const chatContainer = document.querySelector('.chat-container');
                if (chatContainer) {
                    const containerWidth = Math.min(viewportWidth * 0.7, 1200); // æœ€å¤§1200px
                    const containerHeight = viewportHeight * 0.7;
                    
                    chatContainer.style.width = `${containerWidth}px`;
                    chatContainer.style.height = `${containerHeight}px`;
                }
                
                // æ›´æ–°è®¾ç½®é¡µé¢
                const settingsTab = document.getElementById('settings-tab');
                if (settingsTab) {
                    settingsTab.style.height = `${viewportHeight}px`;
                    settingsTab.style.maxHeight = `${viewportHeight}px`;
                }
                
                // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç»„ä»¶
                window.dispatchEvent(new CustomEvent('layoutUpdated', {
                    detail: { width: viewportWidth, height: viewportHeight }
                }));
            }
            
            // åˆå§‹åŒ–å¸ƒå±€
            updateLayout();
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            let resizeTimer;
            window.addEventListener('resize', function() {
                // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è§¦å‘
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(updateLayout, 150);
            });
            
            // ç›‘å¬æ–¹å‘å˜åŒ–ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
            window.addEventListener('orientationchange', function() {
                setTimeout(updateLayout, 300);
            });
            
            console.log('ğŸ“± Responsive layout initialized');
        }
        
        // Tabåˆ‡æ¢åŠŸèƒ½
        function initTabSwitching() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('ğŸ”„ Initializing tab switching...');
            console.log('Found tab buttons:', tabButtons.length);
            console.log('Found tab contents:', tabContents.length);
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    console.log(`ğŸ¯ Switching to tab: ${targetTab}`);
                    
                    try {
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        
                        // æ›´æ–°å†…å®¹æ˜¾ç¤º
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        const targetContent = document.getElementById(`${targetTab}-tab`);
                        if (targetContent) {
                            targetContent.classList.add('active');
                            console.log(`âœ… Successfully switched to ${targetTab} tab`);
                        } else {
                            console.error(`âŒ Target tab content not found: ${targetTab}-tab`);
                        }
                        
                        // æ›´æ–°çŠ¶æ€ä¿¡æ¯ï¼ˆä»…åœ¨åˆ‡æ¢åˆ°è®¾ç½®é¡µé¢æ—¶ï¼‰
                        if (targetTab === 'settings') {
                            try {
                                updateSettingsInfo();
                            } catch (error) {
                                console.error('âŒ Error updating settings info:', error);
                            }
                        }
                        
                        // å¤„ç†æ—¥å¿—é¡µé¢åˆ‡æ¢
                        if (targetTab === 'logs') {
                            try {
                                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ‡æ¢åˆ°æ—¥å¿—é¡µé¢ï¼Œåˆå§‹åŒ–æ—¥å¿—åŠŸèƒ½
                                if (!window.logsInitialized) {
                                    initLogsPage();
                                    window.logsInitialized = true;
                                } else {
                                    // å·²ç»åˆå§‹åŒ–è¿‡ï¼Œåªéœ€è¦æ¿€æ´»è‡ªåŠ¨åˆ·æ–°
                                    isLogsTabActive = true;
                                    if (autoRefreshLogs) {
                                        startAutoRefresh();
                                    }
                                }
                            } catch (error) {
                                console.error('âŒ Error initializing logs page:', error);
                            }
                        } else {
                            // åˆ‡æ¢åˆ°å…¶ä»–tabæ—¶ï¼Œåœæ­¢æ—¥å¿—è‡ªåŠ¨åˆ·æ–°
                            if (window.logsInitialized) {
                                isLogsTabActive = false;
                                stopAutoRefresh();
                            }
                        }
                        
                        // å¦‚æœåˆ‡æ¢åˆ°èŠå¤©é¡µé¢ï¼Œè§¦å‘å¸ƒå±€æ›´æ–°
                        if (targetTab === 'chat') {
                            setTimeout(() => {
                                if (typeof initResponsiveLayout !== 'undefined') {
                                    // è§¦å‘å¸ƒå±€æ›´æ–°
                                    window.dispatchEvent(new Event('resize'));
                                }
                            }, 100);
                        }
                        
                    } catch (error) {
                        console.error('âŒ Error during tab switching:', error);
                    }
                });
            });
            
            console.log('âœ… Tab switching initialized');
        }
        
        // æ›´æ–°è®¾ç½®é¡µé¢ä¿¡æ¯
        function updateSettingsInfo() {
            // æ›´æ–°è¿æ¥çŠ¶æ€
            const connectionStatus = document.getElementById('connectionStatus');
            if (connectionStatus) {
                // æ£€æŸ¥WebSocketæ˜¯å¦å­˜åœ¨ä¸”å·²è¿æ¥
                if (typeof ws !== 'undefined' && ws && ws.readyState === WebSocket.OPEN) {
                    connectionStatus.textContent = 'å·²è¿æ¥';
                    connectionStatus.className = 'info-value connected';
                } else {
                    connectionStatus.textContent = 'æœªè¿æ¥';
                    connectionStatus.className = 'info-value disconnected';
                }
            }
        }
        
        // æ—¥å¿—åŠŸèƒ½
        function fetchLogs() {
            const level = logLevelSelect ? logLevelSelect.value : 'INFO';
            const limit = 100; // é»˜è®¤è·å–æœ€è¿‘100æ¡æ—¥å¿—
            const timeRange = timeRangeSelect ? timeRangeSelect.value : '30m';
            
            let url = `/api/logs?level=${level}&limit=${limit}&timeRange=${timeRange}`;
            
            // å¦‚æœæ˜¯è‡ªå®šä¹‰æ—¶é—´æ®µï¼Œæ·»åŠ å¼€å§‹å’Œç»“æŸæ—¶é—´å‚æ•°
            if (timeRange === 'custom' && startTimeInput && endTimeInput) {
                const startTime = formatDateTimeForAPI(startTimeInput.value);
                const endTime = formatDateTimeForAPI(endTimeInput.value);
                if (startTime && endTime) {
                    url += `&startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`;
                }
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayLogs(data.logs);
                        updateLogStats();
                        // æ˜¾ç¤ºè·å–ä¿¡æ¯
                        if (data.message) {
                            console.log('æ—¥å¿—è·å–ä¿¡æ¯:', data.message);
                        }
                    } else {
                        console.error('è·å–æ—¥å¿—å¤±è´¥:', data.message);
                        displayLogs([]);
                        logViewer.innerHTML = '<div class="log-entry"><span class="log-message">è·å–æ—¥å¿—å¤±è´¥: ' + data.message + '</span></div>';
                    }
                })
                .catch(error => {
                    console.error('è·å–æ—¥å¿—è¯·æ±‚å¤±è´¥:', error);
                    displayLogs([]);
                    logViewer.innerHTML = '<div class="log-entry"><span class="log-message">è·å–æ—¥å¿—è¯·æ±‚å¤±è´¥: ' + error.message + '</span></div>';
                });
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºAPIæ‰€éœ€æ ¼å¼
        function formatDateTimeForAPI(datetimeLocal) {
            if (!datetimeLocal) return '';
            // å°† "2024-10-10T17:30" æ ¼å¼è½¬æ¢ä¸º "2024-10-10 17:30:00"
            return datetimeLocal.replace('T', ' ') + ':00';
        }
        
        // è®¾ç½®é»˜è®¤è‡ªå®šä¹‰æ—¶é—´
        function setDefaultCustomTime() {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            
            // æ ¼å¼åŒ–ä¸º datetime-local è¾“å…¥æ‰€éœ€çš„æ ¼å¼
            const formatForInput = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            if (startTimeInput) {
                startTimeInput.value = formatForInput(oneHourAgo);
            }
            if (endTimeInput) {
                endTimeInput.value = formatForInput(now);
            }
        }
        
        function displayLogs(logs) {
            if (!logs || logs.length === 0) {
                logViewer.innerHTML = '<div class="log-entry"><span class="log-message">æš‚æ— æ—¥å¿—æ•°æ®</span></div>';
                return;
            }
            
            logViewer.innerHTML = '';
            logs.forEach(log => {
                addLogEntry(log.level, log.message, log.timestamp, false);
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            logViewer.scrollTop = logViewer.scrollHeight;
        }
        
        function addLogEntry(level, message, timestamp = null, updateStats = true) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const time = timestamp || new Date().toLocaleString('zh-CN');
            
            logEntry.innerHTML = `
                <span class="log-timestamp">${time}</span>
                <span class="log-level ${level}">${level}</span>
                <span class="log-message">${message}</span>
            `;
            
            logViewer.appendChild(logEntry);
            
            if (updateStats) {
                // æ›´æ–°ç»Ÿè®¡
                logStats.total++;
                switch(level.toUpperCase()) {
                    case 'ERROR':
                        logStats.error++;
                        break;
                    case 'WARN':
                        logStats.warn++;
                        break;
                    case 'INFO':
                        logStats.info++;
                        break;
                    case 'DEBUG':
                        logStats.debug++;
                        break;
                }
                updateLogStats();
            }
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logViewer.scrollTop = logViewer.scrollHeight;
        }
        
        function updateLogStats() {
            if (totalLogsSpan) totalLogsSpan.textContent = logStats.total;
            if (errorLogsSpan) errorLogsSpan.textContent = logStats.error;
            if (warnLogsSpan) warnLogsSpan.textContent = logStats.warn;
            if (infoLogsSpan) infoLogsSpan.textContent = logStats.info;
            if (lastUpdateSpan) lastUpdateSpan.textContent = new Date().toLocaleString('zh-CN');
        }
        
        function clearLogDisplay() {
            logViewer.innerHTML = '<div class="log-entry"><span class="log-message">æ—¥å¿—æ˜¾ç¤ºå·²æ¸…ç©º</span></div>';
            logStats = {
                total: 0,
                error: 0,
                warn: 0,
                info: 0,
                debug: 0
            };
            updateLogStats();
        }
        
        function toggleAutoRefresh() {
            autoRefreshLogs = !autoRefreshLogs;
            
            if (autoRefreshLogs) {
                autoRefreshToggle.classList.add('active');
                startAutoRefresh();
            } else {
                autoRefreshToggle.classList.remove('active');
                stopAutoRefresh();
            }
        }
        
        function startAutoRefresh() {
            if (autoRefreshLogs && isLogsTabActive) {
                stopAutoRefresh(); // å…ˆåœæ­¢ç°æœ‰çš„å®šæ—¶å™¨
                const intervalMs = refreshIntervalSeconds * 1000;
                logRefreshInterval = setInterval(fetchLogs, intervalMs);
                console.log(`è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œé—´éš”: ${refreshIntervalSeconds}ç§’`);
            }
        }
        
        function stopAutoRefresh() {
            if (logRefreshInterval) {
                clearInterval(logRefreshInterval);
                logRefreshInterval = null;
                console.log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
            }
        }
        
        function initLogsPage() {
            // åˆ·æ–°æ—¥å¿—æŒ‰é’®
            if (refreshLogsBtn) {
                refreshLogsBtn.addEventListener('click', () => {
                    fetchLogs();
                });
            }
            
            // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', clearLogDisplay);
            }
            
            // è‡ªåŠ¨åˆ·æ–°åˆ‡æ¢
            if (autoRefreshToggle) {
                autoRefreshToggle.addEventListener('click', toggleAutoRefresh);
            }
            
            // æ—¥å¿—çº§åˆ«é€‰æ‹©å™¨
            if (logLevelSelect) {
                logLevelSelect.addEventListener('change', () => {
                    fetchLogs(); // çº§åˆ«æ”¹å˜æ—¶é‡æ–°è·å–æ—¥å¿—
                });
            }
            
            // åˆ·æ–°é—´éš”é€‰æ‹©å™¨
            if (refreshIntervalSelect) {
                refreshIntervalSelect.addEventListener('change', () => {
                    refreshIntervalSeconds = parseInt(refreshIntervalSelect.value);
                    // å¦‚æœè‡ªåŠ¨åˆ·æ–°æ­£åœ¨è¿è¡Œï¼Œé‡æ–°å¯åŠ¨ä»¥åº”ç”¨æ–°é—´éš”
                    if (autoRefreshLogs && isLogsTabActive) {
                        startAutoRefresh();
                    }
                });
            }
            
            // æ—¶é—´èŒƒå›´é€‰æ‹©å™¨
            if (timeRangeSelect) {
                timeRangeSelect.addEventListener('change', () => {
                    const selectedRange = timeRangeSelect.value;
                    
                    // æ˜¾ç¤ºæˆ–éšè—è‡ªå®šä¹‰æ—¶é—´æ®µè¾“å…¥
                    if (customTimeRange) {
                        if (selectedRange === 'custom') {
                            customTimeRange.style.display = 'flex';
                            // è®¾ç½®é»˜è®¤æ—¶é—´å€¼
                            setDefaultCustomTime();
                        } else {
                            customTimeRange.style.display = 'none';
                            // ç«‹å³è·å–æ—¥å¿—
                            fetchLogs();
                        }
                    }
                });
            }
            
            // è‡ªå®šä¹‰æ—¶é—´æ®µåº”ç”¨æŒ‰é’®
            if (applyCustomTimeBtn) {
                applyCustomTimeBtn.addEventListener('click', () => {
                    fetchLogs();
                });
            }
            
            // è®¾ç½®æ—¥å¿—tabä¸ºæ¿€æ´»çŠ¶æ€
            isLogsTabActive = true;
            
            // åˆå§‹åŒ–æ—¶åŠ è½½ä¸€æ¬¡æ—¥å¿—
            fetchLogs();
            
            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆå¦‚æœå¼€å¯çš„è¯ï¼‰
            if (autoRefreshLogs) {
                startAutoRefresh();
            }
        }
        
        // è®¾ç½®é¡µé¢åŠŸèƒ½
        function initSettingsPage() {
            // ç”¨æˆ·é…ç½®å¯¹è±¡
            let userPreferences = {};
            
            // åŠ è½½ç”¨æˆ·é…ç½®
            async function loadUserPreferences() {
                try {
                    const response = await fetch('/api/preferences');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        userPreferences = result.data;
                        updateSettingsUI(userPreferences);
                        updateConfigStatus('loaded', 'é…ç½®å·²åŠ è½½');
                        console.log('âœ… ç”¨æˆ·é…ç½®åŠ è½½æˆåŠŸ', userPreferences);
                    } else {
                        console.warn('âš ï¸ åŠ è½½ç”¨æˆ·é…ç½®å¤±è´¥', result.message);
                        updateConfigStatus('error', 'åŠ è½½å¤±è´¥');
                    }
                } catch (error) {
                    console.error('âŒ åŠ è½½ç”¨æˆ·é…ç½®é”™è¯¯', error);
                    updateConfigStatus('error', 'åŠ è½½é”™è¯¯');
                }
            }
            
            // ä¿å­˜ç”¨æˆ·é…ç½®
            async function saveUserPreferences() {
                try {
                    updateConfigStatus('loading', 'ä¿å­˜ä¸­...');
                    
                    const response = await fetch('/api/preferences', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userPreferences)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        updateConfigStatus('loaded', 'ä¿å­˜æˆåŠŸ');
                        updateLastSavedTime();
                        console.log('âœ… ç”¨æˆ·é…ç½®ä¿å­˜æˆåŠŸ');
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        showNotification('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    } else {
                        console.error('âŒ ä¿å­˜ç”¨æˆ·é…ç½®å¤±è´¥', result.message);
                        updateConfigStatus('error', 'ä¿å­˜å¤±è´¥');
                        showNotification('é…ç½®ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('âŒ ä¿å­˜ç”¨æˆ·é…ç½®é”™è¯¯', error);
                    updateConfigStatus('error', 'ä¿å­˜é”™è¯¯');
                    showNotification('é…ç½®ä¿å­˜é”™è¯¯: ' + error.message, 'error');
                }
            }
            
            // é‡ç½®é…ç½®ä¸ºé»˜è®¤å€¼
            async function resetUserPreferences() {
                if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    return;
                }
                
                try {
                    updateConfigStatus('loading', 'é‡ç½®ä¸­...');
                    
                    const response = await fetch('/api/preferences/reset', {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        userPreferences = result.data;
                        updateSettingsUI(userPreferences);
                        updateConfigStatus('loaded', 'é‡ç½®æˆåŠŸ');
                        updateLastSavedTime();
                        console.log('âœ… ç”¨æˆ·é…ç½®é‡ç½®æˆåŠŸ');
                        showNotification('é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼ï¼', 'success');
                    } else {
                        console.error('âŒ é‡ç½®ç”¨æˆ·é…ç½®å¤±è´¥', result.message);
                        updateConfigStatus('error', 'é‡ç½®å¤±è´¥');
                        showNotification('é…ç½®é‡ç½®å¤±è´¥: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('âŒ é‡ç½®ç”¨æˆ·é…ç½®é”™è¯¯', error);
                    updateConfigStatus('error', 'é‡ç½®é”™è¯¯');
                    showNotification('é…ç½®é‡ç½®é”™è¯¯: ' + error.message, 'error');
                }
            }
            
            // æ›´æ–°è®¾ç½®ç•Œé¢
            function updateSettingsUI(preferences) {
                // ç•Œé¢è®¾ç½®
                setElementValue('darkModeToggle', preferences.darkMode);
                setElementValue('animationsToggle', preferences.enableAnimations);
                setElementValue('autoScrollToggle', preferences.autoScroll);
                setElementValue('soundNotificationToggle', preferences.soundNotification);
                setElementValue('languageSelect', preferences.language);
                
                // Ollamaè®¾ç½®
                setElementValue('ollamaUrlInput', preferences.ollamaBaseUrl);
                setElementValue('ollamaModelInput', preferences.ollamaModel);
                setElementValue('ollamaTimeoutInput', preferences.ollamaTimeout);
                setElementValue('ollamaMaxTokensInput', preferences.ollamaMaxTokens);
                setElementValue('ollamaStreamToggle', preferences.ollamaStream);
                
                // è”ç½‘æœç´¢è®¾ç½®
                setElementValue('webSearchEnabledToggle', preferences.webSearchEnabled);
                setElementValue('webSearchEngineSelect', preferences.webSearchEngine);
                setElementValue('webSearchMaxResultsInput', preferences.webSearchMaxResults);
                setElementValue('webSearchTimeoutInput', preferences.webSearchTimeout);
                
                
                // åº”ç”¨ä¸€äº›è®¾ç½®
                applyUISettings(preferences);
            }
            
            // ä»ç•Œé¢æ”¶é›†è®¾ç½®
            function collectSettingsFromUI() {
                // ç•Œé¢è®¾ç½®
                userPreferences.darkMode = getElementValue('darkModeToggle');
                userPreferences.enableAnimations = getElementValue('animationsToggle');
                userPreferences.autoScroll = getElementValue('autoScrollToggle');
                userPreferences.soundNotification = getElementValue('soundNotificationToggle');
                userPreferences.language = getElementValue('languageSelect');
                
                // Ollamaè®¾ç½®
                userPreferences.ollamaBaseUrl = getElementValue('ollamaUrlInput');
                userPreferences.ollamaModel = getElementValue('ollamaModelInput');
                userPreferences.ollamaTimeout = parseInt(getElementValue('ollamaTimeoutInput'));
                userPreferences.ollamaMaxTokens = parseInt(getElementValue('ollamaMaxTokensInput'));
                userPreferences.ollamaStream = getElementValue('ollamaStreamToggle');
                
                // è”ç½‘æœç´¢è®¾ç½®
                userPreferences.webSearchEnabled = getElementValue('webSearchEnabledToggle');
                userPreferences.webSearchEngine = getElementValue('webSearchEngineSelect');
                userPreferences.webSearchMaxResults = parseInt(getElementValue('webSearchMaxResultsInput'));
                userPreferences.webSearchTimeout = parseInt(getElementValue('webSearchTimeoutInput'));
                
            }
            
            // åº”ç”¨UIè®¾ç½®
            function applyUISettings(preferences) {
                // æ·±è‰²æ¨¡å¼
                if (preferences.darkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                
                // åŠ¨ç”»æ•ˆæœ
                if (!preferences.enableAnimations) {
                    document.body.classList.add('no-animations');
                } else {
                    document.body.classList.remove('no-animations');
                }
                
                // è‡ªåŠ¨æ»šåŠ¨
                window.autoScrollEnabled = preferences.autoScroll;
            }
            
            // å·¥å…·å‡½æ•°
            function setElementValue(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            }
            
            function getElementValue(id) {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        return element.checked;
                    } else {
                        return element.value;
                    }
                }
                return null;
            }
            
            function updateRangeValue(inputId, valueId, value) {
                const valueElement = document.getElementById(valueId);
                if (valueElement) {
                    valueElement.textContent = value;
                }
            }
            
            function updateConfigStatus(status, message) {
                const statusElement = document.getElementById('configStatus');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = 'info-value config-status ' + status;
                }
            }
            
            function updateLastSavedTime() {
                const timeElement = document.getElementById('lastSavedTime');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleString();
                }
            }
            
            function showNotification(message, type = 'info') {
                // åˆ›å»ºé€šçŸ¥å…ƒç´ 
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 6px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                `;
                
                // è®¾ç½®é¢œè‰²
                switch (type) {
                    case 'success':
                        notification.style.background = '#28a745';
                        break;
                    case 'error':
                        notification.style.background = '#dc3545';
                        break;
                    default:
                        notification.style.background = '#007bff';
                }
                
                document.body.appendChild(notification);
                
                // æ˜¾ç¤ºåŠ¨ç”»
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // è‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }
            
            // å¯¼å‡ºé…ç½®
            function exportSettings() {
                collectSettingsFromUI();
                const dataStr = JSON.stringify(userPreferences, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'chatbot-settings-' + new Date().toISOString().split('T')[0] + '.json';
                link.click();
                URL.revokeObjectURL(url);
                showNotification('é…ç½®å·²å¯¼å‡ºåˆ°æ–‡ä»¶ï¼', 'success');
            }
            
            // å¯¼å…¥é…ç½®
            function importSettings(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedSettings = JSON.parse(e.target.result);
                        userPreferences = { ...userPreferences, ...importedSettings };
                        updateSettingsUI(userPreferences);
                        showNotification('é…ç½®å¯¼å…¥æˆåŠŸï¼è¯·ç‚¹å‡»ä¿å­˜æŒ‰é’®åº”ç”¨é…ç½®ã€‚', 'success');
                    } catch (error) {
                        console.error('âŒ å¯¼å…¥é…ç½®å¤±è´¥', error);
                        showNotification('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼', 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            function bindEventListeners() {
                // ä¿å­˜æŒ‰é’®
                const saveBtn = document.getElementById('saveSettingsBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        collectSettingsFromUI();
                        saveUserPreferences();
                    });
                }
                
                // é‡ç½®æŒ‰é’®
                const resetBtn = document.getElementById('resetSettingsBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', resetUserPreferences);
                }
                
                // å¯¼å‡ºæŒ‰é’®
                const exportBtn = document.getElementById('exportSettingsBtn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportSettings);
                }
                
                // å¯¼å…¥æŒ‰é’®
                const importBtn = document.getElementById('importSettingsBtn');
                const importFileInput = document.getElementById('importFileInput');
                if (importBtn && importFileInput) {
                    importBtn.addEventListener('click', () => importFileInput.click());
                    importFileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            importSettings(file);
                        }
                    });
                }
                
                // èŒƒå›´æ»‘å—å®æ—¶æ›´æ–°
                const responseSpeedInput = document.getElementById('responseSpeedInput');
                if (responseSpeedInput) {
                    responseSpeedInput.addEventListener('input', (e) => {
                        updateRangeValue('responseSpeedInput', 'responseSpeedValue', e.target.value + 'x');
                    });
                }
                
                // å®æ—¶åº”ç”¨æŸäº›è®¾ç½®
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            document.body.classList.add('dark-mode');
                        } else {
                            document.body.classList.remove('dark-mode');
                        }
                    });
                }
                
                const animationsToggle = document.getElementById('animationsToggle');
                if (animationsToggle) {
                    animationsToggle.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            document.body.classList.remove('no-animations');
                        } else {
                            document.body.classList.add('no-animations');
                        }
                    });
                }
                
                const autoScrollToggle = document.getElementById('autoScrollToggle');
                if (autoScrollToggle) {
                    autoScrollToggle.addEventListener('change', (e) => {
                        window.autoScrollEnabled = e.target.checked;
                    });
                }
            }
            
            // åˆå§‹åŒ–
            updateConfigStatus('loading', 'åŠ è½½ä¸­...');
            bindEventListeners();
            loadUserPreferences();
        }
        window.addEventListener('load', function() {
            connect();
            
            // åˆå§‹åŒ–Tabåˆ‡æ¢åŠŸèƒ½
            initTabSwitching();
            
            // åˆå§‹åŒ–è®¾ç½®é¡µé¢
            initSettingsPage();
            
            // åˆå§‹åŒ–è‡ªé€‚åº”å¸ƒå±€
            initResponsiveLayout();
            
            // åˆå§‹åŒ–TTSè®¾ç½®
            loadTTSSettings();
            initTTSSettings();
            
            console.log('âœ… Chat system initialized');
        });
        
        // ========== TTSæ§åˆ¶åŠŸèƒ½ ==========
        
        // æ›´æ–°TTSæ¨¡å¼æ˜¾ç¤º
        function updateTTSModeDisplay() {
            const display = document.getElementById('currentTTSMode');
            if (display) {
                const modeText = currentTTSMode === 'text_only' ? 'æ¨¡å¼1 - çº¯æ–‡æœ¬' : 'æ¨¡å¼2 - å­—ç¬¦æµ+è¯­éŸ³';
                display.textContent = modeText;
            }
            
            // æ›´æ–°è®¾ç½®ç•Œé¢çš„checkboxçŠ¶æ€
            const chatToggle = document.getElementById('chatTTSToggle');
            if (chatToggle) chatToggle.checked = ttsSettings.chatEnabled;
            
            // æ›´æ–°è¯­éŸ³äººè®¾é€‰æ‹©çŠ¶æ€
            const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
            if (speakerSelect && ttsSettings.spk_id) {
                speakerSelect.value = ttsSettings.spk_id;
            }
        }
        
        
        // æ›´æ–°TTSæ§åˆ¶æŒ‰é’®çŠ¶æ€
        function updateTTSControlButton() {
            // æ›´æ–°åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            updateTTSToggleUI(ttsSettings.chatEnabled);
        }
        
        // è·å–CosyVoiceè¯­éŸ³è§’è‰²åˆ—è¡¨
        async function loadCosyVoiceSpeakers() {
            try {
                const response = await fetch('/api/cosyvoice/speakers', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateSpeakerSelect(result.builtinSpeakers, result.customSpeakers);
                        return true;
                    } else {
                        console.error('è·å–è¯­éŸ³äººè®¾å¤±è´¥:', result.message);
                        showTTSNotification('è·å–è¯­éŸ³äººè®¾å¤±è´¥: ' + result.message);
                        return false;
                    }
                } else {
                    console.error('è·å–è¯­éŸ³äººè®¾è¯·æ±‚å¤±è´¥:', response.status);
                    showTTSNotification('è·å–è¯­éŸ³äººè®¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥TTSæœåŠ¡çŠ¶æ€');
                    return false;
                }
            } catch (error) {
                console.error('è·å–è¯­éŸ³äººè®¾å¼‚å¸¸:', error);
                showTTSNotification('è·å–è¯­éŸ³äººè®¾å¼‚å¸¸: ' + error.message);
                return false;
            }
        }
        
        // æ›´æ–°è¯­éŸ³äººè®¾é€‰æ‹©æ¡†
        function updateSpeakerSelect(builtinSpeakers, customSpeakers) {
            const select = document.getElementById('cosyVoiceSpeakerSelect');
            if (!select) return;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            select.innerHTML = '';
            
            let firstSpeaker = null;
            
            // æ·»åŠ å†…ç½®è¯­éŸ³äººè®¾
            if (builtinSpeakers && builtinSpeakers.length > 0) {
                const builtinGroup = document.createElement('optgroup');
                builtinGroup.label = 'å†…ç½®è¯­éŸ³äººè®¾';
                
                builtinSpeakers.forEach((speaker, index) => {
                    const option = document.createElement('option');
                    option.value = speaker;
                    option.textContent = speaker;
                    builtinGroup.appendChild(option);
                    
                    // è®°å½•ç¬¬ä¸€ä¸ªè¯­éŸ³äººè®¾
                    if (firstSpeaker === null) {
                        firstSpeaker = speaker;
                    }
                });
                
                select.appendChild(builtinGroup);
            }
            
            // æ·»åŠ è‡ªå®šä¹‰è¯­éŸ³äººè®¾
            if (customSpeakers && customSpeakers.length > 0) {
                const customGroup = document.createElement('optgroup');
                customGroup.label = 'è‡ªå®šä¹‰è¯­éŸ³äººè®¾';
                
                customSpeakers.forEach(speaker => {
                    const option = document.createElement('option');
                    option.value = speaker;
                    option.textContent = speaker + ' (è‡ªå®šä¹‰)';
                    customGroup.appendChild(option);
                    
                    // å¦‚æœæ²¡æœ‰å†…ç½®è¯­éŸ³äººè®¾ï¼Œè®°å½•ç¬¬ä¸€ä¸ªè‡ªå®šä¹‰è¯­éŸ³äººè®¾
                    if (firstSpeaker === null) {
                        firstSpeaker = speaker;
                    }
                });
                
                select.appendChild(customGroup);
            }
            
            // è®¾ç½®é€‰ä¸­çš„è¯­éŸ³äººè®¾
            let selectedSpeaker = ttsSettings.spk_id;
            
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é€‰æ‹©æˆ–ä¿å­˜çš„é€‰æ‹©ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª
            if (!selectedSpeaker || !isValidSpeaker(selectedSpeaker, builtinSpeakers, customSpeakers)) {
                selectedSpeaker = firstSpeaker;
                if (selectedSpeaker) {
                    ttsSettings.spk_id = selectedSpeaker;
                    saveTTSSettings();
                }
            }
            
            // è®¾ç½®é€‰ä¸­å€¼
            if (selectedSpeaker) {
                select.value = selectedSpeaker;
            }
            
            console.log('è¯­éŸ³äººè®¾åˆ—è¡¨å·²æ›´æ–°:', {
                builtin: builtinSpeakers ? builtinSpeakers.length : 0,
                custom: customSpeakers ? customSpeakers.length : 0,
                selected: selectedSpeaker,
                first: firstSpeaker
            });
        }
        
        // æ£€æŸ¥è¯­éŸ³äººè®¾æ˜¯å¦æœ‰æ•ˆ
        function isValidSpeaker(speakerId, builtinSpeakers, customSpeakers) {
            if (!speakerId) return false;
            
            if (builtinSpeakers && builtinSpeakers.includes(speakerId)) {
                return true;
            }
            
            if (customSpeakers && customSpeakers.includes(speakerId)) {
                return true;
            }
            
            return false;
        }
        
        // æ˜¾ç¤ºTTSé€šçŸ¥
        function showTTSNotification(message) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'tts-notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                animation: slideInRight 0.3s ease, fadeInUp 0.3s ease;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ä¿å­˜TTSè®¾ç½®
        function saveTTSSettings() {
            localStorage.setItem('ttsSettings', JSON.stringify(ttsSettings));
            localStorage.setItem('currentTTSMode', currentTTSMode);
        }
        
        // åŠ è½½TTSè®¾ç½®
        function loadTTSSettings() {
            const savedSettings = localStorage.getItem('ttsSettings');
            const savedMode = localStorage.getItem('currentTTSMode');
            
            if (savedSettings) {
                ttsSettings = { ...ttsSettings, ...JSON.parse(savedSettings) };
            }
            
            if (savedMode) {
                currentTTSMode = savedMode;
            }
            
            updateTTSModeDisplay();
            updateTTSControlButton();
            
            // åˆå§‹åŠ è½½è¯­éŸ³è§’è‰²åˆ—è¡¨
            loadCosyVoiceSpeakers();
        }
        
        // åˆå§‹åŒ–TTSè®¾ç½®äº‹ä»¶ç›‘å¬
        function initTTSSettings() {
            // èŠå¤©TTSå¼€å…³ - è®¾ç½®é¡µé¢çš„checkboxç°åœ¨åªæ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œä¸å…è®¸ç›´æ¥ä¿®æ”¹
            const chatToggle = document.getElementById('chatTTSToggle');
            if (chatToggle) {
                chatToggle.addEventListener('change', function() {
                    // é˜»æ­¢ç›´æ¥åœ¨è®¾ç½®é¡µé¢ä¿®æ”¹ï¼Œæç¤ºç”¨æˆ·åœ¨èŠå¤©çª—å£æ“ä½œ
                    this.checked = ttsSettings.chatEnabled; // æ¢å¤åŸçŠ¶æ€
                    
                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    showTTSNotification('è¯·åœ¨èŠå¤©çª—å£ä½¿ç”¨TTSæŒ‰é’®åˆ‡æ¢æ¨¡å¼');
                });
            }
            
            
            // CosyVoiceè¯­éŸ³äººè®¾é€‰æ‹©
            const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
            if (speakerSelect) {
                speakerSelect.addEventListener('change', function() {
                    // ç¡®ä¿ä¸å¯ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ä¸ä¿å­˜
                    if (this.value) {
                        ttsSettings.spk_id = this.value;
                        saveTTSSettings();
                        console.log('è¯­éŸ³äººè®¾å·²æ›´æ”¹:', ttsSettings.spk_id);
                        showTTSNotification('è¯­éŸ³äººè®¾å·²æ›´æ–°: ' + this.value);
                    }
                });
                
                // ç‚¹å‡»ä¸‹æ‹‰æ¡†æ—¶è‡ªåŠ¨åˆ·æ–°è¯­éŸ³äººè®¾åˆ—è¡¨
                speakerSelect.addEventListener('focus', function() {
                    loadCosyVoiceSpeakers();
                });
            }
            
            // åˆ·æ–°è¯­éŸ³äººè®¾æŒ‰é’®
            const refreshBtn = document.getElementById('refreshSpeakersBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    showTTSNotification('æ­£åœ¨åˆ·æ–°è¯­éŸ³äººè®¾åˆ—è¡¨...');
                    loadCosyVoiceSpeakers();
                });
            }

            // æ–°å¢è¯­éŸ³äººè®¾æŒ‰é’®
            const addSpeakerBtn = document.getElementById('addCustomSpeakerBtn');
            if (addSpeakerBtn) {
                addSpeakerBtn.addEventListener('click', function() {
                    showAddSpeakerModal();
                });
            }

            // ç”Ÿæˆè¯­éŸ³æŒ‰é’®
            const generateVoiceBtn = document.getElementById('generateVoiceBtn');
            if (generateVoiceBtn) {
                generateVoiceBtn.addEventListener('click', function() {
                    generateTestVoice();
                });
            }
            
            // è¯­éŸ³é€Ÿåº¦
            const speedRange = document.getElementById('ttsSpeedRange');
            const speedValue = document.getElementById('ttsSpeedValue');
            if (speedRange && speedValue) {
                speedRange.addEventListener('input', function() {
                    ttsSettings.speed = parseFloat(this.value);
                    speedValue.textContent = this.value + 'x';
                    saveTTSSettings();
                });
            }
        }

        // ==================== æ–°å¢è¯­éŸ³äººè®¾å¼¹çª—åŠŸèƒ½ ====================

        // æ˜¾ç¤ºæ–°å¢è¯­éŸ³äººè®¾å¼¹çª—
        function showAddSpeakerModal() {
            const modal = document.getElementById('addSpeakerModal');
            if (modal) {
                modal.style.display = 'block';
                // æ¸…ç©ºè¡¨å•
                resetAddSpeakerForm();
            }
        }

        // éšè—æ–°å¢è¯­éŸ³äººè®¾å¼¹çª—
        function hideAddSpeakerModal() {
            const modal = document.getElementById('addSpeakerModal');
            if (modal) {
                modal.style.display = 'none';
                resetAddSpeakerForm();
            }
        }

        // é‡ç½®è¡¨å•
        function resetAddSpeakerForm() {
            const form = document.getElementById('addSpeakerForm');
            if (form) {
                form.reset();
            }
        }

        // åˆ›å»ºè¯­éŸ³äººè®¾
        async function createCustomSpeaker(formData) {
            try {
                const createBtn = document.getElementById('createSpeakerBtn');
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.textContent = 'åˆ›å»ºä¸­...';
                }

                const response = await fetch('/api/cosyvoice/speaker/create', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showTTSNotification('è¯­éŸ³äººè®¾åˆ›å»ºæˆåŠŸ: ' + result.speakerName, 'success');
                        hideAddSpeakerModal();
                        
                        // åˆ·æ–°è¯­éŸ³äººè®¾åˆ—è¡¨
                        await loadCosyVoiceSpeakers();
                        
                        // é€‰ä¸­æ–°åˆ›å»ºçš„è¯­éŸ³äººè®¾
                        const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
                        if (speakerSelect && result.speakerName) {
                            speakerSelect.value = result.speakerName;
                            ttsSettings.spk_id = result.speakerName;
                            saveTTSSettings();
                            showTTSNotification('å·²è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„è¯­éŸ³äººè®¾: ' + result.speakerName);
                        }
                        
                        return true;
                    } else {
                        showTTSNotification('åˆ›å»ºå¤±è´¥: ' + result.message, 'error');
                        return false;
                    }
                } else {
                    const errorText = await response.text();
                    showTTSNotification('åˆ›å»ºå¤±è´¥: HTTP ' + response.status + ' - ' + errorText, 'error');
                    return false;
                }
            } catch (error) {
                console.error('åˆ›å»ºè¯­éŸ³äººè®¾å¼‚å¸¸:', error);
                showTTSNotification('åˆ›å»ºå¼‚å¸¸: ' + error.message, 'error');
                return false;
            } finally {
                const createBtn = document.getElementById('createSpeakerBtn');
                if (createBtn) {
                    createBtn.disabled = false;
                    createBtn.textContent = 'åˆ›å»ºè¯­éŸ³äººè®¾';
                }
            }
        }

        // éªŒè¯è¡¨å•æ•°æ®
        function validateSpeakerForm() {
            const speakerName = document.getElementById('speakerNameInput').value.trim();
            const referenceText = document.getElementById('referenceTextInput').value.trim();
            const referenceAudio = document.getElementById('referenceAudioInput').files[0];

            if (!speakerName) {
                showTTSNotification('è¯·è¾“å…¥è¯­éŸ³äººç‰©åç§°', 'error');
                return false;
            }

            if (speakerName.length > 50) {
                showTTSNotification('è¯­éŸ³äººç‰©åç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦', 'error');
                return false;
            }

            if (!referenceText) {
                showTTSNotification('è¯·è¾“å…¥å‚è€ƒæ–‡æœ¬', 'error');
                return false;
            }

            if (referenceText.length > 500) {
                showTTSNotification('å‚è€ƒæ–‡æœ¬ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦', 'error');
                return false;
            }

            if (!referenceAudio) {
                showTTSNotification('è¯·é€‰æ‹©å‚è€ƒéŸ³é¢‘æ–‡ä»¶', 'error');
                return false;
            }

            if (!referenceAudio.name.toLowerCase().endsWith('.wav')) {
                showTTSNotification('è¯·é€‰æ‹©WAVæ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶', 'error');
                return false;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º50MBï¼‰
            if (referenceAudio.size > 50 * 1024 * 1024) {
                showTTSNotification('éŸ³é¢‘æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡50MB', 'error');
                return false;
            }

            return true;
        }

        // åˆå§‹åŒ–å¼¹çª—äº‹ä»¶ç›‘å¬å™¨
        function initAddSpeakerModal() {
            // å…³é—­æŒ‰é’®
            const closeBtn = document.getElementById('closeSpeakerModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', hideAddSpeakerModal);
            }

            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.getElementById('cancelSpeakerBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideAddSpeakerModal);
            }

            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
            const modal = document.getElementById('addSpeakerModal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        hideAddSpeakerModal();
                    }
                });
            }

            // è¡¨å•æäº¤
            const form = document.getElementById('addSpeakerForm');
            if (form) {
                form.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    if (!validateSpeakerForm()) {
                        return;
                    }

                    const formData = new FormData();
                    formData.append('speakerName', document.getElementById('speakerNameInput').value.trim());
                    formData.append('referenceText', document.getElementById('referenceTextInput').value.trim());
                    formData.append('referenceAudio', document.getElementById('referenceAudioInput').files[0]);

                    await createCustomSpeaker(formData);
                });
            }

            // ESCé”®å…³é—­å¼¹çª—
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modal = document.getElementById('addSpeakerModal');
                    if (modal && modal.style.display === 'block') {
                        hideAddSpeakerModal();
                    }
                }
            });
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å¼¹çª—
        document.addEventListener('DOMContentLoaded', function() {
            initAddSpeakerModal();
        });

        // ==================== æµ‹è¯•è¯­éŸ³ç”ŸæˆåŠŸèƒ½ ====================

        // ç”Ÿæˆæµ‹è¯•è¯­éŸ³
        async function generateTestVoice() {
            const textInput = document.getElementById('testVoiceText');
            const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
            const generateBtn = document.getElementById('generateVoiceBtn');
            const resultDiv = document.getElementById('voiceTestResult');

            // éªŒè¯è¾“å…¥
            const text = textInput.value.trim();
            if (!text) {
                showTTSNotification('è¯·è¾“å…¥è¦æµ‹è¯•çš„æ–‡æœ¬', 'error');
                textInput.focus();
                return;
            }

            const selectedSpeaker = speakerSelect.value;
            if (!selectedSpeaker) {
                showTTSNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯­éŸ³äººè®¾', 'error');
                return;
            }

            try {
                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                generateBtn.disabled = true;
                generateBtn.textContent = 'ç”Ÿæˆä¸­...';
                
                // æ˜¾ç¤ºåŠ è½½å ä½ç¬¦
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        <div class="loading-spinner"></div>
                        <span>æ­£åœ¨ç”Ÿæˆè¯­éŸ³ï¼Œè¯·ç¨å€™...</span>
                    </div>
                `;

                // è·å–å½“å‰è¯­éŸ³é€Ÿåº¦è®¾ç½®
                const speedRange = document.getElementById('ttsSpeedRange');
                const speed = speedRange ? parseFloat(speedRange.value) : 1.0;

                // è°ƒç”¨APIç”Ÿæˆè¯­éŸ³
                const response = await fetch('/api/cosyvoice/synthesis/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        text: text,
                        speakerName: selectedSpeaker,
                        speed: speed.toString(),
                        format: 'wav'
                    })
                });

                if (response.ok) {
                    // è·å–éŸ³é¢‘æ•°æ®
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                    resultDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #4caf50;">
                            <span style="color: #2e7d32; font-weight: 500;">âœ… è¯­éŸ³ç”ŸæˆæˆåŠŸ</span>
                            <audio controls style="flex: 1;">
                                <source src="${audioUrl}" type="audio/wav">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                            </audio>
                            <button onclick="downloadTestAudio('${audioUrl}')" style="padding: 4px 8px; font-size: 12px;">ä¸‹è½½</button>
                        </div>
                    `;
                    
                    showTTSNotification('è¯­éŸ³ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <div style="padding: 10px; background: #f8d7da; border-radius: 6px; border-left: 4px solid #dc3545; color: #721c24;">
                            âŒ ç”Ÿæˆå¤±è´¥: ${errorText}
                        </div>
                    `;
                    showTTSNotification('è¯­éŸ³ç”Ÿæˆå¤±è´¥: ' + errorText, 'error');
                }

            } catch (error) {
                console.error('ç”Ÿæˆè¯­éŸ³å¼‚å¸¸:', error);
                resultDiv.innerHTML = `
                    <div style="padding: 10px; background: #f8d7da; border-radius: 6px; border-left: 4px solid #dc3545; color: #721c24;">
                        âŒ ç”Ÿæˆå¼‚å¸¸: ${error.message}
                    </div>
                `;
                showTTSNotification('è¯­éŸ³ç”Ÿæˆå¼‚å¸¸: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.textContent = 'ç”Ÿæˆè¯­éŸ³';
            }
        }

        // ä¸‹è½½æµ‹è¯•éŸ³é¢‘
        function downloadTestAudio(audioUrl) {
            const link = document.createElement('a');
            link.href = audioUrl;
            link.download = 'test_voice_' + new Date().getTime() + '.wav';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ¸…ç†éŸ³é¢‘URLï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
        function cleanupAudioUrls() {
            const audioElements = document.querySelectorAll('#voiceTestResult audio');
            audioElements.forEach(audio => {
                if (audio.src && audio.src.startsWith('blob:')) {
                    URL.revokeObjectURL(audio.src);
                }
            });
        }

        // åœ¨ç”Ÿæˆæ–°è¯­éŸ³å‰æ¸…ç†æ—§çš„URL
        window.addEventListener('beforeunload', cleanupAudioUrls);
    </script>

    <!-- æ–°å¢è¯­éŸ³äººè®¾å¼¹çª— -->
    <div id="addSpeakerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ­ æ–°å¢è¯­éŸ³äººè®¾</h2>
                <span class="close" id="closeSpeakerModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addSpeakerForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="speakerNameInput">è¯­éŸ³äººç‰©åç§°:</label>
                        <input type="text" id="speakerNameInput" name="speakerName" required 
                               placeholder="è¯·è¾“å…¥è¯­éŸ³äººç‰©åç§°ï¼ˆå¦‚ï¼šæ´¾è’™ï¼‰" maxlength="50">
                        <span class="form-description">å°†ä½œä¸ºè¯­éŸ³äººè®¾çš„æ ‡è¯†åç§°</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="referenceTextInput">å‚è€ƒæ–‡æœ¬:</label>
                        <textarea id="referenceTextInput" name="referenceText" required 
                                  placeholder="è¯·è¾“å…¥å‚è€ƒæ–‡æœ¬ï¼Œç”¨äºè®­ç»ƒè¯­éŸ³ç‰¹å¾..." 
                                  rows="4" maxlength="500"></textarea>
                        <span class="form-description">ç”¨äºè¯­éŸ³å…‹éš†çš„å‚è€ƒæ–‡æœ¬ï¼Œå»ºè®®10-50å­—</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="referenceAudioInput">å‚è€ƒéŸ³é¢‘æ–‡ä»¶:</label>
                        <input type="file" id="referenceAudioInput" name="referenceAudio" 
                               accept=".wav" required>
                        <span class="form-description">è¯·é€‰æ‹©WAVæ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶ï¼Œå»ºè®®3-10ç§’</span>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="cancelSpeakerBtn" class="cancel-btn">å–æ¶ˆ</button>
                        <button type="submit" id="createSpeakerBtn" class="create-btn">åˆ›å»ºè¯­éŸ³äººè®¾</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>
</html>
