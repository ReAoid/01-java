<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIËÅäÂ§©Êú∫Âô®‰∫∫Á≥ªÁªü</title>
    <!-- ÂºïÂÖ•marked.jsÁî®‰∫émarkdownËß£Êûê -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }
        
        /* Â∑¶‰æßTabÂØºËà™ */
        .sidebar {
            width: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 1000;
        }
        
        .tab-button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button:hover {
            background: rgba(103, 126, 234, 0.1);
            transform: scale(1.1);
        }
        
        .tab-button.active {
            background: rgba(103, 126, 234, 0.2);
            color: #667eea;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            right: -10px;
            width: 3px;
            height: 20px;
            background: #667eea;
            border-radius: 2px;
        }
        
        /* ‰∏ªÂÜÖÂÆπÂå∫Âüü */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* TabÂÜÖÂÆπ */
        .tab-content {
            display: none;
            flex: 1;
            padding: 0;
            overflow: hidden;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* ËÅäÂ§©Tab - ÈÄÇÂ∫î70%Á™óÂè£ */
        .tab-content#chat-tab {
            height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .tab-content#chat-tab.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* ËÆæÁΩÆTabÊ†áÂáÜÈ´òÂ∫¶ */
        .tab-content#settings-tab {
            height: 100vh;
        }
        
        .tab-content#settings-tab.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Êó•ÂøóTab - ÈÄÇÂ∫î70%Á™óÂè£ */
        .tab-content#logs-tab {
            height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .tab-content#logs-tab.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* ËÅäÂ§©ÁïåÈù¢Ê†∑Âºè - 70%Â§ßÂ∞èÂ±Ö‰∏≠ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 70%;
            height: 70vh;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .chat-container .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 12px;
            box-shadow: none;
            background: white;
        }
        
        .chat-container .header {
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .chat-container .chat-messages {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            background: white;
        }
        
        .chat-container .input-container {
            flex-shrink: 0;
            background: white;
            border-radius: 0 0 12px 12px;
        }
        
        /* Á°Æ‰øùÊ∂àÊÅØÂå∫ÂüüÊ≠£Á°ÆÊªöÂä® */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
        }
        
        .input-container {
            padding: 20px;
            border-top: 1px solid #eee;
            background: white;
        }
        
        /* ËÆæÁΩÆÁïåÈù¢Ê†∑Âºè */
        .settings-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            min-height: 100vh;
        }
        
        .settings-container .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: none;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }
        
        .settings-container .header {
            flex-shrink: 0;
            border-radius: 0;
        }
        
        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 0;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .settings-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .settings-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
        }
        
        .save-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .reset-btn {
            background: #dc3545;
            color: white;
        }
        
        .reset-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .export-btn, .import-btn {
            background: #007bff;
            color: white;
        }
        
        .export-btn:hover, .import-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .setting-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .setting-section:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .setting-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            position: relative;
        }
        
        .setting-item:last-child {
            margin-bottom: 0;
        }
        
        .setting-item label {
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .setting-item input[type="text"],
        .setting-item input[type="url"],
        .setting-item input[type="number"],
        .setting-item select {
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .setting-item input[type="text"]:focus,
        .setting-item input[type="url"]:focus,
        .setting-item input[type="number"]:focus,
        .setting-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .setting-item input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e1e5e9;
            outline: none;
            -webkit-appearance: none;
            margin: 10px 0;
        }
        
        .setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .setting-item input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }
        
        .setting-item input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .setting-description {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-weight: 500;
            color: #555;
        }
        
        .info-value {
            font-weight: 600;
            color: #333;
        }
        
        .setting-section p {
            margin: 0 0 15px 0;
            color: #666;
        }
        
        /* Êó•ÂøóÁïåÈù¢Ê†∑Âºè - 70%Â§ßÂ∞èÂ±Ö‰∏≠ */
        .logs-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 70%;
            height: 80vh;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .logs-container .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 12px;
            box-shadow: none;
            background: white;
        }
        
        .logs-container .header {
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .logs-content {
            flex: 1;
            padding: 20px;
            overflow: visible;
            min-height: 0;
        }
        
        .log-controls {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .log-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .log-controls select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .log-controls label {
            font-size: 14px;
            color: #333;
            margin-right: 8px;
        }
        
        .custom-time-range {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .custom-time-range div {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .custom-time-range input[type="datetime-local"] {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .refresh-btn {
            background: #007bff;
            color: white;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
        }
        
        .clear-btn {
            background: #dc3545;
            color: white;
        }
        
        .clear-btn:hover {
            background: #c82333;
        }
        
        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .log-viewer {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #d4d4d4;
            overflow-y: auto;
            height: 300px;
            border: 1px solid #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #569cd6;
            font-weight: bold;
        }
        
        .log-level {
            font-weight: bold;
            margin: 0 8px;
        }
        
        .log-level.INFO {
            color: #4ec9b0;
        }
        
        .log-level.WARN {
            color: #dcdcaa;
        }
        
        .log-level.ERROR {
            color: #f44747;
        }
        
        .log-level.DEBUG {
            color: #9cdcfe;
        }
        
        .log-message {
            color: #d4d4d4;
        }
        
        .log-stats {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .log-stats h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .stat-label {
            font-weight: 500;
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
        }
        
        .setting-item {
            margin: 15px 0;
        }
        
        .setting-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .setting-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .info-label {
            font-weight: 500;
            color: #666;
        }
        
        .info-value {
            font-weight: bold;
            color: #333;
        }
        
        #connectionStatus.connected {
            color: #28a745;
        }
        
        #connectionStatus.disconnected {
            color: #dc3545;
        }
        
        /* Ê∑±Ëâ≤Ê®°ÂºèÊ†∑Âºè */
        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        body.dark-mode .sidebar {
            background: rgba(52, 73, 94, 0.95);
        }
        
        body.dark-mode .tab-button {
            color: #ecf0f1;
        }
        
        body.dark-mode .tab-button:hover {
            background: rgba(52, 152, 219, 0.2);
        }
        
        body.dark-mode .tab-button.active {
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }
        
        body.dark-mode .container:not(.chat-container .container):not(.settings-container .container) {
            background: #34495e;
            color: #ecf0f1;
        }
        
        body.dark-mode .chat-container .container,
        body.dark-mode .settings-container .container {
            background: #34495e;
            color: #ecf0f1;
        }
        
        /* ËÅäÂ§©ÁïåÈù¢Âú®Ê∑±Ëâ≤Ê®°Âºè‰∏ã‰øùÊåÅÁôΩËâ≤ËÉåÊôØ */
        body.dark-mode .chat-container,
        body.dark-mode .chat-container .container,
        body.dark-mode .chat-container .chat-messages,
        body.dark-mode .chat-container .input-container {
            background: white !important;
            color: #333 !important;
        }
        
        /* ËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®Âú®Ê∑±Ëâ≤Ê®°Âºè‰∏ã‰øùÊåÅÊ∏êÂèò */
        body.dark-mode .chat-container .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        
        body.dark-mode .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        body.dark-mode .setting-section {
            background: #2c3e50;
            color: #ecf0f1;
        }
        
        body.dark-mode .info-item {
            background: #34495e;
        }
        
        body.dark-mode .info-label {
            color: #bdc3c7;
        }
        
        body.dark-mode .info-value {
            color: #ecf0f1;
        }
        
        /* Ê∑±Ëâ≤Ê®°Âºè‰∏ãÁöÑÊó•ÂøóÁïåÈù¢Ê†∑Âºè - ‰øùÊåÅÁôΩËâ≤ËÉåÊôØ */
        body.dark-mode .logs-container,
        body.dark-mode .logs-container .container,
        body.dark-mode .logs-content {
            background: white !important;
            color: #333 !important;
        }
        
        /* Êó•ÂøóÁïåÈù¢Â§¥ÈÉ®Âú®Ê∑±Ëâ≤Ê®°Âºè‰∏ã‰øùÊåÅÊ∏êÂèò */
        body.dark-mode .logs-container .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        
        body.dark-mode .log-controls {
            background: white !important;
            color: #333 !important;
        }
        
        body.dark-mode .log-stats {
            background: white !important;
            color: #333 !important;
        }
        
        body.dark-mode .log-stats h4 {
            color: #333 !important;
        }
        
        body.dark-mode .stat-item {
            background: #f8f9fa !important;
        }
        
        body.dark-mode .stat-label {
            color: #666 !important;
        }
        
        body.dark-mode .stat-value {
            color: #333 !important;
        }
        
        body.dark-mode .log-controls select {
            background: white !important;
            border-color: #ddd !important;
            color: #333 !important;
        }
        
        body.dark-mode .log-controls label {
            color: #333 !important;
        }
        
        body.dark-mode .custom-time-range {
            background: white !important;
            color: #333 !important;
        }
        
        body.dark-mode .custom-time-range label {
            color: #333 !important;
        }
        
        body.dark-mode .custom-time-range input[type="datetime-local"] {
            background: white !important;
            border-color: #ddd !important;
            color: #333 !important;
        }
        
        /* Êó†Âä®ÁîªÊ®°Âºè */
        body.no-animations * {
            transition: none !important;
            animation: none !important;
        }
        /* ÈªòËÆ§ÂÆπÂô®Ê†∑ÂºèÔºà‰ªÖÁî®‰∫éÁã¨Á´ãÈ°µÈù¢Ôºâ */
        .container:not(.chat-container .container):not(.settings-container .container) {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .status {
            padding: 10px 20px;
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            margin: 0;
            transition: all 0.3s ease;
        }
        .status.disconnected {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .status.connecting {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .message.assistant {
            background: #f1f3f4;
            color: #333;
        }
        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            max-width: 100%;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            text-align: center;
            max-width: 100%;
        }
        
        .typing-indicator {
            background: #f1f3f4;
            color: #666;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }
        .typing-indicator .dots {
            animation: blink 1.4s infinite both;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        .message.assistant[data-streamable="true"] {
            position: relative;
        }
        .message.assistant[data-streamable="true"]:after {
            content: '|';
            animation: cursor-blink 1s infinite;
            color: #007bff;
        }
        .message.assistant.stream-complete:after {
            display: none;
        }
        /* Ê∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØ‰∏çÊòæÁ§∫ÂÖâÊ†á */
        .message.mixed-content:after {
            display: none !important;
        }
        /* Ê∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØÊ†∑Âºè */
        .message.mixed-content {
            background: #f1f3f4;
            color: #333;
            padding: 0;
        }
        
        /* ÊÄùËÄÉÈÉ®ÂàÜÊ†∑Âºè - ÁÅ∞Ëâ≤ËÉåÊôØÔºåÁÅ∞ÁôΩËâ≤Â≠ó‰Ωì */
        .thinking-section {
            background: #6c757d;
            padding: 12px 15px;
            margin: 0;
            border-radius: 15px 15px 0 0;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #e9ecef;
            position: relative;
        }
        
        .thinking-section::before {
            content: 'üß† AIÊÄùËÄÉËøáÁ®ã';
            display: block;
            font-weight: bold;
            color: #f8f9fa;
            margin-bottom: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
        }
        
        /* ÊôÆÈÄöÂÜÖÂÆπÈÉ®ÂàÜÊ†∑Âºè - Ê≠£Â∏∏ËÉåÊôØÂíåÂ≠ó‰Ωì */
        .normal-section {
            background: #f1f3f4;
            padding: 12px 15px;
            margin: 0;
            border-radius: 0 0 15px 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            border-top: 1px solid #dee2e6;
        }
        
        /* Âè™ÊúâÊÄùËÄÉÂÜÖÂÆπÊó∂ÁöÑÊ†∑Âºè */
        .thinking-only {
            border-radius: 15px;
        }
        
        /* Âè™ÊúâÊôÆÈÄöÂÜÖÂÆπÊó∂ÁöÑÊ†∑Âºè */
        .normal-only {
            border-radius: 15px;
        }
        
        /* ÊÄùËÄÉÈÉ®ÂàÜmarkdownÊ†∑Âºè - ÈÄÇÈÖçÁÅ∞Ëâ≤ËÉåÊôØ */
        .thinking-section h1, .thinking-section h2, .thinking-section h3 {
            margin: 10px 0 5px 0;
            color: #f8f9fa;
            font-weight: bold;
        }
        
        .thinking-section h1 { font-size: 16px; }
        .thinking-section h2 { font-size: 15px; }
        .thinking-section h3 { font-size: 14px; }
        
        .thinking-section code {
            background: rgba(0, 0, 0, 0.2);
            color: #ffc107;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: inherit;
        }
        
        .thinking-section pre {
            background: rgba(0, 0, 0, 0.2);
            color: #e9ecef;
            padding: 8px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .thinking-section ul, .thinking-section ol {
            margin: 8px 0;
            padding-left: 20px;
            color: #e9ecef;
        }
        
        .thinking-section li {
            margin: 4px 0;
        }
        
        .thinking-section blockquote {
            border-left: 3px solid #17a2b8;
            padding-left: 10px;
            margin: 8px 0;
            font-style: italic;
            color: #ced4da;
        }
        
        .thinking-section p {
            margin: 8px 0;
            color: #e9ecef;
        }
        
        .thinking-section strong {
            color: #f8f9fa;
            font-weight: bold;
        }
        
        .thinking-section em {
            color: #ced4da;
            font-style: italic;
        }
        
        /* ‰øùÁïôÂéüÊúâÁöÑÁã¨Á´ãÊÄùËÄÉÊ∂àÊÅØÊ†∑ÂºèÔºåÁî®‰∫éÂÖºÂÆπ */
        .message.thinking {
            background: #fff8dc;
            border-left: 4px solid #ffa500;
            font-style: italic;
            opacity: 0.8;
        }
        .message.thinking::before {
            content: 'üß† ÊÄùËÄÉ: ';
            font-weight: bold;
            color: #ff8c00;
        }
        @keyframes cursor-blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .input-container {
            padding: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }
        .send-btn {
            padding: 12px 25px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }
        .send-btn:hover {
            background: #0056b3;
        }
        .interrupt-btn {
            padding: 12px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            display: none; /* ÈªòËÆ§ÈöêËóè */
            transition: all 0.3s ease;
        }
        .interrupt-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        .interrupt-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .interrupt-btn.visible {
            display: block;
        }
        .interrupt-icon {
            font-size: 16px;
            margin-right: 5px;
        }
        .persona-selector {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .persona-selector select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        .thinking-toggle, .asr-toggle, .tts-toggle, .web-search-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .thinking-toggle label, .asr-toggle label, .tts-toggle label, .web-search-toggle label {
            font-size: 14px;
            color: #666;
            margin: 0;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #007bff;
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch.active::before {
            transform: translateX(26px);
        }
        .ollama-status {
            padding: 5px 20px;
            background: #d1ecf1;
            border-bottom: 1px solid #bee5eb;
            font-size: 12px;
            color: #0c5460;
        }
        .ollama-status.unavailable {
            background: #f8d7da;
            border-bottom-color: #f5c6cb;
            color: #721c24;
        }
        
        /* ========== Â§öÈÄöÈÅìTTSÊ†∑Âºè ========== */
        
        /* Live2DÊ∞îÊ≥°Ê†∑Âºè */
        .live2d-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 20px 20px 5px 20px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            max-width: 250px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease;
        }
        
        .live2d-bubble.waiting-for-audio {
            border-left: 4px solid #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }
        
        .live2d-bubble.playing-audio {
            border-left: 4px solid #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            box-shadow: 0 2px 12px rgba(76, 175, 80, 0.3);
            transform: scale(1.02);
        }
        
        .live2d-bubble.sentence-completed {
            border-left: 4px solid #2196f3;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            opacity: 0.8;
        }
        
        .live2d-bubble.audio-failed {
            border-left: 4px solid #f44336;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
        }
        
        .live2d-bubble::before {
            content: '';
            position: absolute;
            bottom: -5px;
            right: 15px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #764ba2;
        }
        
        .live2d-bubble.waiting-for-audio::before {
            border-top-color: #ffe0b2;
        }
        
        .live2d-bubble.playing-audio::before {
            border-top-color: #c8e6c9;
        }
        
        .live2d-bubble.sentence-completed::before {
            border-top-color: #bbdefb;
        }
        
        .live2d-bubble.audio-failed::before {
            border-top-color: #ffcdd2;
        }
        
        /* Live2DÂÆπÂô® */
        .live2d-container {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* Èü≥È¢ëÁä∂ÊÄÅÊåáÁ§∫Âô® */
        .audio-waiting-indicator,
        .audio-playing-indicator {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .audio-waiting-indicator {
            color: #ff9800;
            animation: pulse 1.5s infinite;
        }
        
        .audio-playing-indicator {
            color: #4caf50;
            animation: pulse 1.5s infinite;
        }
        
        .audio-error-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.7;
            font-size: 16px;
        }
        
        /* TTSÈîôËØØÈÄöÁü• */
        .tts-error-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffebee;
            color: #c62828;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0.9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease;
        }
        
        /* ÂÖ®Â±ÄÈü≥È¢ëÊåáÁ§∫Âô® */
        .global-audio-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .global-audio-indicator.active {
            opacity: 1;
            transform: scale(1);
        }
        
        .global-audio-indicator::before {
            content: 'üîä';
            font-size: 18px;
            animation: pulse 1.5s infinite;
        }
        
        /* Â§öÈÄöÈÅìÈÖçÁΩÆÁïåÈù¢ */
        .output-channels-settings {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .channel-config {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            background: #fafafa;
        }
        
        .channel-config h4 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 16px;
        }
        
        .sub-options {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        .sub-options label {
            display: block;
            margin: 6px 0;
            font-size: 14px;
        }
        
        .preset-configs {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }
        
        .preset-configs button {
            margin: 4px;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .preset-configs button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        /* TTSÊ®°ÂºèÊòæÁ§∫ */
        .current-mode-display {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        /* Âä®ÁîªÊïàÊûú */
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1); 
            }
            50% { 
                opacity: 0.6; 
                transform: scale(1.05); 
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 0.9;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        /* ËÅäÂ§©Á™óÂè£TTSÁä∂ÊÄÅ */
        .message.assistant.tts-enabled {
            border-left: 3px solid #4caf50;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e9 100%);
        }
        
        .message.assistant.tts-playing {
            animation: pulse 2s infinite;
            border-left-color: #ff9800;
        }
        
        .message.assistant.tts-completed {
            border-left-color: #2196f3;
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .live2d-container {
                right: 10px;
                width: 250px;
            }
            
            .live2d-bubble {
                max-width: 200px;
                font-size: 13px;
                padding: 10px 14px;
            }
            
            .tts-error-notification {
                right: 10px;
                font-size: 11px;
                padding: 6px 10px;
            }
            
            .preset-configs button {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* ÂºπÁ™óÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-description {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        .cancel-btn,
        .create-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .create-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .create-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Ê∑±Ëâ≤Ê®°Âºè‰∏ãÁöÑÂºπÁ™óÊ†∑Âºè */
        body.dark-mode .modal-content {
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        body.dark-mode .form-group input[type="text"],
        body.dark-mode .form-group textarea {
            background-color: #34495e;
            border-color: #4a5f7a;
            color: #ecf0f1;
        }

        body.dark-mode .form-group input[type="text"]:focus,
        body.dark-mode .form-group textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        body.dark-mode .form-description {
            color: #bdc3c7;
        }

        body.dark-mode .form-actions {
            border-top-color: #4a5f7a;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ëá™ÂÆö‰πâ‰∏ãÊãâÊ°ÜÊ†∑Âºè */
        .custom-select-container {
            position: relative;
        }

        .custom-select {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            user-select: none;
            transition: border-color 0.3s ease;
        }

        .custom-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .custom-select:hover {
            border-color: #999;
        }

        .select-display {
            flex: 1;
            color: #333;
        }

        .select-arrow {
            margin-left: 8px;
            color: #666;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .custom-select.open .select-arrow {
            transform: rotate(180deg);
        }

        .select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .select-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .select-option:last-child {
            border-bottom: none;
        }

        .select-option:hover {
            background-color: #f8f9fa;
        }

        .select-option.selected {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .option-text {
            flex: 1;
        }

        .option-badge {
            margin-left: 8px;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 3px;
            background: #e3f2fd;
            color: #1976d2;
        }

        .option-badge.custom {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .delete-btn {
            margin-left: 8px;
            padding: 2px 6px;
            font-size: 12px;
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        /* Ê∑±Ëâ≤Ê®°Âºè‰∏ãÁöÑËá™ÂÆö‰πâ‰∏ãÊãâÊ°ÜÊ†∑Âºè */
        body.dark-mode .custom-select {
            background: #34495e;
            border-color: #4a5f7a;
            color: #ecf0f1;
        }

        body.dark-mode .custom-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        body.dark-mode .select-dropdown {
            background: #34495e;
            border-color: #4a5f7a;
        }

        body.dark-mode .select-option {
            color: #ecf0f1;
            border-bottom-color: #4a5f7a;
        }

        body.dark-mode .select-option:hover {
            background-color: #4a5f7a;
        }

        body.dark-mode .select-option.selected {
            background-color: #2c5282;
            color: #90cdf4;
        }
    </style>
</head>
<body>
    <!-- Â∑¶‰æßTabÂØºËà™ -->
    <div class="sidebar">
        <button class="tab-button active" data-tab="chat" title="ËÅäÂ§©">
            üí¨
        </button>
        <button class="tab-button" data-tab="settings" title="ËÆæÁΩÆ">
            ‚öôÔ∏è
        </button>
        <button class="tab-button" data-tab="logs" title="Êó•Âøó">
            üìã
        </button>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
    <div class="main-content">
        <!-- ËÅäÂ§©TabÂÜÖÂÆπ -->
        <div class="tab-content active" id="chat-tab">
            <div class="chat-container">
    <div class="container">
        <div class="header">
            <h1>ü§ñ AIËÅäÂ§©Êú∫Âô®‰∫∫Á≥ªÁªü</h1>
            <p>Âü∫‰∫éJava21ÁöÑÊô∫ËÉΩÂØπËØùÁ≥ªÁªü - ÊîØÊåÅÊµÅÂºèÂìçÂ∫î„ÄÅÂ§ö‰∫∫ËÆæ„ÄÅÈïøÊúüËÆ∞ÂøÜ</p>
        </div>
        
        <div class="status" id="status">
            üî¥ Êú™ËøûÊé•
        </div>
        
        <div class="ollama-status" id="ollamaStatus">
            ü§ñ Ê≠£Âú®Ê£ÄÊü•OllamaÊúçÂä°Áä∂ÊÄÅ...
        </div>
        
        <div class="persona-selector">
            <div>
                <label>ÈÄâÊã©‰∫∫ËÆæ: </label>
                <select id="personaSelect">
                    <option value="default">Êô∫ËÉΩÂä©Êâã</option>
                    <option value="advisor">‰∏ì‰∏öÈ°æÈóÆ</option>
                    <option value="creative">ÂàõÊÑèÂä©Êâã</option>
                </select>
            </div>
            <div class="thinking-toggle">
                <label for="thinkingToggle">ÊòæÁ§∫ÊÄùËÄÉ:</label>
                <div class="toggle-switch" id="thinkingToggle" title="ÂàáÊç¢ÊòØÂê¶ÊòæÁ§∫AIÁöÑÊÄùËÄÉËøáÁ®ã"></div>
            </div>
            <div class="asr-toggle">
                <label for="asrToggle">ÂºÄÂêØASR:</label>
                <div class="toggle-switch" id="asrToggle" title="ÂàáÊç¢ËØ≠Èü≥ËØÜÂà´ËæìÂÖ•Ê®°Âºè"></div>
            </div>
            <div class="tts-toggle">
                <label for="ttsToggle">ÂºÄÂêØTTS:</label>
                <div class="toggle-switch" id="ttsToggle" title="ÂàáÊç¢ËÅäÂ§©Á™óÂè£ËØ≠Èü≥ËæìÂá∫Ê®°Âºè"></div>
            </div>
            <div class="web-search-toggle">
                <label for="webSearchToggle">ËÅîÁΩëÊêúÁ¥¢:</label>
                <div class="toggle-switch" id="webSearchToggle" title="ÂàáÊç¢ÊòØÂê¶ÂêØÁî®ËÅîÁΩëÊêúÁ¥¢ÂäüËÉΩ"></div>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="message system">Ê¨¢Ëøé‰ΩøÁî®AIËÅäÂ§©Êú∫Âô®‰∫∫Á≥ªÁªüÔºÅÊ≠£Âú®ËøûÊé•ÊúçÂä°Âô®...</div>
        </div>
        
        <div class="input-container">
            <input type="text" id="messageInput" class="message-input" 
                   placeholder="ËæìÂÖ•ÊÇ®ÁöÑÊ∂àÊÅØ..." disabled>
            <button id="interruptBtn" class="interrupt-btn" title="ÂÅúÊ≠¢AIÂõûÂ§ç">
                <span class="interrupt-icon">‚èπ</span>ÂÅúÊ≠¢
            </button>
            <button id="sendBtn" class="send-btn" disabled>ÂèëÈÄÅ</button>
        </div>
    </div>
            </div>
        </div>

        <!-- ËÆæÁΩÆTabÂÜÖÂÆπ -->
        <div class="tab-content" id="settings-tab">
            <div class="settings-container">
                <div class="container">
                    <div class="header">
                        <h1>‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ</h1>
                        <p>Á≥ªÁªüÈÖçÁΩÆÂíå‰∏™ÊÄßÂåñÈÄâÈ°π</p>
                    </div>
                    
                    <div class="settings-content">
                        <!-- ÈÖçÁΩÆÊìç‰ΩúÊåâÈíÆ -->
                        <div class="settings-actions">
                            <button id="saveSettingsBtn" class="save-btn">üíæ ‰øùÂ≠òÈÖçÁΩÆ</button>
                            <button id="resetSettingsBtn" class="reset-btn">üîÑ ÈáçÁΩÆ‰∏∫ÈªòËÆ§</button>
                            <button id="exportSettingsBtn" class="export-btn">üì§ ÂØºÂá∫ÈÖçÁΩÆ</button>
                            <button id="importSettingsBtn" class="import-btn">üì• ÂØºÂÖ•ÈÖçÁΩÆ</button>
                            <input type="file" id="importFileInput" accept=".json" style="display: none;">
                        </div>
                        
                        <!-- ÁïåÈù¢ËÆæÁΩÆ -->
                        <div class="setting-section">
                            <h3>üé® ÁïåÈù¢ËÆæÁΩÆ</h3>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="darkModeToggle"> Ê∑±Ëâ≤Ê®°Âºè
                                </label>
                                <span class="setting-description">ÂàáÊç¢Ê∑±Ëâ≤/ÊµÖËâ≤‰∏ªÈ¢ò</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="animationsToggle" checked> ÂêØÁî®Âä®ÁîªÊïàÊûú
                                </label>
                                <span class="setting-description">ÂêØÁî®ÁïåÈù¢Âä®ÁîªÂíåËøáÊ∏°ÊïàÊûú</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="autoScrollToggle" checked> Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
                                </label>
                                <span class="setting-description">Êñ∞Ê∂àÊÅØÊó∂Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="soundNotificationToggle"> Ê∂àÊÅØÊèêÁ§∫Èü≥
                                </label>
                                <span class="setting-description">Êî∂Âà∞Êñ∞Ê∂àÊÅØÊó∂Êí≠ÊîæÊèêÁ§∫Èü≥</span>
                            </div>
                            <div class="setting-item">
                                <label for="languageSelect">ÁïåÈù¢ËØ≠Ë®Ä:</label>
                                <select id="languageSelect">
                                    <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                                    <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                                    <option value="en-US">English</option>
                                    <option value="ja-JP">Êó•Êú¨Ë™û</option>
                                </select>
                                <span class="setting-description">ÈÄâÊã©ÁïåÈù¢ÊòæÁ§∫ËØ≠Ë®Ä</span>
                            </div>
                        </div>
                        
                        <!-- OllamaËÆæÁΩÆ -->
                        <div class="setting-section">
                            <h3>ü§ñ OllamaËÆæÁΩÆ</h3>
                            <div class="setting-item">
                                <label for="ollamaUrlInput">OllamaÊúçÂä°Âú∞ÂùÄ:</label>
                                <input type="url" id="ollamaUrlInput" placeholder="http://localhost:11434" value="http://localhost:11434">
                                <span class="setting-description">OllamaÊúçÂä°ÁöÑËÆøÈóÆÂú∞ÂùÄ</span>
                            </div>
                            <div class="setting-item">
                                <label for="ollamaModelInput">‰ΩøÁî®Ê®°Âûã:</label>
                                <input type="text" id="ollamaModelInput" placeholder="qwen3:4b" value="qwen3:4b">
                                <span class="setting-description">ÊåáÂÆö‰ΩøÁî®ÁöÑAIÊ®°ÂûãÂêçÁß∞</span>
                            </div>
                            <div class="setting-item">
                                <label for="ollamaTimeoutInput">ËøûÊé•Ë∂ÖÊó∂ (ÊØ´Áßí):</label>
                                <input type="number" id="ollamaTimeoutInput" min="5000" max="120000" step="1000" value="30000">
                                <span class="setting-description">OllamaÊúçÂä°ËøûÊé•Ë∂ÖÊó∂Êó∂Èó¥</span>
                            </div>
                            <div class="setting-item">
                                <label for="ollamaMaxTokensInput">ÊúÄÂ§ßËæìÂá∫ÈïøÂ∫¶:</label>
                                <input type="number" id="ollamaMaxTokensInput" min="512" max="8192" step="256" value="4096">
                                <span class="setting-description">ÂçïÊ¨°ÂõûÂ§çÁöÑÊúÄÂ§ßÈïøÂ∫¶ÈôêÂà∂</span>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="ollamaStreamToggle" checked> ÂêØÁî®ÊµÅÂºèËæìÂá∫
                                </label>
                                <span class="setting-description">ÂÆûÊó∂ÊòæÁ§∫AIÂõûÂ§çËøáÁ®ã</span>
                            </div>
                        </div>
                        
                        <!-- ËÅîÁΩëÊêúÁ¥¢ËÆæÁΩÆ -->
                        <div class="setting-section">
                            <h3>üåê ËÅîÁΩëÊêúÁ¥¢ËÆæÁΩÆ</h3>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="webSearchEnabledToggle"> ÂêØÁî®ËÅîÁΩëÊêúÁ¥¢
                                </label>
                                <span class="setting-description">ÂÖ®Â±ÄÂêØÁî®/Á¶ÅÁî®ËÅîÁΩëÊêúÁ¥¢ÂäüËÉΩ</span>
                            </div>
                            <div class="setting-item">
                                <label for="webSearchEngineSelect">ÊêúÁ¥¢ÂºïÊìé:</label>
                                <select id="webSearchEngineSelect">
                                    <option value="duckduckgo">DuckDuckGo</option>
                                    <option value="google">Google</option>
                                    <option value="bing">Bing</option>
                                </select>
                                <span class="setting-description">ÈÄâÊã©ÈªòËÆ§ÊêúÁ¥¢ÂºïÊìé</span>
                            </div>
                            <div class="setting-item">
                                <label for="webSearchMaxResultsInput">ÊúÄÂ§ßÊêúÁ¥¢ÁªìÊûúÊï∞:</label>
                                <input type="number" id="webSearchMaxResultsInput" min="1" max="20" value="5">
                                <span class="setting-description">ÊØèÊ¨°ÊêúÁ¥¢ËøîÂõûÁöÑÊúÄÂ§ßÁªìÊûúÊï∞Èáè</span>
                            </div>
                            <div class="setting-item">
                                <label for="webSearchTimeoutInput">ÊêúÁ¥¢Ë∂ÖÊó∂ (Áßí):</label>
                                <input type="number" id="webSearchTimeoutInput" min="5" max="60" value="10">
                                <span class="setting-description">ÊêúÁ¥¢ËØ∑Ê±ÇÁöÑË∂ÖÊó∂Êó∂Èó¥</span>
                            </div>
                        </div>
                        
                        <!-- TTSËØ≠Èü≥ËÆæÁΩÆ -->
                        <div class="setting-section">
                            <h3>üîä TTSËØ≠Èü≥ËÆæÁΩÆ</h3>
                            <div class="setting-item">
                                <label>ÂΩìÂâçTTSÊ®°Âºè:</label>
                                <span id="currentTTSMode" class="current-mode-display">Ê®°Âºè1 - Á∫ØÊñáÊú¨</span>
                                <span class="setting-description">ÂΩìÂâçÊøÄÊ¥ªÁöÑËØ≠Èü≥ËæìÂá∫Ê®°ÂºèÔºàÈÄöËøáËÅäÂ§©Á™óÂè£ÂàáÊç¢Ôºâ</span>
                            </div>
                            <div class="setting-item">
                                <label for="cosyVoiceSpeakerSelect">ËØ≠Èü≥‰∫∫ËÆæ:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="custom-select-container" style="flex: 1; position: relative;">
                                        <div id="cosyVoiceSpeakerSelect" class="custom-select" tabindex="0">
                                            <div class="select-display">ËØ∑ÈÄâÊã©ËØ≠Èü≥‰∫∫ËÆæ...</div>
                                            <div class="select-arrow">‚ñº</div>
                                        </div>
                                        <div id="speakerDropdown" class="select-dropdown" style="display: none;">
                                            <!-- ËØ≠Èü≥‰∫∫ËÆæÈÄâÈ°πÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                                        </div>
                                    </div>
                                    <button id="refreshSpeakersBtn" type="button">Âà∑Êñ∞</button>
                                    <button id="addCustomSpeakerBtn" type="button">Êñ∞Â¢ûËØ≠Èü≥‰∫∫ËÆæ</button>
                                </div>
                                <span class="setting-description">ÈÄâÊã©CosyVoice TTSÊúçÂä°ÁöÑËØ≠Èü≥‰∫∫ËÆæ</span>
                            </div>
                            <div class="setting-item">
                                <label for="testVoiceText">ÊµãËØï‰∫∫ËÆæËØ≠Èü≥:</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" id="testVoiceText" placeholder="ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑÊñáÊú¨..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <button id="generateVoiceBtn" type="button">ÁîüÊàêËØ≠Èü≥</button>
                                </div>
                                <div id="voiceTestResult" style="margin-top: 10px; min-height: 40px;">
                                    <!-- Èü≥È¢ëÊí≠ÊîæÂô®Â∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                                </div>
                                <span class="setting-description">ËæìÂÖ•ÊñáÊú¨ÊµãËØïÂΩìÂâçÈÄâ‰∏≠ÁöÑËØ≠Èü≥‰∫∫ËÆæÊïàÊûú</span>
                            </div>
                            <div class="setting-item">
                                <label for="ttsSpeedRange">ËØ≠Èü≥ÈÄüÂ∫¶:</label>
                                <input type="range" id="ttsSpeedRange" min="0.5" max="2.0" step="0.1" value="1.0">
                                <span id="ttsSpeedValue">1.0x</span>
                                <span class="setting-description">Ë∞ÉÊï¥ËØ≠Èü≥Êí≠ÊîæÈÄüÂ∫¶</span>
                            </div>
                        </div>
                        
                        
                        <!-- Á≥ªÁªü‰ø°ÊÅØ -->
                        <div class="setting-section">
                            <h3>üîß Á≥ªÁªü‰ø°ÊÅØ</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">ÁâàÊú¨:</span>
                                    <span class="info-value">v1.0.0</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ËøûÊé•Áä∂ÊÄÅ:</span>
                                    <span class="info-value" id="connectionStatus">Êú™ËøûÊé•</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ÈÖçÁΩÆÁä∂ÊÄÅ:</span>
                                    <span class="info-value" id="configStatus">Êú™Âä†ËΩΩ</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ÊúÄÂêé‰øùÂ≠ò:</span>
                                    <span class="info-value" id="lastSavedTime">‰ªéÊú™‰øùÂ≠ò</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Êó•ÂøóTabÂÜÖÂÆπ -->
        <div class="tab-content" id="logs-tab">
            <div class="logs-container">
                <div class="container">
                    <div class="header">
                        <h1>üìã Á≥ªÁªüÊó•Âøó</h1>
                        <p>ÂÆûÊó∂Êü•ÁúãÁ≥ªÁªüËøêË°åÊó•ÂøóÂíåÁä∂ÊÄÅ‰ø°ÊÅØ</p>
                    </div>
                    
                    <div class="logs-content">
                        <div class="log-controls">
                            <div>
                                <button id="refreshLogsBtn" class="refresh-btn">üîÑ Âà∑Êñ∞Êó•Âøó</button>
                                <button id="clearLogsBtn" class="clear-btn">üóëÔ∏è Ê∏ÖÁ©∫ÊòæÁ§∫</button>
                            </div>
                            <div>
                                <label for="logLevelSelect">Êó•ÂøóÁ∫ßÂà´:</label>
                                <select id="logLevelSelect">
                                    <option value="ALL">ÂÖ®ÈÉ®</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="WARN">WARN</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="TRACE">TRACE</option>
                                </select>
                            </div>
                            <div>
                                <label for="timeRangeSelect">Êó∂Èó¥ËåÉÂõ¥:</label>
                                <select id="timeRangeSelect">
                                    <option value="30m" selected>ÊúÄËøë30ÂàÜÈíü</option>
                                    <option value="1h">ÊúÄËøë1Â∞èÊó∂</option>
                                    <option value="3h">ÊúÄËøë3Â∞èÊó∂</option>
                                    <option value="12h">ÊúÄËøëÂçäÂ§©</option>
                                    <option value="1d">ÊúÄËøë1Â§©</option>
                                    <option value="custom">Ëá™ÂÆö‰πâÊó∂Èó¥ÊÆµ</option>
                                    <option value="all">ÂÖ®ÈÉ®Êó∂Èó¥</option>
                                </select>
                            </div>
                            <div class="auto-refresh-toggle">
                                <label for="autoRefreshToggle">Ëá™Âä®Âà∑Êñ∞:</label>
                                <div class="toggle-switch active" id="autoRefreshToggle" title="ÂàáÊç¢ÊòØÂê¶Ëá™Âä®Âà∑Êñ∞Êó•Âøó"></div>
                                <select id="refreshIntervalSelect">
                                    <option value="5">5Áßí</option>
                                    <option value="10" selected>10Áßí</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="custom-time-range" id="customTimeRange" style="display: none;">
                            <div>
                                <label for="startTimeInput">ÂºÄÂßãÊó∂Èó¥:</label>
                                <input type="datetime-local" id="startTimeInput">
                            </div>
                            <div>
                                <label for="endTimeInput">ÁªìÊùüÊó∂Èó¥:</label>
                                <input type="datetime-local" id="endTimeInput">
                            </div>
                            <button id="applyCustomTimeBtn" class="refresh-btn">Â∫îÁî®Êó∂Èó¥ÊÆµ</button>
                        </div>
                        
                        <div class="log-viewer" id="logViewer">
                            <div class="log-entry">
                                <span class="log-message">Ê≠£Âú®Âä†ËΩΩÊó•Âøó...</span>
                            </div>
                        </div>
                        
                        <div class="log-stats">
                            <h4>üìä Êó•ÂøóÁªüËÆ°</h4>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">ÊÄªÊù°Êï∞:</span>
                                    <span class="stat-value" id="totalLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ÈîôËØØ:</span>
                                    <span class="stat-value" id="errorLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Ë≠¶Âëä:</span>
                                    <span class="stat-value" id="warnLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">‰ø°ÊÅØ:</span>
                                    <span class="stat-value" id="infoLogs">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ÊúÄÂêéÊõ¥Êñ∞:</span>
                                    <span class="stat-value" id="lastUpdate">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentSessionId = null;
        let isConnected = false;
        let currentAssistantMessage = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let showThinking = true; // ÊÄùËÄÉÊòæÁ§∫Áä∂ÊÄÅ
        let asrEnabled = false; // ASRËØ≠Èü≥ËØÜÂà´Áä∂ÊÄÅ
        let useWebSearch = false; // ËÅîÁΩëÊêúÁ¥¢Áä∂ÊÄÅ
        let isAIResponding = false; // AIÊòØÂê¶Ê≠£Âú®ÂõûÂ§ç
        let currentStreamingMessage = null; // ÂΩìÂâçÊµÅÂºèÊ∂àÊÅØÂÖÉÁ¥†
        let aiResponseTimeout = null; // AIÂìçÂ∫îË∂ÖÊó∂ÂÆöÊó∂Âô®
        let timeoutMessageShown = false; // Èò≤Ê≠¢ÈáçÂ§çÊòæÁ§∫Ë∂ÖÊó∂Ê∂àÊÅØÁöÑÊ†áÂøó
        let lastAIActivityTime = null; // ÊúÄÂêé‰∏ÄÊ¨°AIÊ¥ªÂä®Êó∂Èó¥
        let activityCheckInterval = null; // Ê¥ªÂä®Ê£ÄÊµãÂÆöÊó∂Âô®
        
        // ASRÁõ∏ÂÖ≥ÂèòÈáè
        let asrServiceAvailable = false; // ASRÊúçÂä°ÊòØÂê¶ÂèØÁî®
        let mediaRecorder = null; // Â™í‰ΩìÂΩïÂà∂Âô®
        let audioStream = null; // Èü≥È¢ëÊµÅ
        let isRecording = false; // ÊòØÂê¶Ê≠£Âú®ÂΩïÈü≥
        
        // TTSÁõ∏ÂÖ≥ÂèòÈáè
        let currentTTSMode = 'text_only'; // ÂΩìÂâçTTSÊ®°Âºè
        let ttsSettings = {
            chatEnabled: false,
            chatMode: 'text_only',
            speed: 1.0,
            spk_id: null // CosyVoiceËØ≠Èü≥‰∫∫ËÆæID
        };
        
        // Êó•ÂøóÁõ∏ÂÖ≥ÂèòÈáè
        let autoRefreshLogs = true; // Ëá™Âä®Âà∑Êñ∞Êó•ÂøóÁä∂ÊÄÅ - ÈªòËÆ§ÂºÄÂêØ
        let logRefreshInterval = null; // Êó•ÂøóÂà∑Êñ∞ÂÆöÊó∂Âô®
        let refreshIntervalSeconds = 10; // ÈªòËÆ§Âà∑Êñ∞Èó¥Èöî10Áßí
        let isLogsTabActive = false; // Êó•ÂøótabÊòØÂê¶ÊøÄÊ¥ª
        let logStats = {
            total: 0,
            error: 0,
            warn: 0,
            info: 0,
            debug: 0
        };

        const statusDiv = document.getElementById('status');
        const ollamaStatusDiv = document.getElementById('ollamaStatus');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const interruptBtn = document.getElementById('interruptBtn');
        const personaSelect = document.getElementById('personaSelect');
        const thinkingToggle = document.getElementById('thinkingToggle');
        const asrToggle = document.getElementById('asrToggle');
        const ttsToggle = document.getElementById('ttsToggle');
        const webSearchToggle = document.getElementById('webSearchToggle');
        
        // Êó•ÂøóÁõ∏ÂÖ≥DOMÂÖÉÁ¥†
        const logViewer = document.getElementById('logViewer');
        const refreshLogsBtn = document.getElementById('refreshLogsBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        const logLevelSelect = document.getElementById('logLevelSelect');
        const refreshIntervalSelect = document.getElementById('refreshIntervalSelect');
        const timeRangeSelect = document.getElementById('timeRangeSelect');
        const customTimeRange = document.getElementById('customTimeRange');
        const startTimeInput = document.getElementById('startTimeInput');
        const endTimeInput = document.getElementById('endTimeInput');
        const applyCustomTimeBtn = document.getElementById('applyCustomTimeBtn');
        const totalLogsSpan = document.getElementById('totalLogs');
        const errorLogsSpan = document.getElementById('errorLogs');
        const warnLogsSpan = document.getElementById('warnLogs');
        const infoLogsSpan = document.getElementById('infoLogs');
        const lastUpdateSpan = document.getElementById('lastUpdate');

        // ËøûÊé•WebSocket
        function connect() {
            if (reconnectAttempts === 0) {
                updateStatus('connecting', 'üü° Ê≠£Âú®ËøûÊé•...');
            }
            
            const wsUrl = `ws://${window.location.host}/ws/chat`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                isConnected = true;
                reconnectAttempts = 0;
                updateStatus('connected', 'üü¢ Â∑≤ËøûÊé•');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                
                addMessage('system', 'ËøûÊé•ÊàêÂäüÔºÅÊÇ®ÂèØ‰ª•ÂºÄÂßãÂØπËØù‰∫Ü„ÄÇ');
                checkOllamaStatus();
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleIncomingMessage(message);
                } catch (e) {
                    console.error('Ëß£ÊûêÊ∂àÊÅØÂ§±Ë¥•:', e);
                }
            };

            ws.onclose = function() {
                isConnected = false;
                updateStatus('disconnected', 'üî¥ ËøûÊé•Êñ≠ÂºÄ');
                messageInput.disabled = true;
                sendBtn.disabled = true;
                
                // ÈáçÁΩÆAIÂìçÂ∫îÁä∂ÊÄÅÔºàËøûÊé•Êñ≠ÂºÄÊó∂Ôºâ
                console.log('üîå WebSocketËøûÊé•Êñ≠ÂºÄ - ÈáçÁΩÆAIÁä∂ÊÄÅ');
                isAIResponding = false;
                hideInterruptButton();
                enableChatControls();
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    addMessage('system', `ËøûÊé•Â∑≤Êñ≠ÂºÄÔºåÊ≠£Âú®Â∞ùËØïÈáçËøû... (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
                    reconnectAttempts++;
                    setTimeout(connect, 3000);
                } else {
                    addMessage('system', 'ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Âô®Áä∂ÊÄÅÂêéÂà∑Êñ∞È°µÈù¢ÈáçËØï„ÄÇ');
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketÈîôËØØ:', error);
                addMessage('system', 'ËøûÊé•Âá∫Áé∞ÈîôËØØÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Âô®Áä∂ÊÄÅ„ÄÇ');
                
                // ÈáçÁΩÆAIÂìçÂ∫îÁä∂ÊÄÅÔºàËøûÊé•ÈîôËØØÊó∂Ôºâ
                console.log('‚ùå WebSocketËøûÊé•ÈîôËØØ - ÈáçÁΩÆAIÁä∂ÊÄÅ');
                isAIResponding = false;
                hideInterruptButton();
                enableChatControls();
            };
        }

        // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
        function updateStatus(type, text) {
            statusDiv.innerHTML = text;
            statusDiv.className = 'status';
            if (type === 'disconnected') {
                statusDiv.classList.add('disconnected');
            } else if (type === 'connecting') {
                statusDiv.classList.add('connecting');
            }
        }

        // Ê£ÄÊü•OllamaÊúçÂä°Áä∂ÊÄÅ
        function checkOllamaStatus() {
            // ÂèëÈÄÅ‰∏Ä‰∏™Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅÁöÑÊ∂àÊÅØ
            if (ws && isConnected) {
                const checkMessage = {
                    type: 'system',
                    content: 'check_ollama_status',
                    metadata: { action: 'check_service' }
                };
                ws.send(JSON.stringify(checkMessage));
            }
        }

        // Â§öÈÄöÈÅìÊ∂àÊÅØË∑ØÁî±Âô®
        class MultiChannelRouter {
            constructor() {
                this.channels = new Map();
                this.registerChannels();
            }
            
            registerChannels() {
                this.channels.set('chat_window', new ChatWindowHandler());
                this.channels.set('live2d', new Live2DHandler());
            }
            
            routeMessage(message) {
                const channelType = message.channelType || 'chat_window';
                const handler = this.channels.get(channelType);
                
                if (handler) {
                    handler.handleMessage(message);
                } else {
                    console.warn('Êú™Áü•ÁöÑÈÄöÈÅìÁ±ªÂûã:', channelType, message);
                    // ÊäõÂá∫ÂºÇÂ∏∏ËÆ©Â§ñÂ±ÇÂ§ÑÁêÜ
                    throw new Error(`Êú™Áü•ÁöÑÈÄöÈÅìÁ±ªÂûã: ${channelType}`);
                }
            }
            
            // ÂÖºÂÆπÊóßÁâàÊú¨Ê∂àÊÅØÂ§ÑÁêÜ
            handleLegacyMessage(message) {
                const chatHandler = this.channels.get('chat_window');
                if (chatHandler) {
                    chatHandler.handleMessage(message);
                }
            }
            
            getChannel(channelType) {
                return this.channels.get(channelType);
            }
        }
        
        // ËÅäÂ§©Á™óÂè£Â§ÑÁêÜÂô®
        class ChatWindowHandler {
            constructor() {
                this.audioManager = new CharStreamAudioManager();
                this.currentAssistantMessage = null;
            }
            
            handleMessage(message) {
                console.log('üè† ËÅäÂ§©Á™óÂè£Â§ÑÁêÜÊ∂àÊÅØ:', message);
                
                switch(message.type) {
                    case 'text':
                        this.handleTextMessage(message);
                        break;
                    case 'audio':
                        this.handleAudioMessage(message);
                        break;
                    case 'tts_error':
                        this.handleTTSError(message);
                        break;
                    default:
                        console.log('ËÅäÂ§©Á™óÂè£Êú™Â§ÑÁêÜÁöÑÊ∂àÊÅØÁ±ªÂûã:', message.type);
                }
            }
            
            handleTextMessage(message) {
                removeTypingIndicator();
                
                // Â¶ÇÊûúÊòØÊÄùËÄÉÂÜÖÂÆπÔºå‰ΩøÁî®‰º†ÁªüÁöÑÊµÅÂºèÊ∂àÊÅØÂ§ÑÁêÜÔºà‰∏çËß¶ÂèëTTSÔºâ
                if (message.thinking) {
                    console.log('üß† Â§ÑÁêÜÊÄùËÄÉÂÜÖÂÆπÔºåË∑≥ËøáTTS:', message);
                    if (message.streaming) {
                        if (!isAIResponding) {
                            console.log('üöÄ ÂºÄÂßãAIÂõûÂ§ç (ÊÄùËÄÉÊµÅÂºèÊ∂àÊÅØ)');
                            isAIResponding = true;
                            showInterruptButton();
                            disableChatControls();
                            setAIResponseTimeout();
                        }
                        handleStreamingMessage(message);
                    } else {
                        recordAIActivity(); // ËÆ∞ÂΩïÊúÄÂêé‰∏ÄÊ¨°Ê¥ªÂä®
                        addMessage('assistant', message.content);
                        // ÈáçÁΩÆAIÂìçÂ∫îÁä∂ÊÄÅÔºàÊÄùËÄÉÊ∂àÊÅØÂÆåÊàêÔºâ
                        console.log('‚úÖ AIÂõûÂ§çÁªìÊùü (ÊÄùËÄÉÈùûÊµÅÂºèÊ∂àÊÅØ)');
                        isAIResponding = false;
                        clearAIResponseTimeout();
                        hideInterruptButton();
                        enableSendButton();
                        enableChatControls();
                    }
                    return;
                }
                
                if (message.ttsMode === 'char_stream') {
                    // Ê®°Âºè2ÔºöÂ≠óÁ¨¶ÊµÅ+TTS
                    if (!isAIResponding) {
                        console.log('üöÄ ÂºÄÂßãAIÂõûÂ§ç (Â≠óÁ¨¶ÊµÅÊ®°Âºè)');
                        isAIResponding = true;
                        showInterruptButton();
                        disableChatControls();
                        setAIResponseTimeout();
                    }
                    this.handleCharStreamText(message);
                } else if (message.streaming) {
                    // ‰º†ÁªüÊµÅÂºèÊ∂àÊÅØ
                    if (!isAIResponding) {
                        console.log('üöÄ ÂºÄÂßãAIÂõûÂ§ç (‰º†ÁªüÊµÅÂºèÊ∂àÊÅØ)');
                        isAIResponding = true;
                        showInterruptButton();
                        disableChatControls();
                        setAIResponseTimeout();
                    }
                    handleStreamingMessage(message);
                } else {
                    // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ - ÈúÄË¶ÅÈáçÁΩÆAIÁä∂ÊÄÅ
                    recordAIActivity(); // ËÆ∞ÂΩïÊúÄÂêé‰∏ÄÊ¨°Ê¥ªÂä®
                    addMessage('assistant', message.content);
                    // ÈáçÁΩÆAIÂìçÂ∫îÁä∂ÊÄÅ
                    console.log('‚úÖ AIÂõûÂ§çÁªìÊùü (ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ)');
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableSendButton();
                    enableChatControls();
                }
            }
            
            handleCharStreamText(message) {
                // ËÆ∞ÂΩïAIÊ¥ªÂä®
                recordAIActivity();
                
                console.log('üîç Â§ÑÁêÜÂ≠óÁ¨¶ÊµÅÊñáÊú¨:', {
                    content: message.content,
                    contentLength: message.content ? message.content.length : 0,
                    isEmpty: !message.content || message.content.trim() === '',
                    sentenceOrder: message.sentenceOrder,
                    streamComplete: message.streamComplete
                });
                
                // Â¶ÇÊûúÂÜÖÂÆπ‰∏∫Á©∫‰∏î‰∏çÊòØÊµÅÂºèÂÆåÊàêÊ∂àÊÅØÔºåË∑≥ËøáÂ§ÑÁêÜ
                if ((!message.content || message.content.trim() === '') && !message.streamComplete) {
                    console.warn('‚ö†Ô∏è Ë∑≥ËøáÁ©∫ÂÜÖÂÆπÊ∂àÊÅØ');
                    return;
                }
                
                // ‰∏∫ÊØè‰∏™Êñ∞ÁöÑAIÂõûÂ§çÂàõÂª∫Êñ∞ÁöÑÊ∂àÊÅØÊ∞îÊ≥°
                if (!this.currentAssistantMessage || message.sentenceOrder === 0) {
                    this.currentAssistantMessage = this.createMessage('assistant');
                    console.log('üÜï ÂàõÂª∫Êñ∞ÁöÑÂä©ÊâãÊ∂àÊÅØÊ∞îÊ≥°');
                }
                
                // Á´ãÂç≥ÊòæÁ§∫ÊñáÊú¨ÔºàÂè™ÊúâÂú®ÊúâÂÜÖÂÆπÊó∂ÊâçÊòæÁ§∫Ôºâ
                if (message.content && message.content.trim() !== '') {
                    this.appendText(this.currentAssistantMessage, message.content);
                }
                
                if (message.streamComplete) {
                    // Ê£ÄÊü•ÂΩìÂâçÊ∂àÊÅØÊòØÂê¶‰∏∫Á©∫ÔºåÂ¶ÇÊûú‰∏∫Á©∫ÂàôÁßªÈô§
                    if (this.currentAssistantMessage && 
                        (!this.currentAssistantMessage.textContent || 
                         this.currentAssistantMessage.textContent.trim() === '')) {
                        console.warn('üóëÔ∏è ÁßªÈô§Á©∫ÁöÑÊ∂àÊÅØÊ∞îÊ≥°');
                        this.currentAssistantMessage.remove();
                    }
                    
                    this.currentAssistantMessage = null;
                    enableSendButton();
                    
                    // Âú®Ê®°Âºè2‰∏ãÔºåÈúÄË¶ÅÁ≠âÂæÖÈü≥È¢ëÊí≠ÊîæÂÆåÊàêÊâçËÉΩÂÆåÂÖ®ÈáçÁΩÆÁä∂ÊÄÅ
                    if (ttsSettings.chatEnabled && ttsSettings.chatMode === 'char_stream_tts') {
                        console.log('üìù Â≠óÁ¨¶ÊµÅÊñáÊú¨ÂÆåÊàêÔºå‰ΩÜÈü≥È¢ëÂèØËÉΩËøòÂú®Êí≠ÊîæÔºå‰øùÊåÅÂÅúÊ≠¢ÊåâÈíÆ');
                        // ËÆæÁΩÆ‰∏Ä‰∏™Ê£ÄÊü•Âô®Êù•ÁõëÊéßÈü≥È¢ëÊí≠ÊîæÁä∂ÊÄÅ
                        this.checkAudioCompletionForMode2();
                    } else {
                        // ÈùûTTSÊ®°ÂºèÔºåÁ´ãÂç≥ÈáçÁΩÆÁä∂ÊÄÅ
                        isAIResponding = false;
                        clearAIResponseTimeout();
                        hideInterruptButton();
                        enableChatControls();
                        
                        
                        console.log('‚úÖ Â≠óÁ¨¶ÊµÅÊ®°ÂºèÂÆåÊàêÔºåÈáçÁΩÆÁä∂ÊÄÅ');
                    }
                }
            }
            
            checkAudioCompletionForMode2() {
                // Ê£ÄÊü•Èü≥È¢ëÊòØÂê¶ËøòÂú®Êí≠Êîæ
                const checkInterval = setInterval(() => {
                    const audioManager = this.audioManager;
                    const isAudioPlaying = audioManager && (audioManager.isPlaying || audioManager.audioQueue.length > 0);
                    
                    if (!isAudioPlaying) {
                        // Èü≥È¢ëÊí≠ÊîæÂÆåÊàêÔºåÂèØ‰ª•ÈáçÁΩÆÁä∂ÊÄÅ
                        console.log('üîä Ê®°Âºè2Èü≥È¢ëÊí≠ÊîæÂÆåÊàêÔºåÈáçÁΩÆUIÁä∂ÊÄÅ');
                        isAIResponding = false;
                        clearAIResponseTimeout();
                        hideInterruptButton();
                        enableChatControls();
                        clearInterval(checkInterval);
                    } else {
                        console.log('üéµ Ê®°Âºè2Èü≥È¢ë‰ªçÂú®Êí≠ÊîæÔºå‰øùÊåÅÂÅúÊ≠¢ÊåâÈíÆÊòæÁ§∫');
                    }
                }, 500); // ÊØè500msÊ£ÄÊü•‰∏ÄÊ¨°
                
                // ËÆæÁΩÆÊúÄÂ§ßÁ≠âÂæÖÊó∂Èó¥ÔºåÈò≤Ê≠¢Êó†ÈôêÁ≠âÂæÖ
                setTimeout(() => {
                    clearInterval(checkInterval);
                    if (isAIResponding) {
                        console.log('‚è∞ Ê®°Âºè2Èü≥È¢ëÁ≠âÂæÖË∂ÖÊó∂ÔºåÂº∫Âà∂ÈáçÁΩÆÁä∂ÊÄÅ');
                        isAIResponding = false;
                        clearAIResponseTimeout();
                        hideInterruptButton();
                        enableChatControls();
                    }
                }, 30000); // 30ÁßíË∂ÖÊó∂
            }
            
            handleAudioMessage(message) {
                if (message.ttsMode === 'char_stream') {
                    // Ê®°Âºè2ÔºöÂºÇÊ≠•Èü≥È¢ëÊí≠Êîæ
                    console.log('üéµ Êî∂Âà∞Èü≥È¢ëÊ∂àÊÅØ:', {
                        sentenceId: message.sentenceId,
                        hasAudioData: !!message.audioData,
                        audioDataLength: message.audioData ? message.audioData.length : 0,
                        content: message.content
                    });
                    
                    if (!message.audioData) {
                        console.error('‚ùå Èü≥È¢ëÊï∞ÊçÆ‰∏∫Á©∫ÔºÅ');
                        return;
                    }
                    
                    this.audioManager.addAudio(
                        message.audioData, 
                        message.sentenceId || this.generateId(), 
                        message.content,
                        this.currentAssistantMessage // ‰º†ÈÄíÊ∂àÊÅØÂÖÉÁ¥†Áî®‰∫éÁä∂ÊÄÅÊõ¥Êñ∞
                    );
                }
            }
            
            handleTTSError(message) {
                console.warn('TTSÈîôËØØ:', message.content);
            }
            
            createMessage(sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                chatContainer.appendChild(messageDiv);
                scrollToBottom();
                return messageDiv;
            }
            
            appendText(element, text) {
                element.textContent += text;
                scrollToBottom();
            }
            
            showTTSError(errorText) {
                // ÊòæÁ§∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑÈîôËØØÊèêÁ§∫
                const errorDiv = document.createElement('div');
                errorDiv.className = 'tts-error-notification';
                errorDiv.textContent = 'üîá ' + errorText;
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #ffebee;
                    color: #c62828;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    opacity: 0.9;
                `;
                
                document.body.appendChild(errorDiv);
                
                // 3ÁßíÂêéËá™Âä®ÁßªÈô§
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 3000);
            }
            
            generateId() {
                return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
        }
        
        // Live2DÂ§ÑÁêÜÂô®
        class Live2DHandler {
            constructor() {
                this.sentenceSyncManager = new StrictSentenceSyncManager();
                this.live2dController = null; // Â∞ÜÊù•ËøûÊé•Live2D
            }
            
            handleMessage(message) {
                console.log('üé® Live2DÂ§ÑÁêÜÊ∂àÊÅØ:', message);
                
                switch(message.type) {
                    case 'live2d_sentence_display':
                        this.sentenceSyncManager.handleSentenceDisplay(message);
                        this.showLive2DBubble(message);
                        break;
                    case 'live2d_sentence_audio':
                        this.sentenceSyncManager.handleSentenceAudio(message);
                        break;
                    case 'live2d_audio_failed':
                        this.sentenceSyncManager.handleAudioFailed(message);
                        break;
                    case 'live2d_all_complete':
                        this.handleAllComplete(message);
                        break;
                    default:
                        console.log('Live2DÊú™Â§ÑÁêÜÁöÑÊ∂àÊÅØÁ±ªÂûã:', message.type);
                }
            }
            
            showLive2DBubble(message) {
                // ÊòæÁ§∫Live2DÊ∞îÊ≥°
                if (this.live2dController) {
                    this.live2dController.showBubble(message.content, message.sentenceId);
                } else {
                    // ÈôçÁ∫ßÊòæÁ§∫ÔºöÂú®È°µÈù¢‰∏äÊòæÁ§∫Live2DÊ∞îÊ≥°
                    this.showFallbackBubble(message.content, message.sentenceId);
                }
            }
            
            showFallbackBubble(text, sentenceId) {
                // Âú®È°µÈù¢Âè≥‰æßÊòæÁ§∫Live2DÈ£éÊ†ºÁöÑÊ∞îÊ≥°
                const bubble = document.createElement('div');
                bubble.className = 'live2d-bubble';
                bubble.dataset.sentenceId = sentenceId;
                bubble.textContent = text;
                
                const live2dContainer = document.querySelector('.live2d-container') || 
                                       this.createLive2DContainer();
                live2dContainer.appendChild(bubble);
                
                // Ê∑ªÂä†Âä®Áîª
                bubble.style.opacity = '0';
                bubble.style.transform = 'scale(0.8) translateY(20px)';
                
                requestAnimationFrame(() => {
                    bubble.style.transition = 'all 0.3s ease';
                    bubble.style.opacity = '1';
                    bubble.style.transform = 'scale(1) translateY(0)';
                });
            }
            
            createLive2DContainer() {
                const container = document.createElement('div');
                container.className = 'live2d-container';
                container.style.cssText = `
                    position: fixed;
                    right: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 300px;
                    z-index: 1000;
                    pointer-events: none;
                `;
                document.body.appendChild(container);
                return container;
            }
            
            handleAllComplete(message) {
                console.log('‚úÖ Live2DÊâÄÊúâÂè•Â≠êÂ§ÑÁêÜÂÆåÊàê - ÈáçÁΩÆAIÁä∂ÊÄÅ');
                // ÈáçÁΩÆAIÂìçÂ∫îÁä∂ÊÄÅ
                isAIResponding = false;
                clearAIResponseTimeout();
                hideInterruptButton();
                enableSendButton();
                enableChatControls();
            }
        }
        
        // Â≠óÁ¨¶ÊµÅÈü≥È¢ëÁÆ°ÁêÜÂô®
        class CharStreamAudioManager {
            constructor() {
                this.audioQueue = [];
                this.isPlaying = false;
                this.currentAudio = null;
            }
            
            addAudio(audioData, sentenceId, text, messageElement = null) {
                console.log('üéµ CharStreamAudioManager.addAudio Ë∞ÉÁî®:', {
                    hasAudioData: !!audioData,
                    audioDataType: typeof audioData,
                    audioDataLength: audioData ? audioData.length : 0,
                    sentenceId: sentenceId,
                    text: text
                });
                
                if (!audioData) {
                    console.warn('Èü≥È¢ëÊï∞ÊçÆ‰∏∫Á©∫ÔºåË∑≥ËøáÊí≠Êîæ');
                    return;
                }
                
                try {
                    // Â∞ÜBase64Èü≥È¢ëÊï∞ÊçÆËΩ¨Êç¢‰∏∫Blob
                    console.log('üîÑ ÂºÄÂßãËΩ¨Êç¢Base64Èü≥È¢ëÊï∞ÊçÆ...');
                    const binaryString = atob(audioData);
                    console.log('‚úÖ Base64Ëß£Á†ÅÊàêÂäüÔºå‰∫åËøõÂà∂ÈïøÂ∫¶:', binaryString.length);
                    
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    const audioBlob = new Blob([bytes], {type: 'audio/wav'});
                    const audioUrl = URL.createObjectURL(audioBlob);
                    console.log('‚úÖ Èü≥È¢ëBlobÂàõÂª∫ÊàêÂäüÔºåURL:', audioUrl);
                    
                    const audioElement = new Audio(audioUrl);
                    
                    // Ê∑ªÂä†Èü≥È¢ëÂä†ËΩΩ‰∫ã‰ª∂ÁõëÂê¨
                    audioElement.addEventListener('loadstart', () => {
                        console.log('üéµ Èü≥È¢ëÂºÄÂßãÂä†ËΩΩ:', sentenceId);
                    });
                    
                    audioElement.addEventListener('canplay', () => {
                        console.log('‚úÖ Èü≥È¢ëÂèØ‰ª•Êí≠Êîæ:', sentenceId);
                    });
                    
                    audioElement.addEventListener('error', (e) => {
                        console.error('‚ùå Èü≥È¢ëÂä†ËΩΩÈîôËØØ:', e, sentenceId);
                    });
                    
                    const audioItem = {
                        id: sentenceId,
                        text: text,
                        audio: audioElement,
                        timestamp: Date.now(),
                        messageElement: messageElement
                    };
                    
                    this.audioQueue.push(audioItem);
                    console.log('‚úÖ Èü≥È¢ëÊ∑ªÂä†Âà∞ÈòüÂàóÔºåÈòüÂàóÈïøÂ∫¶:', this.audioQueue.length);
                    
                    // Â¶ÇÊûúÂΩìÂâçÊ≤°ÊúâÊí≠ÊîæÔºåÁ´ãÂç≥ÂºÄÂßãÊí≠Êîæ
                    if (!this.isPlaying) {
                        console.log('üöÄ ÂºÄÂßãÊí≠ÊîæÈü≥È¢ëÈòüÂàó');
                        this.playNext();
                    }
                } catch (error) {
                    console.error('‚ùå Â§ÑÁêÜÈü≥È¢ëÊï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }
            
            async playNext() {
                if (this.audioQueue.length === 0) {
                    this.isPlaying = false;
                    return;
                }
                
                this.isPlaying = true;
                const audioItem = this.audioQueue.shift();
                this.currentAudio = audioItem.audio;
                
                try {
                    await this.playAudio(audioItem.audio);
                } catch (error) {
                    console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', error);
                } finally {
                    // Êí≠Êîæ‰∏ã‰∏Ä‰∏™
                    setTimeout(() => this.playNext(), 100); // Âè•Â≠êÈó¥100msÈó¥Èöî
                }
            }
            
            playAudio(audio) {
                return new Promise((resolve, reject) => {
                    console.log('üéµ ÂºÄÂßãÊí≠ÊîæÈü≥È¢ë:', audio.src);
                    
                    audio.onended = () => {
                        console.log('‚úÖ Èü≥È¢ëÊí≠ÊîæÂÆåÊàê:', audio.src);
                        resolve();
                    };
                    
                    audio.onerror = (e) => {
                        console.error('‚ùå Èü≥È¢ëÊí≠ÊîæÈîôËØØ:', e, audio.src);
                        reject(e);
                    };
                    
                    audio.play()
                        .then(() => {
                            console.log('‚úÖ Èü≥È¢ëÂºÄÂßãÊí≠Êîæ:', audio.src);
                        })
                        .catch((e) => {
                            console.error('‚ùå Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e, audio.src);
                            reject(e);
                        });
                });
            }
            
            skipCurrent() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.playNext();
                }
            }
            
            clearQueue() {
                this.audioQueue = [];
                if (this.currentAudio) {
                    this.currentAudio.pause();
                }
                this.isPlaying = false;
            }
            
            stopAll() {
                console.log('üîá CharStreamAudioManager: ÂÅúÊ≠¢ÊâÄÊúâÈü≥È¢ë');
                
                // ÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÁöÑÈü≥È¢ë
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.currentAudio = null;
                }
                
                // Ê∏ÖÁ©∫ÈòüÂàó‰∏≠ÁöÑÊâÄÊúâÈü≥È¢ë
                this.audioQueue.forEach(item => {
                    if (item.audio) {
                        item.audio.pause();
                        item.audio.currentTime = 0;
                    }
                });
                
                // Ê∏ÖÁ©∫ÈòüÂàó
                this.audioQueue = [];
                this.isPlaying = false;
                
                console.log('‚úÖ CharStreamAudioManager: ÊâÄÊúâÈü≥È¢ëÂ∑≤ÂÅúÊ≠¢');
            }
        }
        
        // ‰∏•Ê†ºÂè•Â≠êÂêåÊ≠•ÁÆ°ÁêÜÂô®
        class StrictSentenceSyncManager {
            constructor() {
                this.currentSentence = null;
                this.isWaitingForAudio = false;
                this.isPlayingAudio = false;
            }
            
            handleSentenceDisplay(message) {
                // Âè™ÊúâÂú®Ê≤°ÊúâÂΩìÂâçÂè•Â≠êÊó∂ÊâçÊòæÁ§∫Êñ∞Âè•Â≠ê
                if (this.currentSentence === null) {
                    this.displaySentence(message);
                } else {
                    console.error('Êî∂Âà∞Êñ∞Âè•Â≠ê‰ΩÜÂΩìÂâçÂè•Â≠êÊú™ÂÆåÊàê:', message);
                }
            }
            
            handleSentenceAudio(message) {
                if (this.currentSentence && 
                    this.currentSentence.sentenceId === message.sentenceId) {
                    
                    if (message.audioData) {
                        this.playAudio(message.audioData);
                    } else {
                        // TTSÂ§±Ë¥•ÔºåË∑≥ËøáÈü≥È¢ëÁõ¥Êé•ÂÆåÊàê
                        this.completeSentence();
                    }
                }
            }
            
            handleAudioFailed(message) {
                if (this.currentSentence && 
                    this.currentSentence.sentenceId === message.sentenceId) {
                    
                    this.markAudioFailed();
                    this.completeSentence();
                }
            }
            
            displaySentence(message) {
                // ÂàõÂª∫Âè•Â≠êÊ∞îÊ≥°
                const bubble = this.createSentenceBubble(message.content, message.sentenceId);
                
                this.currentSentence = {
                    sentenceId: message.sentenceId,
                    order: message.sentenceOrder,
                    text: message.content,
                    element: bubble,
                    audio: null
                };
                
                this.isWaitingForAudio = true;
                
                // ÊòæÁ§∫Á≠âÂæÖÈü≥È¢ëÁöÑÁä∂ÊÄÅ
                bubble.classList.add('waiting-for-audio');
                this.showWaitingIndicator(bubble);
            }
            
            async playAudio(audioData) {
                if (!this.currentSentence) return;
                
                this.isWaitingForAudio = false;
                this.isPlayingAudio = true;
                
                try {
                    // Â∞ÜBase64Èü≥È¢ëÊï∞ÊçÆËΩ¨Êç¢‰∏∫AudioÂØπË±°
                    const binaryString = atob(audioData);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    const audioBlob = new Blob([bytes], {type: 'audio/wav'});
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    this.currentSentence.audio = audio;
                    this.currentSentence.element.classList.remove('waiting-for-audio');
                    this.currentSentence.element.classList.add('playing-audio');
                    
                    this.hideWaitingIndicator();
                    this.showPlayingIndicator(this.currentSentence.element);
                    
                    await this.playAudioWithPromise(audio);
                    this.completeSentence();
                } catch (error) {
                    console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', error);
                    this.markAudioFailed();
                    this.completeSentence();
                }
            }
            
            playAudioWithPromise(audio) {
                return new Promise((resolve, reject) => {
                    audio.onended = resolve;
                    audio.onerror = reject;
                    audio.play().catch(reject);
                });
            }
            
            completeSentence() {
                if (!this.currentSentence) return;
                
                this.isWaitingForAudio = false;
                this.isPlayingAudio = false;
                
                // Ê†áËÆ∞Âè•Â≠êÂÆåÊàê
                this.currentSentence.element.classList.remove('waiting-for-audio', 'playing-audio');
                this.currentSentence.element.classList.add('sentence-completed');
                
                this.hideAllIndicators();
                
                // ÈÄöÁü•ÂêéÁ´ØÈü≥È¢ëÊí≠ÊîæÂÆåÊàêÔºåÂèØ‰ª•ÂèëÈÄÅ‰∏ã‰∏ÄÂè•
                this.notifyAudioCompleted(this.currentSentence.sentenceId);
                
                // Ê∏ÖÁ©∫ÂΩìÂâçÂè•Â≠ê
                this.currentSentence = null;
            }
            
            notifyAudioCompleted(sentenceId) {
                const completionMessage = {
                    type: 'audio_playback_completed',
                    sentenceId: sentenceId,
                    timestamp: Date.now()
                };
                
                // ÈÄöËøáWebSocketÂèëÈÄÅÁªôÂêéÁ´Ø
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(completionMessage));
                    console.log('ÈÄöÁü•ÂêéÁ´ØÈü≥È¢ëÊí≠ÊîæÂÆåÊàê:', sentenceId);
                }
            }
            
            createSentenceBubble(text, sentenceId) {
                const bubble = document.createElement('div');
                bubble.className = 'live2d-bubble';
                bubble.dataset.sentenceId = sentenceId;
                bubble.textContent = text;
                
                // Ê∑ªÂä†Âà∞Live2DÂÆπÂô®
                const container = document.querySelector('.live2d-container') || 
                                 this.createLive2DContainer();
                container.appendChild(bubble);
                
                // Ê∑ªÂä†Âá∫Áé∞Âä®Áîª
                bubble.style.opacity = '0';
                bubble.style.transform = 'translateY(20px)';
                bubble.style.transition = 'all 0.4s ease';
                
                requestAnimationFrame(() => {
                    bubble.style.opacity = '1';
                    bubble.style.transform = 'translateY(0)';
                });
                
                return bubble;
            }
            
            createLive2DContainer() {
                const container = document.createElement('div');
                container.className = 'live2d-container';
                container.style.cssText = `
                    position: fixed;
                    right: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 300px;
                    z-index: 1000;
                `;
                document.body.appendChild(container);
                return container;
            }
            
            showWaitingIndicator(bubble) {
                const indicator = document.createElement('div');
                indicator.className = 'audio-waiting-indicator';
                indicator.innerHTML = '‚è≥ Ê≠£Âú®ÁîüÊàêËØ≠Èü≥...';
                bubble.appendChild(indicator);
            }
            
            hideWaitingIndicator() {
                if (this.currentSentence) {
                    const indicator = this.currentSentence.element.querySelector('.audio-waiting-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            }
            
            showPlayingIndicator(bubble) {
                const indicator = document.createElement('div');
                indicator.className = 'audio-playing-indicator';
                indicator.innerHTML = 'üîä Ê≠£Âú®Êí≠Êîæ...';
                bubble.appendChild(indicator);
            }
            
            hideAllIndicators() {
                if (this.currentSentence) {
                    const indicators = this.currentSentence.element.querySelectorAll('.audio-waiting-indicator, .audio-playing-indicator');
                    indicators.forEach(indicator => indicator.remove());
                }
            }
            
            markAudioFailed() {
                if (this.currentSentence) {
                    this.currentSentence.element.classList.add('audio-failed');
                    const errorIcon = document.createElement('span');
                    errorIcon.className = 'audio-error-icon';
                    errorIcon.textContent = 'üîá';
                    errorIcon.title = 'ËØ≠Èü≥ÁîüÊàêÂ§±Ë¥•';
                    this.currentSentence.element.appendChild(errorIcon);
                }
            }
            
            skipCurrentSentence() {
                if (this.currentSentence) {
                    if (this.currentSentence.audio) {
                        this.currentSentence.audio.pause();
                    }
                    this.completeSentence();
                }
            }
        }

        // ÂàõÂª∫ÂÖ®Â±ÄÂ§öÈÄöÈÅìË∑ØÁî±Âô®ÂÆû‰æã
        const multiChannelRouter = new MultiChannelRouter();

        // Â§ÑÁêÜÊî∂Âà∞ÁöÑÊ∂àÊÅØ - Â§öÈÄöÈÅìÁâàÊú¨
        function handleIncomingMessage(message) {
            // Ê∑ªÂä†ÂÖ®Â±ÄÊ∂àÊÅØÊé•Êî∂Êó•Âøó
            console.log('üì® Êî∂Âà∞WebSocketÊ∂àÊÅØ:', {
                type: message.type,
                channelType: message.channelType,
                hasAudioData: !!message.audioData,
                audioDataLength: message.audioData ? message.audioData.length : 0,
                ttsMode: message.ttsMode,
                sentenceId: message.sentenceId
            });
            
            // Á≥ªÁªüÊ∂àÊÅØÁâπÊÆäÂ§ÑÁêÜ
            if (message.type === 'system') {
                if (!currentSessionId) {
                    currentSessionId = message.sessionId;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØOllamaÁä∂ÊÄÅÊõ¥Êñ∞
                if (message.metadata && message.metadata.ollama_status) {
                    updateOllamaStatus(message.metadata.ollama_status === 'available');
                } else if (message.metadata && message.metadata.thinking_toggle) {
                    // Â§ÑÁêÜÊÄùËÄÉÂàáÊç¢Á°ÆËÆ§
                    handleThinkingToggleConfirmation(message);
                } else if (message.metadata && message.metadata.web_search_toggle) {
                    // Â§ÑÁêÜËÅîÁΩëÊêúÁ¥¢ÂàáÊç¢Á°ÆËÆ§
                    handleWebSearchToggleConfirmation(message);
                } else if (message.metadata && message.metadata.interrupt_confirmed) {
                    // Â§ÑÁêÜÊâìÊñ≠Á°ÆËÆ§
                    handleInterruptConfirmation(message);
                } else if (message.metadata && message.metadata.asr_result) {
                    // Â§ÑÁêÜASRËØÜÂà´ÁªìÊûú
                    handleASRResult(message);
                } else if (message.metadata && message.metadata.asr_connection_failed) {
                    // Â§ÑÁêÜASRËøûÊé•Â§±Ë¥•
                    handleASRConnectionFailed(message);
                } else if (message.metadata && message.metadata.asr_session_taken_over) {
                    // Â§ÑÁêÜASR‰ºöËØùË¢´Êé•ÁÆ°
                    handleASRSessionTakenOver(message);
                } else {
                    addMessage('system', message.content);
                }
                return;
            }
            
            // ÈîôËØØÊ∂àÊÅØÁâπÊÆäÂ§ÑÁêÜ
            if (message.type === 'error') {
                removeTypingIndicator();
                addMessage('error', '‚ùå ' + message.content);
                // ÈáçÁΩÆAIÂìçÂ∫îÁä∂ÊÄÅ
                isAIResponding = false;
                hideInterruptButton();
                enableSendButton();
                enableChatControls();
                return;
            }
            
            // ‰ΩøÁî®Â§öÈÄöÈÅìË∑ØÁî±Âô®Â§ÑÁêÜÂÖ∂‰ªñÊ∂àÊÅØ
            try {
                multiChannelRouter.routeMessage(message);
            } catch (error) {
                console.error('Â§öÈÄöÈÅìÊ∂àÊÅØË∑ØÁî±Â§±Ë¥•:', error, message);
                // ÈôçÁ∫ßÂà∞‰º†ÁªüÂ§ÑÁêÜÊñπÂºè
                handleLegacyMessage(message);
            }
        }
        
        // ‰º†ÁªüÊ∂àÊÅØÂ§ÑÁêÜÔºàÈôçÁ∫ßÊñπÊ°àÔºâ
        function handleLegacyMessage(message) {
            if (message.type === 'text') {
                removeTypingIndicator();
                if (message.streaming) {
                    // ÊµÅÂºèÊ∂àÊÅØÂ§ÑÁêÜ
                    if (!isAIResponding) {
                        isAIResponding = true;
                        showInterruptButton();
                        disableChatControls();
                        setAIResponseTimeout();
                    }
                    handleStreamingMessage(message);
                } else {
                    recordAIActivity(); // ËÆ∞ÂΩïÊúÄÂêé‰∏ÄÊ¨°Ê¥ªÂä®
                    addMessage('assistant', message.content);
                    // ÈáçÁΩÆAIÂìçÂ∫îÁä∂ÊÄÅÔºàÈùûÊµÅÂºèÊ∂àÊÅØÂÆåÊàêÔºâ
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableSendButton();
                    enableChatControls();
                }
            }
        }
        
        // Â§ÑÁêÜÊµÅÂºèÊ∂àÊÅØ
        function handleStreamingMessage(message) {
            console.log('üîÑ Â§ÑÁêÜÊµÅÂºèÊ∂àÊÅØ:', message);
            console.log('üîß ÂΩìÂâçÊÄùËÄÉÊòæÁ§∫Áä∂ÊÄÅ:', showThinking);
            console.log('üîß ÂΩìÂâçAIÂìçÂ∫îÁä∂ÊÄÅ:', isAIResponding);
            console.log('üîç Ê∂àÊÅØËØ¶ÁªÜ‰ø°ÊÅØ:', {
                hasContent: !!message.content,
                contentLength: message.content ? message.content.length : 0,
                streaming: message.streaming,
                streamComplete: message.streamComplete,
                thinking: message.thinking,
                type: message.type
            });
            
            // È¶ñÂÖàÂ§ÑÁêÜÊúâÂÜÖÂÆπÁöÑÊ∂àÊÅØ
            if (message.content) {
                // ËÆ∞ÂΩïAIÊ¥ªÂä®
                recordAIActivity();
                
                console.log('üìù Êî∂Âà∞ÂÜÖÂÆπ:', {
                    content: message.content,
                    thinking: message.thinking,
                    hasCurrentMessage: !!currentAssistantMessage,
                    isMixedContent: currentAssistantMessage?.classList.contains('mixed-content')
                });
                
                // Á°Æ‰øùÊúâ‰∏Ä‰∏™Ê∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØÊù•Êé•Êî∂ÂÜÖÂÆπ
                // ÈáçË¶ÅÔºöÊØèÊ¨°Êñ∞ÁöÑÂØπËØùÈÉΩÂ∫îËØ•ÂàõÂª∫Êñ∞ÁöÑÊ∂àÊÅØÊ∞îÊ≥°
                if (!currentAssistantMessage || !currentAssistantMessage.classList.contains('mixed-content')) {
                    console.log('üÜï ÂàõÂª∫Êñ∞ÁöÑÊ∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØ');
                    currentAssistantMessage = addMixedContentMessage('', '');
                }
                
                // ÊúâÂÜÖÂÆπÁöÑÊµÅÂºèÊ∂àÊÅØ
                if (message.thinking) {
                    console.log('üß† Â§ÑÁêÜÊÄùËÄÉÂÜÖÂÆπ:', message.content);
                    appendToMixedContentMessage(message.content, '', true);
                } else {
                    console.log('üí¨ Â§ÑÁêÜÊôÆÈÄöÂÜÖÂÆπ:', message.content);
                    appendToMixedContentMessage('', message.content, false);
                }
                
                // Â¶ÇÊûúÊµÅÂºèÊ∂àÊÅØÂÆåÊàêÔºåÊ†áËÆ∞ÂÆåÊàêÁä∂ÊÄÅ
                if (message.streamComplete && currentAssistantMessage) {
                    console.log('‚úÖ Âçï‰∏™Ê∂àÊÅØÊµÅÂÆåÊàê - ÈáçÁΩÆAIÁä∂ÊÄÅ');
                    currentAssistantMessage.dataset.streamable = 'false';
                    currentAssistantMessage.classList.add('stream-complete');
                    currentAssistantMessage = null;
                    enableSendButton();
                    // ÈöêËóèÊâìÊñ≠ÊåâÈíÆ
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableChatControls();
                }
            } else if (message.streamComplete) {
                // Â§ÑÁêÜÊó†ÂÜÖÂÆπÁöÑÂÆåÊàê‰ø°Âè∑
                console.log('‚úÖ Êî∂Âà∞Êó†ÂÜÖÂÆπÁöÑÊµÅÂºèÂÆåÊàê‰ø°Âè∑ - ÈáçÁΩÆAIÁä∂ÊÄÅ');
                if (currentAssistantMessage) {
                    currentAssistantMessage.dataset.streamable = 'false';
                    currentAssistantMessage.classList.add('stream-complete');
                    currentAssistantMessage = null;
                }
                // ÈáçÊñ∞ÂêØÁî®ÂèëÈÄÅÊåâÈíÆ
                enableSendButton();
                // ÈöêËóèÊâìÊñ≠ÊåâÈíÆ
                isAIResponding = false;
                clearAIResponseTimeout();
                hideInterruptButton();
                enableChatControls();
            }
        }

        // Êõ¥Êñ∞OllamaÁä∂ÊÄÅ
        function updateOllamaStatus(available) {
            if (available) {
                ollamaStatusDiv.innerHTML = 'üü¢ OllamaÊúçÂä°Ê≠£Â∏∏ - ‰ΩøÁî®Êú¨Âú∞AIÊ®°Âûã';
                ollamaStatusDiv.className = 'ollama-status';
            } else {
                ollamaStatusDiv.innerHTML = 'üü° OllamaÊúçÂä°‰∏çÂèØÁî® - ‰ΩøÁî®MockÂìçÂ∫î';
                ollamaStatusDiv.className = 'ollama-status unavailable';
            }
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ÂÆπÂô®
        function addMessage(sender, content) {
            // Ê£ÄÊü•ÂÜÖÂÆπÊòØÂê¶‰∏∫Á©∫
            if (!content || content.trim() === '') {
                console.warn('‚ö†Ô∏è Ë∑≥ËøáÊ∑ªÂä†Á©∫ÂÜÖÂÆπÊ∂àÊÅØ:', sender);
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = content;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Â¶ÇÊûúÊòØÂä©ÊâãÊ∂àÊÅØ‰∏îÊîØÊåÅÊµÅÂºèÔºåÊ†áËÆ∞‰∏∫ÂèØËøΩÂä†
            if (sender === 'assistant') {
                messageDiv.dataset.streamable = 'true';
                currentAssistantMessage = messageDiv;
            }
        }
        
        // Ê∑ªÂä†Ê∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØÂà∞ËÅäÂ§©ÂÆπÂô®
        function addMixedContentMessage(thinkingContent = '', normalContent = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant mixed-content';
            messageDiv.dataset.streamable = 'true';
            messageDiv.dataset.hasThinking = thinkingContent ? 'true' : 'false';
            messageDiv.dataset.hasNormal = normalContent ? 'true' : 'false';
            messageDiv.dataset.thinkingContent = thinkingContent;
            messageDiv.dataset.normalContent = normalContent;
            
            updateMixedContentMessage(messageDiv, thinkingContent, normalContent);
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            
            currentAssistantMessage = messageDiv;
            return messageDiv;
        }
        
        // Êõ¥Êñ∞Ê∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØ
        function updateMixedContentMessage(messageDiv, thinkingContent, normalContent) {
            console.log('üîÑ Êõ¥Êñ∞Ê∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØ:', {
                thinkingLength: thinkingContent?.length || 0,
                normalLength: normalContent?.length || 0,
                thinkingPreview: thinkingContent?.substring(0, 50) + '...',
                normalPreview: normalContent?.substring(0, 50) + '...'
            });
            
            let html = '';
            
            // Â§ÑÁêÜÊÄùËÄÉÂÜÖÂÆπ
            if (thinkingContent && thinkingContent.trim()) {
                // ÁßªÈô§<think>Âíå</think>Ê†áÁ≠æ
                let cleanThinking = thinkingContent.replace(/<\/?think>/g, '').trim();
                console.log('üß† Ê∏ÖÁêÜÂêéÁöÑÊÄùËÄÉÂÜÖÂÆπ:', cleanThinking.substring(0, 100) + '...');
                
                if (cleanThinking) {
                    // ‰ΩøÁî®markedËß£Êûêmarkdown
                    let thinkingHtml = '';
                    try {
                        thinkingHtml = marked.parse(cleanThinking);
                        console.log('‚úÖ MarkdownËß£ÊûêÊàêÂäü');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è MarkdownËß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂßãÊñáÊú¨:', e);
                        // Â¶ÇÊûúmarkdownËß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂßãÊñáÊú¨
                        thinkingHtml = cleanThinking.replace(/\n/g, '<br>');
                    }
                    
                    const sectionClass = normalContent && normalContent.trim() ? 'thinking-section' : 'thinking-section thinking-only';
                    html += `<div class="${sectionClass}">${thinkingHtml}</div>`;
                    messageDiv.dataset.hasThinking = 'true';
                    console.log('üß† Ê∑ªÂä†ÊÄùËÄÉÈÉ®ÂàÜÔºåÊ†∑ÂºèÁ±ª:', sectionClass);
                }
            }
            
            // Â§ÑÁêÜÊôÆÈÄöÂÜÖÂÆπ
            if (normalContent && normalContent.trim()) {
                const sectionClass = (thinkingContent && thinkingContent.trim()) ? 'normal-section' : 'normal-section normal-only';
                html += `<div class="${sectionClass}">${normalContent.replace(/\n/g, '<br>')}</div>`;
                messageDiv.dataset.hasNormal = 'true';
                console.log('üí¨ Ê∑ªÂä†ÊôÆÈÄöÈÉ®ÂàÜÔºåÊ†∑ÂºèÁ±ª:', sectionClass);
            }
            
            console.log('üìù ÊúÄÁªàHTMLÈïøÂ∫¶:', html.length);
            messageDiv.innerHTML = html;
        }
        
        // Ê∑ªÂä†ÊÄùËÄÉÊ∂àÊÅØÂà∞ËÅäÂ§©ÂÆπÂô®
        function addThinkingMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant thinking';
            messageDiv.textContent = content;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            
            return messageDiv;
        }

        // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊåáÁ§∫Âô®
        function showTypingIndicator() {
            removeTypingIndicator(); // Á°Æ‰øùÂè™Êúâ‰∏Ä‰∏™ÊåáÁ§∫Âô®
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = 'AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠<span class="dots">...</span>';
            
            chatContainer.appendChild(typingDiv);
            scrollToBottom();
        }
        
        // ÊªöÂä®Âà∞Â∫ïÈÉ® - ‰ºòÂåñÁâà
        function scrollToBottom() {
            // ‰ΩøÁî®requestAnimationFrame‰øùËØÅÊªöÂä®ÁöÑÊµÅÁïÖÊÄß
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // ÁßªÈô§Ê≠£Âú®ËæìÂÖ•ÊåáÁ§∫Âô®
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // ËøΩÂä†ÂÜÖÂÆπÂà∞Ê∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØ
        function appendToMixedContentMessage(thinkingContent, normalContent, isThinking) {
            // Áé∞Âú®Êàë‰ª¨Á°Æ‰øùÂú®Ë∞ÉÁî®Ê≠§ÂáΩÊï∞‰πãÂâçÂ∑≤ÁªèÊúâ‰∫ÜÊ∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØ
            if (!currentAssistantMessage || !currentAssistantMessage.classList.contains('mixed-content')) {
                console.error('appendToMixedContentMessage called without mixed-content message');
                return;
            }
            
            // Ëé∑ÂèñÁé∞ÊúâÂÜÖÂÆπ
            let existingThinking = currentAssistantMessage.dataset.thinkingContent || '';
            let existingNormal = currentAssistantMessage.dataset.normalContent || '';
            
            // ËøΩÂä†Êñ∞ÂÜÖÂÆπ
            if (isThinking) {
                existingThinking += thinkingContent;
            } else {
                existingNormal += normalContent;
            }
            
            // ‰øùÂ≠òÂà∞dataset
            currentAssistantMessage.dataset.thinkingContent = existingThinking;
            currentAssistantMessage.dataset.normalContent = existingNormal;
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateMixedContentMessage(currentAssistantMessage, existingThinking, existingNormal);
            
            // ‰ΩøÁî®ËäÇÊµÅÊªöÂä®‰ª•ÊèêÈ´òÊÄßËÉΩ
            throttledScrollToBottom();
        }
        
        // ËøΩÂä†ÂÜÖÂÆπÂà∞ÊúÄÂêé‰∏ÄÊù°Âä©ÊâãÊ∂àÊÅØ - ‰ºòÂåñÁâàÔºà‰øùÁïôÁî®‰∫éÂÖºÂÆπÔºâ
        function appendToLastMessage(content, isComplete) {
            if (!currentAssistantMessage) {
                // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçÊ∂àÊÅØÔºåÂàõÂª∫Êñ∞Ê∂àÊÅØ
                addMessage('assistant', content);
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ∑∑ÂêàÂÜÖÂÆπÊ∂àÊÅØ
            if (currentAssistantMessage.classList.contains('mixed-content')) {
                appendToMixedContentMessage('', content, false);
                return;
            }
            
            // ÊâπÈáèÂ§ÑÁêÜDOMÊõ¥Êñ∞‰ª•ÊèêÈ´òÊÄßËÉΩ
            if (currentAssistantMessage.textContent === 'AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...') {
                // È¶ñÊ¨°ÂÜÖÂÆπÔºåÊõøÊç¢Âç†‰ΩçÊñáÊú¨
                currentAssistantMessage.textContent = content;
            } else {
                // ËøΩÂä†ÂÜÖÂÆπ
                currentAssistantMessage.textContent += content;
            }
            
            // ‰ΩøÁî®ËäÇÊµÅÊªöÂä®‰ª•ÊèêÈ´òÊÄßËÉΩ
            throttledScrollToBottom();
            
            if (isComplete) {
                currentAssistantMessage.dataset.streamable = 'false';
                currentAssistantMessage.classList.add('stream-complete');
                currentAssistantMessage = null;
                // ÈáçÊñ∞ÂêØÁî®ÂèëÈÄÅÊåâÈíÆ
                enableSendButton();
                enableChatControls();
            }
        }
        
        // ËøΩÂä†ÂÜÖÂÆπÂà∞ÊúÄÂêé‰∏ÄÊù°ÊÄùËÄÉÊ∂àÊÅØ
        function appendToLastThinkingMessage(content, isComplete) {
            // Êü•ÊâæÊúÄÂêé‰∏ÄÊù°ÊÄùËÄÉÊ∂àÊÅØ
            const thinkingMessages = chatContainer.querySelectorAll('.message.thinking');
            let lastThinkingMessage = null;
            
            if (thinkingMessages.length > 0) {
                lastThinkingMessage = thinkingMessages[thinkingMessages.length - 1];
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúÄÊñ∞ÁöÑÊ∂àÊÅØÔºàÁÆÄÂçïÊ£ÄÊü•Ôºâ
                const allMessages = chatContainer.querySelectorAll('.message');
                const lastMessage = allMessages[allMessages.length - 1];
                if (lastMessage !== lastThinkingMessage) {
                    lastThinkingMessage = null;
                }
            }
            
            if (!lastThinkingMessage) {
                // ÂàõÂª∫Êñ∞ÁöÑÊÄùËÄÉÊ∂àÊÅØ
                lastThinkingMessage = addThinkingMessage(content);
            } else {
                // ËøΩÂä†Âà∞Áé∞ÊúâÊ∂àÊÅØ
                lastThinkingMessage.textContent += content;
            }
            
            throttledScrollToBottom();
            
            if (isComplete) {
                lastThinkingMessage.classList.add('stream-complete');
                // ÈáçÁΩÆAIÂìçÂ∫îÁä∂ÊÄÅ
                isAIResponding = false;
                clearAIResponseTimeout();
                hideInterruptButton();
                enableSendButton();
                enableChatControls();
                console.log('‚úÖ ÊÄùËÄÉÊ∂àÊÅØÂÆåÊàêÔºåÈáçÁΩÆÁä∂ÊÄÅ');
            }
        }
        
        // ËäÇÊµÅÊªöÂä®ÂáΩÊï∞
        const throttledScrollToBottom = throttle(scrollToBottom, 16); // 60fps
        
        // ËäÇÊµÅÂáΩÊï∞
        function throttle(func, delay) {
            let timeoutId;
            let lastExecTime = 0;
            return function (...args) {
                const currentTime = Date.now();
                
                if (currentTime - lastExecTime > delay) {
                    func.apply(this, args);
                    lastExecTime = currentTime;
                } else {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        func.apply(this, args);
                        lastExecTime = Date.now();
                    }, delay - (currentTime - lastExecTime));
                }
            };
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !isConnected) return;

            // Â¶ÇÊûúAIÊ≠£Âú®ÂõûÂ§çÔºåÂÖàÂèëÈÄÅÊâìÊñ≠‰ø°Âè∑
            if (isAIResponding) {
                sendInterruptSignal('NEW_MESSAGE', 'Áî®Êà∑ÂèëÈÄÅ‰∫ÜÊñ∞Ê∂àÊÅØ');
            }

            // ÈáçÁΩÆÂΩìÂâçÊ∂àÊÅØÁä∂ÊÄÅÔºåÁ°Æ‰øùÊñ∞Ê∂àÊÅØÂàõÂª∫Êñ∞Ê∞îÊ≥°
            currentAssistantMessage = null;
            
            // ÂêåÊó∂ÈáçÁΩÆChatWindowHandler‰∏≠ÁöÑcurrentAssistantMessage
            const chatHandler = multiChannelRouter.getChannel('chat_window');
            if (chatHandler) {
                chatHandler.currentAssistantMessage = null;
            }

            const message = {
                type: 'text',
                content: content,
                role: 'user',
                sessionId: currentSessionId
            };

            // ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØ
            addMessage('user', content);
            
            // ÊòæÁ§∫AIÊ≠£Âú®ÊÄùËÄÉÁöÑÊåáÁ§∫Âô®
            showTypingIndicator();
            
            // ÂèëÈÄÅÂà∞ÊúçÂä°Âô®
            ws.send(JSON.stringify(message));
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            messageInput.value = '';
            
            // Á¶ÅÁî®ÂèëÈÄÅÊåâÈíÆÈò≤Ê≠¢ÈáçÂ§çÂèëÈÄÅ
            disableSendButton();
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        sendBtn.addEventListener('click', sendMessage);
        
        interruptBtn.addEventListener('click', function() {
            sendInterruptSignal('USER_STOP', 'Áî®Êà∑ÁÇπÂáªÂÅúÊ≠¢ÊåâÈíÆ');
        });
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        personaSelect.addEventListener('change', function() {
            // Â¶ÇÊûúAIÊ≠£Âú®ÂõûÂ§çÔºåÊÅ¢Â§çÂà∞‰πãÂâçÁöÑÈÄâÊã©Âπ∂Áõ¥Êé•ËøîÂõû
            if (isAIResponding) {
                // ÊÅ¢Â§çÂà∞‰πãÂâçÁöÑÈÄâÊã©
                this.selectedIndex = this.dataset.lastSelectedIndex || 0;
                return;
            }
            
            // ËÆ∞ÂΩïÂΩìÂâçÈÄâÊã©ÁöÑÁ¥¢Âºï
            this.dataset.lastSelectedIndex = this.selectedIndex;
            
            if (currentSessionId) {
                const message = {
                    type: 'system',
                    content: `ÂàáÊç¢Âà∞‰∫∫ËÆæ: ${this.options[this.selectedIndex].text}`,
                    metadata: {
                        action: 'change_persona',
                        personaId: this.value
                    }
                };
                
                addMessage('system', `Â∑≤ÂàáÊç¢Âà∞ ${this.options[this.selectedIndex].text} ‰∫∫ËÆæ`);
                ws.send(JSON.stringify(message));
            }
        });
        
        // ÊÄùËÄÉÂàáÊç¢‰∫ã‰ª∂ÁõëÂê¨
        thinkingToggle.addEventListener('click', toggleThinkingDisplay);
        
        // ASRÂàáÊç¢‰∫ã‰ª∂ÁõëÂê¨
        asrToggle.addEventListener('click', toggleASR);
        
        // TTSÂàáÊç¢‰∫ã‰ª∂ÁõëÂê¨
        ttsToggle.addEventListener('click', toggleChatTTS);
        
        // ËÅîÁΩëÊêúÁ¥¢ÂàáÊç¢‰∫ã‰ª∂ÁõëÂê¨
        webSearchToggle.addEventListener('click', toggleWebSearchDisplay);

        // ÂêØÁî®/Á¶ÅÁî®ÂèëÈÄÅÊåâÈíÆÁöÑÂ∑•ÂÖ∑ÂáΩÊï∞
        function enableSendButton() {
            if (isConnected) {
                sendBtn.disabled = false;
                messageInput.disabled = false;
                sendBtn.textContent = 'ÂèëÈÄÅ';
            }
        }
        
        function disableSendButton() {
            sendBtn.disabled = true;
            messageInput.disabled = true;
            sendBtn.textContent = 'ÂèëÈÄÅ‰∏≠...';
        }

        // Á¶ÅÁî®ËÅäÂ§©Êéß‰ª∂ÔºàAIÂõûÂ§çÊó∂Ôºâ
        function disableChatControls() {
            console.log('üö´ Á¶ÅÁî®ËÅäÂ§©Êéß‰ª∂ - isAIResponding:', isAIResponding);
            // Á¶ÅÁî®‰∫∫ËÆæÈÄâÊã©Âô®
            personaSelect.disabled = true;
            personaSelect.style.opacity = '0.5';
            personaSelect.style.cursor = 'not-allowed';
            
            // Á¶ÅÁî®ÊÄùËÄÉËøáÁ®ãÂàáÊç¢
            thinkingToggle.style.pointerEvents = 'none';
            thinkingToggle.style.opacity = '0.5';
            thinkingToggle.style.cursor = 'not-allowed';
            
            // Á¶ÅÁî®TTSÂàáÊç¢
            ttsToggle.style.pointerEvents = 'none';
            ttsToggle.style.opacity = '0.5';
            ttsToggle.style.cursor = 'not-allowed';
            
            // Á¶ÅÁî®ËÅîÁΩëÊêúÁ¥¢ÂàáÊç¢
            webSearchToggle.style.pointerEvents = 'none';
            webSearchToggle.style.opacity = '0.5';
            webSearchToggle.style.cursor = 'not-allowed';
        }

        // ÂêØÁî®ËÅäÂ§©Êéß‰ª∂ÔºàAIÂõûÂ§çÁªìÊùüÊó∂Ôºâ
        function enableChatControls() {
            console.log('‚úÖ ÂêØÁî®ËÅäÂ§©Êéß‰ª∂ - isAIResponding:', isAIResponding);
            // ÂêØÁî®‰∫∫ËÆæÈÄâÊã©Âô®
            personaSelect.disabled = false;
            personaSelect.style.opacity = '1';
            personaSelect.style.cursor = 'pointer';
            
            // ÂêØÁî®ÊÄùËÄÉËøáÁ®ãÂàáÊç¢
            thinkingToggle.style.pointerEvents = 'auto';
            thinkingToggle.style.opacity = '1';
            thinkingToggle.style.cursor = 'pointer';
            
            // ÂêØÁî®TTSÂàáÊç¢
            ttsToggle.style.pointerEvents = 'auto';
            ttsToggle.style.opacity = '1';
            ttsToggle.style.cursor = 'pointer';
            
            // ÂêØÁî®ËÅîÁΩëÊêúÁ¥¢ÂàáÊç¢
            webSearchToggle.style.pointerEvents = 'auto';
            webSearchToggle.style.opacity = '1';
            webSearchToggle.style.cursor = 'pointer';
        }

        // ËÆ∞ÂΩïAIÊ¥ªÂä®
        function recordAIActivity() {
            lastAIActivityTime = Date.now();
            console.log('üìù ËÆ∞ÂΩïAIÊ¥ªÂä®Êó∂Èó¥:', new Date(lastAIActivityTime).toLocaleTimeString());
        }
        
        // ËÆæÁΩÆAIÂìçÂ∫îË∂ÖÊó∂ÔºàÂü∫‰∫éÊ¥ªÂä®Ê£ÄÊµãÔºâ
        function setAIResponseTimeout() {
            // Â¶ÇÊûúÂ∑≤ÁªèÊúâË∂ÖÊó∂ÂÆöÊó∂Âô®Âú®ËøêË°åÔºå‰∏çÈáçÂ§çËÆæÁΩÆ
            if (aiResponseTimeout || activityCheckInterval) {
                console.log('üîÑ AIÂìçÂ∫îË∂ÖÊó∂ÂÆöÊó∂Âô®Â∑≤Â≠òÂú®ÔºåË∑≥ËøáÈáçÂ§çËÆæÁΩÆ');
                return;
            }
            
            // ÈáçÁΩÆË∂ÖÊó∂Ê∂àÊÅØÊ†áÂøó
            timeoutMessageShown = false;
            
            // ËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥
            recordAIActivity();
            
            console.log('‚è∞ ÂêØÂä®Âü∫‰∫éÊ¥ªÂä®Ê£ÄÊµãÁöÑAIÂìçÂ∫îÁõëÊéß (ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°)');
            
            // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°AIÊ¥ªÂä®Áä∂ÊÄÅ
            activityCheckInterval = setInterval(() => {
                if (!isAIResponding) {
                    // AIÂ∑≤Áªè‰∏çÂú®ÂìçÂ∫îÁä∂ÊÄÅÔºåÊ∏ÖÈô§ÁõëÊéß
                    console.log('‚úÖ AIÂ∑≤ÂÆåÊàêÂìçÂ∫îÔºåÂÅúÊ≠¢Ê¥ªÂä®ÁõëÊéß');
                    clearAIResponseTimeout();
                    return;
                }
                
                const now = Date.now();
                const timeSinceLastActivity = now - (lastAIActivityTime || now);
                
                console.log('üîç Ê£ÄÊü•AIÊ¥ªÂä®Áä∂ÊÄÅ:', {
                    timeSinceLastActivity: Math.round(timeSinceLastActivity / 1000) + 'Áßí',
                    isAIResponding: isAIResponding,
                    lastActivity: new Date(lastAIActivityTime).toLocaleTimeString()
                });
                
                // Â¶ÇÊûú30ÁßíÂÜÖÊ≤°ÊúâAIÊ¥ªÂä®ÔºåËÆ§‰∏∫Ë∂ÖÊó∂
                if (timeSinceLastActivity > 30000 && !timeoutMessageShown) {
                    console.log('‚è∞ AIÂìçÂ∫îÁúüÊ≠£Ë∂ÖÊó∂ - 30ÁßíÂÜÖÊó†Ê¥ªÂä®ÔºåÂº∫Âà∂ÈáçÁΩÆÁä∂ÊÄÅ');
                    timeoutMessageShown = true;
                    isAIResponding = false;
                    clearAIResponseTimeout();
                    hideInterruptButton();
                    enableSendButton();
                    enableChatControls();
                    addMessage('system', '‚ö†Ô∏è AIÂìçÂ∫îË∂ÖÊó∂ÔºåÂ∑≤Ëá™Âä®ÈáçÁΩÆÁä∂ÊÄÅ');
                }
            }, 30000); // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
        }

        // Ê∏ÖÈô§AIÂìçÂ∫îË∂ÖÊó∂
        function clearAIResponseTimeout() {
            if (aiResponseTimeout) {
                clearTimeout(aiResponseTimeout);
                aiResponseTimeout = null;
            }
            if (activityCheckInterval) {
                clearInterval(activityCheckInterval);
                activityCheckInterval = null;
                console.log('üõë ÂÅúÊ≠¢AIÊ¥ªÂä®ÁõëÊéß');
            }
            // ÈáçÁΩÆË∂ÖÊó∂Ê∂àÊÅØÊ†áÂøóÂíåÊ¥ªÂä®Êó∂Èó¥
            timeoutMessageShown = false;
            lastAIActivityTime = null;
        }
        
        // Â§ÑÁêÜÊÄùËÄÉÂàáÊç¢Á°ÆËÆ§
        function handleThinkingToggleConfirmation(message) {
            if (message.metadata.thinking_toggle === 'confirmed') {
                const newState = message.metadata.showThinking;
                showThinking = newState;
                updateThinkingToggleUI(newState);
                addMessage('system', message.content);
            }
        }
        
        
        // Êõ¥Êñ∞ÊÄùËÄÉÂàáÊç¢UI
        function updateThinkingToggleUI(state) {
            if (state) {
                thinkingToggle.classList.add('active');
            } else {
                thinkingToggle.classList.remove('active');
            }
        }
        
        
        // ÂèëÈÄÅÊÄùËÄÉÂàáÊç¢ËØ∑Ê±Ç
        function toggleThinkingDisplay() {
            if (!ws || !isConnected) {
                addMessage('system', 'ËØ∑ÂÖàËøûÊé•Âà∞ÊúçÂä°Âô®');
                return;
            }
            
            // Â¶ÇÊûúAIÊ≠£Âú®ÂõûÂ§çÔºåÁõ¥Êé•ËøîÂõû‰∏çÂÅö‰ªª‰ΩïÊìç‰Ωú
            if (isAIResponding) {
                return;
            }
            
            const newState = !showThinking;
            
            const toggleMessage = {
                type: 'system',
                content: 'toggle_thinking',
                metadata: {
                    action: 'toggle_thinking',
                    showThinking: newState
                }
            };
            
            ws.send(JSON.stringify(toggleMessage));
        }
        
        
        // Â§ÑÁêÜËÅîÁΩëÊêúÁ¥¢ÂàáÊç¢Á°ÆËÆ§
        function handleWebSearchToggleConfirmation(message) {
            if (message.metadata.web_search_toggle === 'confirmed') {
                const newState = message.metadata.useWebSearch;
                useWebSearch = newState;
                updateWebSearchToggleUI(newState);
                addMessage('system', message.content);
            }
        }
        
        // Êõ¥Êñ∞ËÅîÁΩëÊêúÁ¥¢ÂàáÊç¢UI
        function updateWebSearchToggleUI(state) {
            if (state) {
                webSearchToggle.classList.add('active');
            } else {
                webSearchToggle.classList.remove('active');
            }
        }
        
        // ÂèëÈÄÅËÅîÁΩëÊêúÁ¥¢ÂàáÊç¢ËØ∑Ê±Ç
        function toggleWebSearchDisplay() {
            if (!ws || !isConnected) {
                addMessage('system', 'ËØ∑ÂÖàËøûÊé•Âà∞ÊúçÂä°Âô®');
                return;
            }
            
            // Â¶ÇÊûúAIÊ≠£Âú®ÂõûÂ§çÔºåÁõ¥Êé•ËøîÂõû‰∏çÂÅö‰ªª‰ΩïÊìç‰Ωú
            if (isAIResponding) {
                return;
            }
            
            const newState = !useWebSearch;
            
            const toggleMessage = {
                type: 'system',
                content: 'toggle_web_search',
                metadata: {
                    action: 'toggle_web_search',
                    useWebSearch: newState
                }
            };
            
            ws.send(JSON.stringify(toggleMessage));
        }
        
        // ÂàùÂßãÂåñÊÄùËÄÉÂàáÊç¢UI
        updateThinkingToggleUI(showThinking);
        
        // ÂàùÂßãÂåñËÅîÁΩëÊêúÁ¥¢ÂàáÊç¢UI
        updateWebSearchToggleUI(useWebSearch);
        
        // ÂàùÂßãÂåñASRÂàáÊç¢UI
        updateASRToggleUI(asrEnabled);
        
        // ÂàùÂßãÂåñTTSÂàáÊç¢UI
        updateTTSToggleUI(ttsSettings.chatEnabled);
        
        // ÂàùÂßãÂåñ‰∫∫ËÆæÈÄâÊã©Âô®ÁöÑÁ¥¢ÂºïËÆ∞ÂΩï
        personaSelect.dataset.lastSelectedIndex = personaSelect.selectedIndex;
        
        // TTSÂÅ•Â∫∑Ê£ÄÊü•ÂáΩÊï∞
        async function checkTTSHealth() {
            try {
                const response = await fetch('/api/cosyvoice/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.success && result.healthy;
                } else {
                    console.error('TTSÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('TTSÂÅ•Â∫∑Ê£ÄÊü•ÂºÇÂ∏∏:', error);
                return false;
            }
        }
        
        // ASRÂàáÊç¢ÂáΩÊï∞
        async function toggleASR() {
            // Â¶ÇÊûúAIÊ≠£Âú®ÂõûÂ§çÔºåÁõ¥Êé•ËøîÂõû‰∏çÂÅö‰ªª‰ΩïÊìç‰Ωú
            if (isAIResponding) {
                return;
            }
            
            // Â¶ÇÊûúË¶ÅÂêØÁî®ASRÔºåÂÖàÊ£ÄÊü•ÊúçÂä°ÂÅ•Â∫∑Áä∂ÊÄÅ
            if (!asrEnabled) {
                // ÊòæÁ§∫Ê£ÄÊü•‰∏≠ÁöÑÊèêÁ§∫
                addMessage('system', 'üîç Ê≠£Âú®Ê£ÄÊü•ASRÊúçÂä°Áä∂ÊÄÅ...');
                
                // ÊâßË°åÂÅ•Â∫∑Ê£ÄÊü•
                const isHealthy = await checkASRHealth();
                
                if (!isHealthy) {
                    // ASRÊúçÂä°‰∏çÂèØÁî®ÔºåÊòæÁ§∫Ë≠¶ÂëäÂπ∂ËøîÂõû
                    addMessage('system', '‚ö†Ô∏è ASRÊúçÂä°‰∏çÂèØÁî®ÔºåÊó†Ê≥ïÂêØÁî®');
                    // Á°Æ‰øùUIÁä∂ÊÄÅÊ≠£Á°ÆÔºà‰øùÊåÅÂÖ≥Èó≠Áä∂ÊÄÅÔºâ
                    updateASRToggleUI(false);
                    return;
                }
                
                // ÂèëÈÄÅASRÂêØÁî®Ê∂àÊÅØÂà∞ÂêéÁ´ØÔºåÁ≠âÂæÖÂêéÁ´ØÁ°ÆËÆ§
                const backendSuccess = await sendASRToggleMessageAsync(true);
                
                if (!backendSuccess) {
                    addMessage('system', '‚ö†Ô∏è ASRÂêéÁ´ØËøûÊé•Â§±Ë¥•ÔºåÊó†Ê≥ïÂêØÁî®');
                    // Á°Æ‰øùUIÁä∂ÊÄÅÊ≠£Á°ÆÔºà‰øùÊåÅÂÖ≥Èó≠Áä∂ÊÄÅÔºâ
                    updateASRToggleUI(false);
                    return;
                }
                
                // ÊúçÂä°ÂèØÁî®‰∏îÂêéÁ´ØËøûÊé•ÊàêÂäüÔºåÁªßÁª≠ÂêØÁî®ASR
                asrEnabled = true;
                addMessage('system', '‚úÖ Â∑≤ÂêØÁî®ASRËØ≠Èü≥ËØÜÂà´');
                
                // ÂêØÂä®È∫¶ÂÖãÈ£éÂΩïÈü≥
                await startMicrophoneRecording();
            } else {
                // Á¶ÅÁî®ASR
                asrEnabled = false;
                addMessage('system', '‚ùå Â∑≤Á¶ÅÁî®ASRËØ≠Èü≥ËØÜÂà´');
                
                // ÂèëÈÄÅASRÁ¶ÅÁî®Ê∂àÊÅØÂà∞ÂêéÁ´Ø
                sendASRToggleMessage(false);
                
                // ÂÅúÊ≠¢È∫¶ÂÖãÈ£éÂΩïÈü≥
                stopMicrophoneRecording();
            }
            
            // Êõ¥Êñ∞UI
            updateASRToggleUI(asrEnabled);
            
            console.log('ASRÁä∂ÊÄÅÂàáÊç¢:', {
                enabled: asrEnabled,
                serviceAvailable: asrServiceAvailable,
                isRecording: isRecording
            });
        }
        
        // Êõ¥Êñ∞ASRÂàáÊç¢ÊåâÈíÆUI
        function updateASRToggleUI(state) {
            if (state) {
                asrToggle.classList.add('active');
            } else {
                asrToggle.classList.remove('active');
            }
        }
        
        // ÂèëÈÄÅASRÂàáÊç¢Ê∂àÊÅØÂà∞ÂêéÁ´Ø
        function sendASRToggleMessage(enabled) {
            if (!ws || !isConnected) {
                console.error('WebSocketÊú™ËøûÊé•ÔºåÊó†Ê≥ïÂèëÈÄÅASRÂàáÊç¢Ê∂àÊÅØ');
                return;
            }
            
            const message = {
                type: enabled ? 'asr_start_session' : 'asr_end_session',
                sessionId: currentSessionId,
                metadata: {
                    enabled: enabled,
                    timestamp: Date.now()
                }
            };
            
            console.log('ÂèëÈÄÅASRÂàáÊç¢Ê∂àÊÅØ:', message);
            ws.send(JSON.stringify(message));
        }
        
        // ÂºÇÊ≠•ÂèëÈÄÅASRÂàáÊç¢Ê∂àÊÅØÂà∞ÂêéÁ´ØÂπ∂Á≠âÂæÖÁ°ÆËÆ§
        async function sendASRToggleMessageAsync(enabled) {
            if (!ws || !isConnected) {
                console.error('WebSocketÊú™ËøûÊé•ÔºåÊó†Ê≥ïÂèëÈÄÅASRÂàáÊç¢Ê∂àÊÅØ');
                return false;
            }
            
            return new Promise((resolve) => {
                const message = {
                    type: enabled ? 'asr_start_session' : 'asr_end_session',
                    sessionId: currentSessionId,
                    metadata: {
                        enabled: enabled,
                        timestamp: Date.now()
                    }
                };
                
                console.log('ÂèëÈÄÅASRÂàáÊç¢Ê∂àÊÅØ:', message);
                
                // ËÆæÁΩÆË∂ÖÊó∂Â§ÑÁêÜ
                const timeout = setTimeout(() => {
                    console.error('ASRÂêéÁ´ØÂìçÂ∫îË∂ÖÊó∂');
                    resolve(false);
                }, 5000); // 5ÁßíË∂ÖÊó∂
                
                // ‰∏¥Êó∂ÁõëÂê¨ASRÂìçÂ∫î
                const handleASRResponse = (event) => {
                    try {
                        const response = JSON.parse(event.data);
                        if (response.type === 'system' && response.metadata && 
                            (response.metadata.asr_session_started || response.metadata.asr_session_ended)) {
                            clearTimeout(timeout);
                            ws.removeEventListener('message', handleASRResponse);
                            resolve(true);
                        }
                    } catch (e) {
                        // ÂøΩÁï•ÈùûJSONÊ∂àÊÅØ
                    }
                };
                
                ws.addEventListener('message', handleASRResponse);
                ws.send(JSON.stringify(message));
                
                // Â¶ÇÊûúÊòØÁ¶ÅÁî®Êìç‰ΩúÔºåÁõ¥Êé•ËøîÂõûÊàêÂäüÔºà‰∏çÈúÄË¶ÅÁ≠âÂæÖÁ°ÆËÆ§Ôºâ
                if (!enabled) {
                    clearTimeout(timeout);
                    ws.removeEventListener('message', handleASRResponse);
                    resolve(true);
                }
            });
        }
        
        // Ê£ÄÊü•ASRÊúçÂä°ÂÅ•Â∫∑Áä∂ÊÄÅ
        async function checkASRHealth() {
            try {
                const response = await fetch('http://localhost:8768/health', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    const healthData = await response.json();
                    asrServiceAvailable = healthData.server_ready === true;
                    return asrServiceAvailable;
                }
                
                asrServiceAvailable = false;
                return false;
            } catch (error) {
                console.error('ASRÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•:', error);
                asrServiceAvailable = false;
                return false;
            }
        }
        
        // ÂêØÂä®È∫¶ÂÖãÈ£éÂΩïÈü≥
        async function startMicrophoneRecording() {
            try {
                // ËØ∑Ê±ÇÈ∫¶ÂÖãÈ£éÊùÉÈôê
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                // ÂàõÂª∫Â™í‰ΩìÂΩïÂà∂Âô®
                mediaRecorder = new MediaRecorder(audioStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                // ËÆæÁΩÆÂΩïÈü≥Êï∞ÊçÆÂ§ÑÁêÜ
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0 && asrEnabled) {
                        // ÂèëÈÄÅÈü≥È¢ëÊï∞ÊçÆÂà∞ASRÊúçÂä°
                        sendAudioToASR(event.data);
                    }
                };
                
                // ÂºÄÂßãÂΩïÈü≥
                mediaRecorder.start(100); // ÊØè100msÂèëÈÄÅ‰∏ÄÊ¨°Êï∞ÊçÆ
                isRecording = true;
                
                console.log('È∫¶ÂÖãÈ£éÂΩïÈü≥Â∑≤ÂêØÂä®');
                
            } catch (error) {
                console.error('ÂêØÂä®È∫¶ÂÖãÈ£éÂΩïÈü≥Â§±Ë¥•:', error);
                addMessage('system', '‚ùå Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
                asrEnabled = false;
                updateASRToggleUI(false);
            }
        }
        
        // ÂÅúÊ≠¢È∫¶ÂÖãÈ£éÂΩïÈü≥
        function stopMicrophoneRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
            
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            
            console.log('È∫¶ÂÖãÈ£éÂΩïÈü≥Â∑≤ÂÅúÊ≠¢');
        }
        
        // ÂèëÈÄÅÈü≥È¢ëÊï∞ÊçÆÂà∞ASRÊúçÂä°
        async function sendAudioToASR(audioBlob) {
            try {
                // Â∞ÜÈü≥È¢ëblobËΩ¨Êç¢‰∏∫base64
                const arrayBuffer = await audioBlob.arrayBuffer();
                const base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                
                // ÈÄöËøáWebSocketÂèëÈÄÅASRÊ∂àÊÅØ
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const asrMessage = {
                        type: 'asr_audio_chunk',
                        sessionId: currentSessionId,
                        metadata: {
                            audio_data: base64Audio,
                            timestamp: Date.now()
                        }
                    };
                    
                    ws.send(JSON.stringify(asrMessage));
                }
                
            } catch (error) {
                console.error('ÂèëÈÄÅÈü≥È¢ëÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }
        
        // Â§ÑÁêÜASRËØÜÂà´ÁªìÊûú
        function handleASRResult(message) {
            const metadata = message.metadata;
            const transcription = metadata.transcription;
            const confidence = metadata.confidence;
            const isFinal = metadata.is_final;
            
            console.log('Êî∂Âà∞ASRËØÜÂà´ÁªìÊûú:', {
                transcription,
                confidence,
                isFinal
            });
            
            if (isFinal && transcription && transcription.trim()) {
                // ÊòæÁ§∫ËØÜÂà´ÁªìÊûú
                addMessage('system', `üé§ ËØ≠Èü≥ËØÜÂà´: "${transcription}" (ÁΩÆ‰ø°Â∫¶: ${(confidence * 100).toFixed(1)}%)`);
                
                // Â¶ÇÊûúÁΩÆ‰ø°Â∫¶Ë∂≥Â§üÈ´òÔºåËá™Âä®ÂèëÈÄÅÊ∂àÊÅØ
                if (confidence > 0.7) {
                    // Â∞ÜËØÜÂà´ÁöÑÊñáÊú¨ËÆæÁΩÆÂà∞ËæìÂÖ•Ê°Ü
                    messageInput.value = transcription;
                    
                    // Ëá™Âä®ÂèëÈÄÅÊ∂àÊÅØ
                    setTimeout(() => {
                        sendMessage();
                    }, 500);
                }
            }
        }
        
        // Â§ÑÁêÜASRËøûÊé•Â§±Ë¥•
        function handleASRConnectionFailed(message) {
            console.log('Êî∂Âà∞ASRËøûÊé•Â§±Ë¥•ÈÄöÁü•:', message);
            
            // Âº∫Âà∂ÂÖ≥Èó≠ASRÂäüËÉΩ
            asrEnabled = false;
            updateASRToggleUI(false);
            
            // ÂÅúÊ≠¢È∫¶ÂÖãÈ£éÂΩïÈü≥
            stopMicrophoneRecording();
            
            // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
            addMessage('system', '‚ùå ' + message.content);
            
            console.log('ASRÂäüËÉΩÂ∑≤Ëá™Âä®ÂÖ≥Èó≠:', {
                enabled: asrEnabled,
                maxRetriesReached: message.metadata.max_retries_reached,
                autoDisabled: message.metadata.asr_auto_disabled
            });
        }
        
        // Â§ÑÁêÜASR‰ºöËØùË¢´Êé•ÁÆ°
        function handleASRSessionTakenOver(message) {
            console.log('Êî∂Âà∞ASR‰ºöËØùÊé•ÁÆ°ÈÄöÁü•:', message);
            
            // Âº∫Âà∂ÂÖ≥Èó≠ÂΩìÂâçÁ™óÂè£ÁöÑASRÂäüËÉΩ
            asrEnabled = false;
            updateASRToggleUI(false);
            
            // ÂÅúÊ≠¢È∫¶ÂÖãÈ£éÂΩïÈü≥
            stopMicrophoneRecording();
            
            // ÊòæÁ§∫Êé•ÁÆ°Ê∂àÊÅØ
            addMessage('system', 'üîÑ ' + message.content);
            
            console.log('ASRÂäüËÉΩÂ∑≤Ë¢´ÂÖ∂‰ªñÁ™óÂè£Êé•ÁÆ°:', {
                oldSessionId: message.metadata.old_session_id,
                newSessionId: message.metadata.new_session_id,
                autoDisabled: message.metadata.asr_auto_disabled
            });
        }
        
        // TTSÂàáÊç¢ÂáΩÊï∞
        async function toggleChatTTS() {
            // Â¶ÇÊûúAIÊ≠£Âú®ÂõûÂ§çÔºåÁõ¥Êé•ËøîÂõû‰∏çÂÅö‰ªª‰ΩïÊìç‰Ωú
            if (isAIResponding) {
                return;
            }
            
            // Â¶ÇÊûúË¶ÅÂêØÁî®TTSÔºåÂÖàÊ£ÄÊü•ÊúçÂä°ÂÅ•Â∫∑Áä∂ÊÄÅ
            if (!ttsSettings.chatEnabled) {
                // ÊòæÁ§∫Ê£ÄÊü•‰∏≠ÁöÑÊèêÁ§∫
                addMessage('system', 'üîç Ê≠£Âú®Ê£ÄÊü•TTSÊúçÂä°Áä∂ÊÄÅ...');
                
                // ÊâßË°åÂÅ•Â∫∑Ê£ÄÊü•
                const isHealthy = await checkTTSHealth();
                
                if (!isHealthy) {
                    // TTSÊúçÂä°‰∏çÂèØÁî®ÔºåÊòæÁ§∫Ë≠¶ÂëäÂπ∂ËøîÂõû
                    addMessage('system', '‚ö†Ô∏è TTSÊúçÂä°‰∏çÂèØÁî®ÔºåÊó†Ê≥ïÂêØÁî®');
                    return;
                }
                
                // ÊúçÂä°ÂèØÁî®ÔºåÁªßÁª≠ÂêØÁî®TTS
                ttsSettings.chatEnabled = true;
                ttsSettings.chatMode = 'char_stream_tts';
                currentTTSMode = 'char_stream_tts';
                addMessage('system', '‚úÖ Â∑≤ÂêØÁî®ËÅäÂ§©Á™óÂè£TTS (Ê®°Âºè2 - Â≠óÁ¨¶ÊµÅ+ËØ≠Èü≥)');
                
                // ÂêØÁî®TTSÂêéÂä†ËΩΩËØ≠Èü≥‰∫∫ËÆæÂàóË°®
                loadCosyVoiceSpeakers();
            } else {
                // Á¶ÅÁî®TTSÔºåÂàáÊç¢Âà∞Ê®°Âºè1
                ttsSettings.chatEnabled = false;
                ttsSettings.chatMode = 'text_only';
                currentTTSMode = 'text_only';
                addMessage('system', '‚ùå Â∑≤Á¶ÅÁî®ËÅäÂ§©Á™óÂè£TTS (Ê®°Âºè1 - Á∫ØÊñáÊú¨)');
            }
            
            // Êõ¥Êñ∞UI
            updateTTSToggleUI(ttsSettings.chatEnabled);
            updateTTSModeDisplay();
            updateTTSControlButton();
            
            // ÂêåÊ≠•Êõ¥Êñ∞ËÆæÁΩÆÈ°µÈù¢ÁöÑÁä∂ÊÄÅ
            syncSettingsPageTTS();
            
            // ‰øùÂ≠òËÆæÁΩÆ
            saveTTSSettings();
            
            console.log('TTSÁä∂ÊÄÅÂàáÊç¢:', {
                enabled: ttsSettings.chatEnabled,
                mode: currentTTSMode,
                settings: ttsSettings
            });
        }
        
        // Êõ¥Êñ∞TTSÂàáÊç¢UI
        function updateTTSToggleUI(state) {
            if (state) {
                ttsToggle.classList.add('active');
            } else {
                ttsToggle.classList.remove('active');
            }
        }
        
        // ÂêåÊ≠•ËÆæÁΩÆÈ°µÈù¢ÁöÑTTSÁä∂ÊÄÅ
        function syncSettingsPageTTS() {
            const chatToggle = document.getElementById('chatTTSToggle');
            if (chatToggle) {
                chatToggle.checked = ttsSettings.chatEnabled;
            }
        }
        
        // ÂèëÈÄÅÊâìÊñ≠‰ø°Âè∑
        function sendInterruptSignal(interruptType, reason) {
            if (!ws || !isConnected || !currentSessionId) {
                console.warn('Êó†Ê≥ïÂèëÈÄÅÊâìÊñ≠‰ø°Âè∑ÔºöWebSocketÊú™ËøûÊé•ÊàñÊó†‰ºöËØùID');
                return;
            }
            
            console.log('üõë Áî®Êà∑ÁÇπÂáªÂÅúÊ≠¢ÊåâÈíÆÔºåÂºÄÂßã‰∏≠Êñ≠Â§ÑÁêÜ');
            
            // 1. ÂÅúÊ≠¢ÊâÄÊúâÈü≥È¢ëÊí≠Êîæ
            stopAllAudio();
            
            // 2. ÂèëÈÄÅÂêéÁ´Ø‰∏≠Êñ≠‰ø°Âè∑
            const interruptMessage = {
                type: 'system',
                content: 'interrupt',
                metadata: {
                    action: 'interrupt',
                    interruptType: interruptType,
                    reason: reason
                },
                sessionId: currentSessionId
            };
            
            ws.send(JSON.stringify(interruptMessage));
            console.log('üì§ ÂèëÈÄÅÂêéÁ´ØÊâìÊñ≠‰ø°Âè∑:', interruptMessage);
            
            // 3. Á´ãÂç≥ËøõË°åËßÜËßâÂèçÈ¶à
            if (currentStreamingMessage) {
                // Âú®ÂΩìÂâçÊµÅÂºèÊ∂àÊÅØÊú´Â∞æÊ∑ªÂä†‰∏≠Êñ≠ÊèêÁ§∫
                const interruptNotice = document.createElement('span');
                interruptNotice.className = 'interrupt-notice';
                interruptNotice.textContent = ' ...ÔºàÂ∑≤‰∏≠Êñ≠Ôºâ';
                interruptNotice.style.color = '#dc3545';
                interruptNotice.style.fontStyle = 'italic';
                currentStreamingMessage.appendChild(interruptNotice);
            }
            
            // 4. Á´ãÂç≥ÈáçÁΩÆUIÁä∂ÊÄÅ
            isAIResponding = false;
            clearAIResponseTimeout();
            hideInterruptButton();
            enableChatControls();
            
            console.log('‚úÖ ‰∏≠Êñ≠Â§ÑÁêÜÂÆåÊàêÔºåUIÁä∂ÊÄÅÂ∑≤ÈáçÁΩÆ');
        }
        
        // ÂÅúÊ≠¢ÊâÄÊúâÈü≥È¢ëÊí≠Êîæ
        function stopAllAudio() {
            console.log('üîá ÂÅúÊ≠¢ÊâÄÊúâÈü≥È¢ëÊí≠Êîæ');
            
            // ÂÅúÊ≠¢Â≠óÁ¨¶ÊµÅÈü≥È¢ëÁÆ°ÁêÜÂô®‰∏≠ÁöÑÈü≥È¢ë
            if (window.charStreamAudioManager) {
                window.charStreamAudioManager.stopAll();
            }
            
            // ÂÅúÊ≠¢ÊâÄÊúâHTML5Èü≥È¢ëÂÖÉÁ¥†
            const audioElements = document.querySelectorAll('audio');
            audioElements.forEach(audio => {
                if (!audio.paused) {
                    audio.pause();
                    audio.currentTime = 0;
                    console.log('‚è∏Ô∏è ÂÅúÊ≠¢Èü≥È¢ëÂÖÉÁ¥†:', audio.src);
                }
            });
            
            // Ê∏ÖÈô§Èü≥È¢ëÊí≠ÊîæÈòüÂàó
            if (window.audioQueue) {
                window.audioQueue.length = 0;
                console.log('üóëÔ∏è Ê∏ÖÁ©∫Èü≥È¢ëÈòüÂàó');
            }
            
        }
        
        
        // ÊòæÁ§∫ÊâìÊñ≠ÊåâÈíÆ
        function showInterruptButton() {
            interruptBtn.classList.add('visible');
            interruptBtn.disabled = false;
        }
        
        // ÈöêËóèÊâìÊñ≠ÊåâÈíÆ
        function hideInterruptButton() {
            interruptBtn.classList.remove('visible');
            interruptBtn.disabled = true;
        }
        
        // Â§ÑÁêÜÊâìÊñ≠Á°ÆËÆ§
        function handleInterruptConfirmation(message) {
            console.log('Êî∂Âà∞ÊâìÊñ≠Á°ÆËÆ§:', message);
            
            // Á°Æ‰øùÊâìÊñ≠ÊåâÈíÆË¢´ÈöêËóè
            isAIResponding = false;
            clearAIResponseTimeout();
            hideInterruptButton();
            enableChatControls();
            
            // ÁßªÈô§Ê≠£Âú®ËæìÂÖ•ÊåáÁ§∫Âô®
            removeTypingIndicator();
            
            // ÈáçÊñ∞ÂêØÁî®ÂèëÈÄÅÊåâÈíÆ
            enableSendButton();
            enableChatControls();
            
            // Âè™ÊúâÂú®Á°ÆÂÆûÊúâ‰ªªÂä°Ë¢´‰∏≠Êñ≠Êó∂ÊâçÊòæÁ§∫‰∏≠Êñ≠Á°ÆËÆ§Ê∂àÊÅØ
            if (message.metadata.interrupted_tasks && message.metadata.interrupted_tasks > 0) {
                addMessage('system', message.content + ` (‰∏≠Êñ≠‰∫Ü ${message.metadata.interrupted_tasks} ‰∏™‰ªªÂä°)`);
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰ªªÂä°Ë¢´‰∏≠Êñ≠Ôºå‰∏çÊòæÁ§∫‰∏≠Êñ≠Ê∂àÊÅØ
                console.log('Ê≤°Êúâ‰ªªÂä°Ë¢´‰∏≠Êñ≠ÔºåË∑≥ËøáÊòæÁ§∫‰∏≠Êñ≠Ê∂àÊÅØ');
            }
        }
        
        // Ëá™ÈÄÇÂ∫îÁ™óÂè£Â§ßÂ∞èÁÆ°ÁêÜ
        function initResponsiveLayout() {
            function updateLayout() {
                const viewportWidth = document.documentElement.clientWidth;
                const viewportHeight = document.documentElement.clientHeight;
                
                console.log(`üìê Viewport size: ${viewportWidth}x${viewportHeight}`);
                
                // Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢Â§ßÂ∞è (70%Á™óÂè£)
                const chatContainer = document.querySelector('.chat-container');
                if (chatContainer) {
                    const containerWidth = Math.min(viewportWidth * 0.7, 1200); // ÊúÄÂ§ß1200px
                    const containerHeight = viewportHeight * 0.7;
                    
                    chatContainer.style.width = `${containerWidth}px`;
                    chatContainer.style.height = `${containerHeight}px`;
                }
                
                // Êõ¥Êñ∞ËÆæÁΩÆÈ°µÈù¢
                const settingsTab = document.getElementById('settings-tab');
                if (settingsTab) {
                    settingsTab.style.height = `${viewportHeight}px`;
                    settingsTab.style.maxHeight = `${viewportHeight}px`;
                }
                
                // Ëß¶ÂèëËá™ÂÆö‰πâ‰∫ã‰ª∂ÔºåÈÄöÁü•ÂÖ∂‰ªñÁªÑ‰ª∂
                window.dispatchEvent(new CustomEvent('layoutUpdated', {
                    detail: { width: viewportWidth, height: viewportHeight }
                }));
            }
            
            // ÂàùÂßãÂåñÂ∏ÉÂ±Ä
            updateLayout();
            
            // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
            let resizeTimer;
            window.addEventListener('resize', function() {
                // Èò≤ÊäñÂ§ÑÁêÜÔºåÈÅøÂÖçÈ¢ëÁπÅËß¶Âèë
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(updateLayout, 150);
            });
            
            // ÁõëÂê¨ÊñπÂêëÂèòÂåñÔºàÁßªÂä®ËÆæÂ§áÔºâ
            window.addEventListener('orientationchange', function() {
                setTimeout(updateLayout, 300);
            });
            
            console.log('üì± Responsive layout initialized');
        }
        
        // TabÂàáÊç¢ÂäüËÉΩ
        function initTabSwitching() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('üîÑ Initializing tab switching...');
            console.log('Found tab buttons:', tabButtons.length);
            console.log('Found tab contents:', tabContents.length);
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    console.log(`üéØ Switching to tab: ${targetTab}`);
                    
                    try {
                        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        
                        // Êõ¥Êñ∞ÂÜÖÂÆπÊòæÁ§∫
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        const targetContent = document.getElementById(`${targetTab}-tab`);
                        if (targetContent) {
                            targetContent.classList.add('active');
                            console.log(`‚úÖ Successfully switched to ${targetTab} tab`);
                        } else {
                            console.error(`‚ùå Target tab content not found: ${targetTab}-tab`);
                        }
                        
                        // Êõ¥Êñ∞Áä∂ÊÄÅ‰ø°ÊÅØÔºà‰ªÖÂú®ÂàáÊç¢Âà∞ËÆæÁΩÆÈ°µÈù¢Êó∂Ôºâ
                        if (targetTab === 'settings') {
                            try {
                                updateSettingsInfo();
                            } catch (error) {
                                console.error('‚ùå Error updating settings info:', error);
                            }
                        }
                        
                        // Â§ÑÁêÜÊó•ÂøóÈ°µÈù¢ÂàáÊç¢
                        if (targetTab === 'logs') {
                            try {
                                // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°ÂàáÊç¢Âà∞Êó•ÂøóÈ°µÈù¢ÔºåÂàùÂßãÂåñÊó•ÂøóÂäüËÉΩ
                                if (!window.logsInitialized) {
                                    initLogsPage();
                                    window.logsInitialized = true;
                                } else {
                                    // Â∑≤ÁªèÂàùÂßãÂåñËøáÔºåÂè™ÈúÄË¶ÅÊøÄÊ¥ªËá™Âä®Âà∑Êñ∞
                                    isLogsTabActive = true;
                                    if (autoRefreshLogs) {
                                        startAutoRefresh();
                                    }
                                }
                            } catch (error) {
                                console.error('‚ùå Error initializing logs page:', error);
                            }
                        } else {
                            // ÂàáÊç¢Âà∞ÂÖ∂‰ªñtabÊó∂ÔºåÂÅúÊ≠¢Êó•ÂøóËá™Âä®Âà∑Êñ∞
                            if (window.logsInitialized) {
                                isLogsTabActive = false;
                                stopAutoRefresh();
                            }
                        }
                        
                        // Â¶ÇÊûúÂàáÊç¢Âà∞ËÅäÂ§©È°µÈù¢ÔºåËß¶ÂèëÂ∏ÉÂ±ÄÊõ¥Êñ∞
                        if (targetTab === 'chat') {
                            setTimeout(() => {
                                if (typeof initResponsiveLayout !== 'undefined') {
                                    // Ëß¶ÂèëÂ∏ÉÂ±ÄÊõ¥Êñ∞
                                    window.dispatchEvent(new Event('resize'));
                                }
                            }, 100);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error during tab switching:', error);
                    }
                });
            });
            
            console.log('‚úÖ Tab switching initialized');
        }
        
        // Êõ¥Êñ∞ËÆæÁΩÆÈ°µÈù¢‰ø°ÊÅØ
        function updateSettingsInfo() {
            // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
            const connectionStatus = document.getElementById('connectionStatus');
            if (connectionStatus) {
                // Ê£ÄÊü•WebSocketÊòØÂê¶Â≠òÂú®‰∏îÂ∑≤ËøûÊé•
                if (typeof ws !== 'undefined' && ws && ws.readyState === WebSocket.OPEN) {
                    connectionStatus.textContent = 'Â∑≤ËøûÊé•';
                    connectionStatus.className = 'info-value connected';
                } else {
                    connectionStatus.textContent = 'Êú™ËøûÊé•';
                    connectionStatus.className = 'info-value disconnected';
                }
            }
        }
        
        // Êó•ÂøóÂäüËÉΩ
        function fetchLogs() {
            const level = logLevelSelect ? logLevelSelect.value : 'INFO';
            const limit = 100; // ÈªòËÆ§Ëé∑ÂèñÊúÄËøë100Êù°Êó•Âøó
            const timeRange = timeRangeSelect ? timeRangeSelect.value : '30m';
            
            let url = `/api/logs?level=${level}&limit=${limit}&timeRange=${timeRange}`;
            
            // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÊó∂Èó¥ÊÆµÔºåÊ∑ªÂä†ÂºÄÂßãÂíåÁªìÊùüÊó∂Èó¥ÂèÇÊï∞
            if (timeRange === 'custom' && startTimeInput && endTimeInput) {
                const startTime = formatDateTimeForAPI(startTimeInput.value);
                const endTime = formatDateTimeForAPI(endTimeInput.value);
                if (startTime && endTime) {
                    url += `&startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`;
                }
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayLogs(data.logs);
                        updateLogStats();
                        // ÊòæÁ§∫Ëé∑Âèñ‰ø°ÊÅØ
                        if (data.message) {
                            console.log('Êó•ÂøóËé∑Âèñ‰ø°ÊÅØ:', data.message);
                        }
                    } else {
                        console.error('Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•:', data.message);
                        displayLogs([]);
                        logViewer.innerHTML = '<div class="log-entry"><span class="log-message">Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•: ' + data.message + '</span></div>';
                    }
                })
                .catch(error => {
                    console.error('Ëé∑ÂèñÊó•ÂøóËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    displayLogs([]);
                    logViewer.innerHTML = '<div class="log-entry"><span class="log-message">Ëé∑ÂèñÊó•ÂøóËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message + '</span></div>';
                });
        }
        
        // Ê†ºÂºèÂåñÊó•ÊúüÊó∂Èó¥‰∏∫APIÊâÄÈúÄÊ†ºÂºè
        function formatDateTimeForAPI(datetimeLocal) {
            if (!datetimeLocal) return '';
            // Â∞Ü "2024-10-10T17:30" Ê†ºÂºèËΩ¨Êç¢‰∏∫ "2024-10-10 17:30:00"
            return datetimeLocal.replace('T', ' ') + ':00';
        }
        
        // ËÆæÁΩÆÈªòËÆ§Ëá™ÂÆö‰πâÊó∂Èó¥
        function setDefaultCustomTime() {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            
            // Ê†ºÂºèÂåñ‰∏∫ datetime-local ËæìÂÖ•ÊâÄÈúÄÁöÑÊ†ºÂºè
            const formatForInput = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            if (startTimeInput) {
                startTimeInput.value = formatForInput(oneHourAgo);
            }
            if (endTimeInput) {
                endTimeInput.value = formatForInput(now);
            }
        }
        
        function displayLogs(logs) {
            if (!logs || logs.length === 0) {
                logViewer.innerHTML = '<div class="log-entry"><span class="log-message">ÊöÇÊó†Êó•ÂøóÊï∞ÊçÆ</span></div>';
                return;
            }
            
            logViewer.innerHTML = '';
            logs.forEach(log => {
                addLogEntry(log.level, log.message, log.timestamp, false);
            });
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            logViewer.scrollTop = logViewer.scrollHeight;
        }
        
        function addLogEntry(level, message, timestamp = null, updateStats = true) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const time = timestamp || new Date().toLocaleString('zh-CN');
            
            logEntry.innerHTML = `
                <span class="log-timestamp">${time}</span>
                <span class="log-level ${level}">${level}</span>
                <span class="log-message">${message}</span>
            `;
            
            logViewer.appendChild(logEntry);
            
            if (updateStats) {
                // Êõ¥Êñ∞ÁªüËÆ°
                logStats.total++;
                switch(level.toUpperCase()) {
                    case 'ERROR':
                        logStats.error++;
                        break;
                    case 'WARN':
                        logStats.warn++;
                        break;
                    case 'INFO':
                        logStats.info++;
                        break;
                    case 'DEBUG':
                        logStats.debug++;
                        break;
                }
                updateLogStats();
            }
            
            // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
            logViewer.scrollTop = logViewer.scrollHeight;
        }
        
        function updateLogStats() {
            if (totalLogsSpan) totalLogsSpan.textContent = logStats.total;
            if (errorLogsSpan) errorLogsSpan.textContent = logStats.error;
            if (warnLogsSpan) warnLogsSpan.textContent = logStats.warn;
            if (infoLogsSpan) infoLogsSpan.textContent = logStats.info;
            if (lastUpdateSpan) lastUpdateSpan.textContent = new Date().toLocaleString('zh-CN');
        }
        
        function clearLogDisplay() {
            logViewer.innerHTML = '<div class="log-entry"><span class="log-message">Êó•ÂøóÊòæÁ§∫Â∑≤Ê∏ÖÁ©∫</span></div>';
            logStats = {
                total: 0,
                error: 0,
                warn: 0,
                info: 0,
                debug: 0
            };
            updateLogStats();
        }
        
        function toggleAutoRefresh() {
            autoRefreshLogs = !autoRefreshLogs;
            
            if (autoRefreshLogs) {
                autoRefreshToggle.classList.add('active');
                startAutoRefresh();
            } else {
                autoRefreshToggle.classList.remove('active');
                stopAutoRefresh();
            }
        }
        
        function startAutoRefresh() {
            if (autoRefreshLogs && isLogsTabActive) {
                stopAutoRefresh(); // ÂÖàÂÅúÊ≠¢Áé∞ÊúâÁöÑÂÆöÊó∂Âô®
                const intervalMs = refreshIntervalSeconds * 1000;
                logRefreshInterval = setInterval(fetchLogs, intervalMs);
                console.log(`Ëá™Âä®Âà∑Êñ∞Â∑≤ÂêØÂä®ÔºåÈó¥Èöî: ${refreshIntervalSeconds}Áßí`);
            }
        }
        
        function stopAutoRefresh() {
            if (logRefreshInterval) {
                clearInterval(logRefreshInterval);
                logRefreshInterval = null;
                console.log('Ëá™Âä®Âà∑Êñ∞Â∑≤ÂÅúÊ≠¢');
            }
        }
        
        function initLogsPage() {
            // Âà∑Êñ∞Êó•ÂøóÊåâÈíÆ
            if (refreshLogsBtn) {
                refreshLogsBtn.addEventListener('click', () => {
                    fetchLogs();
                });
            }
            
            // Ê∏ÖÁ©∫Êó•ÂøóÊåâÈíÆ
            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', clearLogDisplay);
            }
            
            // Ëá™Âä®Âà∑Êñ∞ÂàáÊç¢
            if (autoRefreshToggle) {
                autoRefreshToggle.addEventListener('click', toggleAutoRefresh);
            }
            
            // Êó•ÂøóÁ∫ßÂà´ÈÄâÊã©Âô®
            if (logLevelSelect) {
                logLevelSelect.addEventListener('change', () => {
                    fetchLogs(); // Á∫ßÂà´ÊîπÂèòÊó∂ÈáçÊñ∞Ëé∑ÂèñÊó•Âøó
                });
            }
            
            // Âà∑Êñ∞Èó¥ÈöîÈÄâÊã©Âô®
            if (refreshIntervalSelect) {
                refreshIntervalSelect.addEventListener('change', () => {
                    refreshIntervalSeconds = parseInt(refreshIntervalSelect.value);
                    // Â¶ÇÊûúËá™Âä®Âà∑Êñ∞Ê≠£Âú®ËøêË°åÔºåÈáçÊñ∞ÂêØÂä®‰ª•Â∫îÁî®Êñ∞Èó¥Èöî
                    if (autoRefreshLogs && isLogsTabActive) {
                        startAutoRefresh();
                    }
                });
            }
            
            // Êó∂Èó¥ËåÉÂõ¥ÈÄâÊã©Âô®
            if (timeRangeSelect) {
                timeRangeSelect.addEventListener('change', () => {
                    const selectedRange = timeRangeSelect.value;
                    
                    // ÊòæÁ§∫ÊàñÈöêËóèËá™ÂÆö‰πâÊó∂Èó¥ÊÆµËæìÂÖ•
                    if (customTimeRange) {
                        if (selectedRange === 'custom') {
                            customTimeRange.style.display = 'flex';
                            // ËÆæÁΩÆÈªòËÆ§Êó∂Èó¥ÂÄº
                            setDefaultCustomTime();
                        } else {
                            customTimeRange.style.display = 'none';
                            // Á´ãÂç≥Ëé∑ÂèñÊó•Âøó
                            fetchLogs();
                        }
                    }
                });
            }
            
            // Ëá™ÂÆö‰πâÊó∂Èó¥ÊÆµÂ∫îÁî®ÊåâÈíÆ
            if (applyCustomTimeBtn) {
                applyCustomTimeBtn.addEventListener('click', () => {
                    fetchLogs();
                });
            }
            
            // ËÆæÁΩÆÊó•Âøótab‰∏∫ÊøÄÊ¥ªÁä∂ÊÄÅ
            isLogsTabActive = true;
            
            // ÂàùÂßãÂåñÊó∂Âä†ËΩΩ‰∏ÄÊ¨°Êó•Âøó
            fetchLogs();
            
            // ÂêØÂä®Ëá™Âä®Âà∑Êñ∞ÔºàÂ¶ÇÊûúÂºÄÂêØÁöÑËØùÔºâ
            if (autoRefreshLogs) {
                startAutoRefresh();
            }
        }
        
        // ËÆæÁΩÆÈ°µÈù¢ÂäüËÉΩ
        function initSettingsPage() {
            // Áî®Êà∑ÈÖçÁΩÆÂØπË±°
            let userPreferences = {};
            
            // Âä†ËΩΩÁî®Êà∑ÈÖçÁΩÆ
            async function loadUserPreferences() {
                try {
                    const response = await fetch('/api/preferences');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        userPreferences = result.data;
                        updateSettingsUI(userPreferences);
                        updateConfigStatus('loaded', 'ÈÖçÁΩÆÂ∑≤Âä†ËΩΩ');
                        console.log('‚úÖ Áî®Êà∑ÈÖçÁΩÆÂä†ËΩΩÊàêÂäü', userPreferences);
                    } else {
                        console.warn('‚ö†Ô∏è Âä†ËΩΩÁî®Êà∑ÈÖçÁΩÆÂ§±Ë¥•', result.message);
                        updateConfigStatus('error', 'Âä†ËΩΩÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('‚ùå Âä†ËΩΩÁî®Êà∑ÈÖçÁΩÆÈîôËØØ', error);
                    updateConfigStatus('error', 'Âä†ËΩΩÈîôËØØ');
                }
            }
            
            // ‰øùÂ≠òÁî®Êà∑ÈÖçÁΩÆ
            async function saveUserPreferences() {
                try {
                    updateConfigStatus('loading', '‰øùÂ≠ò‰∏≠...');
                    
                    const response = await fetch('/api/preferences', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userPreferences)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        updateConfigStatus('loaded', '‰øùÂ≠òÊàêÂäü');
                        updateLastSavedTime();
                        console.log('‚úÖ Áî®Êà∑ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü');
                        
                        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                        showNotification('ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
                    } else {
                        console.error('‚ùå ‰øùÂ≠òÁî®Êà∑ÈÖçÁΩÆÂ§±Ë¥•', result.message);
                        updateConfigStatus('error', '‰øùÂ≠òÂ§±Ë¥•');
                        showNotification('ÈÖçÁΩÆ‰øùÂ≠òÂ§±Ë¥•: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('‚ùå ‰øùÂ≠òÁî®Êà∑ÈÖçÁΩÆÈîôËØØ', error);
                    updateConfigStatus('error', '‰øùÂ≠òÈîôËØØ');
                    showNotification('ÈÖçÁΩÆ‰øùÂ≠òÈîôËØØ: ' + error.message, 'error');
                }
            }
            
            // ÈáçÁΩÆÈÖçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº
            async function resetUserPreferences() {
                if (!confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÈÖçÁΩÆ‰∏∫ÈªòËÆ§ÂÄºÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
                    return;
                }
                
                try {
                    updateConfigStatus('loading', 'ÈáçÁΩÆ‰∏≠...');
                    
                    const response = await fetch('/api/preferences/reset', {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        userPreferences = result.data;
                        updateSettingsUI(userPreferences);
                        updateConfigStatus('loaded', 'ÈáçÁΩÆÊàêÂäü');
                        updateLastSavedTime();
                        console.log('‚úÖ Áî®Êà∑ÈÖçÁΩÆÈáçÁΩÆÊàêÂäü');
                        showNotification('ÈÖçÁΩÆÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄºÔºÅ', 'success');
                    } else {
                        console.error('‚ùå ÈáçÁΩÆÁî®Êà∑ÈÖçÁΩÆÂ§±Ë¥•', result.message);
                        updateConfigStatus('error', 'ÈáçÁΩÆÂ§±Ë¥•');
                        showNotification('ÈÖçÁΩÆÈáçÁΩÆÂ§±Ë¥•: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('‚ùå ÈáçÁΩÆÁî®Êà∑ÈÖçÁΩÆÈîôËØØ', error);
                    updateConfigStatus('error', 'ÈáçÁΩÆÈîôËØØ');
                    showNotification('ÈÖçÁΩÆÈáçÁΩÆÈîôËØØ: ' + error.message, 'error');
                }
            }
            
            // Êõ¥Êñ∞ËÆæÁΩÆÁïåÈù¢
            function updateSettingsUI(preferences) {
                // ÁïåÈù¢ËÆæÁΩÆ
                setElementValue('darkModeToggle', preferences.darkMode);
                setElementValue('animationsToggle', preferences.enableAnimations);
                setElementValue('autoScrollToggle', preferences.autoScroll);
                setElementValue('soundNotificationToggle', preferences.soundNotification);
                setElementValue('languageSelect', preferences.language);
                
                // OllamaËÆæÁΩÆ
                setElementValue('ollamaUrlInput', preferences.ollamaBaseUrl);
                setElementValue('ollamaModelInput', preferences.ollamaModel);
                setElementValue('ollamaTimeoutInput', preferences.ollamaTimeout);
                setElementValue('ollamaMaxTokensInput', preferences.ollamaMaxTokens);
                setElementValue('ollamaStreamToggle', preferences.ollamaStream);
                
                // ËÅîÁΩëÊêúÁ¥¢ËÆæÁΩÆ
                setElementValue('webSearchEnabledToggle', preferences.webSearchEnabled);
                setElementValue('webSearchEngineSelect', preferences.webSearchEngine);
                setElementValue('webSearchMaxResultsInput', preferences.webSearchMaxResults);
                setElementValue('webSearchTimeoutInput', preferences.webSearchTimeout);
                
                
                // Â∫îÁî®‰∏Ä‰∫õËÆæÁΩÆ
                applyUISettings(preferences);
            }
            
            // ‰ªéÁïåÈù¢Êî∂ÈõÜËÆæÁΩÆ
            function collectSettingsFromUI() {
                // ÁïåÈù¢ËÆæÁΩÆ
                userPreferences.darkMode = getElementValue('darkModeToggle');
                userPreferences.enableAnimations = getElementValue('animationsToggle');
                userPreferences.autoScroll = getElementValue('autoScrollToggle');
                userPreferences.soundNotification = getElementValue('soundNotificationToggle');
                userPreferences.language = getElementValue('languageSelect');
                
                // OllamaËÆæÁΩÆ
                userPreferences.ollamaBaseUrl = getElementValue('ollamaUrlInput');
                userPreferences.ollamaModel = getElementValue('ollamaModelInput');
                userPreferences.ollamaTimeout = parseInt(getElementValue('ollamaTimeoutInput'));
                userPreferences.ollamaMaxTokens = parseInt(getElementValue('ollamaMaxTokensInput'));
                userPreferences.ollamaStream = getElementValue('ollamaStreamToggle');
                
                // ËÅîÁΩëÊêúÁ¥¢ËÆæÁΩÆ
                userPreferences.webSearchEnabled = getElementValue('webSearchEnabledToggle');
                userPreferences.webSearchEngine = getElementValue('webSearchEngineSelect');
                userPreferences.webSearchMaxResults = parseInt(getElementValue('webSearchMaxResultsInput'));
                userPreferences.webSearchTimeout = parseInt(getElementValue('webSearchTimeoutInput'));
                
            }
            
            // Â∫îÁî®UIËÆæÁΩÆ
            function applyUISettings(preferences) {
                // Ê∑±Ëâ≤Ê®°Âºè
                if (preferences.darkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                
                // Âä®ÁîªÊïàÊûú
                if (!preferences.enableAnimations) {
                    document.body.classList.add('no-animations');
                } else {
                    document.body.classList.remove('no-animations');
                }
                
                // Ëá™Âä®ÊªöÂä®
                window.autoScrollEnabled = preferences.autoScroll;
            }
            
            // Â∑•ÂÖ∑ÂáΩÊï∞
            function setElementValue(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            }
            
            function getElementValue(id) {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        return element.checked;
                    } else {
                        return element.value;
                    }
                }
                return null;
            }
            
            function updateRangeValue(inputId, valueId, value) {
                const valueElement = document.getElementById(valueId);
                if (valueElement) {
                    valueElement.textContent = value;
                }
            }
            
            function updateConfigStatus(status, message) {
                const statusElement = document.getElementById('configStatus');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = 'info-value config-status ' + status;
                }
            }
            
            function updateLastSavedTime() {
                const timeElement = document.getElementById('lastSavedTime');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleString();
                }
            }
            
            function showNotification(message, type = 'info') {
                // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 6px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                `;
                
                // ËÆæÁΩÆÈ¢úËâ≤
                switch (type) {
                    case 'success':
                        notification.style.background = '#28a745';
                        break;
                    case 'error':
                        notification.style.background = '#dc3545';
                        break;
                    default:
                        notification.style.background = '#007bff';
                }
                
                document.body.appendChild(notification);
                
                // ÊòæÁ§∫Âä®Áîª
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // Ëá™Âä®ÁßªÈô§
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }
            
            // ÂØºÂá∫ÈÖçÁΩÆ
            function exportSettings() {
                collectSettingsFromUI();
                const dataStr = JSON.stringify(userPreferences, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'chatbot-settings-' + new Date().toISOString().split('T')[0] + '.json';
                link.click();
                URL.revokeObjectURL(url);
                showNotification('ÈÖçÁΩÆÂ∑≤ÂØºÂá∫Âà∞Êñá‰ª∂ÔºÅ', 'success');
            }
            
            // ÂØºÂÖ•ÈÖçÁΩÆ
            function importSettings(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedSettings = JSON.parse(e.target.result);
                        userPreferences = { ...userPreferences, ...importedSettings };
                        updateSettingsUI(userPreferences);
                        showNotification('ÈÖçÁΩÆÂØºÂÖ•ÊàêÂäüÔºÅËØ∑ÁÇπÂáª‰øùÂ≠òÊåâÈíÆÂ∫îÁî®ÈÖçÁΩÆ„ÄÇ', 'success');
                    } catch (error) {
                        console.error('‚ùå ÂØºÂÖ•ÈÖçÁΩÆÂ§±Ë¥•', error);
                        showNotification('ÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºèÈîôËØØÔºÅ', 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
            function bindEventListeners() {
                // ‰øùÂ≠òÊåâÈíÆ
                const saveBtn = document.getElementById('saveSettingsBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        collectSettingsFromUI();
                        saveUserPreferences();
                    });
                }
                
                // ÈáçÁΩÆÊåâÈíÆ
                const resetBtn = document.getElementById('resetSettingsBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', resetUserPreferences);
                }
                
                // ÂØºÂá∫ÊåâÈíÆ
                const exportBtn = document.getElementById('exportSettingsBtn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportSettings);
                }
                
                // ÂØºÂÖ•ÊåâÈíÆ
                const importBtn = document.getElementById('importSettingsBtn');
                const importFileInput = document.getElementById('importFileInput');
                if (importBtn && importFileInput) {
                    importBtn.addEventListener('click', () => importFileInput.click());
                    importFileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            importSettings(file);
                        }
                    });
                }
                
                // ËåÉÂõ¥ÊªëÂùóÂÆûÊó∂Êõ¥Êñ∞
                const responseSpeedInput = document.getElementById('responseSpeedInput');
                if (responseSpeedInput) {
                    responseSpeedInput.addEventListener('input', (e) => {
                        updateRangeValue('responseSpeedInput', 'responseSpeedValue', e.target.value + 'x');
                    });
                }
                
                // ÂÆûÊó∂Â∫îÁî®Êüê‰∫õËÆæÁΩÆ
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            document.body.classList.add('dark-mode');
                        } else {
                            document.body.classList.remove('dark-mode');
                        }
                    });
                }
                
                const animationsToggle = document.getElementById('animationsToggle');
                if (animationsToggle) {
                    animationsToggle.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            document.body.classList.remove('no-animations');
                        } else {
                            document.body.classList.add('no-animations');
                        }
                    });
                }
                
                const autoScrollToggle = document.getElementById('autoScrollToggle');
                if (autoScrollToggle) {
                    autoScrollToggle.addEventListener('change', (e) => {
                        window.autoScrollEnabled = e.target.checked;
                    });
                }
            }
            
            // ÂàùÂßãÂåñ
            updateConfigStatus('loading', 'Âä†ËΩΩ‰∏≠...');
            bindEventListeners();
            loadUserPreferences();
        }
        window.addEventListener('load', function() {
            connect();
            
            // ÂàùÂßãÂåñTabÂàáÊç¢ÂäüËÉΩ
            initTabSwitching();
            
            // ÂàùÂßãÂåñËÆæÁΩÆÈ°µÈù¢
            initSettingsPage();
            
            // ÂàùÂßãÂåñËá™ÈÄÇÂ∫îÂ∏ÉÂ±Ä
            initResponsiveLayout();
            
            // ÂàùÂßãÂåñTTSËÆæÁΩÆ
            loadTTSSettings();
            initTTSSettings();
            
            console.log('‚úÖ Chat system initialized');
        });
        
        // ========== TTSÊéßÂà∂ÂäüËÉΩ ==========
        
        // Êõ¥Êñ∞TTSÊ®°ÂºèÊòæÁ§∫
        function updateTTSModeDisplay() {
            const display = document.getElementById('currentTTSMode');
            if (display) {
                const modeText = currentTTSMode === 'text_only' ? 'Ê®°Âºè1 - Á∫ØÊñáÊú¨' : 'Ê®°Âºè2 - Â≠óÁ¨¶ÊµÅ+ËØ≠Èü≥';
                display.textContent = modeText;
            }
            
            // Êõ¥Êñ∞ËÆæÁΩÆÁïåÈù¢ÁöÑcheckboxÁä∂ÊÄÅ
            const chatToggle = document.getElementById('chatTTSToggle');
            if (chatToggle) chatToggle.checked = ttsSettings.chatEnabled;
            
            // Êõ¥Êñ∞ËØ≠Èü≥‰∫∫ËÆæÈÄâÊã©Áä∂ÊÄÅ
            const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
            if (speakerSelect && ttsSettings.spk_id) {
                speakerSelect.value = ttsSettings.spk_id;
            }
        }
        
        
        // Êõ¥Êñ∞TTSÊéßÂà∂ÊåâÈíÆÁä∂ÊÄÅ
        function updateTTSControlButton() {
            // Êõ¥Êñ∞ÂàáÊç¢ÊåâÈíÆÁä∂ÊÄÅ
            updateTTSToggleUI(ttsSettings.chatEnabled);
        }
        
        // Ëé∑ÂèñCosyVoiceËØ≠Èü≥ËßíËâ≤ÂàóË°®
        async function loadCosyVoiceSpeakers() {
            try {
                const response = await fetch('/api/cosyvoice/speakers', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateSpeakerSelect(result.builtinSpeakers, result.customSpeakers);
                        return true;
                    } else {
                        console.error('Ëé∑ÂèñËØ≠Èü≥‰∫∫ËÆæÂ§±Ë¥•:', result.message);
                        showTTSNotification('Ëé∑ÂèñËØ≠Èü≥‰∫∫ËÆæÂ§±Ë¥•: ' + result.message);
                        return false;
                    }
                } else {
                    console.error('Ëé∑ÂèñËØ≠Èü≥‰∫∫ËÆæËØ∑Ê±ÇÂ§±Ë¥•:', response.status);
                    showTTSNotification('Ëé∑ÂèñËØ≠Èü≥‰∫∫ËÆæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•TTSÊúçÂä°Áä∂ÊÄÅ');
                    return false;
                }
            } catch (error) {
                console.error('Ëé∑ÂèñËØ≠Èü≥‰∫∫ËÆæÂºÇÂ∏∏:', error);
                showTTSNotification('Ëé∑ÂèñËØ≠Èü≥‰∫∫ËÆæÂºÇÂ∏∏: ' + error.message);
                return false;
            }
        }
        
        // Êõ¥Êñ∞ËØ≠Èü≥‰∫∫ËÆæÈÄâÊã©Ê°Ü
        function updateSpeakerSelect(builtinSpeakers, customSpeakers) {
            const dropdown = document.getElementById('speakerDropdown');
            const selectDisplay = document.querySelector('.select-display');
            
            if (!dropdown || !selectDisplay) return;
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            dropdown.innerHTML = '';
            
            let firstSpeaker = null;
            let allSpeakers = [];
            
            // Ëé∑ÂèñÈªòËÆ§ËØ≠Èü≥‰∫∫ËÆæÂàóË°®Ôºà‰ªéreference_audioÁõÆÂΩïÔºâ
            const defaultSpeakers = getDefaultSpeakers();
            
            // Ê∑ªÂä†ÂÜÖÁΩÆËØ≠Èü≥‰∫∫ËÆæ
            if (builtinSpeakers && builtinSpeakers.length > 0) {
                builtinSpeakers.forEach((speaker, index) => {
                    const isDefault = defaultSpeakers.includes(speaker);
                    const option = createSpeakerOption(speaker, 'builtin', isDefault);
                    dropdown.appendChild(option);
                    allSpeakers.push(speaker);
                    
                    // ËÆ∞ÂΩïÁ¨¨‰∏Ä‰∏™ËØ≠Èü≥‰∫∫ËÆæ
                    if (firstSpeaker === null) {
                        firstSpeaker = speaker;
                    }
                });
            }
            
            // Ê∑ªÂä†Ëá™ÂÆö‰πâËØ≠Èü≥‰∫∫ËÆæ
            if (customSpeakers && customSpeakers.length > 0) {
                customSpeakers.forEach(speaker => {
                    const option = createSpeakerOption(speaker, 'custom', false);
                    dropdown.appendChild(option);
                    allSpeakers.push(speaker);
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÂÜÖÁΩÆËØ≠Èü≥‰∫∫ËÆæÔºåËÆ∞ÂΩïÁ¨¨‰∏Ä‰∏™Ëá™ÂÆö‰πâËØ≠Èü≥‰∫∫ËÆæ
                    if (firstSpeaker === null) {
                        firstSpeaker = speaker;
                    }
                });
            }
            
            // ËÆæÁΩÆÈÄâ‰∏≠ÁöÑËØ≠Èü≥‰∫∫ËÆæ
            let selectedSpeaker = ttsSettings.spk_id;
            
            // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÈÄâÊã©Êàñ‰øùÂ≠òÁöÑÈÄâÊã©‰∏çÂú®ÂàóË°®‰∏≠Ôºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™
            if (!selectedSpeaker || !isValidSpeaker(selectedSpeaker, builtinSpeakers, customSpeakers)) {
                selectedSpeaker = firstSpeaker;
                if (selectedSpeaker) {
                    ttsSettings.spk_id = selectedSpeaker;
                    saveTTSSettings();
                }
            }
            
            // Êõ¥Êñ∞ÊòæÁ§∫ÊñáÊú¨ÂíåÈÄâ‰∏≠Áä∂ÊÄÅ
            updateSelectedSpeaker(selectedSpeaker);
            
            console.log('ËØ≠Èü≥‰∫∫ËÆæÂàóË°®Â∑≤Êõ¥Êñ∞:', {
                builtin: builtinSpeakers ? builtinSpeakers.length : 0,
                custom: customSpeakers ? customSpeakers.length : 0,
                selected: selectedSpeaker,
                first: firstSpeaker,
                default: defaultSpeakers
            });
        }

        // Ëé∑ÂèñÈªòËÆ§ËØ≠Èü≥‰∫∫ËÆæÂàóË°®
        function getDefaultSpeakers() {
            // ËøôÈáåËøîÂõûÂú®reference_audioÁõÆÂΩï‰∏≠ÁöÑÈªòËÆ§ËØ≠Èü≥‰∫∫ËÆæ
            // ÂÆûÈôÖÂ∫îËØ•‰ªéÊúçÂä°Âô®Ëé∑ÂèñÔºåËøôÈáåÂÖàÁ°¨ÁºñÁ†Å
            return ['Ê¥æËíô']; // ÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÊâ©Â±ï
        }

        // ÂàõÂª∫ËØ≠Èü≥‰∫∫ËÆæÈÄâÈ°π
        function createSpeakerOption(speaker, type, isDefault) {
            const option = document.createElement('div');
            option.className = 'select-option';
            option.dataset.value = speaker;
            
            const optionContent = document.createElement('div');
            optionContent.style.display = 'flex';
            optionContent.style.alignItems = 'center';
            optionContent.style.width = '100%';
            
            const optionText = document.createElement('span');
            optionText.className = 'option-text';
            optionText.textContent = speaker;
            optionContent.appendChild(optionText);
            
            // Ê∑ªÂä†Ê†áËØÜ
            if (type === 'builtin') {
                const badge = document.createElement('span');
                badge.className = 'option-badge';
                badge.textContent = 'ÂÜÖÁΩÆ';
                optionContent.appendChild(badge);
            } else if (type === 'custom') {
                const badge = document.createElement('span');
                badge.className = 'option-badge custom';
                badge.textContent = 'Ëá™ÂÆö‰πâ';
                optionContent.appendChild(badge);
            }
            
            // ‰∏∫ÈùûÈªòËÆ§ËØ≠Èü≥‰∫∫ËÆæÊ∑ªÂä†Âà†Èô§ÊåâÈíÆ
            if (!isDefault && type === 'custom') {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Âà†Èô§';
                deleteBtn.title = 'Âà†Èô§Ê≠§ËØ≠Èü≥‰∫∫ËÆæ';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    confirmDeleteSpeaker(speaker);
                };
                optionContent.appendChild(deleteBtn);
            }
            
            option.appendChild(optionContent);
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
            option.addEventListener('click', function() {
                selectSpeaker(speaker);
            });
            
            return option;
        }

        // ÈÄâÊã©ËØ≠Èü≥‰∫∫ËÆæ
        function selectSpeaker(speaker) {
            ttsSettings.spk_id = speaker;
            saveTTSSettings();
            updateSelectedSpeaker(speaker);
            closeDropdown();
            console.log('ËØ≠Èü≥‰∫∫ËÆæÂ∑≤Êõ¥Êîπ:', speaker);
            showTTSNotification('ËØ≠Èü≥‰∫∫ËÆæÂ∑≤Êõ¥Êñ∞: ' + speaker);
        }

        // Êõ¥Êñ∞ÈÄâ‰∏≠ÁöÑËØ≠Èü≥‰∫∫ËÆæÊòæÁ§∫
        function updateSelectedSpeaker(speaker) {
            const selectDisplay = document.querySelector('.select-display');
            const options = document.querySelectorAll('.select-option');
            
            if (selectDisplay) {
                selectDisplay.textContent = speaker || 'ËØ∑ÈÄâÊã©ËØ≠Èü≥‰∫∫ËÆæ...';
            }
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            options.forEach(option => {
                if (option.dataset.value === speaker) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }
        
        // Ê£ÄÊü•ËØ≠Èü≥‰∫∫ËÆæÊòØÂê¶ÊúâÊïà
        function isValidSpeaker(speakerId, builtinSpeakers, customSpeakers) {
            if (!speakerId) return false;
            
            if (builtinSpeakers && builtinSpeakers.includes(speakerId)) {
                return true;
            }
            
            if (customSpeakers && customSpeakers.includes(speakerId)) {
                return true;
            }
            
            return false;
        }
        
        // ÊòæÁ§∫TTSÈÄöÁü•
        function showTTSNotification(message) {
            // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = 'tts-notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                animation: slideInRight 0.3s ease, fadeInUp 0.3s ease;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            `;
            
            document.body.appendChild(notification);
            
            // 3ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ‰øùÂ≠òTTSËÆæÁΩÆ
        async function saveTTSSettings() {
            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('ttsSettings', JSON.stringify(ttsSettings));
            localStorage.setItem('currentTTSMode', currentTTSMode);
            
            // ÂêåÊ≠•Âà∞ÂêéÁ´ØUserPreferences
            try {
                const response = await fetch('/api/preferences/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatEnabled: ttsSettings.chatEnabled,
                        chatMode: ttsSettings.chatMode,
                        speakerId: ttsSettings.spk_id,
                        speed: ttsSettings.speed
                    })
                });
                
                if (!response.ok) {
                    console.warn('TTSËÆæÁΩÆÂêåÊ≠•Âà∞ÂêéÁ´ØÂ§±Ë¥•:', response.status);
                }
            } catch (error) {
                console.warn('TTSËÆæÁΩÆÂêåÊ≠•ÂºÇÂ∏∏:', error);
            }
        }
        
        // Âä†ËΩΩTTSËÆæÁΩÆ
        function loadTTSSettings() {
            const savedSettings = localStorage.getItem('ttsSettings');
            const savedMode = localStorage.getItem('currentTTSMode');
            
            if (savedSettings) {
                ttsSettings = { ...ttsSettings, ...JSON.parse(savedSettings) };
            }
            
            if (savedMode) {
                currentTTSMode = savedMode;
            }
            
            // Âº∫Âà∂Á°Æ‰øùTTSÂú®Á®ãÂ∫èÂêØÂä®Êó∂‰∏∫Á¶ÅÁî®Áä∂ÊÄÅ
            ttsSettings.chatEnabled = false;
            ttsSettings.chatMode = 'text_only';
            currentTTSMode = 'text_only';
            
            // ‰øùÂ≠òÂº∫Âà∂ÈáçÁΩÆÁöÑÁä∂ÊÄÅ
            saveTTSSettings();
            
            updateTTSModeDisplay();
            updateTTSControlButton();
            
            // ‰∏çÂú®ÂàùÂßãÂåñÊó∂Âä†ËΩΩËØ≠Èü≥ËßíËâ≤ÂàóË°®ÔºåÂè™Âú®ÈúÄË¶ÅÊó∂Âä†ËΩΩ
            console.log('‚úÖ TTSËÆæÁΩÆÂ∑≤ÂàùÂßãÂåñ‰∏∫Á¶ÅÁî®Áä∂ÊÄÅ');
        }
        
        // ÂàùÂßãÂåñTTSËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
        function initTTSSettings() {
            // ËÅäÂ§©TTSÂºÄÂÖ≥ - ËÆæÁΩÆÈ°µÈù¢ÁöÑcheckboxÁé∞Âú®Âè™ÊòØÊòæÁ§∫Áä∂ÊÄÅÔºå‰∏çÂÖÅËÆ∏Áõ¥Êé•‰øÆÊîπ
            const chatToggle = document.getElementById('chatTTSToggle');
            if (chatToggle) {
                chatToggle.addEventListener('change', function() {
                    // ÈòªÊ≠¢Áõ¥Êé•Âú®ËÆæÁΩÆÈ°µÈù¢‰øÆÊîπÔºåÊèêÁ§∫Áî®Êà∑Âú®ËÅäÂ§©Á™óÂè£Êìç‰Ωú
                    this.checked = ttsSettings.chatEnabled; // ÊÅ¢Â§çÂéüÁä∂ÊÄÅ
                    
                    // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
                    showTTSNotification('ËØ∑Âú®ËÅäÂ§©Á™óÂè£‰ΩøÁî®TTSÊåâÈíÆÂàáÊç¢Ê®°Âºè');
                });
            }
            
            
            // CosyVoiceËØ≠Èü≥‰∫∫ËÆæÈÄâÊã©
            // Ëá™ÂÆö‰πâ‰∏ãÊãâÊ°Ü‰∫§‰∫í
            const customSelect = document.getElementById('cosyVoiceSpeakerSelect');
            if (customSelect) {
                // ÁÇπÂáª‰∏ãÊãâÊ°ÜÂàáÊç¢ÊòæÁ§∫/ÈöêËóè
                customSelect.addEventListener('click', function() {
                    toggleDropdown();
                });
                
                // ÈîÆÁõòÊîØÊåÅ
                customSelect.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleDropdown();
                    } else if (e.key === 'Escape') {
                        closeDropdown();
                    }
                });
                
                // ÁÇπÂáª‰∏ãÊãâÊ°ÜÊó∂ÊâçÂä†ËΩΩËØ≠Èü≥‰∫∫ËÆæÂàóË°®ÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÂä†ËΩΩËøáÔºâ
                customSelect.addEventListener('focus', function() {
                    // Âè™Âú®TTSÂêØÁî®Êó∂ÊàñÁî®Êà∑‰∏ªÂä®ÁÇπÂáªÊó∂ÊâçÂä†ËΩΩ
                    if (ttsSettings.chatEnabled || this.children.length <= 1) {
                        loadCosyVoiceSpeakers();
                    }
                });
            }

            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâÊ°Ü
            document.addEventListener('click', function(e) {
                const container = document.querySelector('.custom-select-container');
                if (container && !container.contains(e.target)) {
                    closeDropdown();
                }
            });
            
            // Âà∑Êñ∞ËØ≠Èü≥‰∫∫ËÆæÊåâÈíÆ
            const refreshBtn = document.getElementById('refreshSpeakersBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    showTTSNotification('Ê≠£Âú®Âà∑Êñ∞ËØ≠Èü≥‰∫∫ËÆæÂàóË°®...');
                    loadCosyVoiceSpeakers();
                });
            }

            // Êñ∞Â¢ûËØ≠Èü≥‰∫∫ËÆæÊåâÈíÆ
            const addSpeakerBtn = document.getElementById('addCustomSpeakerBtn');
            if (addSpeakerBtn) {
                addSpeakerBtn.addEventListener('click', function() {
                    showAddSpeakerModal();
                });
            }

            // ÁîüÊàêËØ≠Èü≥ÊåâÈíÆ
            const generateVoiceBtn = document.getElementById('generateVoiceBtn');
            if (generateVoiceBtn) {
                generateVoiceBtn.addEventListener('click', function() {
                    generateTestVoice();
                });
            }
            
            // ËØ≠Èü≥ÈÄüÂ∫¶
            const speedRange = document.getElementById('ttsSpeedRange');
            const speedValue = document.getElementById('ttsSpeedValue');
            if (speedRange && speedValue) {
                speedRange.addEventListener('input', function() {
                    ttsSettings.speed = parseFloat(this.value);
                    speedValue.textContent = this.value + 'x';
                    saveTTSSettings();
                });
            }
        }

        // ==================== Êñ∞Â¢ûËØ≠Èü≥‰∫∫ËÆæÂºπÁ™óÂäüËÉΩ ====================

        // ÊòæÁ§∫Êñ∞Â¢ûËØ≠Èü≥‰∫∫ËÆæÂºπÁ™ó
        function showAddSpeakerModal() {
            const modal = document.getElementById('addSpeakerModal');
            if (modal) {
                modal.style.display = 'block';
                // Ê∏ÖÁ©∫Ë°®Âçï
                resetAddSpeakerForm();
            }
        }

        // ÈöêËóèÊñ∞Â¢ûËØ≠Èü≥‰∫∫ËÆæÂºπÁ™ó
        function hideAddSpeakerModal() {
            const modal = document.getElementById('addSpeakerModal');
            if (modal) {
                modal.style.display = 'none';
                resetAddSpeakerForm();
            }
        }

        // ÈáçÁΩÆË°®Âçï
        function resetAddSpeakerForm() {
            const form = document.getElementById('addSpeakerForm');
            if (form) {
                form.reset();
            }
        }

        // ÂàõÂª∫ËØ≠Èü≥‰∫∫ËÆæ
        async function createCustomSpeaker(formData) {
            try {
                const createBtn = document.getElementById('createSpeakerBtn');
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.textContent = 'ÂàõÂª∫‰∏≠...';
                }

                const response = await fetch('/api/cosyvoice/speaker/create', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showTTSNotification('ËØ≠Èü≥‰∫∫ËÆæÂàõÂª∫ÊàêÂäü: ' + result.speakerName, 'success');
                        hideAddSpeakerModal();
                        
                        // Âà∑Êñ∞ËØ≠Èü≥‰∫∫ËÆæÂàóË°®
                        await loadCosyVoiceSpeakers();
                        
                        // ÈÄâ‰∏≠Êñ∞ÂàõÂª∫ÁöÑËØ≠Èü≥‰∫∫ËÆæ
                        const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
                        if (speakerSelect && result.speakerName) {
                            speakerSelect.value = result.speakerName;
                            ttsSettings.spk_id = result.speakerName;
                            saveTTSSettings();
                            showTTSNotification('Â∑≤Ëá™Âä®ÈÄâÊã©Êñ∞ÂàõÂª∫ÁöÑËØ≠Èü≥‰∫∫ËÆæ: ' + result.speakerName);
                        }
                        
                        return true;
                    } else {
                        showTTSNotification('ÂàõÂª∫Â§±Ë¥•: ' + result.message, 'error');
                        return false;
                    }
                } else {
                    const errorText = await response.text();
                    showTTSNotification('ÂàõÂª∫Â§±Ë¥•: HTTP ' + response.status + ' - ' + errorText, 'error');
                    return false;
                }
            } catch (error) {
                console.error('ÂàõÂª∫ËØ≠Èü≥‰∫∫ËÆæÂºÇÂ∏∏:', error);
                showTTSNotification('ÂàõÂª∫ÂºÇÂ∏∏: ' + error.message, 'error');
                return false;
            } finally {
                const createBtn = document.getElementById('createSpeakerBtn');
                if (createBtn) {
                    createBtn.disabled = false;
                    createBtn.textContent = 'ÂàõÂª∫ËØ≠Èü≥‰∫∫ËÆæ';
                }
            }
        }

        // È™åËØÅË°®ÂçïÊï∞ÊçÆ
        function validateSpeakerForm() {
            const speakerName = document.getElementById('speakerNameInput').value.trim();
            const referenceText = document.getElementById('referenceTextInput').value.trim();
            const referenceAudio = document.getElementById('referenceAudioInput').files[0];

            if (!speakerName) {
                showTTSNotification('ËØ∑ËæìÂÖ•ËØ≠Èü≥‰∫∫Áâ©ÂêçÁß∞', 'error');
                return false;
            }

            if (speakerName.length > 50) {
                showTTSNotification('ËØ≠Èü≥‰∫∫Áâ©ÂêçÁß∞‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', 'error');
                return false;
            }

            if (!referenceText) {
                showTTSNotification('ËØ∑ËæìÂÖ•ÂèÇËÄÉÊñáÊú¨', 'error');
                return false;
            }

            if (referenceText.length > 500) {
                showTTSNotification('ÂèÇËÄÉÊñáÊú¨‰∏çËÉΩË∂ÖËøá500‰∏™Â≠óÁ¨¶', 'error');
                return false;
            }

            if (!referenceAudio) {
                showTTSNotification('ËØ∑ÈÄâÊã©ÂèÇËÄÉÈü≥È¢ëÊñá‰ª∂', 'error');
                return false;
            }

            if (!referenceAudio.name.toLowerCase().endsWith('.wav')) {
                showTTSNotification('ËØ∑ÈÄâÊã©WAVÊ†ºÂºèÁöÑÈü≥È¢ëÊñá‰ª∂', 'error');
                return false;
            }

            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫50MBÔºâ
            if (referenceAudio.size > 50 * 1024 * 1024) {
                showTTSNotification('Èü≥È¢ëÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá50MB', 'error');
                return false;
            }

            return true;
        }

        // ÂàùÂßãÂåñÂºπÁ™ó‰∫ã‰ª∂ÁõëÂê¨Âô®
        function initAddSpeakerModal() {
            // ÂÖ≥Èó≠ÊåâÈíÆ
            const closeBtn = document.getElementById('closeSpeakerModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', hideAddSpeakerModal);
            }

            // ÂèñÊ∂àÊåâÈíÆ
            const cancelBtn = document.getElementById('cancelSpeakerBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideAddSpeakerModal);
            }

            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠ÂºπÁ™ó
            const modal = document.getElementById('addSpeakerModal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        hideAddSpeakerModal();
                    }
                });
            }

            // Ë°®ÂçïÊèê‰∫§
            const form = document.getElementById('addSpeakerForm');
            if (form) {
                form.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    if (!validateSpeakerForm()) {
                        return;
                    }

                    const formData = new FormData();
                    formData.append('speakerName', document.getElementById('speakerNameInput').value.trim());
                    formData.append('referenceText', document.getElementById('referenceTextInput').value.trim());
                    formData.append('referenceAudio', document.getElementById('referenceAudioInput').files[0]);

                    await createCustomSpeaker(formData);
                });
            }

            // ESCÈîÆÂÖ≥Èó≠ÂºπÁ™ó
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modal = document.getElementById('addSpeakerModal');
                    if (modal && modal.style.display === 'block') {
                        hideAddSpeakerModal();
                    }
                }
            });
        }

        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÂºπÁ™ó
        document.addEventListener('DOMContentLoaded', function() {
            initAddSpeakerModal();
        });

        // ==================== ÊµãËØïËØ≠Èü≥ÁîüÊàêÂäüËÉΩ ====================

        // ÁîüÊàêÊµãËØïËØ≠Èü≥
        async function generateTestVoice() {
            const textInput = document.getElementById('testVoiceText');
            const speakerSelect = document.getElementById('cosyVoiceSpeakerSelect');
            const generateBtn = document.getElementById('generateVoiceBtn');
            const resultDiv = document.getElementById('voiceTestResult');

            // È™åËØÅËæìÂÖ•
            const text = textInput.value.trim();
            if (!text) {
                showTTSNotification('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑÊñáÊú¨', 'error');
                textInput.focus();
                return;
            }

            const selectedSpeaker = speakerSelect.value;
            if (!selectedSpeaker) {
                showTTSNotification('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËØ≠Èü≥‰∫∫ËÆæ', 'error');
                return;
            }

            try {
                // Á¶ÅÁî®ÊåâÈíÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                generateBtn.disabled = true;
                generateBtn.textContent = 'ÁîüÊàê‰∏≠...';
                
                // ÊòæÁ§∫Âä†ËΩΩÂç†‰ΩçÁ¨¶
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        <div class="loading-spinner"></div>
                        <span>Ê≠£Âú®ÁîüÊàêËØ≠Èü≥ÔºåËØ∑Á®çÂÄô...</span>
                    </div>
                `;

                // Ëé∑ÂèñÂΩìÂâçËØ≠Èü≥ÈÄüÂ∫¶ËÆæÁΩÆ
                const speedRange = document.getElementById('ttsSpeedRange');
                const speed = speedRange ? parseFloat(speedRange.value) : 1.0;

                // Ë∞ÉÁî®APIÁîüÊàêËØ≠Èü≥
                const response = await fetch('/api/cosyvoice/synthesis/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        text: text,
                        speakerName: selectedSpeaker,
                        speed: speed.toString(),
                        format: 'wav'
                    })
                });

                if (response.ok) {
                    // Ëé∑ÂèñÈü≥È¢ëÊï∞ÊçÆ
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // ÊòæÁ§∫Èü≥È¢ëÊí≠ÊîæÂô®
                    resultDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #4caf50;">
                            <span style="color: #2e7d32; font-weight: 500;">‚úÖ ËØ≠Èü≥ÁîüÊàêÊàêÂäü</span>
                            <audio controls style="flex: 1;">
                                <source src="${audioUrl}" type="audio/wav">
                                ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ„ÄÇ
                            </audio>
                            <button onclick="downloadTestAudio('${audioUrl}')" style="padding: 4px 8px; font-size: 12px;">‰∏ãËΩΩ</button>
                        </div>
                    `;
                    
                    showTTSNotification('ËØ≠Èü≥ÁîüÊàêÊàêÂäüÔºÅ', 'success');
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <div style="padding: 10px; background: #f8d7da; border-radius: 6px; border-left: 4px solid #dc3545; color: #721c24;">
                            ‚ùå ÁîüÊàêÂ§±Ë¥•: ${errorText}
                        </div>
                    `;
                    showTTSNotification('ËØ≠Èü≥ÁîüÊàêÂ§±Ë¥•: ' + errorText, 'error');
                }

            } catch (error) {
                console.error('ÁîüÊàêËØ≠Èü≥ÂºÇÂ∏∏:', error);
                resultDiv.innerHTML = `
                    <div style="padding: 10px; background: #f8d7da; border-radius: 6px; border-left: 4px solid #dc3545; color: #721c24;">
                        ‚ùå ÁîüÊàêÂºÇÂ∏∏: ${error.message}
                    </div>
                `;
                showTTSNotification('ËØ≠Èü≥ÁîüÊàêÂºÇÂ∏∏: ' + error.message, 'error');
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                generateBtn.disabled = false;
                generateBtn.textContent = 'ÁîüÊàêËØ≠Èü≥';
            }
        }

        // ‰∏ãËΩΩÊµãËØïÈü≥È¢ë
        function downloadTestAudio(audioUrl) {
            const link = document.createElement('a');
            link.href = audioUrl;
            link.download = 'test_voice_' + new Date().getTime() + '.wav';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Ê∏ÖÁêÜÈü≥È¢ëURLÔºàÈò≤Ê≠¢ÂÜÖÂ≠òÊ≥ÑÊºèÔºâ
        function cleanupAudioUrls() {
            const audioElements = document.querySelectorAll('#voiceTestResult audio');
            audioElements.forEach(audio => {
                if (audio.src && audio.src.startsWith('blob:')) {
                    URL.revokeObjectURL(audio.src);
                }
            });
        }

        // Âú®ÁîüÊàêÊñ∞ËØ≠Èü≥ÂâçÊ∏ÖÁêÜÊóßÁöÑURL
        window.addEventListener('beforeunload', cleanupAudioUrls);

        // ==================== Ëá™ÂÆö‰πâ‰∏ãÊãâÊ°ÜÊéßÂà∂ÂäüËÉΩ ====================

        // ÂàáÊç¢‰∏ãÊãâÊ°ÜÊòæÁ§∫/ÈöêËóè
        function toggleDropdown() {
            const dropdown = document.getElementById('speakerDropdown');
            const customSelect = document.getElementById('cosyVoiceSpeakerSelect');
            
            if (dropdown && customSelect) {
                const isOpen = dropdown.style.display === 'block';
                if (isOpen) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            }
        }

        // ÊâìÂºÄ‰∏ãÊãâÊ°Ü
        function openDropdown() {
            const dropdown = document.getElementById('speakerDropdown');
            const customSelect = document.getElementById('cosyVoiceSpeakerSelect');
            
            if (dropdown && customSelect) {
                dropdown.style.display = 'block';
                customSelect.classList.add('open');
            }
        }

        // ÂÖ≥Èó≠‰∏ãÊãâÊ°Ü
        function closeDropdown() {
            const dropdown = document.getElementById('speakerDropdown');
            const customSelect = document.getElementById('cosyVoiceSpeakerSelect');
            
            if (dropdown && customSelect) {
                dropdown.style.display = 'none';
                customSelect.classList.remove('open');
            }
        }

        // ==================== ËØ≠Èü≥‰∫∫ËÆæÂà†Èô§ÂäüËÉΩ ====================

        // Á°ÆËÆ§Âà†Èô§ËØ≠Èü≥‰∫∫ËÆæ
        function confirmDeleteSpeaker(speakerName) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ËØ≠Èü≥‰∫∫ËÆæ "${speakerName}" ÂêóÔºü\n\nÊ≠§Êìç‰ΩúÂ∞ÜÔºö\n‚Ä¢ ‰ªéCosyVoiceÊúçÂä°‰∏≠Âà†Èô§ËØ•ËØ≠Èü≥‰∫∫ËÆæ\n‚Ä¢ Âà†Èô§Êú¨Âú∞Â≠òÂÇ®ÁöÑÈü≥È¢ëÂíåÊñáÊú¨Êñá‰ª∂\n‚Ä¢ Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ`)) {
                deleteSpeaker(speakerName);
            }
        }

        // Âà†Èô§ËØ≠Èü≥‰∫∫ËÆæ
        async function deleteSpeaker(speakerName) {
            try {
                showTTSNotification('Ê≠£Âú®Âà†Èô§ËØ≠Èü≥‰∫∫ËÆæ: ' + speakerName + '...');
                
                const response = await fetch(`/api/cosyvoice/speaker/delete/${encodeURIComponent(speakerName)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showTTSNotification('ËØ≠Èü≥‰∫∫ËÆæÂà†Èô§ÊàêÂäü: ' + speakerName, 'success');
                        
                        // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑËØ≠Èü≥‰∫∫ËÆæÔºåÈúÄË¶ÅÈÄâÊã©ÂÖ∂‰ªñÁöÑ
                        if (ttsSettings.spk_id === speakerName) {
                            ttsSettings.spk_id = '';
                            saveTTSSettings();
                        }
                        
                        // Âà∑Êñ∞ËØ≠Èü≥‰∫∫ËÆæÂàóË°®
                        await loadCosyVoiceSpeakers();
                        
                        // ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÂèØÁî®ÁöÑËØ≠Èü≥‰∫∫ËÆæ
                        selectFirstAvailableSpeaker();
                        
                    } else {
                        showTTSNotification('Âà†Èô§Â§±Ë¥•: ' + result.message, 'error');
                    }
                } else {
                    const errorText = await response.text();
                    showTTSNotification('Âà†Èô§Â§±Ë¥•: HTTP ' + response.status + ' - ' + errorText, 'error');
                }

            } catch (error) {
                console.error('Âà†Èô§ËØ≠Èü≥‰∫∫ËÆæÂºÇÂ∏∏:', error);
                showTTSNotification('Âà†Èô§ÂºÇÂ∏∏: ' + error.message, 'error');
            }
        }

        // ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÂèØÁî®ÁöÑËØ≠Èü≥‰∫∫ËÆæ
        function selectFirstAvailableSpeaker() {
            const options = document.querySelectorAll('.select-option');
            if (options.length > 0) {
                const firstOption = options[0];
                const speakerName = firstOption.dataset.value;
                if (speakerName) {
                    selectSpeaker(speakerName);
                }
            } else {
                // Ê≤°ÊúâÂèØÁî®ÁöÑËØ≠Èü≥‰∫∫ËÆæ
                const selectDisplay = document.querySelector('.select-display');
                if (selectDisplay) {
                    selectDisplay.textContent = 'ËØ∑ÈÄâÊã©ËØ≠Èü≥‰∫∫ËÆæ...';
                }
                ttsSettings.spk_id = '';
                saveTTSSettings();
            }
        }
    </script>

    <!-- Êñ∞Â¢ûËØ≠Èü≥‰∫∫ËÆæÂºπÁ™ó -->
    <div id="addSpeakerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé≠ Êñ∞Â¢ûËØ≠Èü≥‰∫∫ËÆæ</h2>
                <span class="close" id="closeSpeakerModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addSpeakerForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="speakerNameInput">ËØ≠Èü≥‰∫∫Áâ©ÂêçÁß∞:</label>
                        <input type="text" id="speakerNameInput" name="speakerName" required 
                               placeholder="ËØ∑ËæìÂÖ•ËØ≠Èü≥‰∫∫Áâ©ÂêçÁß∞ÔºàÂ¶ÇÔºöÊ¥æËíôÔºâ" maxlength="50">
                        <span class="form-description">Â∞Ü‰Ωú‰∏∫ËØ≠Èü≥‰∫∫ËÆæÁöÑÊ†áËØÜÂêçÁß∞</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="referenceTextInput">ÂèÇËÄÉÊñáÊú¨:</label>
                        <textarea id="referenceTextInput" name="referenceText" required 
                                  placeholder="ËØ∑ËæìÂÖ•ÂèÇËÄÉÊñáÊú¨ÔºåÁî®‰∫éËÆ≠ÁªÉËØ≠Èü≥ÁâπÂæÅ..." 
                                  rows="4" maxlength="500"></textarea>
                        <span class="form-description">Áî®‰∫éËØ≠Èü≥ÂÖãÈöÜÁöÑÂèÇËÄÉÊñáÊú¨ÔºåÂª∫ËÆÆ10-50Â≠ó</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="referenceAudioInput">ÂèÇËÄÉÈü≥È¢ëÊñá‰ª∂:</label>
                        <input type="file" id="referenceAudioInput" name="referenceAudio" 
                               accept=".wav" required>
                        <span class="form-description">ËØ∑ÈÄâÊã©WAVÊ†ºÂºèÁöÑÈü≥È¢ëÊñá‰ª∂ÔºåÂª∫ËÆÆ3-10Áßí</span>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="cancelSpeakerBtn" class="cancel-btn">ÂèñÊ∂à</button>
                        <button type="submit" id="createSpeakerBtn" class="create-btn">ÂàõÂª∫ËØ≠Èü≥‰∫∫ËÆæ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>
</html>
